{
    "abstractText": "Systematic uncertainties associated to type Ia supernova (SN Ia) Hubble diagrams from photometrically selected samples using photometric SN host galaxy redshifts are investigated. The host redshift uncertainties and the contamination by core-collapse SNe are both addressed. As a test case, we use the 3-year photometric SN Ia sample of the SuperNova Legacy Survey (SNLS), consisting of 437 objects between 0.1 and 1.05 in redshift with 4.7% contamination. We combine this sample with non-SNLS objects of the spectroscopic sample from the joint analysis (JLA) of the SDSS-II and SNLS collaborations, consisting of 501 objects mostly below 0.4 in redshift. We study two options for the origin of the redshifts of the photometric sample, either provided entirely from the host photometric redshift catalogue used in the selection or a mixed origin where around 75% of the sample can be assigned spectroscopic redshifts from dedicated measurements or external catalogues. Using light curve simulations subject to the same photometric selection as data, we study the impact of photometric redshift uncertainties and contamination on flat \u039bCDM fits to Hubble diagrams from such combined samples. Our primary finding is that photometric redshifts and contamination lead to biased cosmological parameters. The magnitude of the bias is found to be similar for both redshift options. This bias can be largely accounted for if photometric redshift uncertainties and contamination are taken into account when computing the SN magnitude bias correction due to selection effects. To reduce the residual cosmological bias, we explore two methods to propagate redshift uncertainties into the cosmological likelihood computation, either by refitting photometric redshifts along with cosmology or by sampling the redshift resolution function. Redshift refitting fails at correcting the cosmological bias whatever the redshift origin, while sampling slightly reduces it in both cases. Finally, for actual data, we find compatible results with those from the JLA diagram for mixed photometric and spectroscopic redshifts, while the full photometric option is biased upwards, but consistent with JLA when all statistical and systematic uncertainties are included. Corresponding author. ar X iv :2 20 7. 03 78 9v 2 [ as tr oph .C O ] 2 4 O ct 2 02 2",
    "authors": [
        {
            "affiliations": [],
            "name": "V. Ruhlmann-Kleider"
        },
        {
            "affiliations": [],
            "name": "C. Lidman"
        },
        {
            "affiliations": [],
            "name": "A. M\u00f6ller"
        }
    ],
    "id": "SP:4567f394d8ff6c54b998277e05a6cefefe006907",
    "references": [
        {
            "authors": [
                "eBOSS Collaboration: S. Alam",
                "M. Aubert",
                "S. Avila"
            ],
            "title": "The completed SDSS-IV extended Baryon Oscillation Spectroscopic Survey: Cosmological Implications from two Decades of Spectroscopic Surveys at the Apache Point observatory",
            "venue": "Phys. Rev. D",
            "year": 2007
        },
        {
            "authors": [
                "K. Perrett",
                "M. Sullivan"
            ],
            "title": "A",
            "venue": "Conley et al., Evolution in the Volumetric Type Ia Supernova Rate from the Supernova Legacy Survey, AJ 144 ",
            "year": 2012
        },
        {
            "authors": [
                "G. Bazin",
                "V. Ruhlmann-Kleider"
            ],
            "title": "N",
            "venue": "Palanque-Delabrouille et al., Photometric selection of Type Ia supernovae in the Supernova Legacy Survey, A&A 534 ",
            "year": 2011
        },
        {
            "authors": [
                "C. Lidman",
                "V. Ruhlmann-Kleider"
            ],
            "title": "M",
            "venue": "Sullivan et al., An Efficient Approach to Obtaining Large Numbers of Distant Supernova Host Galaxy Redshifts, Pub. Astr. Soc. Austr. 30 ",
            "year": 2013
        },
        {
            "authors": [
                "D.O. Jones",
                "D.M. Scolnic",
                "A.G. Riess"
            ],
            "title": "Measuring the Properties of Dark Energy with Photometrically Classified Pan-STARRS Supernovae. I. Systematic Uncertainty from Core-Collapse Supernova Contamination",
            "year": 2017
        },
        {
            "authors": [
                "A. M\u00f6ller",
                "M. Smith"
            ],
            "title": "M",
            "venue": "Sullivan et al., The Dark Energy Survey 5-year photometrically identified Type Ia Supernovae, MNRAS 514 ",
            "year": 2022
        },
        {
            "authors": [
                "R. Hlozek",
                "M. Kunz"
            ],
            "title": "B",
            "venue": "Bassett et al., Photometric Supernova Cosmology with BEAMS and SDSS-II, ApJ 752 ",
            "year": 2012
        },
        {
            "authors": [
                "M. Sako",
                "B. Bassett"
            ],
            "title": "B",
            "venue": "Connolly et al., Photometric SN Ia Candidates from the Three-Year SDSS-II SN Survey Data, ApJ 738 ",
            "year": 2011
        },
        {
            "authors": [
                "D.O. Jones",
                "D.M. Scolnic",
                "A.G. Riess"
            ],
            "title": "Measuring the Properties of Dark Energy with Photometrically Classified Pan-STARRS Supernovae",
            "venue": "II. Cosmological parameters,",
            "year": 2018
        },
        {
            "authors": [
                "M. Kunz",
                "B.A. Bassett",
                "R.A. Hlozek"
            ],
            "title": "Bayesian Estimation Applied to Multiple Species: Towards cosmology with a million supernovae",
            "venue": "Phys. Rev. D 75 ",
            "year": 2007
        },
        {
            "authors": [
                "R. Kessler",
                "D. Scolnic"
            ],
            "title": "Correcting Type Ia Supernova Distances for Selection Biases and Contamination in Photometrically Identified Samples",
            "venue": "ApJ 836 ",
            "year": 2017
        },
        {
            "authors": [
                "R. Chen",
                "S. Scolnic"
            ],
            "title": "E",
            "venue": "Rozo et al., Measuring Cosmological Parameters with Type Ia Supernovae in redMaGiC galaxies, ApJ 938",
            "year": 2022
        },
        {
            "authors": [
                "A. Mitra",
                "E. Linder"
            ],
            "title": "Cosmology Requirements on Supernova Photometric Redshift Systematics for Rubin LSST and Roman Space Telescope",
            "venue": "Phys. Rev. D 103 ",
            "year": 2021
        },
        {
            "authors": [
                "E. Linder",
                "A. Mitra"
            ],
            "title": "Photometric Supernovae Redshift Systematics Requirements",
            "venue": "Phys. Rev. D 100 ",
            "year": 2019
        },
        {
            "authors": [
                "M. Dai",
                "S. Kuhlmann",
                "Y. Wang"
            ],
            "title": "E",
            "venue": "Kovacs\u201e Photometric classification and redshift estimation of LSST Supernovae, MNRAS 477 ",
            "year": 2018
        },
        {
            "authors": [
                "M. Betoule",
                "R. Kessler"
            ],
            "title": "J",
            "venue": "Guy et al., Improved cosmological constraints from a joint analysis of the SDSS-II and SNLS supernova samples, A&A 568A ",
            "year": 2014
        },
        {
            "authors": [
                "A. Conley",
                "J. Guy"
            ],
            "title": "M",
            "venue": "Sullivan et al., Supernova Constraints and Systematic Uncertainties from the First Three Years of the Supernova Legacy Survey, ApJS 192 ",
            "year": 2011
        },
        {
            "authors": [
                "M. Sullivan",
                "J. Guy"
            ],
            "title": "A",
            "venue": "Conley et al., SNLS3: Constraints on Dark Energy Combining the Supernova Legacy Survey Three Year Data with Other Probes, ApJ 737 ",
            "year": 2011
        },
        {
            "authors": [
                "O. Ilbert"
            ],
            "title": "S",
            "venue": "Arnouts, H.J. McCracken et al., Accurate photometric redshifts for the CFHT Legacy Survey calibrated using the VIMOS VLT Deep Survey, A&A 457 ",
            "year": 2006
        },
        {
            "authors": [
                "J. Guy",
                "M. Sullivan"
            ],
            "title": "A",
            "venue": "Conley et al., The Supernova Legacy Survey 3-year sample: Type Ia Supernovae photometric distances and cosmological constraints, A&A 523 ",
            "year": 2010
        },
        {
            "authors": [
                "N. Regnault",
                "A. Conley"
            ],
            "title": "J",
            "venue": "Guy et al., Photometric Calibration of the Supernova Legacy Survey Fields, A&A 506 ",
            "year": 2009
        },
        {
            "authors": [
                "M. Betoule",
                "R. Kessler"
            ],
            "title": "J",
            "venue": "Guy et al., Improved Photometric Calibration of the SNLS and the SDSS Supernova Surveys, A&A 568A ",
            "year": 2014
        },
        {
            "authors": [
                "J. Mosher",
                "J. Guy"
            ],
            "title": "R",
            "venue": "Kessler et al., Cosmological parameter uncertainties from SALT-II Type Ia supernova light curve models, ApJ 793 ",
            "year": 2014
        },
        {
            "authors": [
                "G. Bazin",
                "N. Palanque-Delabrouille"
            ],
            "title": "J",
            "venue": "Rich et al., The Core-collapse rate from the Supernova Legacy Survey, A&A 499 ",
            "year": 2009
        }
    ],
    "sections": [
        {
            "text": "1Corresponding author.\nar X\niv :2\n20 7.\n03 78\n9v 2\n[ as\ntr o-\nph .C\nO ]\nContents"
        },
        {
            "heading": "1 Introduction 2",
            "text": ""
        },
        {
            "heading": "2 Data sample 3",
            "text": "2.1 The SNLS 3-year photometric sample 3 2.2 Mixed JLA samples 3"
        },
        {
            "heading": "3 Methodology for Hubble diagram systematic uncertainties 4",
            "text": "3.1 The JLA method 4 3.2 Cosmology fitter 5"
        },
        {
            "heading": "4 SN Ia magnitude bias correction 6",
            "text": "4.1 SN Ia light curve simulation 6 4.2 Host galaxy photometric redshift modelling 7 4.3 SN Ia magnitude bias computation 8"
        },
        {
            "heading": "5 Photometric redshift systematic uncertainties 10",
            "text": "5.1 Modelling SALT2 results 10 5.2 Refitting redshifts with cosmology 12 5.3 Sampling the photometric redshift resolution function 13 5.4 Toy Monte Carlo samples 13 5.5 Fits to simulated HDs 14 5.6 Parameter posteriors 15 5.7 Average results 17 5.8 Discussion 19"
        },
        {
            "heading": "6 Core-collapse contamination 21",
            "text": "6.1 CC simulation and magnitude bias correction 21 6.2 Fit results for contaminated toy Monte Carlo samples 22 6.3 Discussion 25"
        },
        {
            "heading": "7 Results on data 26",
            "text": "7.1 Light curve parameters 26 7.2 Covariance matrices for mixed samples 27 7.3 Coupling covariance matrices and sampling 27 7.4 Fit results 28"
        },
        {
            "heading": "8 Conclusion 31",
            "text": ""
        },
        {
            "heading": "A Systematic uncertainties on the SN Ia selection magnitude bias 32",
            "text": ""
        },
        {
            "heading": "B Additional figure for the redshift refitting method 33",
            "text": ""
        },
        {
            "heading": "C Additional figure and table for results from data 33",
            "text": "\u2013 1 \u2013"
        },
        {
            "heading": "1 Introduction",
            "text": "Distant type Ia supernovae, which gave evidence for the Universe expansion acceleration, are still an important probe to help characterising the equation of state of dark energy [1\u20133]. Standard SN Ia selections rely on photometry for detection, supplemented by spectroscopic follow-up for typing and redshift assignment, which cannot be pursued in the future for the large SN Ia samples expected from projects like the Vera C. Rubin Observatory Legacy Survey of Space and Time, the Euclid space mission or the Nancy Grace Roman Space Telescope. Purely photometrically selected SN Ia samples were first used for rate measurements [4], for cross-checking the Malmquist bias correction of a spectroscopic sample [5], or to prove that spectroscopic observations of their hosts can result in large SN Ia samples with a good coverage of spectroscopic host redshifts, see e.g. [6]. The latter has since then become common practice in current SN Ia projects ([7] for DES or [8] for Pan-STARRS) while photometric classification has become more complex, see e.g. [9].\nPhotometrically selected SN Ia samples have already been used for cosmology studies ([10\u201312] for SDSS and [8, 13] for Pan-STARRS) but these used host galaxy spectroscopic redshifts. For these samples, the systematic uncertainty related to photometric classification is that of contamination, which can be overcome by both reducing the amount of contamination with more advanced classification and selection schemes [14] and estimating its impact more accurately with dedicated algorithms [15, 16]. Recently, the use of host galaxy photometric redshifts for SN Ia photometric samples of very low contamination has been explored [17] and is expected to become of more importance for future large SN Ia surveys [18\u201320] where contamination could also be an issue.\nIn this paper, we tackle the question of using photometric SN Ia samples with host photometric redshifts to derive cosmology constraints and study the impact of both photometric redshift resolution and core-collapse SN contamination on those constraints. For that purpose, we build mixed diagrams based on the 3-year photometric sample of SNLS [5] complemented by the non-SNLS part of the spectroscopic JLA sample [21]. We study the impact of using only host photometric redshifts or a mixture of photometric and spectroscopic redshifts for the SNSL photometric sample. This defines two possible mixed diagrams to be compared. We do this by means of Hubble diagrams derived from SN Ia and core-collapse SN simulations and explore different approaches to propagate redshift resolution to the cosmological likelihood. We then fit the mixed diagrams from data.\nThe outline of the paper is as follows. Section 2 describes the SN Ia photometric selection and the two mixed samples built from data, while section 3 details the fitting methodology. Section 4 introduces the SN Ia light curve simulation and the photometric redshift model used to determine the SN magnitude bias of the photometric selection for pure SN Ia samples. Section 5 describes two methods to propagate redshift resolution effects to cosmological fits and discusses the results on a set of simulated Hubble diagrams reproducing the redshift profile of the actual diagrams, assuming no contamination. Section 6 presents the core-collapse light curve simulation used to derive the expected contamination of the photometric selection and studies how the SN magnitude bias correction and the cosmological constraints evolve when that contamination is introduced in simulated diagrams. Finally, section 7 discusses the results obtained on data and compare them to expectations from the simulation and to the JLA case.\n\u2013 2 \u2013"
        },
        {
            "heading": "2 Data sample",
            "text": "We consider the JLA sample of high quality spectroscopically classified SN Ia data assembled in [21] from the inter-calibrated SDSS-II and SNLS surveys, additional data from the HST and several nearby surveys from [22]. This sample contains 740 events, among which 239 are from the SNLS survey. In this analysis, the latter subset is replaced by the 3-year photometric SNLS sample of [5], hereafter briefly described."
        },
        {
            "heading": "2.1 The SNLS 3-year photometric sample",
            "text": "The SNLS photometric sample [5] contains 485 events, among which 150 are in common with the JLA spectroscopic SNLS subset of 239 events. The first step of the photometric selection retains SN-like events, defined as 3-year light curves with a shape consistent with that expected from an SN event and sufficient temporal sampling in each of the four MegaCam bands. Each selected event was assigned a host photometric redshift from [24] and its four light curves were simultaneously fit with the SALT2 light curve fitter [25] at the assigned redshift.\nIn a second step, the SALT2 fit results were used to select SN Ia compatible events. Restricting to well-sampled light curves, constraints on the SALT2 fit \u03c72, SN intrinsic colour and stretch were applied both to reject events with a poor fit and to reduce the contamination by core-collapse SNe or by SN Ia events with incorrect redshift assignment.\nIn the above procedure, light curves were calibrated using the SNLS tertiary standards of [26]. At the end of the selection procedure, the photometric redshift central resolution was \u03c3\u2206z/(1+z) \u223c 3% and the 5 (resp. 3) \u03c3 outlier rates were 1.4% (resp. 5.5%)."
        },
        {
            "heading": "2.2 Mixed JLA samples",
            "text": "Prior to combining the above sample with non-SNLS events of the JLA sample, light curves of all 485 selected events were re-calibrated using the joint calibration of the SNLS and SDSS-II surveys [27] and re-fit with the same SALT2 version as in [21] at their assigned host photometric redshift. Combining the SNLS sample treated that way with the non-SNLS JLA events results in a first mixed JLA sample, referred as to the JLA-P sample in the following.\nPart of the SNLS photometric events can also be assigned a spectroscopic redshift, either because they benefitted from a spectroscopic follow-up during the lifetime of SNLS, or because their host was observed in dedicated observations with the AAOmega spectrograph at the AAT [6], or because they could be matched to an external catalogue of spectroscopic redshifts. This is the case for 357 of the 485 SNLS photometric events. Replacing their photometric redshift by the spectroscopic one, and re-fitting those events with SALT2 at their spectroscopic redshift defines a second mixed JLA sample, hereafter called the JLA-B sample.\nIn both samples, there are events at redshift above 1.05, a region where SALT2 results become unreliable for SNLS events due to vanishing signal in the rM -band. We thus restrict SNLS SNe to have a redshift below that value in the two mixed samples, whose final composition is described in table 1. Note that compared to the JLA-P sample, the number of photometric redshifts in the JLA-B sample is divided by a factor of 4 and 90% of them are present at high redshift, z > 0.5.\n\u2013 3 \u2013"
        },
        {
            "heading": "3 Methodology for Hubble diagram systematic uncertainties",
            "text": "This paper relies on the method of [21] to propagate known uncertainties to SN Ia Hubble diagram fits. This method and the cosmological fitter we use are briefly described here. Changes for the mixed JLA samples are detailed in the next three sections."
        },
        {
            "heading": "3.1 The JLA method",
            "text": "In the JLA method, the fit minimises the following function:\n\u03c72 = (~\u00b5\u2212 ~\u00b5model)\u2020C\u22121cov(~\u00b5\u2212 ~\u00b5model) (3.1)\nwith ~\u00b5 the vector of distance estimates of SNe in the Hubble diagram, ~\u00b5model the vector of their distance moduli predicted in the cosmology under test, and C the covariance matrix of ~\u00b5. For an SN with redshift z, the components of the ~\u00b5 vector are:\n\u00b5 = m\u2217B \u2212 (MB \u2212 \u03b1X1 + \u03b2C) +\u2206m\u2217B (3.2)\nwhere m\u2217B, X1 and C are the SN parameters (apparent B-band rest-frame magnitude, stretch and colour) and \u2206m\u2217B is the SN magnitude bias correction due to selection effects. MB is the SN Ia absolute magnitude and \u03b1, \u03b2 are the nuisance parameters that describe the relation between the SN Ia peak magnitude and stretch and colour, respectively. The three SN parameters are provided by fitting the SN light curves by SALT2 at the SN redshift, but a peculiar velocity correction - important only at low redshift - is added to the SALT2 restframe magnitude to define m\u2217B. As the absolute magnitude MB was found to depend on host galaxy properties [23], two possible values are usually considered for MB, depending on the host galaxy stellar mass [21, 22]. Since our aim is to study systematic uncertainties in Hubble diagrams with host photometric redshifts and not to derive the most accurate cosmological results, we consider only one value for MB throughout this paper.\nAs for the vector of SN distance moduli, the components are:\n\u00b5model = 5log10(dL(z;\u2126m)/10pc) (3.3)\nwhere dL is the luminosity distance at the SN redshift in the tested cosmology. The covariance matrix Ccov is expressed as:\nCcov = AC\u03b7A \u2020 + diag ( 5\u03c3z zlog10 )2 + diag ( \u03c32lens ) + diag ( \u03c32int ) (3.4)\nThe last three terms, purely diagonal, account for redshift uncertainties due to peculiar velocities, magnitude uncertainties due to gravitational lensing and magnitude intrinsic dispersion\n\u2013 4 \u2013\nnot described by the other terms. Note that the peculiar velocity systematic term matters only at low redshift, in which case redshift uncertainties can be approximated by magnitude uncertainties. Values of \u03c3z, \u03c3lens and \u03c3int for the JLA sample are given in [21]. C\u03b7 is the covariance matrix for the SN light curve parameters {m\u2217B, X1, C} that includes statistical and systematic uncertainties:\nC\u03b7 = Cstat + (Ccal + CLCmod + Cbias + Cdust + Cpecvel + CnonIa) (3.5)\nIn the above, Cstat propagates the light curve measurement uncertainties and the uncertainties due to the size of the SALT2 training sample, while the other matrices deal with systematic uncertainties. Those are related to light curve calibration, Ccal, light curve model uncertainty, CLCmod, SN magnitude bias correction estimate, Cbias, dust correction, Cdust, peculiar velocity correction, Cpecvel and contamination of the Hubble diagram by non Ia SNe, CnonIa. The A matrix in (3.4) obeys the following definition:\n~\u00b5 = A~\u03b7 \u2212 ~u(MB) (3.6)\nwith ~\u03b7 the vector of SN light curve parameters {...m\u2217B, X1, C ...}\u2020 and ~u = {... 1, 0, 0 ...}\u2020. When only light curve measurement uncertainties are included, Cstat generates the following purely diagonal term in Ccov:\nCLC = diag ( V ar(m\u2217B) + V ar(\u2206m \u2217 B) + \u03b1 2V ar(X1) + \u03b2 2V ar(C)\n+ 2\u03b1CovmX \u2212 2\u03b2CovmC \u2212 2\u03b1\u03b2CovXC ) (3.7)\nwhere variances of m\u2217B, X1, C,\u2206m \u2217 B and covariances between m \u2217 B, X1, C contribute. Adding to this the three diagonal terms of (3.4) generates what is referred to as \u2019diagonal\u2019 case in the following."
        },
        {
            "heading": "3.2 Cosmology fitter",
            "text": "In this paper, the fixed-grid fitter of [22] is used with the flat \u039bCDM model as a benchmark. Following (3.1), the fitter computes \u03c72 values over a grid in the {\u2126m, \u03b1, \u03b2} parameter space and convert them into likelihood probabilities via:\nL \u221d exp ( \u22121 2 \u03c72 + NSN 2 ) (3.8)\nwith NSN the total number of SNe Ia in the Hubble diagram. The proportionality is obtained by normalisation over the grid. This neglects the fact that the correct normalisation depends on \u03b1, \u03b2, in order to spare computation time, at the cost of producing biased uncertainties for these two nuisance parameters. The fitter reports the median value of each parameter, all other parameters being marginalised over (with flat priors). Confidence intervals for each parameter are derived from the cumulative probability distribution of that parameter, all other parameters being marginalised over. The interval limits are determined such that 68.3% of the probability is enclosed. As MB is a simple additive parameter in the apparent magnitude predictions, it does not contribute to errors at each point of the grid (unlike \u03b1 and \u03b2) and can be marginalised over analytically without generating a biased estimate. The fitter uses the c/H0 reduced luminosity distances defined as:\nDL = H0 c dL (3.9)\n\u2013 5 \u2013\ninstead of dL in (3.3). Consequently, the SN Ia absolute magnitude which is marginalised over in the fitter is:\nM \u2032B =MB + 5log10 c\nH0 + 25 (3.10)\nwith c expressed in km/s. This equation can be used to convert fitted values of M \u2032B reported in this paper (see section 7.4) into the usual definition of the SN Ia absolute magnitude MB. Throughout this paper, a value of 70km/s/Mpc is assumed for H0 (e.g. when quoting MB values from a cosmological fit or when computing luminosity distances). Using the published JLA light-curves, we checked that we could reproduce the results of [21] with our fitter, whether covariance matrices are the published ones or matrices that we reproduced following [21]. The next three sections describe how we treat the SN magnitude bias, photometric redshifts and core-collapse contamination for the mixed JLA samples."
        },
        {
            "heading": "4 SN Ia magnitude bias correction",
            "text": "SN Ia selection in a magnitude-limited survey generates incompleteness of the sample at high redshift which results in a bias of the reconstructed distances. For the SNLS component of the mixed JLA samples, this bias can be estimated from simulated SN light curves submitted to the same selection cuts as real SNLS light curves. In this section, we study the case of negligible contamination and consider SN Ia simulation only. The latter is described in the next section for the light curve part and in section 4.2 for the host photometric redshift modelling. The SN Ia magnitude bias is presented in section 4.3."
        },
        {
            "heading": "4.1 SN Ia light curve simulation",
            "text": "The light curve simulation is that of [5] with minor modifications. SN Ia light curves were simulated from the SALT2 model of [25] assuming a flat \u039bCDM cosmology and a redshift volumetric distribution in the range 0.1 to 1.2. X1 and C parameter values were generated according to model distributions fitted to the set of spectroscopically identified SNe Ia present in our photometric sample, restricted to zspe < 0.7 to avoid spectroscopic selection biases. For each generated event, a magnitude m\u2217B was computed as a function of X1, C and the luminosity distance at the generated redshift in the assumed cosmology, dL(z,\u2126M ):\nm\u2217B =MB \u2212 \u03b1X1 + \u03b2C + 5log10(dL(z,\u2126M )/10pc) (4.1)\nA Gaussian spread \u03c3int was applied to m\u2217B in order to allow for SN Ia intrinsic dispersion. Numerical values of \u2126M , MB, \u03b1, \u03b2 and \u03c3int were updated w.r.t. those in [5]. The new values, from the flat \u039bCDM best fit of [21], are reported in table 2. A value of 70km/s/Mpc was assumed for H0 when computing luminosity distances. The magnitude of each SN after dispersion was converted into a global normalisation factor X0 according to the relationship between m\u2217B and X0 as measured from the spectroscopically identified SNe Ia in the photometric sample, with their light curves fitted with the same SALT2 version as in the simulation. We found:\n\u2212 2.5log10(X0) = m\u2217B \u2212 10.63935 (4.2)\nContrary to what was done in [5], no dependence in colour nor width was included in the above relationship as its effect (a few mmag at high colour values) was found to have a negligible impact on cosmological fits to our simulated samples given the intrinsic dispersion of 0.08.\n\u2013 6 \u2013\nFor each event, the generated values of X0, X1, C and redshift were then passed to SALT2 to produce light curves in the four MegaCam passbands. All remaining steps of the light curve simulation, in particular the inclusion of detection and instrumental effects, is identical to what was done in [5], to which we refer the reader for more details and for a comparison between data and simulation on variables used in the photometric selection of section 2.1. A total of 100,000 light curves were generated with the parameters values in the first line of table 2. Lensing and peculiar velocity effects were not included in the simulation."
        },
        {
            "heading": "4.2 Host galaxy photometric redshift modelling",
            "text": "The model used to assign photometric redshifts to simulated events was changed with respect to that in [5] which was calibrated on a test-sample of 346 SN-like events having both host photometric redshifts and SN spectroscopic redshifts from the SNLS follow-up spectroscopy. Since that publication, the spectroscopic redshift coverage of SN-like events was enlarged, thanks to dedicated spectroscopic measurements of their hosts in several observation campaigns undertaken from 2012 to 2016 at the AAT [6] and to compilation of external catalogues\n\u2013 7 \u2013\nof spectroscopic redshifts from surveys encompassing SNLS fields. As a result, the test-sample with redshifts of both origins now contains 787 events. From that sample, an updated host photometric model was derived, that describes the central resolution and the outlier distribution with two Gaussian distributions in \u2206z/(1+ z), since such a model provides an excellent fit to the \u2206z/(1+ z) distribution of the test-sample, as can be seen in figure 1. The amplitudes of the two distributions are assumed to vary linearly with redshift in order to reproduce the observed increase in the number of outliers as redshift increases. Numerical values of the model parameters, derived from the test-sample, are summarised in table 3. The 3\u03c3 and 5\u03c3 outlier rates as measured in four redshift bins of the test-sample are found to be correctly reproduced by the simulation within uncertainties. Note that the mean bias in redshift, measured at 0.4 10\u22123, is neglected in the model. In the following, we consider the global normalisation of the outlier rate as the main source of systematic uncertainty in this modelling and account for it by scaling the a2 and b2 parameters w.r.t. their base values in table 3. The scaling factor is denoted Wout in the following."
        },
        {
            "heading": "4.3 SN Ia magnitude bias computation",
            "text": "The SN Ia magnitude bias of the SNLS photometric sample was estimated from simulated light curves subject exactly to the same selection algorithm as real data. We ran the SN Ia selection algorithm of section 2.1 on the reconstructed light curves (i.e. including instrumental noise) of our main SN Ia simulation sample, which leaves a total of about 41,000 simulated events. Note that these selections make use of the SALT2 parameters derived from fits to the above light curves at their assigned host photometric redshift, as in real data for the two mixed samples. The selection bias \u2206\u00b5(z) is computed in redshift bins, by taking, in each bin, the difference \u03b4\u00b5(z) between the event fitted distance modulus (3.2) and the generated event distance modulus (3.3):\n\u03b4\u00b5(z) = m\u2217B \u2212 (MB \u2212 \u03b1X1 + \u03b2C)\u2212 5log10(dL(z,\u2126M )/10pc) (4.3)\nand averaging it over all selected events in the bin. In the average, each difference is weighted by its statistical error, which encompasses light curve uncertainties, statistical uncertainties on the values of \u03b1, \u03b2 and the SN Ia intrinsic dispersion used in the simulation. These statistical uncertainties are also propagated in the averaging procedure to define the statistical uncertainty on \u2206\u00b5(z). Note that the selection bias is the opposite to the magnitude correction (3.2) to be used in the fit, \u2206\u00b5(z) \u2261 \u2212\u2206m\u2217B(z). We first estimate what will be called hereafter the intrinsic bias of the selections. To do so, m\u2217B, X1 and C in eq.(4.3) come from fitting the event generated light curves (i.e. without instrumental noise) with SALT2 at the event true redshift, which we consider as the event\n\u2013 8 \u2013\nspectroscopic redshift and also used in the distance luminosity computation. \u2126M andMB are set to their input values in the simulation. For eq. (4.3) to describe the effect of the selections on the apparent magnitude m\u2217B once corrected for variability through the \u03b1 and \u03b2 terms, the values to be used for \u03b1 and \u03b2 must reflect the variability of the initial, uncut SN Ia sample. As eq. (4.3) is intended to correct SN Ia apparent magnitudes to be used in cosmological fits, it must also be coherent with the cosmological fitting procedure applied to real data. For the above reasons, the \u03b1 and \u03b2 values in eq. (4.3) result from a flat \u039bCDM fit to a large sample of simulated light curves without selections, fitting again generated light curves with SALT2 at their true, i.e. spectroscopic, redshifts. We used 25,000 events from the main simulation, kept \u2126M fixed at the simulation input value (0.295) and propagated light curve parameter errors, as in real data. The \u03c3int value in this fit was chosen so as to obtain a \u03c72 value close to the total number of SNe in the sample, as is common in SN Ia cosmological analyses. That fit gave:\n\u03b1 = 0.14098\u00b1 0.00045, \u03b2 = 3.2452+0.0067\u22120.0072,MB = \u221219.084 (4.4)\nWe note that the simulation input value (see table 2) is recovered for \u03b1 and MB but not\n\u2013 9 \u2013\nfor \u03b2, an effect which is due to light curve parameter error propagation in the cosmological fit. Indeed, disabling error propagation in the fit would give \u03b1 = 0.14097 \u00b1 0.00044 and \u03b2 = 3.0964+0.0056\u22120.0079 in good agreement with simulation input values. The bias computed with the values in (4.4) accounts for both the effect of the photometric selections and the fitting procedure, as advocated in [28]. The top plot of figure 2 presents its evolution as a function of the SN Ia spectroscopic redshift (green curve) and illustrates the effect of different choices of \u03b1 and \u03b2 values in the bias computation. This plot shows that throughout the entire redshift interval used in the cosmological analysis (up to 1.05), our photometric selection generates a negligible bias, provided light curve error propagation in the cosmological fitting procedure is accounted for in the nuisance parameter values chosen to compute the bias. This is what we will do in the remaining of this paper. In actual data, only host galaxy photometric redshifts are available for all photometrically selected events. A magnitude bias including also that effect can be computed using assigned host redshifts in eq. (4.3) for both luminosity distances and SALT2 parameter derivation. The latter must then use reconstructed light curves, that is, including instrumental noise, to allow SALT2 to fit light curves at redshifts far from the true ones. Nuisance parameters values remain the same as in the intrinsic bias computation, see eq. (4.4). The result, referred to as full SN Ia magnitude bias in the following, is presented in figure 2 (bottom plot) as a function of the host photometric redshift and compared to the intrinsic bias as a function of the SN Ia spectroscopic redshift. Once redshift migration due to resolution and outliers is accounted for, the magnitude bias becomes much larger, especially at low redshift due to strong variations of luminosity distances. As reconstructed light curves are used, the bias estimate becomes also noisier. To check the trend with redshift, the full bias was computed separately in the four SNLS fields. The redshift evolution is similar in the four fields up to z = 0.85, indicating that redshift uncertainty is the dominant effect there, while light curve noise takes over at higher redshift. The noticeable bias increase between redshifts 0.65 and 0.85 is likely related to the threshold at z = 0.68, above which the gM band is no longer used in SALT2. We discuss which magnitude bias correction to use in fits to the JLA-P and JLA-B diagrams in section 5.5. Systematic uncertainties in the bias estimates are described in Appendix A."
        },
        {
            "heading": "5 Photometric redshift systematic uncertainties",
            "text": "Accounting for photometric redshift uncertainty in Hubble diagram (HD) fits is difficult since redshift uncertainties impact both the model (luminosity distance) and the data (corrected apparent magnitude) to be compared. Two possible methods are proposed to properly propagate redshift uncertainties to cosmological fits. The first one refits individual photometric redshifts along with cosmology, while the second one samples the redshift resolution function to statistically propagate photometric redshift uncertainties to the cosmological fit \u03c72. In the following, the two methods are first described and then tested with a batch of simulated HDs representative of the sample size and redshift profile of the mixed samples from data."
        },
        {
            "heading": "5.1 Modelling SALT2 results",
            "text": "Both methods require to know how the SALT2 parameters of the photometrically selected events would evolve when changing the redshift used in SALT2 fitting. An analytical modelling of those variations was adopted for this purpose. To do so, the light curves of all photometric events to be treated by either method are fit with different redshift hypotheses.\n\u2013 10 \u2013\nIn addition to the initial fit based on the assigned photometric redshift, zpho, we run 20 other fits at redshifts defined in the following way:\nztest = zpho + n\u00d7 0.03(1 + zpho) with n = \u00b10.5,\u00b11,\u00b11.5, . . . ,\u00b15 (5.1)\nThese fits encompass redshift variations up to 5 times the central redshift resolution observed in data (see section 4.2). The shifts of m\u2217B, X1, C, their errors, covariances, and the shifts of the global SALT2 \u03c72 with respect to the initial fit results are then modelled with a degree 6 polynomial as a function of the change in redshift. In order to ensure reliable polynomial fits, points showing strong deviations w.r.t. the bulk of the results were automatically removed from the fit. This eliminates either single outliers or groups of points close to the minimal redshift accessible to SNLS, a region where SALT2 results become unreliable. Results of the polynomial fits are illustrated in figure 3 for one simulated SN Ia. Such a polynomial provides a very good fit to most variations, the most difficult case being shifts of X1, its error and its covariances with the other two parameters. On the other hand, colour is observed to vary essentially linearly with redshift changes. Variations of the global SALT2 \u03c72, not represented in figure 3, are also smooth.\nNote that we use the photometric redshift model of section 4.2 to describe redshift\n\u2013 11 \u2013\nuncertainties rather than the individual uncertainties provided in the catalogue (which are only crude estimates) but the method could be easily adapted to robust individual redshift uncertainties."
        },
        {
            "heading": "5.2 Refitting redshifts with cosmology",
            "text": "Redshift refitting was implemented in the cosmological fitter of section 3.2. At each (\u2126M , \u03b1,\u03b2) point of the fitter grid, all photometric redshifts are varied, and these variations are propagated to distance luminosities, magnitude bias correction and, by use of the above shift model, to light curve parameters, their errors, covariances and the SALT2 \u03c72. The cosmological fit \u03c72 at the tested point is updated accordingly. Redshift variation is pursued until minimisation of the \u03c72 is achieved and the redshifts at that minimum value are used to define the likelihood value in eq. (3.8) and the analytically marginalized value of MB. In addition, redshifts obtained after minimisation are marginalised over the grid to define new redshifts of the photometric SNe. As redshift refitting aims at moving photometric SNe closer to their true redshift in the Hubble diagram, the magnitude bias correction should in principle be the correction to the intrinsic magnitude bias of sec 4.\nMore precisely, the \u03c72 computed at each iteration of the minimisation is:\n\u03c72(~z + ~\u03b4z) = [ ~\u00b5(~z + ~\u03b4z)\u2212 ~\u00b5model(~z + ~\u03b4z) ]\u2020 C\u22121cov(~z + ~\u03b4z) [ ~\u00b5(~z + ~\u03b4z)\u2212 ~\u00b5model(~z + ~\u03b4z) ] +Tr [ diag ( \u03b4z\n0.03(1 + z)\n)2 ] +Tr [ diag(\u03c72Salt(~z + ~\u03b4z)\u2212 \u03c72Salt(~z)) ] (5.2)\nwhere ~\u03b4z is the vector of SN redshift changes, which are non zero only for photometric redshifts, where diag stands for a diagonal matrix and Tr for its trace. In the above, components of ~\u00b5 and ~\u00b5model are still defined by equations (3.2) and (3.3), with m\u2217B, \u2206m \u2217 B, X1, C and dL computed at a redshift z + \u03b4z instead of the initial photometric redshift z. In principle, the covariance matrix Ccov, still given by (3.4) should have all its SN redshift dependent terms evaluated at redshifts ~z+ ~\u03b4z, but this is impossible to put in practice. As the purpose of this paper is to test whether fitting photometric redshift offsets along with cosmology is feasible, we restrict to the purely diagonal case, for which Ccov = CLC whose variation with redshift changes only requires to evaluate variances and covariances of m\u2217B, X1, C and variances of \u2206m\u2217B at ~z + ~\u03b4z in (3.7). Eq. (5.2) contains two extra terms compared to (3.1). The first one is a Gaussian prior to limit redshift excursion in agreement with the (central) resolution in the model of section 4.2. The second term is the SALT2 \u03c72 difference between fits run at ~z + ~\u03b4z and at the initial redshift. This term intends to disfavour redshift variations that would improve the cosmological fit at the cost of a degradation of the light curve fit. As shown in figure 11 in appendix B, globally one third of the events have a better SALT2 \u03c72 when light curves are fit at the event photometric redshift instead of the true one, but this fraction drops for HD outliers. The SALT2 \u03c72 term in eq. (5.2) should thus help correcting redshifts more efficiently. Finally, to avoid testing redshift variations outside the applicability range of our SALT2 shift model, redshift variations are required to remain below 0.15(1 + z), that is below 5\u03c3 and to give new redshifts between 0.1 (the minimal redshift in the SNLS sample) and 1.05. Given the large number of photometric redshifs to fit (see Nzpho in table 1), we used a multidimensional minimiser with derivatives to perform the minimisation of \u03c72(~z + ~\u03b4z) over redshift changes ~\u03b4z. We chose the vector Broyden-Fletcher-Goldfarb-Shanno (BFGS) algorithm in its second version implemented in the GSL library. The minimiser parameters\n\u2013 12 \u2013\nwere set to 0.03 for the initial trial step on ~\u03b4z, 1.5\u00d7Nzpho for the iteration stopping criterion on the \u03c72 gradient norm, 5 for the maximum number of iterations and 0.1 (the default value) for the so-called tolerance on the line minimisation accuracy, which defines the extent of the parameter space domain explored by the minimisation."
        },
        {
            "heading": "5.3 Sampling the photometric redshift resolution function",
            "text": "The second method propagates redshift uncertainties to the cosmology fit \u03c72 without attempting to refit individual photometric redshifts. At each (\u2126M , \u03b1,\u03b2) point of the fitter grid, all photometric redshifts are varied according to the central Gaussian resolution in the model of section 4.2 and these variations are propagated to the \u03c72 as in the previous method. This is repeated a number of times and the \u03c72 values are averaged over all repetitions to define the \u03c72 at the current grid point in eq. (3.8). A similar procedure is used to propagate redshift uncertainties to the marginalised value of MB. To ensure that \u03c72 and fitted parameter values are reproducible from one scan of the same grid point to the other, the number of repetitions, N , must be large. Tests on simulated events showed that N = 1000 ensures stable enough results (absolute \u03c72 variations much below 1 from one scan to the other).\nThe \u03c72 computed at each point of the grid is thus:\n\u03c72 = 1\nN\n\u2211[ ~\u00b5(~z + ~\u03b4z)\u2212 ~\u00b5model(~z + ~\u03b4z) ]\u2020 C\u22121cov(~z + ~\u03b4z) [ ~\u00b5(~z + ~\u03b4z)\u2212 ~\u00b5model(~z + ~\u03b4z) ] (5.3)\nwhere the sum extends over redshift variations applied to photometric redshifts, which are denoted ~\u03b4z. Requirements imposed on \u03b4z values are the same as in the previous method. The last two terms in (5.2) are not added, since the prior on the SALT2 \u03c72 difference term is not justified here, while the Gaussian prior in \u03b4z is not required since redshift variations are directly drawn from a Gaussian distribution with \u03c3 = 0.03(1 + z). Contrary to the first method which aims at correcting HD outliers through redshift refitting, there is no natural protection in the sampling method against outliers generated by redshift variations. For that purpose, in case a redshift variation produces an outlier (i.e. an individual SN \u03c72 above 3), up to 10 new variations in redshift are drawn for that event and, if none of them leads to a \u03c72 below 3, the null variation is kept."
        },
        {
            "heading": "5.4 Toy Monte Carlo samples",
            "text": "The two methods were tested with a batch of simulated HDs representative of the sample size and redshift profile of the actual mixed samples, except for the HST subsample that contains very few events and was ignored. All simulated HDs have a common spectroscopic subsample at low redshift that was built with our SN Ia light curve simulation run in appropriate low redshift intervals1. We used the parameter values of table 2 (first row), except for \u03c3int which was set to values suitable for the low redshift and SDSS components of the JLA sample, as reported in [21]. Events from these specific simulations passing our photometric selections (section 2.1) were then used to build two sets of events representative of the low redshift and SDSS components. For these events, their true redshifts are considered as their spectroscopic redshifts and used to compute eq. (3.1). To obtain the high redshift part of the simulated HDs, photometrically selected events of our main SN Ia simulation were used to generate 50 independent sets of events representative of the JLA-P SNLS subsample. The reconstructed light curves of these events were fit\n1As the role of the low redshift spectroscopic events is only to provide anchorage of Hubble diagrams by tightly constraining M \u2032B , our low redshift simulations suffice for that purpose, there is no need to simulate the true low redshift and SDSS selection functions.\n\u2013 13 \u2013\nwith SALT2 at their photometric redshifts to define parameters entering in eq. (3.1). Using instead SALT2 fits at the true redshifts for part of the events, each of the 50 above sets was converted into a JLA-B SNLS subsample. These replacements were performed so as to reproduce the total sample size and the redshift profiles of the populations with photometric and spectroscopic redshifts in the real JLA-B SNLS subsample (see table 1). Possible redshift migrations due to the upper cut at 1.05 in redshift were accounted for. Extending these replacements to all events defines a third type of SNLS subsample, hereafter referred as to JLA-S, where all photometric events have SALT2 parameters evaluated at their true redshifts. These diagrams have no counterpart in real data because of our incomplete spectroscopic redshift coverage but describe what could be optimal photometrically selected samples with spectroscopic redshifts for all events. Finally, the simulated spectroscopic sample at low redshift was combined with each of the simulated SNLS subsamples to generate 50 independent HDs in each of the JLA-P, JLA-B and JLA-S categories."
        },
        {
            "heading": "5.5 Fits to simulated HDs",
            "text": "We performed flat \u039bCDM fits to each simulated HD, using grids of 80x80x80 points in \u2126M , \u03b1, \u03b2 with steps of 0.0025, 0.001, 0.01, respectively. We remind thatMB is analytically marginalised over at each point of the grid and so does not add an extra dimension to the grid. We tested both methods of redshift uncertainty propagation and ran also fits with no redshift error propagation, hereafter named standard fits, as a comparison. In all cases, we checked the impact of 3\u03c3 clipping aimed at eliminating outliers and varied the SN Ia magnitude bias correction applied to SNLS SNe. For the latter, we either use the correction to the intrinsic SN Ia magnitude bias of section 4.3 for all SNLS events in the diagrams, or use the correction to the full SN Ia magnitude bias of section 4.3 for events with SALT2 parameters evaluated at their photometric redshift and the correction to the intrinsic magnitude bias for all other SNLS events, if any. These two types of corrections will be referred to as \u2019intrinsic bias correction\u2019 and \u2019full bias correction\u2019 in the following. The first option is appropriate for the JLA-S diagrams but was also tried for the two other diagram types, while the second option is appropriate for JLA-P diagrams and approximate for JLA-B ones, a point which will be further discussed in section 6.3. In all cases, the intrinsic bias correction was applied to low redshift events. Systematic uncertainties other than those related to photometric redshift uncertainties were not included in the fits and the only statistical uncertainties accounted for were those from the light curve parameters, the SN Ia intrinsic dispersion \u03c3int and the statistical uncertainty on the bias correction (which has a negligible impact). While running on the 512,000 grid points with standard fits takes less than a minute, the sampling method takes on average 8 hours on JLA-B HDs, four times more on JLA-P HDs and is twice as long as redshift refitting. In order to test for biases in the fit results, we resort again to the sample of 25,000 simulated SN Ia events used in section 4. This sample was submitted to our photometric selections, their generated light curves were fit with SALT2 at their true redshifts and their SALT2 apparent magnitudes were corrected for the intrinsic magnitude bias. A flat \u039bCDM fit to this sample gives \u2126M = 0.294 \u00b1 0.003, MB = \u221219.085, \u03b1 = 0.1408+0.0007\u22120.0009 and \u03b2 = 3.229 \u00b1 0.009. The fit residual dispersion is 0.08. The above values define what can be expected from a photometrically selected SN Ia sample 10 times larger than observed, with noiseless light curves and spectroscopic redshifts. As such, it can be considered as a reference to compare the toy Monte Carlo fit results with. The \u03c3int value in this fit was again chosen so\n\u2013 14 \u2013\nas to obtain a \u03c72 value approximately equal to the total number of SNe in the sample. As this would be too cumbersome to do for all toy Monte Carlo fits, the latter were performed with \u03c3int set to the value used in the simulation for each the three surveys entering the diagrams (low z, SDSS, SNLS). We checked that this has a marginal effect on the fitted parameters except for \u03b2, a point we discuss again in section 5.7."
        },
        {
            "heading": "5.6 Parameter posteriors",
            "text": "Prior to defining average results from the fits to simulated diagrams, which will be the subject of the next section, it is important to check that posterior distributions are close to Gaussian, otherwise average results may be unreliable. This is addressed in the following. Posterior distributions for the cosmology and nuisance parameters were checked for all fits to simulated HDs. We noticed that important distortions can affect parameter posteriors in the redshift refitting method (see top panel of figure 4), leading to incorrect marginalised fit results and underestimated error intervals. Such distortions are observed for 40% (36%) of the JLA-P (JLA-B) HDs in the case of \u2126M and are stronger in the JLA-P case. In the sampling method, distortions can also be observed, but they are always moderate and do not degrade the cumulative probability function (and hence the fit results) significantly, unlike what happens with the refitting method. We hereafter review possible causes for the observed distortions and explain how we overcame them. Distortions in the \u2126M , \u03b1 and \u03b2 posteriors arise from discontinuities in the L map obtained on the cosmological grid, meaning that varying redshifts of the photometric SNe in each point of the grid, can produce strong variations in L between two close points of the grid. One reason may be strong shifts of SALT2 parameters when the redshift variation crosses a threshold in the SALT2 procedure, such as that around redshift 0.68 due to the loss of the gM band. However, HDs with distorted posteriors do not exhibit an abnormally high number of photometric SNe with redshifts changes in the vicinity of that threshold, so this effect is likely to be sub-dominant. Other sub-dominant effects are unreliable polynomial fits of SALT2 parameter shifts, insufficient density of the cosmological grid and the SALT2 \u03c72 difference term in eq. (5.2). All three effects were tested in the sampling method (and the first two in the refitting one). Relaxing cuts against unreliable polynomial fits, degrading the grid density in \u03b1, \u03b2 by a factor of 2 or including the SALT2 \u03c72 difference term were each found to amplify the distortions, the largest impact being that of density. But none of these effects, even density, can be the main origin of the distortions. The most plausible scenario to explain the large discontinuities in the L map from the refitting method is the presence of local minima in the \u03c72(~z + ~\u03b4z) map in part of the cosmology grid points. From one grid point to the other, the minimiser can then end up on different minima, generating quite different \u03c72 values, even for close points on the grid. To check this hypothesis, the refitting method was run on a few HDs for different values of the tolerance on the line minimisation accuracy, keeping all other conditions unchanged. With looser tolerances, the ~\u03b4z parameter space enlarges and the minimisation is observed to lead to quite different best fits on the grid, a result favouring the hypothesis of the existence of multiple local minima in the \u03c72(~z+ ~\u03b4z)map. This hypothesis also explains why discontinuities are larger and more frequent in JLA-P HDs since those have a large number of photometric redshifts to refit, with many of them below z \u223c 0.7, a region where distance luminosities are prompt to strong variations with redshift. In order to obtain reliable results for a maximum of HDs, the refitting method was run for each diagram with three tolerance values, 0.1, 0.3 and 0.7. For each diagram, we retain\n\u2013 15 \u2013\nthe results obtained for the tolerance that maximises the number of parameters with closest to Gaussian posteriors, and in the case of posteriors of equivalent quality, we keep the results from the tolerance giving the highest best fit L value (see bottom plots of figure 4). HDs giving distorted parameter posteriors for the three tolerance values are discarded from the\n\u2013 16 \u2013\naveraging procedure for the corresponding parameter. This removes 6%, 8% and 22% of the JLA-P HDs for \u2126M , \u03b1 and \u03b2, respectively, while only 2% of the JLA-B HDs are removed for \u2126M and none for \u03b1 and \u03b2. As discontinuities in the L map for the sampling method are always minor and with negligible impact on the cumulative distributions, all HDs are considered for that method."
        },
        {
            "heading": "5.7 Average results",
            "text": "Each fit to a simulated HD retained by the above procedure gives marginalised median values of \u2126M , \u03b1, \u03b2,MB and their errors (except for MB), all derived from the parameter posterior cumulative distribution function (see section 3.2 and figure 4). Depending on the parameter, distributions of their marginalised values and error intervals over all retained fits can be symmetric or skewed. We thus rely on the median values of these distributions as a reliable indicator of averaged results and characterise the dispersion of the results by the 15.9-84.1 percentile range of the distributions, which provides a good indicator of the error intervals expected from a single HD fit. Although median and percentile ranges are robust against outliers, values outside of the 15.9-84.1 percentile range expanded on either side by 1.5 times that range (equivalent to a 3.5\u03c3 cut for a Gaussian distribution) were rejected from the average, and the 15.9-84.1 percentile range recomputed.\nAverage results, as defined above, obtained on the simulated JLA-B and JLA-P HDs with the refitting and sampling methods are reported in tables 4 and 5 and compared to\n\u2013 17 \u2013\nstandard fit results on the same samples and on the JLA-S ones. For sake of simplicity, the clipping in sampling fits is that given by the standard fits with the same magnitude bias correction. In the following, we first describe the results of the various fitting methods on the different types of diagrams and then summarise our findings at the end of the section.\nFor the JLA-S samples, we note important biases in MB, \u03b1 and \u03b2 with respect to the reference sample. For \u03b2, part of the bias comes from the \u03c3int settings in the simulated diagram fits (see section 5.5) which do not lead to reduced \u03c72 values around 1 for the JLA-S diagrams as for the reference sample (the same is true for JLA-B diagrams, but not for JLA-P ones). This explains 40% of the bias in beta for the JLA-S samples, the remaining part being due to instrumental noise included in the simulated diagrams but not in the reference sample. The latter effect completely explains the bias in \u03b1 for the JLA-S diagrams, and part of the bias in MB, the remaining effect being the different anchorage of the simulated diagrams at low redshift w.r.t. that of the reference sample.\nIn table 4, we first observe that without clipping the number of 3\u03c3 HD outliers and the HD dispersion are high for JLA-P HDs, as expected for HDs with only photometric redshifts at z>0.2, while they are similar for JLA-B and JLA-S samples. The refitting and sampling methods reduce the number of outliers but not as efficiently as clipping, which is also the most efficient way to reduce the HD dispersion. Comparing the refitting and sampling methods with intrinsic bias correction and no clipping - a priori the most appropriate conditions for these methods - the refitting method results in a bias in \u2126M similar to that observed with standard fits, for both JLA-B and JLA-P samples, while the sampling method corrects that bias efficiently. As the refitting method fails at producing unbiased cosmological results on top of having non-Gaussian posteriors, we did not study this method any further.\nAdding clipping and using the full bias correction reduces the \u2126M bias to a negligible level in all cases, except in sampling fits to the JLA-P HDs, for which clipping has essentially no effect and the full bias correction slightly increases the \u2126M bias. The full bias correction accounts on average for redshift migration effects due to redshift resolution, while the sampling method reshuffles photometric redshifts according to resolution and propagates these individual changes to all photometric SN properties, including the magnitude bias correction which is taken at the reshuffled redshifts. This assumes that the full bias correction computed initially remains appropriate after redshift reshuffling, which is probably not the case\n\u2013 18 \u2013\nfor JLA-P HDs due to their large number of photometric redshifts. However, the \u2126M bias for sampling fits with the full bias correction remains at an acceptable level. As of nuisance parameters, the bias inMB is similar to that of the JLA-S samples in most cases, and lower for JLA-P samples when clipping and the full bias correction are used. Biases in \u03b1, \u03b2 of JLA-B samples are similar to those of JLA-S HDs and do not vary significantly with the fitting method or conditions. We relate this stability to the small number of outliers (affected by clipping) and the small number of SNe with photometric redshifts (subject to the full bias correction and redshift reshuffling in the sampling method) in the JLA-B samples. JLA-P diagrams have biases in \u03b1 and \u03b2 different from those of the two other diagram types, which we relate to their higher dispersion and higher number of outliers. To reduce these requires higher values of \u03b1 and \u03b2 than those for JLA-S and JLA-B HDs. This translates into lower biases in \u03b1, biases in \u03b2 becoming positive when no clipping is applied (with lower biases for sampling fits since redshift reshuffling helps reducing the dispersion) and reduced biases in \u03b2, either positive or negative depending on the fit method, when clipping is applied. Finally, table 5 shows that percentile ranges in the four parameters are similar for JLAB and JLA-S HDs and do not evolve significantly with fitting methods or conditions. On the other hand, percentile ranges for JLA-P HDs are higher than those of JLA-S samples, especially forMB and \u03b2 where an increase of 70-80% is observed. Taking half of the percentile range as an estimate of the statistical uncertainty expected for one single fit, the biases in \u2126M commented above can be better quantified. For standard fits, the bias amounts to 0.5\u03c3 for both JLA-B and JLA-P diagrams. Sampling reduces this bias by a factor better than 2. Adding clipping and the full magnitude bias correction, the bias in \u2126M drops below 0.1\u03c3 for all fits and diagrams, while it remains at the level of 0.3\u03c3 for sampling fits to JLA-P diagrams. For these, the bias drops below 0.1\u03c3 if clipping is used together with the intrinsic bias correction. In summary, fitting pure SN Ia Hubble diagrams containing photometric redshifts leads to biased cosmological results if redshift uncertainties are not accounted for. This is true for both JLA-B diagrams, where photometric redshifts are located mostly at z>0.5 and make 10% of the total sample, and JLA-P diagrams, where photometric redshifts start at z\u223c0.2 and make about half of the total sample. This effect cannot be corrected by refitting photometric redshifts with cosmology, but it can be corrected by sampling the redshift resolution function for SNe with photometric redshifts, even if the magnitude bias correction is computed as if all SNe had spectroscopic redshifts. Uncertainties in the cosmological parameters remain similar to those of spectroscopic HDs for JLA-B diagrams and are degraded for JLA-P ones, despite some improvement brought by clipping. Standard fits offer similar performance only if the magnitude bias correction also includes the effect of redshift resolution. In the following, we discuss possible reasons for the failure of the redshift refitting method and then study how the previous results evolve when HDs are contaminated by core-collapse SNe, restricting to standard and sampling fits only."
        },
        {
            "heading": "5.8 Discussion",
            "text": "Refitting photometric redshifts produces biased cosmological results. Moreover, as shown in table 6, the redshift resolution obtained after redshift refitting is hardly changed (a few per mill improvement) and there is no visible reduction of the number of redshift outliers. The basic reason is that fitting redshifts together with cosmology acts primarily on HD outliers. But our selection retains light curves which, once adjusted at their assigned photometric redshift, are compatible with being SN Ia at this redshift. So, incorrect or\n\u2013 19 \u2013\neven outlier photometric redshifts do not necessarily lead to HD outliers. This is illustrated in figure 5 which shows that 3\u03c3 HD outliers represent only a small fraction of SNe in the photometric sample (around 3%) and only part of them (14%) are due to 3\u03c3 redshift outliers.\nAlso highlighted in this figure is a second, perhaps more fundamental reason for the modest change in redshift resolution. The strongest HD outliers come mostly from low redshift SNe, at z<0.4, a region where distance luminosities vary rapidly with redshift, which explains why such strong outliers can be generated even with a redshift uncertainty around 1%. A small variation of their redshift is likely to move these HD outliers back to the Hubble flow with no significant change of the central redshift resolution. On the other hand, at higher\n\u2013 20 \u2013\nredshift, strong redshift outliers do not lead to very strong HD outliers since they are sitting in a region where distance luminosities vary slowly with redshift. This, together with the usual sources of light curve parameter uncertainties (sampling, photometric accuracy, SN Ia intrinsic dispersion) gives a certain flexibility for a high redshift SN to be made compatible with the same cosmology for different redshift values, including values far from the true one. Altogether, above zpho \u223c 0.8, redshift refitting likely produces redshift changes in either direction, so that globally the central resolution is minimally affected. This is confirmed by table 7 which breaks down the results of redshift refitting according to whether a better or worse redshift is obtained. The performance is only slightly better for redshifts which get improved, resulting in a very modest improvement of the global redshift resolution."
        },
        {
            "heading": "6 Core-collapse contamination",
            "text": "The previous sections dealt with purely SN Ia mixed Hubble diagrams, while our photometric sample is contaminated by core-collapse (CC) events, as reported in [5]. In this section, we use the CC simulation developed in [5] together with our main SN Ia simulation to estimate more precisely this contamination and its redshift profile. Then we review the changes induced by this contamination on the SN magnitude bias estimate of section 4, and on the results of section 5.4, restricting to standard fits and fits that include sampling of the redshift resolution."
        },
        {
            "heading": "6.1 CC simulation and magnitude bias correction",
            "text": "The effect of contamination by core-collapse SNe was studied with the CC light curve simulation described in [5]. The analytical light curve model used in this simulation, which is also that used in the SN Ia photometric selection of section 2.1, is general enough to describe the light curve shape of all types of supernovae. Values of the model parameters and their evolution with redshift were set up separately for fast and slow declining CC SNe, respectively dubbed as SNIbcII and SNIIp events in the following. In the present work, this simulation was updated with the value of \u2126M in table 2 and the model of photometric redshifts of section 4.2. A total of 100,000 light curves was generated in each of the SNIbcII and SNIIp classes (5 times more than in [5]), of which 486 and 8 remained after the SN Ia selection of section 2.1, respectively. The contamination of our SN Ia photometric sample is thus essentially due to fast-declining or non-plateau events. The contamination of the SNLS 3-year photometric sample by CC SNe was estimated from these simulated samples following the method described in [5]. CC and Ia simulations were normalised to each other using the CC to Ia volumetric rate ratio published in [29] and the relative fraction between fast and slow declining events reported in [5]. As a result,\n\u2013 21 \u2013\nthe total contamination of the SNLS photometric sample of 485 events is estimated to be 22.1\u00b1 6.1 events. The quoted uncertainty comes from the statistical error due to the limited size of the simulated SN Ia and CC samples and from the statistical and systematic errors on the measured volumetric rate ratio of [29]. Figure 6 presents the CC contamination of the SNLS photometric sample as a function the SN host photometric redshift (top-left panel). The right-hand plot shows the magnitude biases for CC and SN Ia events separately and once they are combined according to the contamination rate in the bottom-left panel. The SN Ia bias here is the full magnitude bias defined in section 4.3 (i.e. SN Ia contribution only, using reconstructed light curves at the host photometric redshift). Altogether, the CC contamination induces a slight increase of the bias of the total sample, mostly at low redshift, zpho<0.5. In the following, the correction to the above combined SNIa-CC magnitude bias will be referred to as \u2019full combined bias correction\u2019 and that deduced from the pure CC magnitude bias as \u2019full CC bias correction\u2019."
        },
        {
            "heading": "6.2 Fit results for contaminated toy Monte Carlo samples",
            "text": "The CC simulations were used to include contamination in the simulated JLA-P and JLA-B samples of section 5.4. In each initial JLA-P HD, we removed a number of SNe Ia in each photometric redshift bin according to the left-hand top plot of figure 6 and replaced them by an equal number of photometrically selected CC events. Each of these contaminated JLA-P samples was then converted into a contaminated JLA-B sample as explained in section 5.4. Both sets of contaminated HDs were then fit with the standard and sampling fitting methods. For the latter, the simulated CC light curves were fit as described in section 5.1 to obtain polynomial models of the evolution of SALT2 parameter shifts with redshift. The SALT2 parameter shifts for CC SNe vary similarly as those of SNe Ia and are as correctly described by the same polynomial models. Average results of the standard and sampling cosmological fits are given in tables 8 and 9, where they are compared to results for uncontaminated JLA-S HDs. Similar to what was done in section 5.5, we either use the intrinsic SN Ia bias correction for all SNLS events\n\u2013 22 \u2013\nin the diagrams, or use the full combined correction previously defined for events with SALT2 parameters evaluated at their photometric redshift, all other SNLS events, if any, being corrected for the intrinsic SN Ia magnitude bias. We first describe the fit results compared to the uncontaminated case and then summarise our findings at the end of the section. CC contamination results in an increased number of outliers, by a factor of nearly 3 in JLA-B HDs and by 40% in JLA-P ones, while the HD rms increases by 13 and 10 %, respectively (see table 4). For both types of fits and HDs, biases in \u2126M are significantly larger than in uncontaminated HDs, reaching 1.6\u03c3 for standard fits, where \u03c3 is the expected statistical fit error, unless the sampling method with the full combined bias correction is applied, with (resp. without) clipping in JLA-B (resp. JLA-P) HDs. In that case, the \u2126M bias is reduced to an acceptable level (at most 0.005 or 0.3\u03c3) for both types of diagrams. We note that clipping has a more significant effect than for uncontaminated HDs (see table 4).\n\u2013 23 \u2013\nIt helps to reduce the \u2126M bias in all cases, whatever the HD type, fit method or magnitude bias correction, except for JLA-P HDs when the full combined bias correction is applied, whatever the fit method. This may reveal a negative interplay between clipping and the full combined bias correction for both standard and sampling fits for these diagrams. The large number of HD outliers may make the full combined bias correction inappropriate when clipping is applied, especially for the sampling method, despite the fact that clipping w.r.t. the simulation cosmology was applied in the magnitude bias computation. JLA-B diagrams do not suffer from such an issue since the number of outliers is low, as well as the number of photometric SNe, to which the full combined correction is applied.\nWith the sampling method and full combined bias correction, biases in the nuisance parameters MB and \u03b1 are similar to or better than those of JLA-S diagrams for both types of diagrams, with or without clipping, a trend already observed in the uncontaminated case for JLA-P diagrams. On the other hand, without clipping, biases in \u03b2 are significantly larger than without contamination, reaching 0.09 and 0.15 in JLA-B and JLA-P HDs respectively, to be compared to 0.06 at most without contamination (see table 4). With clipping this bias is reduced to 0.02 for both types of HDs. As JLA-P HDs are better treated without clipping to avoid biasing cosmological parameters, a bias in \u03b2 of order 0.15 should be expected. Similar conclusions are reached with standard fits, but with biases in all nuisance parameters slightly higher.\nFinally, table 9 presents the 16-84 percentile ranges in the marginalised values of the four fit parameters. Compared to the uncontaminated case (see table 5), the percentile ranges in \u2126M and MB increase moderately, by at most 15% and 4mmag, respectively. Percentile ranges in \u03b1 increase by at most 20%, while those in \u03b2 increase by a factor of 1.5 to 3, unless clipping is applied. While percentile ranges are similar (within a few % ) with both types of fits in JLA-B HDs, sampling gives reduced ranges (by 10 to 20%) for JLA-P HDs, especially in MB. Compared to JLA-S HDs and retaining only sampling fits with the best option for each diagram type (\u2019full, clip\u2019 for JLA-B, \u2019full\u2019 for JLA-P), the percentile ranges of JLA-B HDs are larger by 15% for \u2126M and 12 to 16% for the nuisance parameters, while those of JLA-P HDs are higher by 19% for \u2126M , and by a factor 1.5 to 2.6 for the nuisance parameters. In summary, CC contamination increases the bias in \u2126M by a factor 2 to 3 w.r.t. that of purely SN Ia JLA-B and JLA-P HDs treated with the intrinsic SN Ia magnitude bias correction, depending whether clipping is applied or not. To reduce the cosmological bias down to a fraction (one-third) of the statistical error, both types of diagrams should be treated with the full combined correction, with (resp. without) clipping in the JLA-B (resp. JLA-P) case. The price to pay for JLA-P HDs is a significant bias in \u03b2 of the order of 0.15 (5% in relative value) and an increase of its interval error by 50%, making the \u03b2 bias a 2\u03c3 effect for the sampling method (2.4\u03c3 for standard fits). Biases in MB and \u03b1 are expected to remain at the same level as in fully spectroscopic SN Ia HDs, despite the contamination. The impact of photometric redshifts and CC contamination on parameter uncertainties is a moderate increase (below 20%) for JLA-B diagrams as compared to purely spectroscopic SN Ia HDs. For JLA-P diagrams, the increase is higher, 15 to 30% on \u2126M and a factor of 1.5 to 3 depending on the nuisance parameter and fitting method, the sampling one giving smaller increases. Although both types of fits show close performance, in particular in terms of cosmological biases, the sampling method should be preferred since it propagates a model of photometric redshift uncertainties.\nIn the following, we discuss the limitations of our procedure as a possible reason for the presence of a residual cosmological bias in fits to contaminated diagrams and then proceed\n\u2013 24 \u2013\nwith fits to the actual JLA-P and JLA-B diagrams from data."
        },
        {
            "heading": "6.3 Discussion",
            "text": "Figure 7 shows HD residuals as a function of redshift residuals for simulated CC SNe. As in the case of SNe Ia with photometric redshifts (figure 5) most cosmological outliers are not redshift outliers, whatever the SN magnitude bias correction applied. CC contamination creates HD outliers mostly at low redshift, zpho<0.5. With the SN Ia intrinsic bias correction, these are mostly on the fainter side and a negative bias in \u2126M is to be expected. This bias is slightly reduced if the full combined bias correction is applied but would vanish if the full CC bias correction was applied. This explains why, in the fits of table 8, the full combined bias correction reduces the bias in \u2126M but in most cases does not correct it as efficiently as in the uncontaminated case. This shows the limit of our attempt to correct the SN magnitude bias with a combined SNIa-CC bias correction rather than trying to apply one or the other correction on each event depending on its probability to be of either type. Methods to include typing probabilities in cosmological fits for contaminated SN Ia samples have been developed\n\u2013 25 \u2013\nin the case of samples with host spectroscopic redshifts [15, 16]. It could be interesting to test whether they can be adapted when part of the sample have host photometric redshifts.\nBeside these limitations, our procedure relies on several simplifying but unavoidable assumptions. For JLA-B diagrams, whatever the fitting method, the SN Ia intrinsic bias correction is applied to any photometric SN that is assigned a spectroscopic redshift, whatever its type. Second, the full combined bias correction is applied to SNe which remain with a photometric redshift, although it was computed assuming that all selected SNe (Ia and CC) have a photometric redshift. We thus assume that CC SNe can be treated as SNe Ia once migrated to their spectroscopic redshift and that the mean full magnitude bias of either SN class in each redshift bin is not changed by the spectroscopic redshift assignment. This can be the case if the latter does not correlate with SN properties but operates as a random sampling of the SNLS photometric population in each redshift bin of the diagram, which is the case in simulated diagrams but may not be the case for data.\nFinally, the negative interplay between clipping and the full combined bias correction noticed for the JLA-P diagrams in table 8 is larger for sampling fits, which may indicate that the clipping from standard fits, also used for sampling ones, may be inappropriate for them."
        },
        {
            "heading": "7 Results on data",
            "text": "The two JLA mixed diagrams from data (section 2.2) were fit with the standard and sampling methods, in the purely diagonal case as was done for simulated HDs, but also in combination with covariance matrices describing the other systematic effects. In the following, we first outline how light curve parameters and covariance matrices are obtained, specify how the latter are coupled with the sampling method, before reporting the fit results."
        },
        {
            "heading": "7.1 Light curve parameters",
            "text": "The two mixed diagrams contain both JLA spectroscopic SNe and SNLS photometric SNe. We took the published parameters for the JLA SNe and built the photometric SN parameters and their errors as described in section 3.1. Compared to what was done for the simulated HDs, the SN magnitudes are corrected for peculiar velocity effect and the magnitude diagonal errors contain the peculiar velocity and the lensing contributions, but does not include the statistical magnitude bias uncertainty. The latter is accounted for through the bias covariance matrix described in the next section. According to our simulations, the preferred option for the SN magnitude bias correction for SNe with a host galaxy photometric redshift is the full combined bias correction (section 6.1) since it is expected to provide unbiased cosmological results, but we also provide results for the intrinsic SN Ia bias correction (section 4) as a comparison. We recall that the intrinsic SN Ia bias correction is used for SNLS SNe which can be assigned a spectroscopic redshift in the mixed JLA-B sample.\nValues of the magnitude intrinsic dispersion \u03c3int are those published in [21] for the three surveys other than SNLS. For the latter, we take values that give a \u03c72 close to the total number of SNe in the diagram for standard fits performed with diagonal errors. We found that the same values can be taken for both SN magnitude bias corrections but that they become smaller with clipping. The values adopted for the fits are 0.22 (resp. 0.18) for the JLA-B diagrams without (resp. with) clipping and 0.235 (resp. 0.22) for the JLA-P diagrams without (resp. with) clipping. They are significantly higher than the SNLS value of the JLA sample, 0.08, reflecting the larger dispersion of the mixed diagrams due to their larger sample\n\u2013 26 \u2013\nsize, photometric nature, contamination and, to a much lesser extent, to the use of a less precise photometry to reconstruct their light curves [5].\nFor the sampling method, the photometric SNLS SN light curves were fit as described in section 5.1 to obtain models of the redshift evolution of their SALT2 parameter shifts w.r.t. values at their initial photometric redshift. We observed that data have similar shift evolutions as simulated SNe, which are as correctly described by degree six polynomial models."
        },
        {
            "heading": "7.2 Covariance matrices for mixed samples",
            "text": "Systematic uncertainties other than that related to redshift are included via covariance matrices as explained in section 3.1. For each mixed sample, the computation was done as follows.\nCstat was built with the method of [21] applied to all SNe in the diagram. For Ccal and CLCmod, we followed [21] and computed shifts of the photometric SN light curve parameters due to, respectively, calibration and light curve model uncertainties and combined them with those of the non-SNLS SNe of the JLA sample as used in [21]. Cdust and Cpecvel were deduced from the corresponding JLA matrices setting all terms where an SNLS photometric SN enters to 0, since these effects do not contribute much for SNLS events, as was checked on the JLA sample.\nFor Cbias we extracted the non-SNLS part of the official JLA matrices, set the covariances between SNLS and other surveys to zero and replaced the SNLS block matrix with a new one. This neglects cross-terms between SNLS and other surveys, which was checked, in the JLA case, to have no significant impact on the cosmological results. To form the SNLS block matrix, bias uncertainties were propagated to the uncertainty on m\u2217B and terms from each uncertainty source were added together, as in [21]. Popagated uncertainties were statistical and systematic ones, the latter being described in appendix A for the SN Ia bias corrections and in section 6.1 for the full CC bias correction. For each mixed diagram, there are thus two Cbias matrices, depending on the SN magnitude bias correction used in the fits. Note that since CC contamination is accounted for through the full combined bias correction, no specific contamination covariance matrix (CnonIa in (3.5)) is introduced. Finally, as for simulated HDs, fits are performed on the initial samples without clipping or with the clipping defined from standard fits. Versions of the covariance matrices for clipped diagrams were thus also produced."
        },
        {
            "heading": "7.3 Coupling covariance matrices and sampling",
            "text": "Systematic uncertainties related to photometric redshift resolution could also be accounted for with a covariance matrix that propagates 1\u03c3 redshift uncertainties to both SN distance moduli and model luminosity distances (see e.g. [3]). This requires one to define a reference cosmological model and point in the model parameter space to compute luminosity distance changes with the redshift resolution. The sampling method proposed in this paper allows changes in the luminosity distances and SN parameters to be computed at every point of the parameter space for any model. In this respect, this is a more exact method to test the impact of redshift uncertainties, but it neglects the cross-terms with the other systematic uncertainties and leads to a significant increase in computation time (a factor of 5 for JLA-B and 15 for JLA-P).\n\u2013 27 \u2013\nTo use the covariance matrices defined in the previous section within the sampling method, the \u03c72 computed at each point of the parameter space is:\n\u03c72 = [ ~\u00b5(~z)\u2212 ~\u00b5model(~z) ]\u2020 C\u22121cov(~z) [ ~\u00b5(~z)\u2212 ~\u00b5model(~z) ] + 1\nN\n\u2211[ ~\u00b5(~z + ~\u03b4z)\u2212 ~\u00b5model(~z + ~\u03b4z) ]\u2020 C\u22121diag(~z + ~\u03b4z) [ ~\u00b5(~z + ~\u03b4z)\u2212 ~\u00b5model(~z + ~\u03b4z) ] \u2212 [ ~\u00b5(~z)\u2212 ~\u00b5model(~z) ]\u2020 C\u22121diag(~z) [ ~\u00b5(~z)\u2212 ~\u00b5model(~z)\n] (7.1) where the sum extends over photomeric redshift variations ~\u03b4z, and:\nCcov = AC\u03b7A \u2020 + diag ( 5\u03c3z zlog10 )2 + diag ( \u03c32lens ) + diag ( \u03c32int ) C\u03b7 = Cstat + Ccal + CLCmod + Cbias + Cdust + Cpecvel\nCdiag = CLC + diag ( 5\u03c3z zlog10 )2 + diag ( \u03c32lens ) + diag ( \u03c32int ) (7.2)\nwith CLC given by (3.7). In the next section, we perform fits with diagonal errors only, in which case the \u03c72 in (7.1) reduces to its central term and is identical to that used for simulated HDs, and fits with covariance matrices, first with statistical errors only, Ccov = Cstat and then with all covariance matrices to include both statistical and systematic uncertainties."
        },
        {
            "heading": "7.4 Fit results",
            "text": "The complete set of results of the fits to the two mixed diagrams is presented in table 11 in appendix B. We performed standard and sampling fits, in each case with or without clipping, and varying the SN magnitude bias corrections as in section 6.2. We recall that the clipping applied in sampling fits is that given by the standard fits performed under the same conditions. We first compare results obtained in different conditions (clipping, magnitude bias correction, fitting method) before comparing the results on the two diagrams. We summarise our findings at the end of the section. We note that clipping has a marginal effect on the fit results for all parameters. This was expected from simulated HDs for M \u2032B and \u03b1, but not for \u2126M and \u03b2 (see table 8), where a significant effect was observed especially on \u03b2 in the JLA-P case. We also note that the HD dispersion is significantly higher in data than in simulation, by 24 and 18 % for the JLA-B and JLA-P diagrams, respectively. This is in line with the higher intrinsic dispersion in data (see section 7.1) w.r.t. the input value of 0.08 used in the simulation (see table 2). The number of HD outliers is also lower in data, especially in the JLA-P diagram, and their effect is reduced for both diagrams w.r.t. expectations. Comparing the two magnitude bias corrections, the full combined one gives upward shifts in \u2126M , three times more pronounced in the JLA-P diagram than in the JLA-B one. This shift is slightly reduced when statistical and systematic uncertainties are combined. Note that the shifts predicted by the simulation for diagonal errors, around +0.008 for JLA-B and +0.024 for JLA-P, are in remarkable agreement with what is observed in data for both diagonal and statistical only errors. The simulation predicted similar results for the two corrections on M \u2032B, \u03b1 and \u03b2, a trend we also see in data. The two fitting methods give compatible results for marginalised parameter values and their errors, a trend already observed in simulation. The largest difference between the two methods is observed for the JLA-P diagram and the \u03b2 parameter (see also figure 12\n\u2013 28 \u2013\nin appendix B), its marginalised value being 0.4 to 0.6\u03c3 lower for the sampling method, depending on the covariance matrices included, all other things being equal. Differences for all other parameters do not exceed 0.2\u03c3. Note that the standard deviation that we used to quantify differences is always that from one of the fits.\nErrors on the fit parameters are similar whatever the fitting method and magnitude bias correction, a trend that was also present in the simulation results (table 9). However, errors are larger in data than expected from the 16-84 percentile ranges derived from simulation. As an example, restricting to fits with diagonal errors to match what was done in simulation, the error in \u2126M is 30% higher in data, which we interpret as another effect of the larger dispersion of the actual diagrams. Adding other uncertainties, errors in \u2126M are increased by about 20% in fits with statistical errors only, and almost double in fits with all errors combined. Errors in \u03b1, \u03b2 also increase by about 20% in fits with statistical errors only and remain at a similar level in fits with all errors combined. This is in line with what was published for the JLA sample [21] (see also table 10).\nWe finally compare the results obtained for the two diagrams, restricting to the conditions advocated by our simulation study, namely sampling fits with the full combined bias correction, with clipping for JLA-B and with no clipping for JLA-P. Whatever the covariances included, the marginalised value of \u2126M is higher for the JLA-P diagram than for the JLA-B one. Comparing the difference between the two values to the standard deviation of one of the fits, the two values are within 0.3\u03c3 when all errors are combined but are different by 1.4\u03c3 with statistical errors only and by 1.9\u03c3 with diagonal errors only. In the same conditions, there are 3 out of 50 fits to simulated HDs that show a higher difference. If no clipping is applied to the JLA-B diagram as well, this difference decreases and a higher value is found in 11 simulated HDs. As for the nuisance parameters, the marginalised values are consistent between the two diagrams, within less than 1\u03c3 for \u03b1 and \u03b2, and within less than 2mmag for M \u2032B, as expected for two samples which are composed mostly of the same SNe. Our final results on both diagrams, using sampling fits with the full SNIa-CC combined bias correction as advocated by our simulation study, are summarised in table 10, which also gives results obtained with standard fits on the JLA sample. Although marginalised values of\n\u2013 29 \u2013\n\u2126M are consistent between the three diagrams (within the error of one of the fits) when all errors are combined, the agreement is preserved only between the JLA and JLA-B diagrams when considering statistical errors only. The marginalised values of \u03b1, \u03b2 are slightly different between the JLA and the two mixed diagrams, which reflects the fact that the mixed samples have a significant component (around 330 SNe) not present in the JLA one. However, the agreement on the absolute SN Ia magnitude M \u2032B is good. For the sake of completeness, figure 8 presents the Hubble diagrams for the three samples and figure 9 illustrates how the change in SNLS event redshifts between the JLA-P and JLA-B samples propagates to the Hubble diagram.\n\u2013 30 \u2013"
        },
        {
            "heading": "8 Conclusion",
            "text": "In this paper, we discussed the case of flat \u039bCDM fits to Hubble diagrams of photometrically selected SNe Ia, using both host photometric redshifts and spectroscopic redshifts. The impact of host galaxy photometric redshift uncertainties and contamination by core-collapse SNe was studied. As a test case, we used the mixed sample made of the non SNLS part of the spectroscopic JLA sample to which we added the 3-year SNLS photometric sample, which constitutes almost half of the diagram and is its main component at redshift above 0.4. To pass the photometric selection, objects were required to have SN Ia compatible light curves when fitted by SALT2 at their host photometric redshift. They can enter the Hubble diagram with their SALT2 parameters determined either at these redshifts or at their (SN or host) spectroscopic redshifts if these exist. Both options were considered, which defines two possible mixed Hubble diagrams, one using only host photometric redshifts for SNLS (JLA-P) and one with only 25% of the SNLS SNe with photometric redshifts, mostly at redshifts above 0.5 (JLA-B).\nThe photometric redshift catalogue used in the selection provides a central redshift resolution \u03c3\u2206z/(1+z) \u223c 3% and a 3\u03c3 outlier rate of 5.5% at the end of the selection procedure, as measured from data. Simulations of SN Ia and core-collapse SN light curves including a redshift model reproducing these numbers were submitted to the exact same photometric selection algorithm as that applied on data. These simulations were used to estimate the SN magnitude bias due to the photometric selection. We found that the magnitude bias is essentially negligible for a pure sample of SNe Ia with noiseless light curves treated at their true redshifts, provided one uses \u03b1, \u03b2 values that fully account for the cosmological fitting procedure. Using light curves with instrumental noise and host galaxy photometric redshifts instead of true SN redshifts makes the SN Ia magnitude bias increase significantly, especially at low redshifts. This increase is reinforced by core-collapse contamination, but only slightly thanks to the moderate contamination - around 5% - of the photometric sample.\nThe expected cosmological performance of both mixed samples was then studied with simulated Hubble diagrams that reproduce the contamination and redshift profile of the two actual diagrams. Treating photometric SNe as pure SNe Ia at their true redshifts in the magnitude bias correction produces a bias in \u2126M in standard fits to both types of diagrams, at the level of 1.6\u03c3, where \u03c3 is the expected statistical fit uncertainty. Contamination is responsible for two thirds of this bias, which can be reduced to 0.5\u03c3 when applying clipping and a magnitude bias correction that accounts for both redshift migration and contamination.\nTo reduce the bias further, we tested two methods that propagate photometric redshift resolution to the cosmological likelihood function, either by refitting the photometric redshifts along with cosmology or by sampling the redshift resolution function when computing the cosmological fit \u03c72. Redshift refitting, tested on simulated photometric diagrams without contamination, was found to produce distorted posteriors of the fit parameters due to multiple local maxima in the likelihood surface. Moreover, this method did not reduce the bias in \u2126M . On the other hand, sampling the redshift resolution function produces Gaussian posteriors and thus provides a reliable way to propagate the error redshift uncertainty to the cosmological likelihood (at a significant cost in CPU). When tested on contaminated simulated diagrams, this method reduces the \u2126M bias to 0.3\u03c3 if the magnitude bias correction accounts for both redshift migration and contamination. Under the same conditions, uncertainties on \u2126M are increased by 10% for both diagram types when compared to photometrically selected samples with full spectroscopic redshift coverage. Standard fits show a similar increase.\n\u2013 31 \u2013\nWith the help of the simulation, we investigated why the impact of the sampling method appears to be modest. The method acts on photometric redshifts to reduce the Hubble diagram dispersion and the number of outliers. But the latter are not necessarily induced by strong redshift outliers but rather by strong luminosity distance shifts due to small redshift uncertainties in low redshift objects, below 0.5, whether SNe Ia or contaminants. In simulated diagrams, we observe that acting on photometric redshifts according to redshift resolution does reduce the number of SN Ia HD outliers w.r.t. standard fitting but not that due to contaminants, probably because changing the redshift of contaminants makes their SALT2 parameters less compatible with being SNe Ia. We also observe that the diagram dispersion is not improved w.r.t. standard fitting, which is likely due to the fact that the bulk of the mixed diagrams is at high redshift, a region where acting on the photometric redshifts has no effect on the Hubble residuals. The standard and sampling fitting techniques were applied to both mixed samples in data, using the two SN magnitude bias corrections determined from simulations, and extending the sampling method to allow combination with the other systematic uncertainties described by covariance matrices. The change in \u2126M we observe between fits using either the pure SN Ia magnitude bias correction or the correction thats accounts for both redshift migration and contamination, is as expected from the simulations. Both fitting methods provide compatible results, the largest difference being obtained for the \u03b2 parameter and the JLA-P sample. Finally, the JLA-B diagram provides values of \u2126M in agreement with those from the JLA sample, whether statistical only or statistical and systematic uncertainties are included in the fit, while the JLA-P diagram gives higher values, only compatible with those from the other two diagrams when all uncertainties are combined. For future SN Ia projects aiming at fitting photometrically selected Hubble diagrams using host photometric redshifts, several conditions appear essential to avoid biasing cosmological parameters: reduce the contamination below the few % level, obtain spectroscopic host redshifts to cover the photometric sample up to redshifts around 0.5 and account for both contamination and redshift resolution in the SN magnitude bias computation. Propagating the redshift resolution function up to the cosmological likelihood function to correct residual biases and include the redshift resolution in the parameter errors seems a second priority for our sample but may become necessary for more precise Hubble diagrams."
        },
        {
            "heading": "Acknowledgments",
            "text": "The authors warmly thank Marc Betoule for his help to set up the tools to compute covariance matrices for the JLA sample and for fruitful discussions in the early stage of this project."
        },
        {
            "heading": "A Systematic uncertainties on the SN Ia selection magnitude bias",
            "text": "Systematic uncertainties in the SN Ia photometric selection magnitude bias estimates (both intrinsic and full biases as defined in section 4.3) were evaluated with additional simulations. Each simulation comprises 20,000 light curves and corresponds to varying one parameter at a time with respect to values in the main simulation, within ranges given in table 2. Ranges on the cosmological and SN Ia nuisance parameters are one standard deviations reported in [21]. We chose to vary \u03c3int by 25% since \u03c3int values reported in [21] for high redshift surveys show such a variation. Wout was varied by \u00b16%, a range that allow good modelling of the redshift outlier rates in data.\n\u2013 32 \u2013\nIn each case, the bias in the alternative simulation was computed as in the main simulation, with appropriate nuisance parameters. As an example, figure 10 presents the full bias estimate in the ten additional simulations. Compared to the bias from the main simulation, the changes do not exceed \u00b10.05mag, except in the first redshift bin between 0.1 and 0.15, where the change is within \u00b10.15mag."
        },
        {
            "heading": "B Additional figure for the redshift refitting method",
            "text": "Figure 11 shows the SALT2 \u03c72 difference between SN Ia light curve fits run at host photometric redshifts and spectroscopic redshifts, as a function of the bias between these two redshift choices, normalised by the host photometric redshift central resolution. This figure is based on a sample of around 12,000 simulated SN Ia light curves fulfilling our SN Ia photometric selections. This figure shows that the proportion of events with a better SALT2 \u03c72 when light curves are fit at their photometric redshift instead of the true one drops for Hubble diagram outliers. This justifies that a SALT2 \u03c72 difference term was added to the \u03c72 of the redshift refitting method, see eq. (5.2), in order to disfavour redshift variations that would improve the cosmological fit at the cost of a degradation of the light curve fit."
        },
        {
            "heading": "C Additional figure and table for results from data",
            "text": "Figure 12 presents posterior distributions from fits to the JLA-P and JLA-B diagrams built from data, showing that the posterior distributions for both data diagrams have no distortions and do not depend on the fitting method or conditions, except for the \u03b2 posterior. The latter is modified by clipping but does not change with the fitting method for the JLA-B diagram, while it differs between the two fitting methods but hardly depends on clipping for the JLA-P diagram.\n\u2013 33 \u2013\nTable 11 presents the complete set of results from fits to the two mixed Hubble diagrams deduced from data."
        }
    ],
    "title": "Type Ia supernova Hubble diagrams with host galaxy photometric redshifts",
    "year": 2022
}