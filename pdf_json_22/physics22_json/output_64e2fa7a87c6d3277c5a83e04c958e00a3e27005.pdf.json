{
    "abstractText": "Ground-based high contrast exoplanet imaging requires state-of-the-art adaptive optics (AO) systems in order to detect extremely faint planets next to their brighter host stars. For such extreme AO systems (with high actuator count deformable mirrors over a small field of view), the lag time of the correction (which can impact our system by the amount the wavefront has changed by the time the system is able to apply the correction) which can be anywhere from 1-5 milliseconds, can cause wavefront errors on spatial scales that lead to speckles at small angular separations from the central star in the final science image. One avenue for correcting these aberrations is predictive control, wherein previous wavefront information is used to predict the future state of the wavefront in one-system-lag\u2019s time, and this predicted state is applied as a correction with a deformable mirror. Here, we consider two methods for predictive control: data-driven prediction using empirical orthogonal functions and the physically-motivated predictive Fourier control. The performance and robustness of these methods have not previously been compared side-by-side. In this paper, we compare these predictors by applying them as post-facto methods to simulated atmospheres and on-sky telemetry, to investigate the circumstances in which their performance differs, including testing them under different wind speeds, C N profiles, and time lags. We also discuss future plans for testing both algorithms on the Santa Cruz Extreme AO Laboratory (SEAL) testbed. This work will inform the next generation of extremely large telescopes (including the European Extremely Large Telescope, as well as plans for the Giant Magellan Telescope and the Thirty Meter Telescope), which will depend on predictive control as a key technology to reach the contrasts necessary to directly image rocky planets in the habitable zones of the nearest low-mass stars.",
    "authors": [
        {
            "affiliations": [],
            "name": "J. Fowler"
        },
        {
            "affiliations": [],
            "name": "M.A.M. Van Kooten"
        },
        {
            "affiliations": [],
            "name": "R. Jensen-Clem"
        }
    ],
    "id": "SP:3ef0ebee096634f15201e37b40dfdc4747640afe",
    "references": [
        {
            "authors": [
                "O. Guyon",
                "J. Males"
            ],
            "title": "Adaptive Optics Predictive Control with Empirical Orthogonal Functions (EOFs)",
            "venue": "arXiv e-prints , arXiv:1707.00570 (July 2017).",
            "year": 2017
        },
        {
            "authors": [
                "L.A. Poyneer",
                "B.A. Macintosh",
                "V\u00e9ran",
                "J.-P."
            ],
            "title": "Fourier transform wavefront control with adaptive prediction of the atmosphere",
            "venue": "Journal of the Optical Society of America A 24, 2645 (Jan. 2007).",
            "year": 2007
        },
        {
            "authors": [
                "R. Jensen-Clem",
                "D. Dillon",
                "B. Gerard",
                "M.A.M. van Kooten",
                "J. Fowler",
                "R. Kupke",
                "S. Cetre",
                "D. Sanchez",
                "P. Hinz",
                "C. Laguna",
                "D. Doelman",
                "F. Snik"
            ],
            "title": "The Santa Cruz Extreme AO Lab (SEAL): design and first light",
            "venue": "[Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series ], Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series 11823, 118231D (Sept. 2021).",
            "year": 2021
        },
        {
            "authors": [
                "V.P. Bailey",
                "L.A. Poyneer",
                "B.A. Macintosh",
                "D. Savransky",
                "J.J. Wang",
                "R.J. De Rosa",
                "K.B. Follette",
                "S.M. Ammons",
                "T. Hayward",
                "P. Ingraham",
                "J. Maire",
                "D.W. Palmer",
                "M.D. Perrin",
                "A. Rajan",
                "F.T. Rantakyr\u00f6",
                "S. Thomas",
                "V\u00e9ran",
                "J.-P."
            ],
            "title": "Status and performance of the Gemini Planet Imager adaptive optics system",
            "venue": "[Adaptive Optics Systems V ], Marchetti, E., Close, L. M., and V\u00e9ran, J.-P., eds., Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series 9909, 99090V (July 2016).",
            "year": 2016
        },
        {
            "authors": [
                "J. Milli",
                "D. Mouillet",
                "T. Fusco",
                "J.H. Girard",
                "E. Masciadri",
                "E. Pena",
                "J.F. Sauvage",
                "C. Reyes",
                "K. Dohlen",
                "J.L. Beuzit",
                "M. Kasper",
                "M. Sarazin",
                "F. Cantalloube"
            ],
            "title": "Performance of the extreme-AO instrument VLT/SPHERE and dependence on the atmospheric conditions",
            "venue": "arXiv e-prints , arXiv:1710.05417 (Oct. 2017).",
            "year": 2017
        },
        {
            "authors": [
                "L. Poyneer",
                "M. van Dam",
                "V\u00e9ran",
                "J.-P."
            ],
            "title": "Experimental verification of the frozen flow atmospheric turbulence assumption with use of astronomical adaptive optics telemetry",
            "venue": "Journal of the Optical Society of America A 26, 833 (Mar. 2009).",
            "year": 2009
        },
        {
            "authors": [
                "G.I. Taylor"
            ],
            "title": "The Spectrum of Turbulence",
            "venue": "Proceedings of the Royal Society of London Series A 164, 476\u2013490 (Feb. 1938).",
            "year": 1938
        },
        {
            "authors": [
                "R. Jensen-Clem",
                "C.Z. Bond",
                "S. Cetre",
                "E. McEwen",
                "P. Wizinowich",
                "S. Ragland",
                "D. Mawet",
                "J. Graham"
            ],
            "title": "Demonstrating predictive wavefront control with the Keck II near-infrared pyramid wavefront sensor",
            "venue": "[Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series ], Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series 11117, 111170W (Sept. 2019).",
            "year": 2019
        },
        {
            "authors": [
                "M.A.M. van Kooten",
                "R. Jensen-Clem",
                "S. Cetre",
                "S. Ragland",
                "C.Z. Bond",
                "J. Fowler",
                "P. Wizinowich"
            ],
            "title": "Predictive wavefront control on Keck II adaptive optics bench: on-sky coronagraphic results",
            "venue": "Journal of Astronomical Telescopes, Instruments, and Systems 8, 029006 (Apr. 2022).",
            "year": 2022
        },
        {
            "authors": [
                "O. Guyon",
                "A. Sevin",
                "D. Gratadour",
                "J. Bernard",
                "H. Ltaief",
                "D. Sukkari",
                "S. Cetre",
                "N. Skaf",
                "J. Lozi",
                "F. Martinache",
                "C. Clergeon",
                "B. Norris",
                "A. Wong",
                "J. Males"
            ],
            "title": "The compute and control for adaptive optics (CACAO) real-time control software package",
            "venue": "[Adaptive Optics Systems VI ], Close, L. M., Schreiber, L., and Schmidt, D., eds., Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series 10703, 107031E (July 2018).",
            "year": 2018
        },
        {
            "authors": [
                "R.N. Paschall",
                "D.J. Anderson"
            ],
            "title": "Linear quadratic Gaussian control of a deformable mirror adaptive optics system with time-delayed measurements",
            "venue": "Applied Optics 32, 6347\u20136358 (Nov. 1993).",
            "year": 1993
        },
        {
            "authors": [
                "C. Kulcs\u00e1r",
                "Raynaud",
                "H.-F.",
                "C. Petit",
                "Conan",
                "J.-M.",
                "P. Viaris de Lesegno"
            ],
            "title": "Optimal control, observers and integrators in adaptive optics",
            "venue": "Optics Express 14, 7464 (Aug. 2006).",
            "year": 2006
        },
        {
            "authors": [
                "E.H. Por",
                "S.Y. Haffert",
                "V.M. Radhakrishnan",
                "D.S. Doelman",
                "M. van Kooten",
                "S.P. Bos"
            ],
            "title": "High Contrast Imaging for Python (HCIPy): an open-source adaptive optics and coronagraph simulator",
            "venue": "[Adaptive Optics Systems VI ], Close, L. M., Schreiber, L., and Schmidt, D., eds., Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series 10703, 1070342 (July 2018).",
            "year": 2018
        },
        {
            "authors": [
                "C. Neyman"
            ],
            "title": "Keck adaptive optics note 303: Atmospheric parameters for mauna kea",
            "venue": "tech. rep., W. M. Keck Observatory (December 2004).",
            "year": 2004
        },
        {
            "authors": [
                "S. Cetre",
                "O. Guyon",
                "C. Bond",
                "M. Chun",
                "D. Mawet",
                "P. Wizinowich",
                "C. Lockhart",
                "S. Goebel",
                "E. Wetherell"
            ],
            "title": "A near-infrared pyramid wavefront sensor for Keck adaptive optics: real-time controller",
            "venue": "[Adaptive Optics Systems VI ], Close, L. M., Schreiber, L., and Schmidt, D., eds., Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series 10703, 1070339 (July 2018).",
            "year": 2018
        },
        {
            "authors": [
                "C.Z. Bond",
                "P. Wizinowich",
                "M. Chun",
                "D. Mawet",
                "S. Lilley",
                "S. Cetre",
                "N. Jovanovic",
                "Delorme",
                "J.-R.",
                "E. Wetherell",
                "S. Jacobson",
                "C. Lockhart",
                "E. Warmbier",
                "J.K. Wallace",
                "D.N. Hall",
                "S. Goebel",
                "O. Guyon",
                "C. Plantet",
                "G. Agapito",
                "C. Giordano",
                "S. Esposito",
                "B. Femenia-Castella"
            ],
            "title": "Adaptive optics with an infrared pyramid wavefront sensor",
            "venue": "[Adaptive Optics Systems VI ], Close, L. M., Schreiber, L., and Schmidt, D., eds., Society of Photo-Optical Instrumentation Engineers (SPIE) Conference Series 10703, 107031Z (July 2018).",
            "year": 2018
        },
        {
            "authors": [
                "J. Wang",
                "D. Mawet",
                "N. Jovanovic",
                "J.R. Delorme",
                "C. Bond",
                "J. Pezzato",
                "S. Cetre",
                "D. Echeverri",
                "J.K. Wallace",
                "R. Bartos",
                "S. Lilley",
                "S. Ragland",
                "G. Ruane",
                "P. Wizinowich",
                "M. Chun",
                "J. Wang",
                "M.P. Fitzgerald",
                "A. Skemer",
                "E. Martin",
                "E. Wetherell",
                "E. Wang",
                "S. Jacobson",
                "E. Warmbier",
                "C. Lockhart",
                "D. Hall"
            ],
            "title": "First Light of the Keck Planet Imager and Characterizer",
            "venue": "[AAS/Division for Extreme Solar Systems Abstracts ], AAS/Division for Extreme Solar Systems Abstracts 51, 328.01 (Aug. 2019).",
            "year": 2019
        },
        {
            "authors": [
                "CFHT"
            ],
            "title": "Mauna kea weather center",
            "venue": "tech. rep., http://mkwc.ifa.hawaii.edu/current/seeing/ (2021).",
            "year": 2021
        },
        {
            "authors": [
                "J.W. Hardy"
            ],
            "title": "Adaptive Optics for Astronomical Telescopes",
            "year": 1998
        },
        {
            "authors": [
                "R.H. Shumway"
            ],
            "title": "Applied statistical time series analysis",
            "year": 1988
        },
        {
            "authors": [
                "L.A. Poyneer",
                "V\u00e9ran",
                "J.-P."
            ],
            "title": "Optimal modal Fourier-transform wavefront control",
            "venue": "Journal of the Optical Society of America A 22, 1515\u20131526 (Aug. 2005).",
            "year": 2005
        },
        {
            "authors": [
                "A.V. Oppenheim",
                "R.W. Schafer"
            ],
            "title": "Digital signal processing",
            "venue": "NASA STI/Recon Technical Report A 76, 11184 (Jan. 1975).",
            "year": 1975
        },
        {
            "authors": [
                "P. Lancaster",
                "L. Rodman"
            ],
            "title": "Algebraic Riccati Equations",
            "year": 2002
        },
        {
            "authors": [
                "P. Virtanen",
                "R. Gommers",
                "T.E. Oliphant",
                "M. Haberland",
                "T. Reddy",
                "D. Cournapeau",
                "E. Burovski",
                "P. Peterson",
                "W. Weckesser",
                "J. Bright",
                "S.J. van der Walt",
                "M. Brett",
                "J. Wilson",
                "K.J. Millman",
                "N. Mayorov",
                "A.R.J. Nelson",
                "E. Jones",
                "R. Kern",
                "E. Larson",
                "C.J. Carey",
                "\u0130. Polat",
                "Y. Feng",
                "E.W. Moore",
                "J. VanderPlas",
                "D. Laxalde",
                "J. Perktold",
                "R. Cimrman",
                "I. Henriksen",
                "E.A. Quintero",
                "C.R. Harris",
                "A.M. Archibald",
                "A.H. Ribeiro",
                "F. Pedregosa",
                "P. van Mulbregt",
                "SciPy 1.0 Contributors"
            ],
            "title": "SciPy 1.0: Fundamental Algorithms for Scientific Computing in Python",
            "venue": "Nature Methods 17, 261\u2013272 (2020).",
            "year": 2020
        }
    ],
    "sections": [
        {
            "text": "This work will inform the next generation of extremely large telescopes (including the European Extremely Large Telescope, as well as plans for the Giant Magellan Telescope and the Thirty Meter Telescope), which will depend on predictive control as a key technology to reach the contrasts necessary to directly image rocky planets in the habitable zones of the nearest low-mass stars.\nKeywords: high-contrast imaging, adaptive optics, predictive wavefront control, empirical orthogonal functions, Kalman filtering, Linear Quadratic Gaussian control"
        },
        {
            "heading": "1. INTRODUCTION",
            "text": "For ground-based astronomy, image quality is impacted by atmospheric turbulence, where varying temperature zones of Earth\u2019s atmosphere change the index of refraction in air, which introduces delays in the path length of light travelling from a star to a telescope, leading to aberrations in the final science image. The solution is adaptive optics (AO), wherein phase information is collected with a wavefront sensor and active correction by deformable optics within the telescope path allow these phase delays to be counteracted; hence, wavefront errors are corrected before the light reaches the final science detector. In particular, for an extreme adaptive optics (XAO) system, a bright, on-axis natural guide star and a large number of DM actuators are used to achieve a good correction over a small (e.g. few arcsecond) field of view. Extreme AO is required for high contrast imaging systems, which use coronagraphs to null the coherent portion of the starlight. As the wavefront error in an AO system increases, the portion of light that can be rejected by the coronagraph decreases, leading to speckles throughout the image plane that closely mimic planets.\nMany current XAO systems (for example the Gemini Planet Imager4 and SPHERE5) see their overall performance limited by temporal effects, termed bandwidth error. While faster computers and deformable mirrors, as well as increasingly efficient readout detector technology can shorten an AO system\u2019s lag time, often the system\nFurther author information: (Send correspondence to J. Fowler) E-mail: jumfowle@ucsc.edu\nar X\niv :2\n20 8.\n00 98\n4v 1\n[ as\ntr o-\nph .E\nP] 1\nA ug\n2 02\nlag is dominated by how long a wavefront sensor needs to expose to get a high signal-to-noise wavefront measurement. Predictive control can mitigate the bandwidth error without reducing the wavefront sensor exposure time, by predicting the wavefront of the system one step into the future. While some atmospheric turbulence will always be stochastic, the bulk motion is accurately represented6 by the simple Frozen Flow Hypothesis,7 wherein we imagine static phase screens translating across the telescope pupil at the velocity of their associated wind layers. It is therefore reasonable to conclude that previous measurements of the wavefront contain information that can be used to predict the future shape of the wavefront.\nWith this work, we focus on two disparate predictive control methods: empirical orthogonal functions1 (EOF), as a method that depends purely on data to find linear relationships through time and space, and predictive Fourier control2 (PFC) , which uses data to identify wind layers in a system and inform a prediction with those layers. As two solutions to the same problem, the performance of EOF and PFC have yet to be directly compared. With this paper we will study their performance over simulated atmospheric data and saved on-sky telemetry from the W.M. Keck Observatory.\nIn sections 2 and 3, we introduce empirical orthogonal functions and predictive Fourier control as two methods of prediction and present their mathematical formalism. In section 4, we examine the performance of these methods, using residual wavefront error, Strehl, and the stability of the correction as metrics to evaluate their performance, and discuss the comparative performance of the two predictors. In section 5, we make conclusions and discuss next steps for testing these methods on the Santa Cruz Extreme AO Laboratory (SEAL) testbed."
        },
        {
            "heading": "2. EMPIRICAL ORTHOGONAL FUNCTIONS AS A DATA-DRIVEN PREDICTOR",
            "text": "Empirical Orthogonal Functions (EOF)1 looks for linear relationships in the evolution of the wavefront over time and space. EOF has been successfully run both in simulation,1 during day-time testing at Keck Observatory,8 as well as on-sky at the Keck Observatory9 and the Subaru Telescope.10 Here we will briefly summarize the math behind building and applying the EOF predictive filter; the mathematical formalism is taken from Guyon & Males (2017)1 unless specified.\nWe consider wavefront sensor data at time t, to be a collection of m points w(t) = [w0(t), ...wm\u22121(t)], that maps to modes (Fourier, Zernike, etc) or zones in the wavefront sensor. We then build history vectors of n of these wavefront sensor exposures each one system time lag apart, such that\nh(t) = \nw0(t) w1(t) ...\nwm\u22121(t) w0(t\u2212 dt)\n... wm\u22121(t\u2212 (n\u2212 1)dt)\n (1)\nWe build a predictive filter F, that when applied to a history vector will predict a future state:\nFh(t) =  w0(t+ dt)... wm\u22121(t+ dt)  (2) To calculate F we build a matrix D which contains a series of history vectors used for training data, and we compare to a matrix P which pairs each history vector at time t to its future state at time t + dt. From there we calculate the filter F as a simple minimization:\nminF||DTFT \u2212PT ||2 (3)\nIn a departure from Guyon & Males (2017),1 we solve this with a least squares pseudo-inversion,8 with a regularization constant \u03b1 (which we set to \u03b1 = 1 for simulations.)\nF = ((DT )\u2020PT )T (4) F = PDT (DDT + \u03b1I)\u22121 (5)\nWe found that using 60000 history vectors of training data and history vectors made up of 3 exposures provided a consistent correction (apart from the 7 m/s layer, see further discussion in Section 4.3), a result also found by Jensen-Clem (2019),8 and used these parameters for our prediction performance estimates."
        },
        {
            "heading": "3. PREDICTIVE FOURIER CONTROL AS A MODEL-DRIVEN PREDICTOR",
            "text": "Predictive Fourier control (PFC)2 uses data to extract information about wind layers from the system, and then builds a predictive filter informed by those wind layers, as an update to a traditional Linear Quadratic Gaussian controller.11,12 By definition, the predictor starts with no knowledge of the wind speed or direction. Here we will briefly summarize the math behind building and applying the PFC predictive filter; the mathematical formalism is taken from Poyneer (2007)2 unless specified. (Further details are available in Appendix A.)\nIn short, PFC consists of 4 main steps:\n1. Decompose turbulent phase screens into complex spatial Fourier modes. Each Fourier mode becomes a separate control problem and a filter is calculated individually for each coefficient. For each coefficient:\n2. Make a power spectral density (PSD) function by looking at how a single coefficient evolves in temporal frequency space.\n3. Isolate and fit peaks in the PSDs (which map to wind layers in an atmosphere).\n4. Feed the coefficients of each fit to a Kalman filter.\nFrom the perspective of a telescope system (under a Frozen Flow assumption7), wind layers will present as static turbulent scenes crossing over the telescope primary mirror at the speed of the wind at that height. Given enough data in time to adequately sample a wind velocity, these pupil crossing times will have high signal to noise peaks across spatial Fourier modes, as different spatial scales will cross with different frequencies. Therefore, when turbulent phase screens are decomposed into Fourier modes, each coefficient contains information on a spatial frequency of a particular size that maps to a series of non-conflicting controllers. A PSD for each coefficient reveals the peak frequency, height, and width for each wind layer, which provides input to a controller specific to that coefficient.\nAt a given Fourier mode indexed (k, l) (over wavefront sensor subapertures), a peak at some \u03bd indicates a velocity (vx, vy) component of:\n\u03bd = \u2212 (kvx + lvy) D\n(6)\nwhere D is the telescope diameter. While in practice, the algorithm is not meant to deliver identifications of wind-layers in a system, testing the wind identification on simulated known atmospheres shows recovery of both single and multi-layer wind layers. Figure 1 shows examples of successful recovery of rejected wind layers. See Appendix A for some exploration of less optimal peak recovery and a discussion of potential causes.\nPeaks can be identified and fit using built-in scipy tools (see Appendix A for further details.) Also present in each PSD is a peak that occurs at \u03bd = 0, due to a 0 Hz frequency peak (DC peak) from the Fourier transform that builds the PSD.2 DC noise encapsulates the static offset in a system, which may be caused by consistent noise from electric components in a realistic system, or mean offset from zero for any distribution. Wind velocity peaks that occur near zero (in frequency space) are difficult to resolve, as they blend into the static DC peak. Further description of the minimum resolvable peaks and treatment of the DC peak is available in Appendix A.\nFor each peak, a height \u03c32, and placement (i.e., peak width and location in angular frequency space) \u03b1, are fit with\nP (\u03c9) = \u03c32\n|1\u2212 \u03b1 exp (\u2212i\u03c9)|2 (7)\nThe complex term \u03b1 is expressed \u03b1 = |\u03b1|ei\u03c9, where \u03c9 encapsulates the actual wind velocity of each layer. (Without the complex phase, \u03b1 acts as a gain for a typical Linear Quadratic Gaussian controller without extracting and predicting based on wind layers.)\nThe fits for each \u03b1 and \u03c3 inform a Kalman filter, which in turn provides a prediction of each Fourier coefficient. We predict the state vector of our system\nx[t] = [ a(t) \u03c6(t+ 1) \u03c6(t) \u03c6(t\u2212 1) d(t\u2212 1) d(t\u2212 2) ] (8)\nwhere a encapsulates the fit parameters, \u03c6 are the wavefront states, and d are commands to the deformable mirror. We predict the next iteration with:\nx(t) = (I\u2212KC)Ax(t\u2212 1) + (I\u2212KC)Gd(t\u2212 1) + Ky(t) (9)\nwhere K are the Kalman gains, C is a control matrix, A is a covariance matrix, G is a matrix to update DM commands, d(t) holds DM commands, and y(t) holds noisy wavefront sensor measurements. For the full definitions and derivations of this Kalman filter see Appendix A, as well as the original treatment.2 Note that in our implementation, for ease of comparison with EOF, we rewrite the original control law so that we can apply it in open loop. Details of this update to the original form are described in Appendix A.\nWe found that using 10000 frames of data to build our PSDs and windows between 1024-2048 exposures provided a consistent correction (see Appendix A for further description of the windowing and its impacts), and used these parameters for our prediction performance estimates."
        },
        {
            "heading": "4. RESULTS",
            "text": ""
        },
        {
            "heading": "4.1 Simulated Single and Multi-Layer Turbulence",
            "text": "Using hcipy, the High Contrast Imaging package for Python,13 we simulated three test case atmospheres: two with single layer atmospheres with a wind speed of 7 m/s (split into vx, vy = 2.13, 6.67) and 14 m/s (split\ninto vx, vy = 2, 13.5), and one that included 8 layers according to a C 2 N and wind velocity study of Maunakea weather.14 The layers and heights from this profile are described in Table 1; all layers in the multi-layer simulation had a random direction assigned. For the purposes of this simulation we used an 8 meter primary mirror diameter, an r0 = 15cm at 500nm, simulated at a resolution of 48 by 48 pixels (which maps to an idealized wavefront sensor of 48 by 48 pixels), and evolved with a 0.5ms time step. This simulates a Gemini Planet Imager-like system, which was the instrument for the original PFC simulations.2 We consider an idealized wavefront sensor whose output is exactly the simulated 48 by 48 pixel phase screen at a given time step. I.e., we use a perfect wavefront sensor (there is no difference between the phase screen and the phase screen we sense) and a perfect deformable mirror (there is no difference between the phase screen we predict and the correction we apply) and focus only on how faithfully we can predict the wavefront given a choice of time delay.\nWe calculated residuals by subtracting the original simulated wavefront from the predicted wavefront in phase, and then calculate the root mean square (RMS) error at 500nm. For the sake of comparison, we also estimate the performance of a quasi-integrator, where we subtract the simulated phase from itself with a two-step delay (i.e., if the system could apply a perfect correction two steps behind.) For this initial implementation we found that edge effects could have a major impact on the residual error, so as an interim measure we calculated the RMS error only over the inner 7 meter diameter of phase correction. Figure 2 shows the results for the two predictors. For the 7 and 14 m/s single-layer turbulence examples, both predictors show improvement over the quasi-integrator, and EOF shows an advantage between the two predictors. Figure 4 shows a video of turbulence and residuals of the 14 m/s atmosphere evolving over time for the 10000 time step correction. Figure 3 shows the results for the multi-layer example, which again shows that both predictors out-perform the integrator, and\nan advantage to EOF between the two predictors (see Section 4.3 for further elaboration.)"
        },
        {
            "heading": "4.2 On-Sky Telemetry",
            "text": "Our telemetry data is from the Keck II AO system running in closed loop on the night of 04-20-2019, previously published in Jensen-Clem (2019).8 It consists of 120000 time steps of data (taken at \u223c 1.7ms intervals15) in the form of DM commands and near-IR pyramid wavefront sensor16 (installed in Keck II as part of the KPIC upgrade17) phase measurements in units of volts. Keck II is a 10 meter telescope, with a 21 by 21 actuator deformable mirror (we use the pyramid wavefront sensor\u2019s 21 by 21 reconstructed residuals to match.)\nAs we see only the residuals and applied commands in this system, we must first reconstruct the pseudo-open loop turbulence in microns with\nopen loop phase = (\u22121\u00d7 dm commands + wf residuals)\u00d7 0.6 (10) integrator residuals = (wf residuals)\u00d7 0.6 (11)\nThe 0.6 factor accounts for system gain and volt-to-micron conversion.8\nUsing data from the Maunakea Weather Center,18 we use the Canada-France-Hawaii Telescope (CFHT) to estimate the wind velocity at the ground layer from the two minutes of Keck telemetry that we use for this analysis. Figure 5 shows the median x and y velocity components from our portion of the night, alongside a peak identification of the ground layer wind velocity from telemetry data. We estimate the ground layer to be (vx, vy) = 1.07, 5.17m/s. DIMM-reported seeing on that night was \u223c 0.7\u201d, as opposed to MASS-reported seeing of \u223c 0.3\u201d.18 Because MASS measures free atmosphere, the discrepancy between the two values implies the turbulence that night was dominated by the ground-layer, making it a good candidate for improvement with predictive control. Using the DIMM value for seeing that night, we find r0 \u223c 15cm at 500nm.\nWe applied both predictors to reconstructed open-loop phase screens, calculated residuals by subtracting the predicted screen via each method from the reconstructed screen, and then calculated the root mean square error. Figure 6 shows the results for the two predictors. Both predictors show a \u2265 2 factor improvement over the on-sky integrator, and in a departure from simulated results, PFC shows a modest advantage between the two predictors. Figure 7 shows the turbulence residuals evolving over time; note features moving at a consistent velocity are still perceivable in the pseudo-open loop and integrator but give way to whiter noise in the two predictors, which implies our predictor is removing the linear trends imparted by wind layers."
        },
        {
            "heading": "4.3 Discussion",
            "text": "Table 2 compiles the residual wavefront error from each prediction method across each atmosphere and estimates (using the Marechal approximation19) the Strehl ratio achieved by the integrator as well as each predictor. Note that simulations are highly idealized, with no measurement error from the wavefront sensor or fitting error from the deformable mirror.\nFor every simulated atmospheric profile and on-sky telemetry we find that both predictors provide an im-\nprovement over a classic integrator. PFC provides a consistent improvement of 2-3 over the integrator, while EOF shows more variety. EOF succeeds more notably in picking out one extremely fast wind layer (the singlelayer 14 m/s atmosphere), but requires a longer training set (90000 frames of data) to find and remove the 7 m/s wind layer. In contrast, PFC performs consistently with only 10000 frames of training data. Both methods of predictive control also out-perform the integrator in the on-sky telemetry example, which is consistent with the results of Jensen-Clem (2019).8 For the on-sky telemetry, we find that PFC shows a greater improvement than EOF, in contrast with its performance over the simulated atmospheres. This may be indicative of the way a Kalman filter handles Gaussian noise (a Kalman filter carries the variance of a distribution in its covariance matrix through each iteration20), as opposed to the treatment of EOF as a purely linear filter. While EOF shows greater performance consistently over atmospheric simulation (which includes no measurement noise), the comparative performance over telemetry may better forecast lab and on-sky performance of the two predictors. However, between the two methods, EOF is less complex to implement, as evinced by the length of Appendix A."
        },
        {
            "heading": "5. CONCLUSIONS AND FUTURE WORK",
            "text": "In this paper we have compared an initial implementation of two predictors to examine their relative performance on both simulated data and on-sky telemetry. We find that both the data-driven predictor using empirical orthogonal functions (EOF) and the model-driven predictor using predictive Fourier control (PFC) provide a consistent improvement across every simulated atmospheric profile and the telemetry compared with the integrator. While EOF shows greater improvement than PFC over our three simulated atmospheres, PFC shows greater improvement than EOF over on-sky telemetry data, which may better correlate with future on-sky performance.\nFuture work will consist of further optimizing our implementation of these two prediction methods, including focusing on noise estimation and a more robust fit to the DC peak for PFC, and better training data and history vector length optimization for EOF. Finally, to build on our simulation work, we will implement these predictors as lab experiments on the Santa Cruz Extreme AO Laboratory testbed (SEAL).3 With this testbed, we will be able to apply realistic turbulence at spatial scales smaller than the resolution of our wavefront sensor (true to the physical nature of atmospheric turbulence) with a spatial light modulator Van Kooten (2022, in prep), correct with with a high-stroke 97 actuator ALPAO and a Boston kilo-DM, and do wavefront sensing with either a Shack-Hartmann or Pyramid wavefront sensor. While simulations are a core initial element of testing the performance of a method, we expect lab demonstrations will unlock key information about the application and performance of these two predictive control methods."
        },
        {
            "heading": "APPENDIX A. PREDICTIVE FOURIER CONTROL MATH IN DETAIL",
            "text": "In this Appendix, we fully describe the mathematical formalism for Predictive Fourier Control,2 as well as how we have implemented it, and any deviations from the original method. For consistency across EOF and PFC, all matrices are defined in the convention of m rows by n columns, in departure from typical control engineering conventions and the original formulation from Poyneer (2007).2"
        },
        {
            "heading": "A.1 Decomposition Into Complex Fourier Modes",
            "text": "We decompose each turbulent scene into complex Fourier modes. Given some mode (k, l), over some x by y pixel grid, each mode is defined by\nfk,l[x, y] = cos\n( 2\u03c0 kx+ ly\nN\n) + i sin ( 2\u03c0 kx+ ly\nN\n) (12)\nwhere N is the total number of modes. (Note that the original paper from Poyneer (2007)2 contains a typo in its casting of each cos/sin term as complex, which we do not duplicate.)\nFourier modes are meant to operate over square regions, and many telescope pupils are circular; both our Keck telemetry and simulations are over a circular pupil. Starting with a circular pupil embedded within a square grid, and applying a mask for the non-used elements to both the telescope pupil and the Fourier mode allows for a decomposition of the original turbulence image at near machine precision as mathematically proved in Poyneer (2005),21 and experimentally reproduced in this work.\nFigure 8 shows an example of a residual turbulent screen, a reconstruction of the same turbulent screen built with complex Fourier modes, the real component of a complex Fourier mode projected onto the same pupil, and the error introduced during this decomposition, on the order of 1 \u00d7 10\u221212, as compared to the phase of the original turbulence which has a median of \u223c 850nm (the ratio of which approaches the machine precision of Python.)"
        },
        {
            "heading": "A.2 Creating Power Spectral Densities and Identifying Peaks",
            "text": "To examine the coefficient for each Fourier mode, we take a periodogram in temporal frequency space. We use a Welch periodogram22 with a Hamming window, using scipy.signal.welch and scipy.signal.get window.\nWe use windows of n = 1024 or n = 2048, depending on the noise present in the data. Longer windows provide the ability to resolve peaks further from each other and from the 0Hz DC peak, but increase noise in the periodogram. For our smallest window, n = 1024 frames, our minimum resolvable frequency would be \u03bdmin = 1024\u00d7 tint = 2\u22120.6Hz, for our 0.5-1.7 ms resolutions in simulated data and telemetry. We do not record a peak as input to the Kalman filter unless it is \u03bdmin from 0, as well as other identified peaks.\nWe find the location of each peak in the data with scipy.signal.find peaks, and fit it with scipy.optimize .curve fit. Peak identification appears repeatable over single layer atmospheres (as shown in Table 3), though Figure 9 shows some examples of sub-optimal peak identification and fitting given known wind layers, which may be due to spectral leakage or scalloping.20"
        },
        {
            "heading": "A.3 Fitting \u03b1 and \u03c3",
            "text": "Each peak can be defined with the power law:\nP (\u03c9) = \u03c32\n|1\u2212 \u03b1e(\u2212i\u03c9)|2 (13)\nwhere \u03c32 describes the peak height for a given coefficient and complex \u03b1 = |\u03b1|ei\u03c9 describes the placement (i.e. peak width and velocity) of a given wind layer. \u03bd is a natural frequency space in Hz, whereas the phase \u03c9 describes angular frequency that goes with \u03c9 = \u22122\u03c0\u03bdtint, where tint is the time between each frame of data."
        },
        {
            "heading": "A.4 Building the State Vector and Covariance Matrix",
            "text": "In keeping with the traditional Linear Quadratic Gaussian (LGQ) control, we use a Kalman filter to predict forward the state of the system. While the original Poyneer (2007)2 paper describes a close-loop control law, we reformulate it to run in open loop, adjusting the covariance matrix A, as well as control matrix C. The original close loop law includes terms in A and C to subtract off a deformable mirror (DM) command. Our update renders the DM commands in the state vector unnecessary for the Kalman filter (which could impact\ncomputational performance), but in this initial implementation we keep them for simplicity in following the original math. We denote these changes in each matrix with an\u2217.\nThe state vector x is a vector of (L+6) elements that consists of\nx(t) = [ a(t) \u03c6(t+ 1) \u03c6(t) \u03c6(t\u2212 1) d(t\u2212 1) d(t\u2212 2) ] (14)\nwhere \u03c6(t) and d(t) map to the wavefront coefficient at each Fourier mode, and the command to the deformable mirror respectively. The system operates with a two-step time delay, and is centered one step off from the deformable mirror and one step off from the wavefront sensor in opposite directions. At the time of some system measurement y(t) taken at t = t0, the wavefront is at time t = t0+dt, and the deformable mirror has information from time t = t0 \u2212 dt; this is why we examine \u03c6(t+ 1), \u03c6(t) as compared to d(t\u2212 1), d(t\u2212 2).\na is a vector of (L+1) elements that encapsulates information on every identified wind layer at that coefficient.\na = (a0, a1, ..., aL) (15) a(t)L = \u03b1La(t\u2212 1) + w(t) (16)\nEach aL evolves according to a first order auto-regressive process, AR(1), 20 driven by the \u03b1L for a given wind layer and complex white noise w(t). The periodogram for each Fourier mode includes a direct current (DC) layer peak at \u03bd = 0, for which we include \u03b10 = 0.999 and \u03c3\n2 = max[P (\u03bd)], where P (\u03bd) is the PSD. (Future implementations could fit the \u03c32DC term in a way that is more physically relevant.)\nThe state vector x evolves according to the state equation:\nx(t+ 1) = Ax(t) + Gd(t) + Bw(t) (17)\nwith the (L+6) by (L+6) covariance matrix\nA =  R 0L+1x1 0L+1x1 0L+1x1 0L+1x1 0L+1x1\n11xL+1 0 0 0 0 0 01xL+1 1 0 0 0 0 01xL+1 0 1 0 0 0 01xL+1 0 0 0 0 0 01xL+1 0 0 0 0 \u2217 0\n (18)\nwhere (L+1) by (L+1) R holds the \u03b1L values on the diagonals such that\nR = Diag(\u03b10, \u03b11, ..., \u03b1L) (19)\nThe 1 by (L+6) DM update matrix is defined as G = [ 01xL+1 0 0 0 1 0 ] (20)\nFinally, an (L+6) by (L+1) noise propagator matrix\nB = [ IL+1xL+1 05xL+1 ] (21)\nThe measurement in the system is defined with\ny[t] = Cx[t] + v[t] (22)\nwhere v[t] is the measurement noise, which is assumed to be zero-mean Gaussian white noise, and 1 by (L+6) C is the control matrix C = [ 01xL+1 0 0 1 0 \u2217 0 ] (23)"
        },
        {
            "heading": "A.5 Steady State Solutions with the Algebraic Ricatti Equation",
            "text": "Instead of recalculating the Kalman filter at each step \u2013 which is quite computationally expensive, we opt to use the Algebraic Ricatti Equation (ARE),23 specifically with a discrete solver, as the covariance matrices will reach a steady-state solution. We use scipy.linalg.solve discrete are to calculate Ps. Poyneer (2007)\n2 outlines this equation as:\nPs = APsA H + BPwB H \u2212APwCH(CPsCH + Pv)\u22121CPsAH (24)\nwith Pv as a scalar variance of the white noise distribution and (L+1) by (L+1)\nPw = Diag(\u03c3 2 0 , \u03c3 2 1 , ..., \u03c3 2 L) (25)\nWe note that this use of the discrete ARE differs from the typical form in that it uses Hermitian conjugates of the known coefficient matrices A\u2192 AH and B\u2192 CH , and builds the noise term with Q\u2192 BPwBH .23,24\nFinally we calculate the Kalman gains (a vector of L+6 elements) for a given coefficient with:\nK = PsC H(CPsC H + Pv) \u22121 (26)\nwhich builds all of the pieces for the update equation to predict the next step:\nx(t) = (I\u2212KC)Ax(t\u2212 1) + (I\u2212KC)Gd(t\u2212 1) + Ky(t) (27)\nFrom the newly calculated state vector we pull the L+1st element as the prediction of the wavefront \u03c6(t+1)."
        },
        {
            "heading": "ACKNOWLEDGMENTS",
            "text": "Many thanks to Don Gavel, who gave up many days of his retirement to give me a crash course in control theory and help me untangle these fundamental papers, as well as Lisa Poyneer for advising me on ways to improve my implementation of Predictive Fourier Control.\nSome of the data presented herein were obtained at the W. M. Keck Observatory, which is operated as a scientific partnership among the California Institute of Technology, the University of California and the National Aeronautics and Space Administration. The Observatory was made possible by the generous financial support of the W. M. Keck Foundation. The authors wish to recognize and acknowledge the very significant cultural role and reverence that the summit of Maunakea has always had within the indigenous Hawaiian community. We are most fortunate to have the opportunity to conduct observations from this mountain."
        }
    ],
    "title": "Battle of the Predictive Wavefront Controls: Comparing Data and Model-Driven Predictive Control for High Contrast Imaging",
    "year": 2022
}