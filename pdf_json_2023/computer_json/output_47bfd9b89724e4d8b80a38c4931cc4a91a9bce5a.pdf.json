{
    "abstractText": "Computing absolute binding affinities by Streamlined Alchemical Free Energy Perturbation Ezry Santiago-McRae1\u2020, Mina Ebrahimi2,3,4\u2020, Jesse W. Sandberg1, Grace Brannigan1,5\u2021, J\u00e9r\u00f4me H\u00e9nin3,4\u2021 1Center for Computational and Integrative Biology, Rutgers University, Camden, New Jersey, 08102; 2Department of Physical Chemistry, School of Chemistry, College of Science, University of Tehran, Tehran 1417935840, Iran; 3Universit\u00e9 Paris Cit\u00e9, Laboratoire de Biochimie Th\u00e9orique, CNRS UPR 9080, 75005, Paris, France; 4Institut de Biologie Physico-Chimique \u2013 Fondation Edmond de Rothschild, PSL Research University, Paris, France; 5Department of Physics, Rutgers University, Camden, New Jersey, 08102",
    "authors": [
        {
            "affiliations": [],
            "name": "Ezry Santiago-McRae"
        },
        {
            "affiliations": [],
            "name": "Mina Ebrahimi"
        },
        {
            "affiliations": [],
            "name": "Jesse W. Sandberg"
        },
        {
            "affiliations": [],
            "name": "Grace Brannigan"
        },
        {
            "affiliations": [],
            "name": "J\u00e9r\u00f4me H\u00e9nin"
        }
    ],
    "id": "SP:acb0e828272fc5dd2c06c3289ea7d5cb70dfed71",
    "references": [
        {
            "authors": [
                "R Salari",
                "T Joseph",
                "R Lohia",
                "J H\u00e9nin",
                "G. Brannigan"
            ],
            "title": "A streamlined, general approach for computing ligand binding free energies and its application to GPCR-bound cholesterol",
            "venue": "Journal of chemical theory and computation",
            "year": 2018
        },
        {
            "authors": [
                "J Phillips",
                "T Isgro",
                "M Sotomayor",
                "E Villa"
            ],
            "title": "NAMD TUTORIAL. NIH Center for Macromolecular Modeling and Bioinformatics, Beckman Institute",
            "year": 2017
        },
        {
            "authors": [
                "J H\u00e9nin",
                "J Gumbart",
                "C. Chipot"
            ],
            "title": "In silico alchemy: A tutorial for alchemical free-energy perturbation calculationswithNAMD. see www ks uiuc edu/Training/Tutorials/namd/FEP/tutorial-FEP pdf for the NAMD",
            "year": 2017
        },
        {
            "authors": [
                "H Chen",
                "JDC Maia",
                "BK Radak",
                "DJ Hardy",
                "W Cai",
                "C Chipot",
                "E. Tajkhorshid"
            ],
            "title": "Boosting Free-Energy Perturbation Calculations with GPU-Accelerated NAMD",
            "venue": "Journal of Chemical Information and Modeling",
            "year": 2023
        },
        {
            "authors": [
                "J Phillips",
                "D Hardy",
                "J Maia",
                "J Stone",
                "J Ribeiro",
                "R Bernardi",
                "R Buch",
                "G Fiorin",
                "J H\u00e9nin",
                "W Jiang",
                "R McGreevy",
                "MCdR Melo",
                "B Radak",
                "R Skeel",
                "A Singharoy",
                "Y Wang",
                "B Roux",
                "A Aksimentiev",
                "Z Luthey- Schulten",
                "L Kale"
            ],
            "title": "Scalable molecular dynamics on CPU and GPU architectures with NAMD",
            "venue": "The Journal of Chemical Physics",
            "year": 2020
        },
        {
            "authors": [
                "W Humphrey",
                "A Dalke",
                "K. Schulten"
            ],
            "title": "VMD: visual molecular dynamics",
            "venue": "Journal of molecular graphics",
            "year": 1996
        },
        {
            "authors": [
                "MK Gilson",
                "JA Given",
                "BL Bush",
                "JA. McCammon"
            ],
            "title": "The statisticalthermodynamic basis for computation of binding affinities: a critical review",
            "venue": "Biophysical journal",
            "year": 1997
        },
        {
            "authors": [
                "Hamelberg D",
                "McCammon JA"
            ],
            "title": "Standard free energy of releasing a localized water molecule from the binding pockets of proteins: double-decoupling method",
            "venue": "Journal of the American Chemical Society",
            "year": 2004
        },
        {
            "authors": [
                "HJ Woo",
                "B. Roux"
            ],
            "title": "Calculation of absolute protein\u2013ligand binding free energy from computer simulations",
            "venue": "Proceedings of the National Academy of Sciences",
            "year": 2005
        },
        {
            "authors": [
                "M Ebrahimi",
                "J. H\u00e9nin"
            ],
            "title": "Symmetry-Adapted Restraints for Binding Free Energy Calculations",
            "venue": "Journal of Chemical Theory and Computation",
            "year": 2022
        },
        {
            "authors": [
                "Merski M",
                "Shoichet BK"
            ],
            "title": "The impact of introducing a histidine into an apolar cavity site on docking and ligand recognition",
            "venue": "Journal of medicinal chemistry",
            "year": 2013
        },
        {
            "authors": [
                "S Jo",
                "T Kim",
                "VG Iyer",
                "W. Im"
            ],
            "title": "CHARMM-GUI: A webbased graphical user interface for CHARMM",
            "venue": "Journal of Computational Chemistry",
            "year": 2008
        },
        {
            "authors": [
                "J Lee",
                "X Cheng",
                "JM Swails",
                "YeomMS",
                "PK Eastman",
                "JA Lemkul",
                "S Wei",
                "J Buckner",
                "JC Jeong",
                "Y Qi",
                "S Jo",
                "VS Pande",
                "DA Case",
                "CL Brooks",
                "AD MacKerell",
                "JB Klauda",
                "W. Im"
            ],
            "title": "CHARMM-GUI Input Generator for NAMD, GROMACS, AMBER, OpenMM, and CHARM- M/OpenMM Simulations Using the CHARMM36 Additive Force Field",
            "venue": "Journal of Chemical Theory and Computation",
            "year": 2016
        },
        {
            "authors": [
                "R Bernardi",
                "BhandarkarM",
                "A Bhatele",
                "BohmE",
                "R Brunner",
                "R Buch",
                "F Buelens",
                "H Chen",
                "C Chipot",
                "A Dalke",
                "S Dixit",
                "G Fiorin",
                "P Freddolino",
                "H Fu",
                "P Grayson",
                "J Gullingsrud",
                "A Gursoy",
                "D Hardy",
                "C Harrison",
                "J H\u00e9nin"
            ],
            "title": "NAMD User\u2019s Guide version 2.14",
            "venue": "Theoretical biophysics group, University of Illinois and Beckman Institute;",
            "year": 2020
        },
        {
            "authors": [
                "Shirts MR",
                "Chodera JD"
            ],
            "title": "Statistically optimal analysis of samples from multiple equilibrium states",
            "venue": "The Journal of chemical physics",
            "year": 2008
        },
        {
            "authors": [
                "JT Petroff",
                "NM Dietzen",
                "E Santiago-McRae",
                "B Deng",
                "MS Washington",
                "LJ Chen",
                "KT Moreland",
                "Z Deng",
                "M Rau",
                "JAJ Fitzpatrick",
                "P Yuan",
                "TT Joseph",
                "J H\u00e9nin",
                "G Brannigan",
                "WWL. Cheng"
            ],
            "title": "Open-channel structure of a pentameric ligand-gated ion channel reveals a mechanismof leaflet-specific phospholipidmodulation",
            "venue": "Nature Communications",
            "year": 2022
        },
        {
            "authors": [
                "J Hermans",
                "S. Shankar"
            ],
            "title": "The Free Energy of Xenon Binding to Myoglobin from Molecular Dynamics Simulation",
            "venue": "Israel Journal of Chemistry",
            "year": 1986
        },
        {
            "authors": [
                "Hermans J",
                "Wang LU"
            ],
            "title": "Inclusion of loss of translational and rotational freedom in theoretical estimates of free energies of binding. Application to a complex of benzene and mutant T4 lysozyme",
            "venue": "Journal of the American Chemical Society",
            "year": 1997
        },
        {
            "authors": [
                "S Boresch",
                "F Tettinger",
                "M Leitgeb",
                "M. Karplus"
            ],
            "title": "Absolute binding free energies: a quantitative approach for their calculation",
            "venue": "The Journal of Physical Chemistry B",
            "year": 2003
        },
        {
            "authors": [
                "Y Deng",
                "B. Roux"
            ],
            "title": "Calculation of standard binding free energies: Aromatic molecules in the T4 lysozyme L99Amutant",
            "venue": "Journal of Chemical Theory and Computation",
            "year": 2006
        },
        {
            "authors": [
                "G Fiorin",
                "ML Klein",
                "J. H\u00e9nin"
            ],
            "title": "Using collective variables to drive molecular dynamics simulations. Molecular Physics",
            "year": 2023
        }
    ],
    "sections": [
        {
            "text": "This LiveCoMS document is maintained online on GitHub at https://github.com/ jhenin/SAFEP_tutorial ; to provide feedback, suggestions, or help improve it, please visit the GitHub repository and participate via the issue tracker.\nThis version dated January 2, 2023\n*For correspondence: grace.brannigan@rutgers.edu (GB); jerome.henin@cnrs.fr (JH) \u2020These authors contributed equally to this work\u2021These authors played an equal role in supervising this work"
        },
        {
            "heading": "1 Introduction",
            "text": "In this tutorial we are principally concerned with computing the Absolute Binding Free Energy (ABFE) of a ligand to its receptor. While many methods of measuring free energies ex-\nist, alchemical Free Energy Perturbation (FEP) methodsmake use of the fact that, since the change in free energy is path independent, it can be calculated via an unphysical path. In the case of FEP, that unphysical path is defined by scaling the\n1 of 23\nA LiveCoMS Tutorial\nnon-bonded interactions of the ligand. In essence, the user can make a bound ligand \"disappear\u201d from the binding site, make it re-appear in the bulk solution, and calculate the corresponding free energy difference.\nWhile elegant and exact in principle, FEP calculations are often unwieldy in practice. One of the most stubborn challenges that most FEP implementations face is that the ligand must maintain the original bound configuration during decoupling, even as the very interactions that stabilize the bound configuration are weakened. Consequently, most schemes introduce restraints on the ligand to mimic the interactions that stabilize the bound ensemble. Such restraints further complicate the thermodynamic cycle, particularly if the restrained ligand cannot fully access the bound ensemble, introducing biases thatmust be accounted for through additional simulations. Thus, while many FEP schemes accelerate convergence, most do so in ways that require error-prone manual input and many hours of the user\u2019s time.\nStreamlined Alchemical Free Energy Perturbation (SAFEP) is specifically designed to make FEP calculations faster and easier for the user without sacrificing accuracy of the final free energy estimate. SAFEP reduces conceptual and computational complexity by replacing conventional rotational and translational restraints for stabilizing the ligand in the binding site with a single Distance-to-Bound-Configuration (DBC) coordinate as illustrated in Figure 3. SAFEP can also handle superficial binding sites in phase-separated bulk [1], which are particularly unwieldy with traditional FEP approaches. Statistically optimal FEP estimators require both decoupling and recoupling calculations; SAFEP uses Interleaved Double-Wide Sampling (IDWS) to extract both quantities from the same calculation, roughly halving the required simulation time. SAFEP makes extensive use of the Colvars Dashboard in VMD, allowing the user to easily measure collective variables, impose biases, and generate restraint configuration files from one interface. Finally, analysis tools and data visualizations are included in one Jupyter notebook allowing for comprehensive quality assurance along with the \u2206G calculation.\nFigure 1 depicts the thermodynamic paths at the heart of SAFEP. The desired quantity \u2206G\u25e6bind (red, left column) isequal to the sum of the steps in the SAFEP method (black, right column), as shown in equation 1.\n\u2206G\u25e6bind = \u2013\u2206G\u2217site +\u2206GDBC \u2013\u2206G\u25e6V +\u2206G\u2217bulk (1) This equation forms the basis for the steps that follow in this tutorial.\n\u0394G\u2218bind\n\u2212\u0394G*site\n\u0394GDBC\n\u2212\u0394G\u2218V\n\u0394G*bulk\n0\nLi ga\nnd in\nG as\nP ha\nse\nLigand Bound to Protein\n0\nLigand in Solution\nFigure 1. The SAFEP thermodynamic cycle. Computing the ABFEof a ligand bound to a protein (\u2206G\u25e6bind) is the ultimate goal. This isfound by computing the free energies of several, smaller perturba-tions: 1) decoupling the unbound ligand from the condensed phaseto the gas phase under no restraints (\u2206G\u2217bulk); 2) enforcing a restraintscheme (-\u2206G\u25e6V and \u2206GDBC ); and 3) coupling the ligand from the gasphase to its bound pose in the condensed phase (-\u2206G\u2217site) under theDistance from Bound Configuration (DBC) restraint. The free energycontribution of the volumetric restraint (\u2206G\u25e6V ) is calculated analyti-cally, while the other three contributions are calculated via simula-tion.The free energy of the top horizontal leg vanishes in SAFEP dueto design of the DBC restraint. See Appendix C for more details."
        },
        {
            "heading": "1.1 Scope",
            "text": "The following steps will walk the user through the calculation of an Absolute Binding Free Energy (ABFE) using a computationally affordable example (phenol bound to a mutant lysozyme), but we have written these steps to be straightforward to generalize to other systems. These exact steps have been tested thoroughly for this particular system. To facilitate generalization of the method to other systems, we have provided additional troubleshooting advice in Appendix F.\n2 of 23\nA LiveCoMS Tutorial\nMore detailed descriptions and justifications for each step are provided in the appendices. These appendix entries are also hyperlinked and referenced throughout the body of the tutorial. 1.2 Prerequisites 1.2.1 Background knowledge We assume familiarity with running classical MD with NAMD 2.14 or later. If this is not the case, please see the NAMD Tutorial [2]. The latter portions that involve analysis are less important for this tutorial. Useful, but not required, material on alchemical free energy perturbations can be found in \u201cInsilico alchemy: A tutorial for alchemical free-energy perturbation calculations with NAMD\u201d [3]. Finally, basic knowledge of VMD and Python will be required for data analysis and visualization. 1.2.2 Software requirements\n1. NAMD 2.14 or later. Support for GPU-accelerated alchemy with IDWS is expected to be available in NAMD 3a14, pending fixes. 2. VMD 1.9.4.a57 or later. Slightly older versions of VMD may be used, but will require manual update of the Colvars Dashboard. See the Colvars Dashboard README for more information on getting the latest version. 3. Python 3.9.12 or later 4. Jupyter 5. safep Python package and its dependencies:\n(a) Alchemlyb (b) Glob (c) MatPlotLib (d) Numpy 1.22 or later (e) Pandas (f) PyMBAR\nNAMDwill be used to perform simulations. GPU acceleration of restrained free energy perturbations are expected in NAMD3 alpha 14 (with CUDASOAintegrate off ) [4, 5]. System setup, trajectory visualization, and restraint definition will be carried out in VMD [6]. Data analysis and visualization will be handled by a Jupyter notebook with the above dependencies.\nHigh-performance computing resources are recommended, but not required. Sample outputs are provided for each step for users with limited compute resources or time."
        },
        {
            "heading": "1.3 Process Overview",
            "text": "Within the scope of free energy perturbations, absolute free energies of binding are typically calculated by the doubledecoupling method (DDM) [7\u20139]. In this method, pair interac-\ntions (non-bonded terms) between the ligand and the rest of the simulation box are gradually scaled to zero (decoupled) from both a bound state and an unbound, solvated state.\nIn order to maintain the ligand in its bound state, most current approaches introduce a series of rotational and translational restraints on the ligand, each of which requires calibration and an additional \u2206G correction. In contrast, SAFEP uses just one restraint: a flat well on the \"Distanceto-Bound Configuration\u201d (DBC). This minimizes both the number of parameters to be optimized and the number of simulations to be performed (See Appendix C for details).\nEquilibrium Simulation\nProtein-Ligand Setup\nDBC Analysis & Restraint Definition\nSite Decoupling\nDBC TI Calculation\nGas-Phase Ligand Setup\nBulk Decoupling\nSolvated Ligand Setup and\nEquilibration\nA\nB C D\nSample Data\nProvided\nE\nFigure 2. The overall SAFEP workflow. The dependencies in thisflowchart can be used to decide in what order steps can be per-formed, and which simulations can be run simultaneously. From topto bottom and left to right: 1) the ligand must be setup (as for classi-cal MD) in each of the three states (bound, solvated, gas phase) andminimally relaxed (white boxes); 2) a longer, unbiased simulation ofthe ligand-protein complex is necessary to sample the bound state(green box) which is used to determine the distribution of the DBC(orange box, Step A); 3) two FEP calculations and a TI calculation arecarried out (blue boxes, Step B, Step C, and Step D); and 4) the result-ing values are combined to get the standard free energy of binding(gray box; Step E). The thermodynamic cycle used for absolute binding free energies in SAFEP is seen in Figure 1 while the unknown values (black arrows) can be calculated by the simulations outlined in Figure 2. More precisely, the thermodynamic cycle (Fig 1) and the corresponding simulations (Fig 2) are broken into three main steps involving three simulation systems: 1) the ligand bound to the protein, 2) the ligand in the gas phase, and 3) the ligand in the bulk. The order of computations is unimportant so long as the end-points are defined consistently (e.g. the same temperature is used throughout and restraints are used consistently). For the sake of clarity, we have arranged the process linearly: Steps A and B are con-\n3 of 23\nA LiveCoMS Tutorial\ncerned with calculating \u2206G\u2217site; step C addresses the free en-ergy of the DBC (\u2206GDBC); step D measures \u2206G\u2217bulk; and stepE calculates an analytical correction (\u2206G\u25e6V ) and combines allthe preceding terms into the overall\u2206G\u25e6bind using Equation 1.\n4 of 23\nA LiveCoMS Tutorial\nReference Coordinates\nAlign to reference using protein fitting group\nMeasure ligand RMSD with respect\nto reference\nCalculation of the Instantaneous DBC\nA B C D\nFigure 3. The Distance-to-Bound-Configuration (DBC) coordinate. The DBC coordinate is used as a bias to prevent ligand dissociationduring uncoupling. The user specifies a subset of protein atoms as the fitting group (teal) and a subset of ligand atoms (red); also shownare the protein surface (gray) and remaining ligand atoms (black). A) User-specified reference coordinates for both protein and ligand. B)During simulation, both protein and ligand will drift from the reference coordinates (black dashed outline). C) In order to remove rotationaland translational diffusion of the protein from calculation of the DBC, Colvars aligns the system to the reference coordinates using only theprotein fitting group atoms. D) The DBC is the RMSD of the user-specified ligand atoms (solid) with respect to the reference coordinates(dashed)."
        },
        {
            "heading": "2 Protocol",
            "text": "The following steps demonstrate the SAFEP protocol applied to a computationally affordable example: calculating the binding affinity of phenol to a lysozyme mutant. For more details on the rationale behind this choice, see Appendix A.\nProcedure:\n1. Clone the SAFEP_tutorial repository to your local environment Tip: use --depth 1 to avoid downloading the entire commit history. git clone https://github.com/jhenin/SAFEP_tutorial.git --depth 1 2. Navigate to the cloned repo This is the starting path for all command line prompts in this tutorial. cd SAFEP_tutorial 3. Install the SAFEP package by running: pip install git+https://github.com/BranniganLab/safep.git 4. Tips: \u2022 All run.namd files contain a line that reads set useSampleFiles 0 . To use the sample data provided, set the value to 1. Otherwise, NAMD will use your inputs (provided they are named exactly as described in this document).\n\u2022 If you run VMD and your simulations on different computers, then you will need to manually edit paths later when you are running simulations. \u2022 Some simulations will take several days on a single core. To use 4 cores in parallel we have included the +p4 argument in the commands for the longer NAMD runs. This number may need to optimized for your particular compute resources. \u2022 Common settings used by multiple simulations are in common/common_config.namd, which is sourced by the individual configuration files. This simplifies the individual configuration files and ensures consistency between calculations, which is a critical part of any free energy method.\n5. Move on to Step A\n5 of 23\nA LiveCoMS Tutorial\nStep A: Sample the bound state and define the binding restraint\nAlchemical decoupling removes the interactions that stabilize the occupied ensemble. Consequently, during decoupling the ligand may spontaneously diffuse into the bulk. Therefore, we need to impose an external restraint to force the ligand to occupy the bound state throughout decoupling. With SAFEP we apply a single restraint on the Distanceto-Bound Configuration (DBC) collective variable as illustrated in Fig. 3. This restraint which is straightforward to define and relatively insensitive to small differences in parameters [1]. Its sole correction factor is calculated via Thermodynamic Integration later in this tutorial. Formore details about theDBC restraint see Appendix C and [1]. For a discussion of the merits in accounting for symmetry when computing the DBC of a small, symmetric ligand see Appendix C.2.2 and [10].\nRequired Input:\n\u2022 Structure file: common/structures/phenol_lysozyme.psf \u2022 Coordinate file: common/structures/phenol_lysozyme.pdb \u2022 Equilibrium trajectory: stepA_create_DBC/inputs/unbiased-sample.dcd"
        },
        {
            "heading": "Essential Output:",
            "text": "\u2022 DBC restraint parameters: stepA_alchemy_site/outputs/DBC_restraint.colvars"
        },
        {
            "heading": "Procedure:",
            "text": "0. Run standard MD of the occupied state. This simulation should be long enough (\u223c50 ns) for the ligand to explore the configuration space of the bound state. See Appendix A for more details. Note: For this tutorial, we have done this step for you and you may skip to the next step using the trajectory provided. 1. Define the Distance-to-Bound Configuration (DBC) Coordinate a. Open the Colvars Dashboard in VMD:\n\u2022 Open VMD. \u2022 Load the psf, pdb, and dcd files listed above under \"Required Input\". You may choose to load your own dcd if you completed Step 0.\n\u2022 From VMD\u2019s main window options select: Extensions\u2192Analysis\u2192Colvars Dashboard b. Create a DBC colvar:\n\u2022 Click New [Ctrl-n] to start editing a new collective variable. \u2022 Delete all sample text shown in the editor on the right-hand side. \u2022 Open the Templates\u2192colvar templates drop-down list and select DBC (ligand RMSD) to populate the editor with a template that now needs to be edited.\nc. Define the atom selection for the ligand atoms: (Fig. 3, red) \u2022 Delete atomNumbers 1 2 3 4 from the atoms block and leave your cursor on the now-empty line. \u2022 Select the left panel text box Editing helpers\u2192Atoms from selection text and enter resname PHEN and noh . \u2022 Press Enter or click Insert [Enter] to insert the new selection into the configuration text at your cursor.\nd. Identify equivalent, symmetric atoms: \u2022 In the rmsd block, add atomPermutation 1 5 3 9 7 11 12 . This indicates equivalence between ligand atoms listed in atomNumbers . That is, (5 and 3) and (9 and 7) are interchangeable. See the Colvars User Guide and Appendix C.2.2 for more details on symmetric DBC and atomPermutation .\ne. Define the atom selection for the binding site atoms: (Fig. 3, teal) \u2022 Delete atomNumbers 6 7 8 9 within the fittingGroup block and leave your cursor on the now-empty line.\n\u2022 Select the left panel text box Editing helpers\u2192Atoms from selection text and enter alpha and same residue as within 6 of resname PHEN . \u2022 Press Enter or click Insert [Enter] to insert the new selection into the configuration text at your cursor.\n6 of 23\nA LiveCoMS Tutorial\nf. Set the reference positions for the RMSD and alignment calculations: \u2022 In the initial RMSD block, before the atoms block, delete refpositionsfile reference.pdb # PDB or XYZ file (the first highlighted line in the figure below) and leave your cursor on that line.\n\u2022 In the left panel under Editing helpers , select the radio button \u25e6 refPositionsFile and click Pick File . \u2022 Select the phenol_lysozyme.pdb file you used as input for this section. This will insert a line in the dashboard text editor that indicates the file that will be used for the DBC reference coordinates. \u2022 Copy the line just inserted and replace the refpositionsfile line at the bottom of the atoms block (the second highlighted line in the figure below). This sets the same PDB file to be used for aligning to the protein frame-of-reference. \u2022 For NAMD builds older than October 31, 2022: change \"centerToReference\u201d and \"rotateToReference\u201d to \"centerReference\u201d and \"rotateReference\u201d respectively. \u2022 The colvar config editor should now look like the screenshot below with your file\u2019s path in place of the two highlighted lines.\ng. Save your edits: Click the Apply [Ctrl-s] button.\n2. Impose a restraint based on the DBC coordinate a. Determine the Upper Wall of the DBC restraint:\n\u2022 In the Plots and real-time visualizations panel of the dashboard, click Histogram . If you don\u2019t see such a button, you need to upgrade your VMD installation. See software requirements for more details. \u2022 From the histogram, estimate the the 95th percentile of the bound state\u2019s DBC coordinate. Use the cumulative distribution line graph as a guide. The value doesn\u2019t need to be precise. We selected 1.5 Angstroms. See Appendix C.2.2 for more details.\n\u2022 Write this value down; you will need it in the next step. b. Impose a flat-bottom harmonic potential:\n\u2022 Open the Biases tab on the Colvars Dashboard and click New bias [Ctrl-n] to create a new biasing potential. \u2022 Delete the default text. \u2022 From the bias templates: drop-down menu select harmonicWalls and click Insert [Enter] . \u2022 Modify the bias to match the following parameters:\n7 of 23\nA LiveCoMS Tutorial\ncolvars DBC\nupperWalls [the DBC\u2019s 95th percentile just identified]\nforceConstant 200\nThe force constant in this case is in units of kcal/(mol\u00b7\u00c52). The strength of restraint should be neither so great that it causes instabilities nor so weak that it fails to cleanly separate the bound and unbound ensembles.\nc. Save your edits: Click the Apply [Ctrl-s] button.\n3. Save the Colvars configuration to a file a. Click Save at the top of the dashboard b. Save your file to stepA_create_DBC/outputs/DBC_restraint.colvars\nNote that if you choose to use a different file name or path you will need to update the files in the next step with the new name.\nStep B: Decouple phenol from the protein via FEP\nIn this section we will calculate \u2206G\u2217site by decoupling the ligand from the protein binding site (and all other contents ofthe simulation box) using alchemical FEP. This FEP calculation is often the slowest to converge due to the relative rarity of the bound state compared to the unbound states. Throughout the simulation, we will maintain the ligand in the bound configuration relative to the protein by restraining the DBC coordinate as defined in the previous subsection.\nRequired Input:\n\u2022 Structure file: common/structures/phenol_lysozyme.psf \u2022 Coordinate file: common/structures/phenol_lysozyme.pdb \u2022 DBC restraint parameters: stepA_create_DBC/outputs/DBC_restraint.colvars \u2022 NAMD configuration file: stepB_alchemy_site/inputs/run.namd"
        },
        {
            "heading": "Essential Output:",
            "text": "\u2022 FEP configuration file: stepB_alchemy_site/outputs/alchemy_site.pdb \u2022 FEP trajectory file: stepB_alchemy_site/outputs/alchemy_site.dcd \u2022 FEP output file: stepB_alchemy_site/outputs/alchemy_site.fepout"
        },
        {
            "heading": "Procedure:",
            "text": "1. Specify which atoms will be decoupled using the pdb beta field a. Open VMD and load the psf and pdb files specified in \u201cRequired Input\u201d. b. Set and write beta values:\n\u2022 Open the Tk Console \u2022 Ensure that your Tk Console is in the correct directory: cd stepB_alchemy_site/outputs \u2022 Set the beta value of all atoms to 0: [atomselect top all] set beta 0 \u2022 Set the beta values of the ligand atoms to -1 for decoupling: [atomselect top \u201cresname PHEN\u201d] set beta -1 \u2022 Save as a pdb file: [atomselect top all] writepdb alchemy_site.pdb\n2. Perform the FEP simulation We have provided a configuration file for this FEP run: stepB_alchemy_site/inputs/run.namd. See the in-line comments in that file and Appendix B for a detailed description of the settings relevant to running FEP in namd. a. Run the decoupling FEP:\nEnter the following in your terminal window: 8 of 23\nA LiveCoMS Tutorial\ncd stepB_alchemy_site/inputs/\nnamd2 +p4 run.namd &> alchemy_site.log\nb. [Optional] Start Step C: If you have access to more compute resources, you can continue on to Step C while this FEP calculation is running. Don\u2019t forget to return to analyze these data once the simulation is complete.\n3. Analyze the trajectory a. Visually inspect the trajectory in VMD:\n\u2022 Open VMD. \u2022 Load the .psf (common/structures/phenol_lysozyme.psf ) and .dcd file(s) from the outputs of stepB. \u2022 Ensure that the ligand remains in a bound-like configuration for the duration of the simulation.\nb. Measure the restraint energy: \u2022 Open the Colvars Dashboard. \u2022 Click Load and import your DBC restraint file (DBC_restraint.colvars). \u2022 Open the biases tab, select the DBC restraint, and click Energy Timeline . \u2022 The restraint energy should remain near zero for several nanoseconds, then increase and reach a maximum in the second half of the simulation (when the ligand is fully decoupled). If this is not the case, see Appendix F.\nc. Calculate \u2206G\u2217site in the Jupyter Notebook: \u2022 Navigate back to the tutorial root directory. \u2022 Begin a Jupyter session and open the notebook titled SAFEP_Tutorial_Notebook.ipynb. \u2022 Follow the in-notebook prompts to parse your new fepout file (stepB_alchemy_site/output/AFEP2-02.fepout). By default, we use the sample output. Be sure to update the paths as indicated in the notebook:\n\u2022 Compare your outputs to the sample outputs found in Appendix B.3. Step C: Compute the DBC restraint free energy correction\nWe designed the DBC restraint so that it doesn\u2019t do any significant work in the fully coupled system. However, it does reduce the entropy of the fully decoupled ligand, which would otherwise be exploring an \u201cempty\u201d simulation box. We need to calculate the corresponding free energy cost sowe can correct for it. In this sectionwewill use Thermodynamic Integration (TI) to calculate \u2206GDBC; the free energy difference between a gas-phase ligand under DBC restraints vs a(spherical) volumetric restraint. For more details see Appendix D.\nRequired Input:\n\u2022 Structure file: common/structures/phenol_gas_phase.psf \u2022 Coordinate file: common/structures/phenol_gas_phase.pdb \u2022 NAMD configuration file: stepC_restraint_perturbation/inputs/run.namd"
        },
        {
            "heading": "Essential Output:",
            "text": "\u2022 Colvars configuration file: stepC_restraint_perturbation/outputs/DBC_Restraint_RFEP.colvars \u2022 FEP trajectory file: stepC_restraint_perturbation/outputs/RFEP.dcd \u2022 Colvars output file: stepC_restraint_perturbation/outputs/RFEP.colvars.traj"
        },
        {
            "heading": "Procedure:",
            "text": "1. Create coordinates upon which to base your restraints a. Get set up:\n\u2022 Open VMD. 9 of 23\nA LiveCoMS Tutorial\n\u2022 Open the Tk Console. \u2022 Open the Colvars Dashboard. \u2022 [Optional] Extract the phenol from the phenol-lysozyme complex by running the following in the tkConsole. Note: We have completed this step for you. The sample files can be found in common/structures. %cd common/structures\n%mol load psf phenol_lysozyme.psf pdb phenol_lysozyme.pdb\n%set ligand [atomselect top \"resname PHEN\"]\n%cd ../stepC_restraint_perturbation/outputs\n%$ligand writepsf phenol_gas_phase.psf\n%$ligand writepdb phenol_gas_phase.pdb\n\u2022 Load phenol_gas_phase.psf and phenol_gas_phase.pdb b. Define the gas-phase spherical coordinate:\n\u2022 In the Colvars Dashboard, click New [Ctrl-n] . \u2022 In the second line of the editor, replace the default name myColvar with COM . \u2022 Delete atomNumbers 1 2 and leave your cursor on that line. \u2022 Using the Atoms from selection text: tool in the left panel, enter resname PHEN and noh and click Insert [Enter] . \u2022 Get the geometric center of the heavy atoms by the following in the Tk Console: measure center [atomselect top \"resname PHEN and noh\"] \u2022 Set the atoms of group 2 to dummyAtom (x0, y0, z0) where x0, y0, and z0 are the coordinates of the geometric center of the ligand you just retrieved in the previous step. Your editor should look similar to the figure below. Note the inclusion of commas in the dummyAtom statement.\n\u2022 Save and close the colvar editor by clicking Apply [Ctrl-s] . c. Define the gas-phase DBC coordinate:\n\u2022 Click New [Ctrl-n] again. \u2022 In the second line of the editor, replace the default name myColvar with DBC . \u2022 Delete the default distance component distance{...} and leave your cursor on that line. \u2022 As before, add atomPermutation 1 5 3 9 7 11 12 to the rmsd block to define the ligand symmetry. \u2022 From the component templates dropdown menu select rmsd and click Insert [Enter] . \u2022 Delete atomNumbers 1 2 3 and leave your cursor on that line. \u2022 In the field labeled Atoms from selection text: enter resname PHEN and noh and click Insert [Enter] . \u2022 Add rotateReference off and centerReference off to the atoms block. \u2022 Replace the default refPositionsFile @ line using the \u25e6 refPositionsFile radio button and the Pick file button to select phenol_gas_phase.pdb. \u2022 Save and close the colvar editor by clicking Apply [Ctrl-s] . 10 of 23\nA LiveCoMS Tutorial\n2. Define the restraints a. Create the spherical restraint:\n\u2022 In the biases tab of the Colvars Dashboard, click New bias (Ctrl-n) and delete the default text. \u2022 From the bias templates dropdown menu, select harmonic walls and press Insert [Enter] . \u2022 Recall the upperWalls value you used for the DBC restraint in subsection 2.b from Step A. You will need this value in this and the next step. \u2022 Modify the bias to match the following parameters (see Appendix D): name distance_restraint\ncolvars COM\noutputEnergy on\nupperWalls [DBC upperWalls plus 1]\nforceConstant 200\n\u2022 Save and close the bias editor by clicking Apply [Ctrl-s] . b. Save the config file:\n\u2022 Click the Save button on the Colvars Dashboard. \u2022 Save the file as stepC_restraint_perturbation/outputs/DBC_restraint_RFEP.colvars.\nc. Create a DBC restraint that gradually releases: \u2022 We will use the provided setTI Tcl procedure. \u2022 Open stepC_restraint_perturbation/inputs/run.namd in a text editor \u2022 Find the block labeled \"COLVARS\" \u2022 Edit the input variables to match the following\ncvName DBC\nbiasType harmonicWalls\nupperWalls [DBC upperWalls as determined in step A]\ntargetForceConstant 200.0\nforceConstant 0.0\ntargetForceExponent 6.0\ntargetEquilSteps 500\ntargetNumSteps 300000\nnWindows 40\nreleaseFlag True\n3. Run the TI simulation a. Enter the following in your terminal:\ncd stepC_restraint_perturbation/inputs\nnamd2 +p1 run.namd &> DBC_FreeEnergy.log\nb. [Optional] Start Step D: If you have access to more compute resources, you can continue on to Step D while the TI calculation is running. Don\u2019t forget to return to analyze these data once the simulation is complete.\n4. Analyze the output If any of these checks fails, check the Troubleshooting section of the Appendices (Appendix F). a. Visually inspect the trajectory in VMD:\n\u2022 Open VMD. \u2022 Load the .psf, .pdb, and .dcd files associated with this tutorial step. \u2022 The ligand should initially fluctuate roughly in place at the start and gradually explore the COM restraint space as the DBC restraint is released.\nb. Check the collective variable trajectories: \u2022 Open the Colvars Dashboard \u2022 Click Load and open the Colvars configuration file DBC_restraint_RFEP.colvars \u2022 Select both the COM and DBC restraints\n11 of 23\nA LiveCoMS Tutorial\n\u2022 Click Timeline plot \u2022 Both coordinates should start low and gradually increase. The COM restraint should level out near its upperWalls restraint as shown:\nc. Calculate the \u2206GDBC in the Jupyter Notebook: \u2022 Open the Jupyter Notebook as in subsection 3.c from step B. \u2022 Ensure that the DBCwidth and COMradius variables are set to the exact values used in your simulations. \u2022 Run the first several cells at least until the first FEP analysis section. \u2022 Update the path in the section titled \"Process the DBC TI calculation\u201d to point to the directory containing your colvars.traj file.\n\u2022 Run all the cells in that section. Sample outputs and more details can be found in Appendix D \u2022 The output will include the \u2206GDBC in kcal/mol as well as an error estimate based on the analytical derivative ofthe free energy with respect to lambda. See the colvars documentation for more details.\nStep D: Decouple phenol from bulk solvent\nYou have completed one alchemical FEP calculation already, but double-decoupling or double-annihilation methods require two such calculations to close the thermodynamic cycle. We need to know the free energy of transferring the ligand from the binding site into vacuum, and from vacuum into the bulk. In this section we will calculate the latter term, \u2206G\u2217bulk , by decoupling the ligand from the bulk solution. If the solution is isotropic, no restraints are needed.The only points of concern are ensuring that the box is large enough that decoupling the ligand does not result in significant changes in volume or net charge.\nRequired Input:\n\u2022 Structure file: common/structures/phenol_water.psf \u2022 Coordinate file: common/structures/phenol_water.pdb \u2022 NAMD configuration file: stepD_alchemy_bulk/inputs/run.namd"
        },
        {
            "heading": "Essential Output:",
            "text": "\u2022 FEP configuration file: stepD_alchemy_bulk/outputs/alchemy_bulk.pdb \u2022 FEP trajectory file: stepD_alchemy_bulk/outputs/alchemy_bulk.dcd \u2022 FEP output file: stepD_alchemy_bulk/outputs/alchemy_bulk.fepout"
        },
        {
            "heading": "Procedure:",
            "text": "1. Specify which atoms will be decoupled using the pdb beta field a. Open VMD and load the psf and pdb files specified in \u201cRequired Input\u201d. b. Set and write beta values:\n12 of 23\nA LiveCoMS Tutorial\n\u2022 Open the Tk Console \u2022 Ensure that your Tk Console is in the correct directory: cd stepD_alchemy_bulk/outputs \u2022 Set the beta value of all atoms to 0: [atomselect top all] set beta 0 \u2022 Set the beta values of the ligand atoms to -1 for decoupling: [atomselect top \u201cresname PHEN\u201d] set beta -1 \u2022 Save as a pdb file: [atomselect top all] writepdb alchemy_bulk.pdb\n2. Run the ligand decoupling simulation in bulk solvent cd stepD_alchemy_bulk/inputs\nnamd2 +p4 run.namd &> alchemy_bulk.log\n3. Analyze the output a. Visually inspect the trajectory in VMD:\n\u2022 Open VMD. \u2022 Load the .psf, .pdb, and .dcd files associated with your simulation. \u2022 The ligand should diffuse normally at the start of the simulation but behave more and more like a gas-phase molecule.\nb. Calculate \u2206G\u2217bulk in the Jupyter Notebook\u2022 Open the Jupyter Notebook as in subsection 3.c from Step B. \u2022 Confirm that bulk_fep_path points to your files \u2022 Parse the .fepout file by running all the cells in the Jupyter notebook section titled \"Decoupling from Solvent\".\nStep E: Calculate corrections and combine quantities\nWe will now calculate \u2206G\u25e6V analytically. With this final piece of information, we can calculate the dissociation constantand estimate a titration curve based on the probability of occupancy assuming a two-state system: Pbind = [PHEN]Kd+[PHEN]where the dissociation constant, Kd = e(\u03b2\u2206G\u25e6bind). For additional information see Appendix E. Required Input:\n\u2022 Site FEP data: stepB_alchemy_site/outputs/alchemy_site.fepout \u2022 Restraint perturbation data (RFEP/TI): stepC_restraint_perturbation/outputs/RFEP.colvars.traj \u2022 Bulk FEP data: stepD_alchemy_bulk/outputs/alchemy_bulk.fepout"
        },
        {
            "heading": "Essential Output:",
            "text": "\u2022 \u2206G\u25e6bind\u2022 titration_curve.pdf"
        },
        {
            "heading": "Procedure:",
            "text": "1. Complete any unfinished analyses in previous steps (i.e. steps B.3, C.4., and D.3). It is especially important to examine the trajectories since numerically subtle biases are more obvious from the trajectory. 2. Open the Jupyter notebook and navigate to the section labeled \"Volumetric Restraint Contribution\u201d 3. Run the section to calculate the volumetric free energy contribution. See Appendix C.3 for a more detailed explanation.\nNote: At this point you will either need to have completed all simulations or use the sample data provided. To use the sample data, change the path variables ( bound_fep_path , restraint_perturbation_path , and bulk_fep_path) to use the files in their respective ./sample_outputs directories.\n4. Calculate the overall \u2206G\u25e6bind and compute a titration curve by running the cells in the section \"Binding Free Energy\".5. Compare your final \u2206G\u25e6bind to the literature value of -5.44 kJ/mol[11].6. Compare your titration curve to Figure 8 below in Appendix E.\n13 of 23\nA LiveCoMS Tutorial"
        },
        {
            "heading": "Appendix A System Selection and Setup",
            "text": "Lysozyme L99A/M102H (PDBid 4I7L) was chosen for several reasons. Lysozyme L99A/M102H is a small protein that binds a small, rigid molecule with reasonably high affinity which has already been measured experimentally. These properties make it well-suited as a model for prototyping and validating free energy calculation methods generally.\nBecause lysozyme is elongated, we save some computation time by using a narrower box. We avoid self-interactions by imposing a soft harmonic restraint on the protein\u2019s alpha\ncarbons provided in common/protein_tilt.colvars. The provided systems were prepared using CHARMM-GUI[12, 13] using a truncated lysozyme (PDBid 4I7L, residues ) and solvated using default parameters (TIP3P water, 0.15M NaCl). The production run uses largely default parameters and settings. The only notable exception is that WrapAll should be set to off . This is because wrapping across the PBC can cause unexpected results during analysis which can compromise the FEP and TI calculations."
        },
        {
            "heading": "Appendix B Running FEP in NAMD",
            "text": ""
        },
        {
            "heading": "Appendix B.1 Configuration Files",
            "text": "In addition to the configuration, forcefield, and structural files, running FEP in NAMD requires a particular pdb file (sometimes called a \"fep file\") that contains flags that indicate which atoms are being coupled or decoupled. This is usually indicated in the beta column as \u2019-1\u2019 for decoupling or \u20191\u2019 for coupling. All other beta fields should be 0.\nThe configuration file also contains some additional options that are detailed in the NAMD user guide [14] and described briefly in the provided configuration files. Whilemost of the settings should remain unchanged in a wide range of settings, there are a few exceptions.\nalchOutFreq determines the number of steps between collecting FEP samples. It should be set to a multiple of fullElectFreq to ensure accurate energy estimates. Later versions of NAMD should resolve this issue automatically, see Bug advisory and Workaround. Additionally the sampling frequency should be between 50 and 200 steps; sampling too frequently will result in bloated data sets of highly autocorrelated samples while sampling infrequently will result in too few samples to get a well-converged estimate of the change in free energy.\nalchVdwShiftCoeff controls the strength of the softcore potential which is essential to prevent \u201cend-point catastrophes\u201d in which one or more Lennard-Jones potentials diverge to infinity near lambda=0 or lambda=1. Higher values result in \"softer\u201d potentials but can introduce artifacts. For this reason, the alchVdwShiftCoeff should be kept between 5 and 8.\nalchEquilSteps hard-codes the time between starting a new lambda value and beginning to sample the ensemble. Alchemlyb and PymBARprovide functions thatwill downsample the data set using automated equilibration and autocorrelation detection schemes. We have found that automated equilibrium detection performs about as well as manually setting alchEquilSteps and autocorrelation is the bigger problem when trying to assess convergence. See [15] for amore detailed discussion of equilibrium detection, autocorrelation, and their effects on free energy estimation. See\n14 of 23\nA LiveCoMS Tutorial\nAppendix B.3 or the provided Jupyter notebook for more information on how these are applied to analysis.\ndeltaLambda is passed as a parameter to the runFEP function and determines the width of the lambda windows. Narrower windows will converge faster but will increase the total number of windows required to span \u03bb = 0 to \u03bb = 1. As a result, we need to empirically optimize the number and length of windows. See Appendix B.3 and Appendix F for more details on assessing and optimizing these parameters. The number and length of windows used here (\u223c 40 ns total simulation time) are a good starting point, but we have used as much as 400 ns for very flexible ligands in superficial binding sites[16].\nIDWS (interleaved double-wide sampling) tells NAMD to alternate between sampling the forward and reverse lambda directions (via the runFEP function, which sets the alchLambdaIDWS parameter). This should be set to \u201ctrue\u201d thus removing the need for independent forward and backward runs. Note that this may cause some correlation between forward and backward samples depending on the value of alchOutFreq ."
        },
        {
            "heading": "Appendix B.2 Parsing and Data Analysis",
            "text": "In this tutorial we have recommended using a Jupyter notebook for analysis. The first decision is whether or not to use Alchemlyb\u2019s equilibrium detection. In our experience it has made very little difference, but if you suspect poor equilibration it may be helpful. In the provided notebook, simply set detectEQ to True before reading in any data.\nAfter initial reading and parsing, you will see the estimated\u2206G\u2217site with standard error in the section labeled \"Get \u2206G.\u201d We provide conservative settings which (though not the most efficient) should result in good convergence for this system. As noted in the previous section, more complicated systems with more internal degrees of freedommay require much longer sampling and narrower lambda windows. In such systems, it is not uncommon for errors to be as high as 0.5 or 1kcal/mol. Errors larger than 1kcal/mol often indicate poor convergence and are likely to suffer from other issues (e.g. hysteresis). See Appendix F for more information on how to identify and resolve the underlying causes."
        },
        {
            "heading": "Appendix B.3 Interpreting the Figures",
            "text": "In this section we describe the contents andmeaning of each of the figures generated by the provided Jupyter notebook. See Appendix F for strategies to address discrepancies between your own results and those described here. An example of a well-converged calculation is shown in Figure 4.\nCumulative and per-window \u2206G curves (first and second panels of Figure 4) should be reasonably smooth. For typical lambda windows (1 to 3 ns), the magnitude of the\u2206G should\nbe less than a few kcal/mol per window. Sharp cusps and large jumps (especially near lambda 0.5) often indicate either insufficient samples or too-wide lambda windows.\nThe \u03b4\u03bb plots (third and fourth panels of Figure 4) are usedto diagnose hysteresis with respect to lambda. No value should be more than about 1 kcal/mol with a mean close to zero and an absolute skewness less than 0.5. Failure to meet any of these criteria indicates that one or more of the lambda windows has not, in fact, reached equilibrium or converged.\nFinally, the convergence plot should display two curves that meet quickly (before 0.5), and both curves should level out well before 1 like the example shown in Figure 5. If they are still changing at 1 or have gotten within 0.5 kcal/mol by \u03bb = 0.5, the system is unlikely to be converged at one ormore lambda values and the final \u2206G estimate is likely to be inaccurate.\n15 of 23\nA LiveCoMS Tutorial"
        },
        {
            "heading": "Appendix C Restraints",
            "text": "In the simulation where the ligand is decoupled from the site, restraints that keep the ligand from diffusing awaymust be applied. This serves two purposes:[17] first, it ensures that the long-time results of the free energy computation describe what we want, which is decoupling from the bound state; second, it accelerates convergence of the computation by limiting the space to be sampled. Thus binding restraints are essential both for estimating a well-defined free energy of binding, and for minimizing the statistical noise on that estimate. This is often achieved by layering several rotational and translational restraints on the ligand, which each must be accounted for by additional simulations[7\u20139, 18\u201320]. SAFEP, in contrast, uses just one restraint, the distance-tobound-configuration (DBC), that can be corrected for with a single TI calculation and a little analytical geometry[1]."
        },
        {
            "heading": "Appendix C.1 Flat-well Restraints",
            "text": "An ideal restraint for decoupling simulations would precisely separate the bound and unbound ensembles without modifying either. That is, it would be of the form:\nU(\u03be) = 0 , \u03be in the bound state\u221e , otherwise (2)\nThis singular potential, however, would create numerical instability in a molecular dynamics simulations. We, therefore, impose smoothed flat-well restraints which result in finite restorative forces when the system crosses the boundary betweenmacrostates, but leave the target ensemble essentially unmodified. Such restraints approximate square wells with the form:\nUFW(\u03be) = 12k (\u03be \u2013 \u03bemax)2 , \u03be > \u03bemax0 otherwise (3)"
        },
        {
            "heading": "Appendix C.2 The Distance-to-Bound",
            "text": "Configuration (DBC) Coordinate\nAppendix C.2.1 Definition of DBC The DBC is the root-mean-square deviation (RMSD) of a subset of ligand coordinates from a typical bound pose in the frame of reference of the binding site. In general, all heavy atoms can be included in the DBC, but larger, more flexible ligands may be better restrained using a narrower subset of atoms. This single, scalar coordinate captures any relative motion of the ligand with respect to the binding site as well as any conformational change of the ligand. To obtain a DBC restraint, we apply a flat-well potential defined by Equation 3 to a DBC coordinate. See Ref. 1 for details.\nAppendix C.2.2 Symmetric DBC One peculiarity of the model system used here is that the ligand, phenol, is symmetric. Although this isn\u2019t strictly problematic, it does require a little extra accounting. Although this case lends itself well to an analytical solution (an extra term of kT ln 2), a symmetric DBC is much more general and robust[10]. This is especially the case for very flexible ligands that would requiremuchmore complicated analytical corrections. The Colvars keyword atomPermutation can be used to define these symmetries:\n1. The easiest way to identify equivalent atoms is to label them. 2. Use the Graphics\u2192Representations interface to hide all atoms except the ligand. 3. Use the labeling tool to label the four symmetric carbons as shown:\n16 of 23\nA LiveCoMS Tutorial\n4. Open Graphics\u2192Labels... . 5. Select all four labels from the list by clicking and drag-\nging 6. Open the tab titled Properties and change the format\nstring to %1i 7. You may wish to adjust other settings in this menu to\nmake the labels more visible 8. Your view should now look something like the image\nabove with the serial number of each atom indicated. 9. In the Colvar config editorwindow, place your cursor on\nthe line before atoms { and add atomPermutation {11 7 3 1 5 9 12}\n10. Your console should now look like this: co lvar { name DBC_sym rmsd {\natomPermutation {11 7 3 1 5 9 12} atoms { atomNumbers {11 9 5 1 3 7 12}\n. . . These changes make atoms 7&9 and 3&5 equivalent for\npurposes of RMSD calculation."
        },
        {
            "heading": "Appendix C.3 Isotropic center-of-mass restraint",
            "text": "The center-of-mass (COM) restraint is used as the container into which the ligand is released during RFEP (Step C). It is created by using a flat-well restraint: Equation 3 where \u03be is the displacement of the ligand\u2019s center of mass. The free energy cost of imposing the COM restraint can be calculated analytically because we treat the ligand as a point particle in a well-defined volume (i.e. as an ideal gas). To get the free energy difference between the simulated volume and some arbitrary concentration L, we can use:\n\u2206GV (L) = \u2013 1\u03b2 ln[L\u00d7 VR] (4) Where VR = 43\u03c0r3R is the volume of a sphere of radius rR (theupper boundary of the COM restraint). [1] Recall that the width of the restraint is slightly (1 \u00c5) larger than the width of the DBC restraint to avoid any edge cases in which the DBC may be larger than the COM displacement. For the standard state, L = 1M and the effective radius, rR \u2248 7.3 \u00c5."
        },
        {
            "heading": "Appendix D Restraint free energy",
            "text": "calculation"
        },
        {
            "heading": "Appendix D.1 Restraint perturbation",
            "text": "simulation Although the DBC restraint, by design, does not affect the coupled state, it does modify the decoupled state, and this contributionmust be accounted for in the overall free energy estimation. To that end, we use the Colvars Module to run a simulationwhere theDBC restraint is removed progressively, and compute the free energy for that process. To make this computation more efficient, the ligand is not released into the whole simulation box, but it is kept confined in spherical volume VR. Be advised, MD simulation algorithms can pre-vent center-of-mass diffusion for thewhole system (inNAMD, zeroMomentum ). In RFEP, the ligand must be allowed to diffuse, so this option must be disabled."
        },
        {
            "heading": "Appendix D.2 Thermodynamic Integration and Analysis",
            "text": "As in FEP, restraint free energy perturbation (RFEP) scales certain energy terms and the associated forces using a perturbation parameter, \u03bb \u2208 {0, 1}. The main difference between FEP and thermodynamic integration (TI), is that FEP estimates finite free energy differences between \u03bb values while TI calculates the derivatives. This is possible because the force constant, k, depends directly on lambda:\nk\u03bb = k0 + \u03bb\u03b1(k1 \u2013 k0) (5) Where k0 = 0 is the force constant (forceConstant)when \u03bb = 0, k1 is the force constant constant when \u03bb = 1(targetForceConstant), and \u03b1 (targetForceExponent) is a tuning parameter that improves convergence of TI by making the energy a smoother function of \u03bb near \u03bb = 0.\nCombining Equations 3 and 5 and taking the partial derivative with respect to \u03bb yields:\n\u2202 \u2202\u03bb UFW(d) = 12\u03b1\u03bb\u03b1\u20131(k1 \u2013 k0)(\u03be \u2013 \u03bemax)2 , \u03be > \u03bemax0 , otherwise (6) Where k in Equation 3 is replaced by k\u03bb in Equation 5. In StepC, \u03be is replaced by d, the DBC, and \u03bemax is replaced by theupper wall of the DBC restraint, dmax. This is applied to thecolvars trajectory data in the Jupyter notebook section associated with Step C.\nNext, we estimate the free energy difference between the endpoints by summing over \u03bb \u2208 {0, 1}:\n\u2206G = 1\u2211 \u03bb=0 \u2329 \u2202U(\u03bb) \u2202\u03bb \u232a (7)\n17 of 23\nA LiveCoMS Tutorial\nFinally, the error in the final estimate is estimated using the standard deviation of each mean (as seen in Figure 7). A tighter estimate of the error can be obtained by running replicas for the TI calculation. Further details can be found in the provided configuration files and in Step C of the protocol."
        },
        {
            "heading": "Appendix E Concentration Dependence",
            "text": "and Non-Ideality While in this tutorial we have only used a single, infinitely dilute, concentration to calculate \u2206Gbind, SAFEP can also beused to predict concentration dependence in non-ideal and non-dilute solutions. Here we consider the underlying theory for interpreting such a calculation, and provide general suggestions for implementation.\nWe consider a \u201cunitary\u201d (single protein, single site[1]) system with m ligands in a volume V . The ligand concentration in this system is L = m/V . A DBC coordinate di can be definedfor each of them ligands, indexed by i.\nThe threshold on the DBC coordinate meaningfully divides the ensemble into two possible macrostates: occupied (one ligand occupies the site andm\u20131 ligands are in solution) and unoccupied (no ligands occupy the site and m ligands are in solution.) We formalize this here through the DBC \u201ctest function,\u201d which for an individual ligand i is a Heaviside step function of the form\n\u0398i = 1 , di < dmax0 , otherwise (8)\nThe instantaneous site occupancy \u0398occ is determined bywhether any of the m ligands occupy the site, given by the sum of all the individual test functions:\n\u0398occ = m\u2211 i=1\n\u0398i. (9) Since here we consider the case where the site can bind at most one ligand, \u0398occ is either 0 or 1.The partition functions for the occupied and unoccupied states are thus Zocc and Zunocc respectively, where\nZocc = \u222b\n\u0398occe\u2013\u03b2UdNr\u20d7 (10) Zunocc = \u222b [1 \u2013\u0398occ] e\u2013\u03b2UdNr\u20d7, (11)\nand the potential energy U is a function of the positions r\u20d7 of all N particles in the system, while \u0398occ is a function of theDBC coordinates d (and thus the positions of ligand and site atoms only).\nThe occupancy probability Pocc(L) is thus Pocc(L) = ZoccZocc + Zunocc = \u222b \u0398occe\u2013\u03b2UdNr\u20d7\u222b e\u2013\u03b2UdNr\u20d7 = \u27e8\u0398occ\u27e9 (12)\nwhich, as expected, yields the average occupancy \u27e8\u0398occ\u27e9.Each macrostate has an associated free energy: \u03b2Gocc = \u2013 ln Zocc (13)\n\u03b2Gunocc = \u2013 ln Zunocc, (14) where Gocc and Gunocc are the free energies of the occupiedand unoccupied macrostate respectively, so\nPocc(L) = e\u2013\u03b2Gocce\u2013\u03b2Gocc + e\u2013\u03b2Gunocc . (15) We turn now to connecting these quantities to a SAFEP calculation. In step D of the protocol, we decoupled one ligand from a bulk that contained m = 0 fully coupled ligands, for an infinitely dilute concentration of L = 0/V . We then extrapolated to the standard concentration using an ideal gas correction that assumes ideality.\n18 of 23\nA LiveCoMS Tutorial\nFor a ligand at finite concentration in a non-ideal bulk, it is not useful or necessary to standardize the free energy. Instead, we would carry out Step D at the finite ligand concentrations of interest (L = m/V > 0), and adjust Step E to calculate the unstandardized free energy \u2206Gbind(L) as follows:\n\u2206Gbind(L) = \u2013\u2206G\u2217site +\u2206GDBC \u2013\u2206GV (L) +\u2206G\u2217bulk(L) (16) where the volume per molecule in the bulk is V/m and thus\n\u2206GV = \u20131\u03b2 ln mVRV . (17) Since \u2206Gbind(L) = Gocc(L) \u2013 Gunocc(L)Equation 15 can be rewritten in terms of \u2206Gbind(L): Pocc(L) = 11 + e\u03b2\u2206Gbind(L) (18) Even for a non-ideal bulk, we may assume the excess chemical potential is unchanging for small changes in concentration. Thus we may perform ligand decoupling (step D) at finite concentration L, and use the ideal gas correction to predict occupancy for nearby concentrations L\u2032, as long as |L\u2013L\u2032| is small.\n\u2206Gbind(L\u2032) = \u2206Gbind(L) \u2013 1\u03b2 ln L \u2032\nL (19) Substitution of Equation 19 in Equation 18 yields the occupancy probability for concentration L\u2032:\nPocc(L\u2032) \u223c L\u2032L\u2032 + Le\u03b2\u2206Gbind(L) (20) Incidentally, for dilute L, Le\u03b2\u2206Gbind(L) = L\u25e6e\u03b2\u2206G\u25e6bind = Kd, andEquation 20 reduces to a form familiar to biochemists Pocc(L\u2032) = L\u2032L\u2032+Kd . In general, Equation 19 only holds if thechange in excess chemical potential is negligible between L\u2032 and the simulation concentration L. This assumption can be tested by running bulk decoupling (Step D) at both L\u2032 and L and checking that the resulting change in \u2206Gbulk is muchsmaller than the overall error. If we wish to calculate Poccover a wider concentration range where this assumption does not hold, we would need to explicitly calculate\u2206G\u2217bulk(L)for multiple simulation concentrations L and extrapolate to the intermediate concentrations, as in Ref. [1]."
        },
        {
            "heading": "Appendix F Troubleshooting",
            "text": "We have written this tutorial to be as robust as possible but also generalizable to other systems. In the process of applying these steps to your own system of interest, however, additional challenges may arise. When calculations fail to converge or appear to converge to unreasonable values, it can be difficult to discern what has gone wrong without simply starting over. We provide here some of the most common issues and their respective fingerprints as cautionary tales and troubleshooting tools. If you encounter a problem with running the tutorial as written and do not see your issue listed below, please contact us.\n\u2206Gbind"
        },
        {
            "heading": "Appendix F.1 Problems with Running; NAMD",
            "text": "crashes Alchemical FEP will make any instabilities in a system more apparent as well as introduce a few more possible sources of instability. Themost common problems are RATTLE errors and box size instability Appendix F.1.1 RATTLE Errors\nERROR: Constraint failure in RATTLE\nalgorithm for atom 593!"
        },
        {
            "heading": "Causes:",
            "text": "If the usual culprits (poor equilibration, long time steps, and over-aggressive RESPA settings) have been ruled out, the most likely causes of RATTLE errors during FEP are 1) toowide lambda windows and 2) a too-low soft-core potential exponent."
        },
        {
            "heading": "Solutions:",
            "text": "Lambda windows can easily be narrowed by reducing dLambda . Values between 0.05 and 0.005 give a good balance between efficiency and accuracy. Note, the shorter the windows, the more windows that will be run and the more CPU time required to complete the calculation.\nThe soft-core potential ( alchVdwShiftCoeff ) should be between 5 and 10. Although higher values are \"softer\u201d and so avoid end-point \"catastrophes,\u201d they are also prone to under-estimate energy differences. Appendix F.1.2 Box Size Instability\nFATAL ERROR: Periodic cell has become\ntoo small for original patch grid!\nPossible solutions are to restart\nfrom a recent checkpoint, increase\nmargin, or disable useFlexibleCell\nfor liquid simulation.\n19 of 23\nA LiveCoMS Tutorial"
        },
        {
            "heading": "Causes:",
            "text": "While classical MD is \"tolerant\u201d to small periodic boxes and aggressive barostats, combining these with FEP is particularly unstable."
        },
        {
            "heading": "Solutions:",
            "text": "First, the periodic box should be at least twice the solute size or twice the cutoff distance (whichever is longer) this will avoid self-interactions which can cause instabilities especially with charged solutes and during FEP decoupling. Second, at least with the Langevin barostat, slowing the piston dynamics can improve system stability but slows box relaxation. We use LangevinPistonPeriod between 75 and 200, and LangevinPistonDecay between 50 and 100. LangevinPistonDecay should always be about half LangevinPistonPeriod . See The NAMD UG for more details. [14]"
        },
        {
            "heading": "Appendix F.2 Problems with Results; Poor Convergence",
            "text": "Convergencewithin each step is a prerequisite to a good final estimate of\u2206G\u25e6bind. Large errors and internal inconsistenciesoften indicate poor equilibration or under-sampling of one or more ensembles. Each leg of a SAFEP calculation has unique challenges and edge-cases which we address below.\nIn general, convergence may be improved by increasing the simulation time for each lambda value. Appendix F.2.1 Local and Misleading Convergence In the case of very slow fluctuations or in the presence of metastable states, a FEP calculation may be converge locally and give a biased outcome. The best way to detect this is to runmultiple replicas as uncorrelated from one another as possible. In this tutorial, we include analysis of the protein-\nligand bound state ensemble because it directly affects the definition of the DBC. Simulation of the apo protein (without ligand in the binding pocket), however, can provide useful information about the decoupled end-point. In the case of lysozyme, for example, the binding pocket is frequently occupied by one or two water molecules. If the lysozyme binding pocket does not recover hydration once the ligand is fully decoupled during FEP, the calculation overestimates the strength of binding by up to 0.5 kcal/mol. This is a small error compared to the overall precision of the technique, but users should be aware that assessing endpoint hydration is particularly important for larger or more hydrated binding pockets. Appendix F.2.2 Step A: Define the DBC Symptom: Multimodal DBC Distribution\nCauses: There are three main causes of multimodal DBC distributions: 1) ligand unbinding, 2) multiple binding modes, and 3) multiple, nearby binding sites."
        },
        {
            "heading": "Solutions:",
            "text": "Use the Colvars Dashboard histogram tool to probe the conformations associated with each mode and decide which modes correspond to bound and unbound states.\nBound and Unbound modes\nIf all but one mode may be described as unbound, place the DBC restraint between the bound mode and the least unbound mode. Proceed with FEP.\nMultiple, indistinguishable bound modes\nSuch modes are a result of symmetric ligands and are best addressed using a symmetric DBC. See Appendix C.2.2 for more details.\nMultiple, distinguishable bound modes\nIf one or more bound mode(s) is meaningfully distinct from some other mode(s), select a representative frame for each class. These frames become reference poses for each binding \"site\u201d from which you must calculate \u2206Gsite, \u2206GDBC,and \u2206GV separately.\nAppendix F.2.3 Step B or D: FEP Calculations Symptom: DBC energy starts low and stays low"
        },
        {
            "heading": "Causes:",
            "text": "the DBC may be too wide/soft. The lambda windows may be too short to properly sample the decoupled ensemble."
        },
        {
            "heading": "Solutions:",
            "text": "First, watch the trajectory for any abnormal behavior; wide DBCs will often be obvious from the last several nanosec-\n20 of 23\nA LiveCoMS Tutorial\nonds of a FEP run because the ligand will move quickly around the box. Then see the DBC debugging list below. If the system passes all checks, try running \u03bb = 1 for longer to make sure the DBC restraint is functioning. Symptom: DBC energy is consistently greater than 0"
        },
        {
            "heading": "Causes:",
            "text": "This issue is most often due to too-narrow DBC restraints or mistakes in the Colvar definition."
        },
        {
            "heading": "Solutions:",
            "text": "This problem is harder to diagnose from the trajectory alone unless there are obviously over-restrained degrees of freedom in the ligand. Consult the DBC debugging checklist below. Symptom: Ligand Unbinding during FEP"
        },
        {
            "heading": "Cause:",
            "text": "The most likely cause of unbinding during FEP is a DBC restraint that is too broad or too weak."
        },
        {
            "heading": "Solutions:",
            "text": "Consult the DBC debugging checklist:\nDBC Debugging Checklist:\n\u25a1 Only the DBC restraint should be active during FEP (Step B) \u25a1 DBC restraint upper walls have the right value. (2.b) \u25a1 DBC restraint force constant is appropriate (100 or 200).\n(2.b) \u25a1 NO lower walls (2.b) \u25a1 If the Colvars configuration file contains a \"width\u201d key-\nword, it should be 1. See [21] and the Colvars user guide for more details. (2.b)\nSymptom: Very Large Hysteresis near \u03bb = 0.5 Hysteresis (\u03b4\u03bb) larger than 1 kcal/mol for any lambda windowsuggests poor convergence."
        },
        {
            "heading": "Causes:",
            "text": "Large hysteresis values are most often caused by: 1) insufficient equilibration, 2) short windows (less than a few hundred ps), or 3) wide windows (large d\u03bb)."
        },
        {
            "heading": "Solutions:",
            "text": "If the system is well-relaxed and equilibrated by the usual metrics (box size, pressure, temperature, etc.), then it is most likely that either the lambda windows are too short or too wide. Try increasing the sampling time or increasing the total number of windows. The we have had good results with 120 windows of 3 ns each but longer may be necessary for particularly unwieldy systems. Symptom: Very Large Hysteresis near \u03bb = 0 or \u03bb = 1"
        },
        {
            "heading": "Causes:",
            "text": "Large hysteresis near the end-points of the FEP calculation are most commonly caused by so-called \u201cend-point catastrophes.\u201d See The NAMD UG for more details. [14]"
        },
        {
            "heading": "Solutions:",
            "text": "The first parameter to check is alchVdwShiftCoeff . As noted above, it should be between 5 and 8. If this is already the case, and no other part of the calculation is problematic, try doubling the number of windows between the window with large hysteresis and the nearest end-point. Symptom: Hysteresis Oscillates or is Otherwise Correlated with \u03bb As noted above, \u03b4\u03bb should be independent of lambda with amean of 0."
        },
        {
            "heading": "Causes:",
            "text": "Some versions of NAMD have a bug that allows FEP data to be written on a step without energy calculations. This results in the use of stale energies (from a previous step) and inaccurate estimates for differences in energy."
        },
        {
            "heading": "Solutions:",
            "text": "Manually ensure that alchOutFreq is a multiple of both fullElectFrequency and nonbondedFreq . See Bug advisory and Workaround for more details.\nAppendix F.2.4 Step C: TI Calculation The DBC restraint should do the most work early in the TI calculation then, as the force constant is scaled out, the COM restraint should take over and keep the center of mass in a well-defined volume. TI convergence issues are most easily diagnosed by watching the MD trajectory and examining the colvar trajectories.\n21 of 23\nA LiveCoMS Tutorial\nSymptom: The collective variable trajectory is abnormal"
        },
        {
            "heading": "Causes:",
            "text": "Strange behavior is expected if you over-write the sample outputs and attempt to run with useSampleFiles set to 1. The example above is the result of a mismatch between the coordinates used to determine the center of the COM restraint and the reference coordinates used for the DBC restraint."
        },
        {
            "heading": "Solutions:",
            "text": "Update the reference coordinates to match those used for determining the center of the COM restraint. That is, revisit Step C1.b paying special attention to the coordinates used. Make sure you save your files in the correct directories. Symptom: Restraint energies during TI are very high or very low and don\u2019t change much"
        },
        {
            "heading": "Causes:",
            "text": "The harmonic walls are likely too stiff or too soft."
        },
        {
            "heading": "Solutions:",
            "text": "Adjust the force constants to be between 100 (minimum) and 200. Symptom: The ligand doesn\u2019t move during TI (or moves very little)"
        },
        {
            "heading": "Causes:",
            "text": "The restraints are probably too narrow."
        },
        {
            "heading": "Solutions:",
            "text": "Double check the choice of wall position and ensure that it is correct in all Colvar config files. Symptom: The ligand flies away during TI (and the calculation doesn\u2019t converge)"
        },
        {
            "heading": "Causes:",
            "text": "The restraints are probably too wide."
        },
        {
            "heading": "Solutions:",
            "text": "Double check the choice of wall position and ensure that it is correct in all Colvars config files."
        },
        {
            "heading": "4 Author Contributions",
            "text": "ESM, ME and JWS ran, tested and refined the protocol. ESM wrote the notebook and analysis scripts. GB and JH designed and supervised the work. All authors wrote the document."
        },
        {
            "heading": "5 Other Contributions",
            "text": "The authors are grateful to Ms. Noureen Abdelrahman, Ms. Mariadelia Arg\u00fcello-Acu\u00f1a, Mr. Jahmal Ennis, and Mr. Connor Pitman for providing feedback and initial testing of this tutorial. The authors acknowledge the Office of Advanced Research Computing (OARC) at Rutgers, The State University of New Jersey for providing access to the Amarel cluster and associated research computing resources."
        },
        {
            "heading": "6 Potentially Conflicting Interests",
            "text": "The authors declare no potential conflict of interests."
        },
        {
            "heading": "7 Funding Information",
            "text": "We acknowledge financial support from the National Science Foundation DGE 2152059 (to ESM, JWS, and GB), the Ministry of Science, Research, and Technology of the Islamic Republic of Iran for a Ph.D. candidate research grant to ME, and the French Agence Nationale de la Recherche (ANR) for grant LABEX DYNAMO (ANR-11-LABX-0011-01, to JH).\nAuthor Information"
        },
        {
            "heading": "ORCID:",
            "text": "Ezry Santiago-McRae: 0000-0002-0930-8277 Mina Ebrahimi: 0000-0001-6204-5886 Jesse W. Sandberg: 0000-0001-7466-8466 Grace Brannigan: 0000-0001-8949-2694 J\u00e9r\u00f4me H\u00e9nin: 0000-0003-2540-4098"
        }
    ],
    "title": "Computing absolute binding affinities by Streamlined Alchemical Free Energy Perturbation",
    "year": 2023
}