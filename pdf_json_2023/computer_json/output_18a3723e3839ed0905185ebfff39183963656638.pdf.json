{
    "abstractText": "Gravitational wave (GW) standard sirens may resolve the Hubble tension, provided that standard siren inference of H0 is free from systematic biases. However, standard sirens from binary neutron star (BNS) mergers suffer from two sources of systematic bias, one arising from the anisotropy of GW emission, and the other from the anisotropy of electromagnetic (EM) emission from the kilonova. For an observed sample of BNS mergers, the traditional Bayesian approach to debiasing involves the direct computation of the detection likelihood. This is infeasible for large samples of detected BNS merger due to the high dimensionality of the parameter space governing merger detection. In this study, we bypass this computation by fitting the Hubble constant to forward simulations of the observed GW and EM data under a simulation-based inference (SBI) framework using marginal neural ratio estimation. A key innovation of our method is the inclusion of BNS mergers which were only detected in GW, which allows for estimation of the bias introduced by EM anisotropy. Our method corrects for \u223c90% of the bias in the inferred value of H0 when telescope follow-up observations of BNS mergers have extensive tiling of the merger localization region, using known telescope sensitivities and assuming a model of kilonova emission. Our SBI-based method thus enables a debiased inference of the Hubble constant of BNS mergers, including both mergers with detected EM counterparts and those without.",
    "authors": [
        {
            "affiliations": [],
            "name": "Samuel Gagnon-Hartman"
        },
        {
            "affiliations": [],
            "name": "John Ruan"
        },
        {
            "affiliations": [],
            "name": "Daryl Haggard"
        }
    ],
    "id": "SP:a9bd5ecd294dbfb2dddc41b85923b37f7c5f939a",
    "references": [
        {
            "authors": [
                "K. Cranmer",
                "J. Pavez",
                "G. Louppe"
            ],
            "title": "Approximating Likelihood Ratios with Calibrated Discriminative Classifiers, doi:10.48550/ARXIV.1506.02169, https://arxiv.org/abs",
            "year": 2015
        },
        {
            "authors": [
                "K. Karchev",
                "R. Trotta",
                "C. Weniger"
            ],
            "title": "SICRET: Supernova Ia Cosmology with truncated marginal neural Ratio EsTimation, doi:10.48550/ARXIV.2209.06733, https://arxiv.org/abs/2209",
            "year": 2022
        },
        {
            "authors": [
                "P. Kingma D",
                "J. Ba"
            ],
            "title": "Adam: A Method for Stochastic Optimization, doi:10.48550/ARXIV.1412.6980, https://arxiv.org",
            "year": 2014
        },
        {
            "authors": [
                "K. Miller B",
                "A. Cole",
                "G. Louppe",
                "C. Weniger"
            ],
            "title": "Machine Learning and the Physical Sciences: Workshop at the 34th Conference on Neural Information Processing Systems (NeurIPS",
            "year": 2020
        },
        {
            "authors": [
                "Raynal L",
                "Onnela J.-P"
            ],
            "title": "Selection of Summary Statistics for Network Model Choice with Approximate Bayesian Computation, doi:10.48550/ARXIV.2101.07766, https://arxiv.org/abs/2101",
            "year": 2021
        },
        {
            "authors": [
                "A Riess"
            ],
            "title": "A Comprehensive Measurement of the Local Value of the Hubble Constant with 1 km/s/Mpc Uncertainty from the Hubble Space Telescope and the SH0ES Team",
            "year": 2022
        },
        {
            "authors": [
                "H. Wahlquist"
            ],
            "title": "General Relativity and Gravitation",
            "year": 1987
        },
        {
            "authors": [
                "Radice"
            ],
            "title": "red and one blue (Metzger 2019), with opacities \u03bared and \u03bablue respectively. We use fiducial values of \u03bared = 10 cm2 g\u22121 and \u03bablue = 0.5 cm2 g\u22121, following the results",
            "year": 2018
        },
        {
            "authors": [
                "Nicholl"
            ],
            "title": "2021) assign \u03b1 a flat prior",
            "year": 2021
        },
        {
            "authors": [
                "Nicholl"
            ],
            "title": "2021) by setting \u03b8 = 45\u25e6. BNS mergers also produce an associated gamma",
            "year": 2021
        }
    ],
    "sections": [
        {
            "text": "Key words: transients: neutron star mergers \u2013 gravitational waves \u2013 methods: data analysis \u2013 cosmology: observations"
        },
        {
            "heading": "1 INTRODUCTION",
            "text": "The value of the Hubble constant, \ud835\udc3b0, is currently the subject of dispute as a \u223c5\ud835\udf0e tension exists between the latest late-time measurement using the cosmic distance ladder by the SH0ES Team (Riess et al. 2022) and the early-time value inferred from cosmic microwave background (CMB) anisotropies by the Planck satellite (Aghanim et al. 2020). Gravitational wave (GW) standard sirens provide an independent way to measure \ud835\udc3b0, and thus have the potential to resolve this dispute (Abbott et al. 2017b).\nGW observations of binary neutron star (BNS) mergers provide an estimate of the luminosity distance (\ud835\udc37\ud835\udc3f) of each merger through modeling of its GWwaveform. If the electromagnetic (EM) emission from the kilonova counterparts of the mergers are also detected, then theBNSmergers can be precisely localized, thus providing their cosmological redshifts through the host galaxy spectrum. Given a sample of BNS mergers with known redshifts and luminosity distances,\ud835\udc3b0 can be inferred. This approach is known as the standard siren method of inferring the Hubble constant (Schutz 1986;\n\u2605 samuel.gagnonhartman@sns.it\nHolz & Hughes 2005). The binary neutron star merger GW170817 was the first standard siren, providing a \u223c10% measurement of \ud835\udc3b0 (Abbott et al. 2017a,c; Soares-Santos et al. 2017; Abbott et al. 2017b; Hotokezaka et al. 2019). Forecasts predict that a 2% measurement of \ud835\udc3b0 can be achieved by combining a future sample of \u223c50 standard sirens (e.g., Dalal et al. 2006; Nissanke et al. 2010, 2013; Chen et al. 2018; Feeney et al. 2019).\nIn order for a standard sirenmeasurement to resolve the tension in \ud835\udc3b0, it must be free of systematic biases. Here, we seek to address twomajor sources of bias in standard sirens: GWanisotropy bias and EM anisotropy bias. The bias from anisotropic GW emission has been shown to inflate the value of \ud835\udc3b0 inferred from standard sirens (Talbot & Thrane 2020), and a method to mitigate these biases was presented by Gerardi et al. (2021) using a simulation-based inference (SBI) approach. An additional source of bias is introduced by observational selection effects owing to the anisotropic EM emission from the kilonova, as detailed in Chen (2020), and this additional bias was not addressed by Gerardi et al. (2021). In both sources of bias, the anisotropy of BNS merger emission produces a selection effect where mergers consistent with a high value of \ud835\udc3b0 are preferentially observed.\n\u00a9 2022 The Authors\nar X\niv :2\n30 1.\n05 24\n1v 1\n[ as\ntr o-\nph .C\nO ]\n1 2\nJa n\nCorrecting for bias introduced by a selection effect requires a careful understanding of the selection criterion itself (Vitale et al. 2021). Gerardi et al. (2021) corrected for GW anisotropy bias through modelling the dependence of successful GW detection on both BNS merger parameters and cosmological parameters, using general relativity (GR) and the GW detector\u2019s configuration. GR directly allows calculation of the strain and polarization breakdown of a GW produced by a BNS merger from that merger\u2019s measured parameters. Making a determination of detection on this GW further requires knowledge of the polarization sensitivity and strain detection threshold of the GW detector.\nWe extend this logic to EM anisotropy bias, using simulationbased inference (SBI) to characterize the EM selection criterion in a sample of BNS mergers. For an observed sample of BNS mergers detected in GWs, we expect to have bothmergers with identified EM counterparts and those without. Mergers without EM counterparts in the sample allow us to infer the probability of EM detection for a BNS merger, given its measured parameters and assuming a model for the EM emission. This allows us to characterize the dependence of EM selection on BNS and cosmological parameters, and thereby correct for the EM anisotropy bias in standard siren measurements of \ud835\udc3b0. The main innovation of our method is this inclusion of BNS mergers detected in GWs without detected EM counterparts.\nIn the absence of an analytic likelihood that includes both GW and EM selection effects, we intead opt for a SBI approach, where a BNS merger forward simulator enables emulation of both selection effects. SBI refers to a class of inference methods that rely on surrogate likelihood functions from a simulator forward model, enabling Bayesian inference even in situations where the likelihood function is intractable, such as ours (Cranmer et al. 2020). SBI methods typically function by simulating a data set from a set of input parameters, and then producing a summary statistic which describes the difference between the simulated data and the observed data. Through repeated sampling of the parameter space, these summary statistics are used to construct a surrogate likelihood function, and thus enable posterior inference.\nHere, we present an SBI-based method which corrects for both GW and EM anisotropy biases in standard siren measurements of \ud835\udc3b0. Our approach exploits our singular goal of inferring the marginal posterior distribution of \ud835\udc3b0, allowing us to treat all BNS merger parameters as nuisance parameters. Specifically, we use marginal neural ratio estimation (MNRE), in which a summary statistic is generated for each set of input parameters. The summary statistic is a quantity which encapsulates the consistency of the parameters drawn with the observed data. These summary statistics are then used as a training set for a neural ratio estimator network, which learns the marginal posterior distribution for \ud835\udc3b0, our parameter of interest (Miller et al. 2021).\nMNRE is a recently-developed SBI method which requires far fewer samples than competing methods to produce an informative posterior. It accomplishes this by estimating only marginal posteriors rather than joint probability distributions (Miller et al. 2021). MNRE is thus appropriate in situations where only marginal distributions are of interest, and the computational expense of each sample is high. MNRE has recently been applied by Karchev et al. (2022) in the context of Type Ia supernova cosmology, where it was used to marginalize over a large number of of supernova parameters. Similarly, our study is only interested in the marginal posterior distribution for \ud835\udc3b0, and thus MNRE is an ideal tool.\nTo test and validate our SBI-based approach on a mock data set, we assume a set of true BNS mergers with associated GW strains. Of these BNS mergers, only a subset have associated EM\ndetections. The expected kilonova light curves from the full merger sample is repeatedly simulated with randomly-sampled kilonova and cosmological parameter configurations, assuming a model for the kilonova emission, and the summary statistics from each round are used to train an MNRE. We demonstrate that by including GWonly mergers in a sample of BNS mergers, we can correct for the EM anisotropy bias latent within the sample. Our method provides a GW anisotropy bias correction level comparable to that in Gerardi et al. (2021), and further addresses EM anisotropy bias for standard siren cosmology.\nThe structure of this paper is as follows. Section 2 explains the physical cause of each source of bias. Section 3 discusses the mock data sets used in this study and the simulator. Section 4 provides a detailed discussion of our SBI-based method. Section 5 reviews results from each validation test performed on the mock data sets. We summarize and conclude in Section 6."
        },
        {
            "heading": "2 SOURCES OF BIAS",
            "text": ""
        },
        {
            "heading": "2.1 GW anisotropy and bias",
            "text": "GW detections of BNS mergers suffer from GW anisotropy bias, which results in standard siren measurements overestimating \ud835\udc3b0 (Malmquist 1922). This stems from the luminosity distance \u2013 inclination angle degeneracy of the GW strain produced from a BNS merger, which skews the inferred luminosity distance of a BNS merger in a way that is dependent on its inclination angle \ud835\udf04 (Wahlquist 1987). We illustrate this effect in Figure 1, where a series of BNSmergers evenly spaced in luminosity distance have their inferred luminosity distances and associated uncertainties shown for two possible inclination angles, one face-on and one oblique. Uncertainty in luminosity distance estimates from GW detections arises from the detector\u2019s polarization sensitivity (Cutler & Flanagan 1994). In Figure 1, we assume the characteristics of the Advanced LIGO/Virgo experiment as expected in O4 (Yi et al. 2022). Mergers placed at oblique inclinations have an inferred luminosity distance greater than their true value, while the opposite is true of mergers placed at face-on inclinations. This is because GW strain is strongest along the angular momentum axis of a BNS merger, and weakest perpendicular to this axis. A weak GW strain may be weak either because the merger is in fact very distant and face-on, or because the merger is nearby but at an oblique inclination, thus giving rise to the aforementioned degeneracy. An example of this luminosity distance-inclination angle degeneracy is shown in Figure 2, which displays the overlaid \ud835\udc43(\ud835\udc37\ud835\udc3f , \ud835\udf04) joint posterior distributions for 10 otherwise identical BNS mergers at different inclination angles.\nThis luminosity distance \u2013 inclination angle degeneracy would be unproblematic in the absence of selection effects. However, the amplitude of a GW strain curve is related to the probability that the merger\u2019s GW is detected at all. In order for a BNS merger to be detected, its strain must exceed some critical signal-to-noise ratio. Naturally, this is less likely for weak-strain mergers than for strongstrain mergers. The nature of this relationship is shown in Figure 3, where we show that face-on mergers are likely to be detected even at large distances, while oblique mergers are unlikely to be detected even at small distances. As a result, GWs from face-on mergers are preferentially detected in a sample of BNS mergers, biasing the luminosity distances to be nearer than their true values, and thus inflating the value of \ud835\udc3b0 as inferred from standard sirens.\nMNRAS 000, 1\u201314 (2022)"
        },
        {
            "heading": "2.2 EM anisotropy and bias",
            "text": "A second source of bias affecting standard siren measurements arises from anisotropy of the kilonova EM emission and its associated selection effect. We provide a brief explanation for this bias below, and its expected effect on \ud835\udc3b0. For a more in-depth discussion of the origin and nature of this bias, we refer to Chen (2020).\nBNSmergers produce an associated kilonova,whose EMemission enables multi-messenger standard siren cosmology. This emission primarily arises from \ud835\udc5f-process nucleosynthesis in the neutronrich ejecta of the BNSmerger. Simple kilonova models often invoke two ejecta components, a \u2018blue\u2019 polar component, and a \u2018red\u2019 equatorial component. The geometry of the emission from these components is schematically depicted in Figure 4. Following Nicholl et al. (2021) and Bulla (2019), we characterize this geometry using the\nblue component half-opening angle, \ud835\udf03. The exact value of this angle is uncertain, with Bulla (2019) estimating \ud835\udf03 = 30\u25e6 for GW170817 and Nicholl et al. (2021) suggesting that \ud835\udf03 = 45\u25e6 is an appropriate guess for all kilonovae.\nAs a result of the anisotropic EM emission from the kilonova, the inclination angle of a BNS merger influences whether or not the kilonova can be detected in EM telescope follow-up observations. When a BNS merger is detected in GWs but its kilonova is not discovered, the observer does not know whether the kilonova was missed due to excessive distance or inclination. This issue is illustrated in Figure 5, where kilonova light curves from a merger at a fixed redshift are produced for various assumed \ud835\udc3b0 and inclination angles. This figure demonstrates that identical BNS mergers can fail to produce a detectable EM signal due to either the assumed value of \ud835\udc3b0, or its inclination. As a result, this effect can cause the observer to preferentially discover face-on kilonovae in optical imaging follow-up searches. Since this EM anisotropy bias further enforces the discovery of standard sirens whose inferred luminosity distances are nearer than their true values, this again inflates the inferred value of \ud835\udc3b0. Thus, EM selection acts to exacerbate the already extant GW anisotropy bias in a sample of BNS mergers."
        },
        {
            "heading": "3 MOCK DATA SETS",
            "text": "To develop and validate our approach, we use a mock GW data set of sample of BNS mergers, as well as accompanying simulated EM light curves for a subset of these mergers for which the kilonova is detected. A GW detection provides three relevant BNS parameter distributions: (1) the joint luminosity distance \u2013 inclination angle distribution \ud835\udc43(\ud835\udc37\ud835\udc3f , \ud835\udf04), (2) the joint NS mass distribution \ud835\udc43(\ud835\udc401, \ud835\udc402), and (3) the GW sky localization \ud835\udc43(RA,DEC). An EM detection of the kilonova counterpart provides a redshift \ud835\udc67, and precise sky location (RA,DEC).\nFor each merger, the joint probability distribution for the inclination angle and luminosity distance is the related to the merger\u2019s true values by the relation\nMNRAS 000, 1\u201314 (2022)\n\ud835\udc51\ud835\udc5d(\ud835\udc63, \ud835\udc37\ud835\udc3f) = N ( \ud835\udc37\ud835\udc3f\n\ud835\udc370 )2 \u00d7 exp\n\u2212 1 2\u039421 ( \ud835\udc63\ud835\udc370 \ud835\udc37\ud835\udc3f \u2212 \ud835\udc630 )2 \u2212 1 2\u039422 ( \ud835\udc370 (1 + \ud835\udc632) 2\ud835\udc37\ud835\udc3f \u2212 1 + \ud835\udc6320 2 )2 \u00d7 \u0398(\ud835\udc37\ud835\udc3f/\ud835\udc370)\u0398 ( \ud835\udc37max \ud835\udc370 \u2212 \ud835\udc37\ud835\udc3f \ud835\udc370 ) \u0398(1 \u2212 \ud835\udc632)\ud835\udc51\ud835\udc63\ud835\udc51\ud835\udc37\ud835\udc3f , (1)\nwhere \ud835\udc63 = cos(\ud835\udf04) is the inferred cosine of the inclination angle, \ud835\udc37\ud835\udc3f is the inferred luminosity distance, \ud835\udc370 is the true luminosity distance, \ud835\udc630 = cos(\ud835\udf040) is the true cosine of the inclination angle, \u03941 and \u03942 are functions which encode the polarization sensitivity functions of the GW detector, \u0398 is the Heaviside step function, and \ud835\udc37max is an arbitrarily high distance which is treated as the cutoff for the probability distribution (Cutler & Flanagan 1994). In this study, we use a fiducial \ud835\udc37max = 6.5 Gpc. While the inclination angle is often marginalized over to convert this into a luminosity distance posterior distribution, it is important for us to leave them separate, as our goal is to discern the bias produced by the inclination angle.\nWe perform two kinds of validation tests, each depending on a different underlying mock sample of BNSmergers. The first class of tests are contrived tests, where the parameters of each BNS merger are conspicuously chosen to highlight a certain effect. For example, a sample of 100mergers may be placed at the same true distance and redshift, but eachwith different inclination angles, to exaggerate and test the effect of EM inclination angle selection bias. The second class of tests are cosmological tests, where the BNS parameters are simulated using GWToolbox, a toolkit for generating realistic GW source populations and their probability of detection with various GW instruments (Yi et al. 2022). In our cosmological tests, we treat all mergers as having been detected by LIGO/Virgo during O4.\nGWToolbox generates a set of true parameters for each merger, produces a strain curve from those parameters, and then verifies that the strain\u2019s signal-to-noise ratio (SNR) is high enough for themerger to be detected. If detected, the strain curve is then interpreted to produce BNS parameter estimates. In this study, we set the detection SNR to 8. Mergers generated using GWToolboxwill thus suffer from GW anisotropy bias due to the dependence of the probability of detection on luminosity distance and inclination angle, as illustrated\nMNRAS 000, 1\u201314 (2022)\nin Figure 3. This stands in contrast with the contrived mergers, where a sample of mergers is assumed to be detected regardless of their parameters, and is therefore not subject to GW anisotropy bias. Contrived mergers are therefore only useful in tests where EM-selection bias is considered independently of GW anisotropy bias.\nOnce a sample of GW mergers is produced through either method, the telescope follow-up imaging must be specified for each merger. In our simplest case, it is assumed that a telescope is always available for EM follow-up and it is always pointed in the right location in the sky to detect the kilonova. We also assume that the exposure depths of the images are the same for each merger. In this case, EM follow-up can only fail if the kilonova is too dim to be detected in the exposure depths of the images. A merger may be too dim either because it is too distant, or because its inclination angle is too oblique, thus giving rise to EM-selection bias. This method is employed for the contrived tests in this study.\nIn the more complex but realistic case, the precise sky localization of the BNS merger is considered. Given the true location of a BNSmerger on the sky and the telescope imaging pointings, there exists some probability that the merger lies outside all pointings and could not have been observed. Furthermore, even if the merger indeed lies within a pointing, the depth, time post-merger, and filter of that image, as well as the Galactic dust extinction at that sky location, must all be considered. This method is employed for the cosmological tests in this study.\nIn our validation tests including sky localization, we assume the same GW sky localization and EM follow-up for each merger. One test uses the GOTO-4 follow-up for GW190425 (Steeghs et al. 2022), which is a very incomplete follow-up tiling (having only 29% probability coverage of the GW localization region), while another uses the CFHT follow-up for GW 190814 to contrast with a deeper and more complete tiling with 64% probability coverage (Abbott et al. 2020a,b; Vieira et al. 2020).\nThe Galactic dust extinction at a BNS merger\u2019s sky location will also affect the probability of EM detection of the kilonova, as a kilonova in a sky region with high dust extinction is less likely to be detected than one in a region with low dust extinction. We use the Galactic dust maps of Schlafly & Finkbeiner (2011) through the dustmaps package. In contrived tests, wherein sky plane sampling is not considered, dust extinction is set to a fiducial value of \ud835\udc38\ud835\udc35\u2212\ud835\udc49 = 2.2.\nWhen evaluating whether or not a kilonova should be detected, its light curve must be generated. We generate kilonova light curves for each simulated merger from its BNS parameters using MOSFiT, a software package for astrophysical transient simulation (Guillochon et al. 2018; Nicholl et al. 2021). If the kilonova\u2019s magnitude is brighter than the exposure depth of the relevant telescope pointing, then the EM counterpart is detected. In this way, each BNS merger in the merger sample is evaluated and classified either as an \u2018EM+GW\u2019 merger (EM counterpart detected) or a \u2018GW-only\u2019 merger (EMcounterpart not detected). Leveraging information from both EM+GWmergers and GW-only mergers to correct for EM selection bias is a core feature of this study."
        },
        {
            "heading": "4 METHOD",
            "text": ""
        },
        {
            "heading": "4.1 The Case for SBI",
            "text": "In this section we discuss the insufficiency of traditional inference methods in accounting for EM and GW anisotropy biases. We begin\nby laying out the traditional approach to inferring parameters from sets of BNS mergers. To simplify this discussion, we neglect the inference of BNS parameters to focus solely on \ud835\udc3b0. Given a fixed catalogue of mergers, x, with estimates on \ud835\udc37\ud835\udc3f , \ud835\udc67, and \ud835\udf04, we may write the posterior distribution for \ud835\udc3b0 as\n\ud835\udc43(\ud835\udc67, \ud835\udc37\ud835\udc3f , \ud835\udf04, \ud835\udc3b0 |x) \u221d \ud835\udc43(\ud835\udc3b0)\n[?\u0304? (\ud835\udc3b0)]\ud835\udc41 \u00d7\n\ud835\udc41\u220f \ud835\udc56=1 \ud835\udc43(\ud835\udc67\ud835\udc56 |\ud835\udc67\ud835\udc56 , \ud835\udc3b0, \ud835\udc37\ud835\udc3f)\ud835\udc43(?\u0302?\ud835\udc3f,\ud835\udc56 , \ud835\udf04\ud835\udc56 |\ud835\udc37\ud835\udc3f,\ud835\udc56 , \ud835\udf04\ud835\udc56), (2)\nwhere \ud835\udc67\ud835\udc56 , ?\u0302?\ud835\udc3f,\ud835\udc56 , and \ud835\udf04\ud835\udc56 are the estimates of \ud835\udc67\ud835\udc56 , \ud835\udc37\ud835\udc3f,\ud835\udc56 , and \ud835\udf04\ud835\udc56 for each merger, ?\u0304? is the mean number of detected EM+GW mergers as a function of \ud835\udc3b0, and \ud835\udc41 is the number of EM+GW mergers in the catalogue (Mortlock et al. 2019). No analytic formula exists to produce ?\u0304? as a function of \ud835\udc3b0; for any given catalogue of mergers, each merger\u2019s luminosity distance and inclination angle influence both the probability of GW detection and the probability of EM detection, as discussed in Section 2.\nA brute force estimation of ?\u0304? for a given \ud835\udc3b0 requires generating the total number of mergers within a volume of space over some duration of time, and then determining which among them would be detected as a standard siren. The determination of detection requires simulating each merger in the catalogue and then comparing the expected GW and EM emission to both the response functions of the GWdetector and the telescope tiling of the localization region. Since each merger has a unique luminosity distance and inclination angle, the number of parameters influencing the number of detected mergers in a given sample, \ud835\udc41 , scales with the number of mergers included within that sample. Estimating ?\u0304? at a particular \ud835\udc3b0 furthermore requires a dense sampling of this parameter space, and an estimation of ?\u0304? (\ud835\udc3b0) requires dense sampling assuming various values of \ud835\udc3b0. Computational expenses mount as the required number of samples increases, rendering this approach prohibitively computationally expensive beyond a merger sample of more than a few mergers.\nWe therefore adopt an SBI approach to estimating ?\u0304? (\ud835\udc3b0). Within the SBI framework, we repeatedly sample the parameter space and simulate a sample of BNS mergers at each point. The mock observables from these \u2018forward simulations\u2019 enable inference of the parameter of interest, in this study, \ud835\udc3b0. We train a neural network to compare the mock observables to real data and thereby learn the parameter values underlying that data. Our method employs marginal posterior inference, completely bypassing calculation of the likelihood function and thus removing the need for explicit knowledge of ?\u0304? (\ud835\udc3b0) (Talbot & Thrane 2020)."
        },
        {
            "heading": "4.2 Layout of Approach",
            "text": "Our SBI method follows a six-step approach:\n(i) Draw parameter sample \u0398 (ii) Generate realistic observables, x|x0,\u0398 (iii) Summarize consistency of generated observables with data using a summary statistic S = \ud835\udc53 (x, x0) (iv) Repeat steps i-iii to produce data set (\u0398,S) (v) Intermediate processing to prepare data set for training (vi) Train neural network to infer the marginal posterior of \ud835\udc3b0 from (\u0398,S).\nBelow, we discuss each step in greater detail, proceeding in order from i to vi. Figure 6 displays a schematic of our approach.\nMNRAS 000, 1\u201314 (2022)\nIn step (i), the forward model gathers a sample of parameters from their relevant prior space. These parameters include the luminosity distances and inclination angles of each BNS merger, as well as \ud835\udc3b0. During tests considering the impact of telescope follow-up we also include the sky location, (RA,DEC). Table 1 summarizes the appropriate minimally-informative prior distributions.\nAfter gathering the parameter sample \u0398, the forward model generates the GW and EM observables for each event (step (ii)). Since training a neural network directly on kilonova light curves and\nmerger GWs is difficult, we introduced a data compression scheme to aid training convergence (for a similar example in cosmology, see Alsing et al. 2018). We perform this compression in steps (iii) and (v). Step (iii) computes the similarity between the simulated and actual observables, producing a quantity called the summary statistic S.\nIn step (iv), the forward model repeatedly samples parameter space and generates observables, thus producing a data set of input parameters,\u0398, and their associated summary statistics, S. This data\nMNRAS 000, 1\u201314 (2022)\nset, (\u0398,S), contains information on the posterior distributions of the input parameters, including \ud835\udc3b0. In this work, we train a neural network to reconstruct themarginal posterior distribution \ud835\udc43(\ud835\udc3b0) using the data set produced by the forward model. However, we found that the noise inherent to our choice of summary statistic hindered training convergence. We therefore apply intermediate processing in step (v), wherein we recast the data to a basis more amenable to training convergence. This transformation varies with the global quantities of the dataset (e.g., maximum and minimum), so we apply it after the completion of the sampling and forward modelling phase. Then, in step (vi), a marginal neural ratio estimator (MNRE) trained on these transformed data produces the marginal posterior distribution for \ud835\udc3b0."
        },
        {
            "heading": "4.3 Forward Model",
            "text": ""
        },
        {
            "heading": "4.3.1 Observable Generation",
            "text": "The forward model generates observable data, x, given a parameter vector, \u0398. Our input parameters consist of \ud835\udc3b0, an inclination angle \ud835\udf04 for each merger, and a luminosity distance \ud835\udc37\ud835\udc3f for each GW-only merger. The observables in this study consist of two parts: GW emission and EM emission.\nThe GW strain for a BNS merger provides a joint estimate for its \ud835\udc37\ud835\udc3f and \ud835\udf04. Example joint (\ud835\udc37\ud835\udc3f , \ud835\udf04) distributions are shown in Figure 2. For an EM+GW merger, the measured redshift \ud835\udc67 and sampled \ud835\udc3b0 specify a \ud835\udc37\ud835\udc3f . We then sample an inclination angle \ud835\udf04 from the corresponding conditional posterior distribution, \ud835\udc43(\ud835\udf04|\ud835\udc37\ud835\udc3f , \ud835\udc65GW), where \ud835\udc65GW represents the GW strain for that merger. Meanwhile, a GW-only merger lacks a measured redshift, leaving both \ud835\udc37\ud835\udc3f and \ud835\udf04 as free parameters to sample from the joint posterior distribution \ud835\udc43(\ud835\udc37\ud835\udc3f , \ud835\udf04|\ud835\udc65GW). Following these rules, the forward model fixes the parameters of all mergers in the sample prior to light curve generation. For a graphical representation, see the parameter generation panel of Figure 7.\nBefore generating light curves, we produce GW observables for each merger. The forward model uses GWToolbox to produce a GW strain and detection signal-to-noise ratio for each merger in the sample. We count the GW emission of a BNS merger as detected if the merger\u2019s SNR exceeds 8. Only GW-detected events contribute to parameter inference. Such events supply the GW-inferred joint posterior distribution for \ud835\udc37\ud835\udc3f and \ud835\udf04.\nThe forward model then generates realistic EM emission (kilonovae) for each GW-detected merger using the MOSFiT software package. MOSFiT uses a number of parameters to specify the features of a kilonova, for a detailed description of these parameters\nsee Nicholl et al. (2021).While we sample \ud835\udc37\ud835\udc3f and \ud835\udf04 from their prior distributions and pass those samples to the light curve simulator, we fix all other relevant parameters to fiducial values. Appendix A1 discusses our assumed values for the following kilonova parameters: the kilonova ejecta component opacities, \ud835\udf05red and \ud835\udf05blue, the neutron star masses, the disk ejection fraction \ud835\udf16disk, the blue ejecta enhancement factor \ud835\udefc, and the geometric parameters \ud835\udf03 and \ud835\udf03\ud835\udc50 , which respectively describe the half-opening angles of the blue ejecta component and gamma ray burst-shocked region."
        },
        {
            "heading": "4.3.2 Summary Statistic",
            "text": "The summary statistic S represents the similarity of the simulated observables with the observed data, x. Since the simulated observables are generated from the parameter sample \u0398, the summary statistic captures the consistency of \u0398 with x.\nFor samples where the simulated and observed data do not meet aminimum consistency threshold, we set the summary statistic to a minimum or \u2018null\u2019 value. We refer to such samples as \u2018noninformative\u2019 since they do not contribute positively to the inferred posterior density. Ourminimum consistency check ensures that only the correct mergers within a sample have detected EM counterparts.\nTo illustrate this \u2018minimum consistency check\u2019 with a basic example, consider a real set of 2 BNS mergers where 1 has a detected EM counterpart. Following our procedure, we sample a parameter sample from prior space and produce mock GW and EM observables from that sample. Should zero or both BNS mergers have detected EM counterparts, then we say that the simulated observables are completely inconsistent with the real data, and a null return is produced. Furthermore, if the wrong merger has a detected EM counterpart in the simulated data, then that is also completely inconsistent, producing a null return.\nFor samples where the minimum consistency threshold is met, we then assess the degree of consistency. We do this by comparing the sampled \ud835\udc37\ud835\udc3f and \ud835\udf04 to the (\ud835\udc37\ud835\udc3f , \ud835\udf04) joint posterior distribution inferred from each merger\u2019s GW signal. Appendix A2 discusses the exact form of this comparison, as well as our choice of minimum return for non-informative samples."
        },
        {
            "heading": "4.3.3 EM Follow-Up",
            "text": "We investigate how imperfect EM follow-up observation attempts influence our ability to correct for EM anisotropy bias. To motivate this, consider a scenario where we can image the full sky to some exposure depth in some filter for several days after a BNS merger is detected inGWs. In this scenario, the only cause for non-detection of the kilonova is the flux from the kilonova does notmeet the detection thresholds of the telescope images. Insufficient flux can only be explained by either the distance of the merger or its inclination, both features of the underlying BNSmerger. Therefore, the EMnondetection places some constraints on these BNSmerger parameters. The existence of these constraints allows for the correction of EM anisotropy bias.\nLet us now consider the case where a realistic telescope followup is performed. When a BNS merger is detected in GWs, LAL inference is used to localize its origin on the sky with a probability density map (Veitch et al. 2015). Telescope follow-up tiling of the localization region is not exhaustive, as they do not cover 100% of the sky, nor are the exposures always deep enough to guarantee kilonova detection. This introduces new failure modes for EM detection: the possibility that an merger was not within the field of\nMNRAS 000, 1\u201314 (2022)\nview of any images during the follow-up campaign, or the images were not of sufficient depth. For any given EM non-detection, it is therefore unclear whether the non-detected was due to factors intrinsic to the BNSmerger (\ud835\udc37\ud835\udc3f , \ud835\udf04) or factors relating to the telescope follow-up."
        },
        {
            "heading": "4.4 Intermediate Processing",
            "text": "We refer to the process of repeatedly simulating observables from parameter samples as a \u2018run\u2019 of the forward model. A run of the forward model produces a table of input parameter vectors, \u0398, and their associated summary statistics, S. These tables contain the information necessary to produce a marginal posterior distribution for \ud835\udc3b0.\nTo correct for EM anisotropy bias, we use information from GW-only mergers to estimate the bias implicit in EM+GW mergers. We do this by inspecting the shift in summary statistics when we include all mergers in the sample versus when the sample only includes EM+GWmergers. Our approach to EM anisotropy correction requires two full runs of the forward model. We refer to the process whereby we graft the output of one run onto the other as \u2018intermediate processing\u2019.\nIn the first run, the data set includes only EM+GW mergers, and the forward model generates a sample of EM+GW summary statistics called SS. In the second run, the data set includes GWonly mergers along with EM+GW mergers, and the forward model generates a second set of summary statistics called SGW. The null statistics in SS indicate \u0398 for which one or more mergers lack a detected EM counterpart. Meanwhile, the null statistics in SGW may also indicate\u0398 for which one ormoremergers erroneously have a detected EM counterpart. This additional constraint marginalizes over the EM selection effect, debiasing the \ud835\udc3b0 posterior prescribed by the summary statistics. However, the uncertainties in the GWonly mergers\u2019 redshifts produce greater scatter in SGW than in S\ud835\udc46 , effectively prescribing a much broader posterior distribution for\ud835\udc3b0. We therefore process both sets of summary statistics into a modified summary statistic setS\u2032, which possesses the unbiasedness ofSGW and a precision nearing that of SS. We discuss the details of this \u2018intermediate processing\u2019 step in Appendix A3."
        },
        {
            "heading": "4.5 Inference Model",
            "text": "The inference model learns the marginal posterior distribution of \ud835\udc3b0 from the set of input parameter vectors and their associated summary statistics produced by the forward model. We perform this inference using Marginal Neural Ratio Estimation (MNRE), a simulation-based inference approach (Miller et al. 2021). MNRE learns the marginal likelihood-to-evidence ratio for a parameter of interest from a set of training data consisting of input parameters and their associated model outputs. Appendix A4 describes in more detail neural ratio estimation, the operating principle behindMNRE.\nWe train the neural network using Adam (Kingma & Ba 2014) to minimize binary cross-entropy loss, as defined in Miller et al. (2021). Although MNRE tends to produce conservative posterior estimates once it converges, inappropriate selection of training hyperparameters often leads to convergence issues (e.g., Cranmer et al. 2015; Brehmer et al. 2018, 2019). To produce reliable posteriors in each training, we adjusted the learning rate schedule and other hyperparameters, as shown in Table 2. We implement MNRE using the swyft software package (Miller et al. 2020, 2022)."
        },
        {
            "heading": "5 RESULTS ON MOCK MERGER DATA SETS",
            "text": ""
        },
        {
            "heading": "5.1 GW-only Correction",
            "text": "In this test, 100 simulated BNS mergers were generated using GWToolbox assuming the realistic \u2018cosmological\u2019 parameter distribution discussed in Section 3. This sample of mergers suffers from GW anisotropy bias, as distant mergers are only detected if their inclination angles are nearly face-on. This is illustrated in Figure 8. For this test, the forward model was modified to not evaluate light curves at all, and to always assume that a GW-detected merger is also an EM+GW merger regardless of its luminosity distance or inclination angle. This is equivalent to assuming that all mergers lie within the field of view of a telescope with infinite exposure depth. The purpose of this modification is to ensure that GW anisotropy bias is corrected in the absence of EM anisotropy bias. In essence, this test is equivalent to the GW anisotropy bias correction test discussed in Gerardi et al. (2021).\nTwo sets of summary statistics are generated using this forward model. In one set, called Sb, GW anisotropy is not considered, and the full sample of 100 mergers are considered in each summary statistic. In the other set, called Sc, GW anisotropy is considered, so only a subset of the 100 mergers are considered in each summary statistic, and this subset varies in size and composition from one draw to the next. The first of these sets is used to produce a biased \ud835\udc3b0 posterior, while the second produces the corrected \ud835\udc3b0 posterior.\nThese posteriors are shown in Figure 8. The value of \ud835\udc3b0 predicted by the biased distribution is 70.54+0.73\u22120.69 km s\n\u22121Mpc\u22121, which indicates aGWanisotropy bias of 0.54+0.73\u22120.69 km s\n\u22121Mpc\u22121. The corrected distribution yeilds \ud835\udc3b0 = 70.09+0.69\u22120.76 km s\n\u22121 Mpc\u22121, which accounts for 83.33% of the bias. The bias in our distribution is within two standard deviations of the mean bias computed by Gerardi et al. (2021), indicating that our method for merger generation and bias measurement is consistent with their results. The degree to which our method corrects for the bias in \ud835\udc3b0 is also comparable to their results, which produce corrected distributions with biases consistent with 0 to the 1-\ud835\udf0e level."
        },
        {
            "heading": "5.2 EM-only Correction",
            "text": "In this test, 10 BNS mergers occur at the same luminosity distance and redshift. This distance is set to 135.9 Mpc, which has a corresponding redshift of 0.031 assuming \ud835\udc3b0 = 70 km s\u22121 Mpc\u22121. Each merger is identical except for its inclination angle, \ud835\udf04. Every neutron star is assumed to have a mass of 1.4\ud835\udc40 . The inclination\nMNRAS 000, 1\u201314 (2022)\nangles of themergers are evenly spaced in cos(\ud835\udf04), taking values from cos(\ud835\udf04) = 0.0 to cos(\ud835\udf04) = 0.9. Of these, only the three mergers with the lowest \ud835\udf04 are EM+GW mergers. By placing these mergers at the same distance and assuming their GW emission are all detected, we ensure that the only parameters which determine an merger\u2019s status as a standard siren are its inclination angle and \ud835\udc3b0. In this way, we probe EM anisotropy bias in the absence of GW anisotropy bias, and can thus investigate the degree to which our method uniquely corrects for EM anisotropy bias.\nIn determining the value of the bias, wemust compare themean of the inferred \ud835\udc3b0 posterior to some true value. While in strict terms the true value of \ud835\udc3b0 is that assumed in the generation of the BNS mergers, it is inappropriate to use this as the baseline for the bias since it is not necessarily the value which would be inferred if all 10\nBNS mergers were EM+GW mergers. Recall that EM anisotropy bias is the difference between the value of\ud835\udc3b0 inferred from a sample of EM+GW mergers and the value inferred a subset of those same mergers.\nThe biased and corrected posteriors produced in this test are shown in Figure 8. Both the biased and corrected distributions exhibit a long tail to high \ud835\udc3b0, which is due to the low inclinations of the three EM+GW mergers. Even after our correction scheme is applied, some small probability density is still applied to these high \ud835\udc3b0. The mean of the biased distribution is 70.17+1.31\u22121.36 km s \u22121 Mpc\u22121 while that of the corrected distribution is 70.01+1.18\u22120.75 km s\u22121 Mpc\u22121. The corrected distribution accounts for 94.12% of EM anisotropy bias. This is greater than the correction level achieved for GW anisotropy bias in both Gerardi et al. (2021) and the GW\nMNRAS 000, 1\u201314 (2022)\nanisotropy-only test presented in this work. The correction itself manifests as a suppression of high \ud835\udc3b0 values, as is expected from our approach to EM anisotropy bias correction (see Section 4.4)."
        },
        {
            "heading": "5.3 Combined Correction Tests",
            "text": "We performed five tests to gauge the ability of our method to simultaneously correct for EM and GW anisotropy bias. Each test considers the same sample of mergers used in the GW-only correction test, shown in Figure 10. In these tests, we vary the EM follow-up campaign specifications for the same 100mergers. In two of these tests, the EM follow-up campaign is assumed to have total sky coverage in the \ud835\udc67 band. The tests differ by the exposure depth assumed, which is 23.3 \ud835\udc5aAB in one and 25.0 \ud835\udc5aAB in the other. For each exposure depth, we also test how our method can correct for bias if a specific GW localization and follow-up campaign is assumed. We perform this using the GW localization of GW190425\nand its GOTO follow-up campaign (Steeghs et al. 2022). Each test and its specifications is laid out in Table 3."
        },
        {
            "heading": "5.3.1 C1 and C2",
            "text": "In C1 and C2, we test the ability of our method to correct for EM and GW anisotropy bias when the detection threshold for EM follow-up is set to 23.3\ud835\udc5aAB in the \ud835\udc67-band. Three posteriors are produced inC1. First, the EM+GW mergers are used to perform a biased inference on \ud835\udc3b0. Then an intermediate correction is performed by activating the GW anisotropy correction method in the forward model. The final posterior is fully-corrected, accounting for both GW and EM selection effects in the forward model. These posteriors are shown in purple in Figure 8.\nWe found that for this sample of EM+GWmergers, the biaswas negative, with an inferred \ud835\udc3b0 of 69.58+0.54\u22120.61 km s\n\u22121 Mpc\u22121. This is not surprising, and it is fairly common when the EM detection threshold is low compared to the magnitudes of BNS mergers at large distances (& 200 Mpc) where GW anisotropy bias becomes important. Gerardi et al. (2021) demonstrates that negatively-biased EM+GW merger posteriors are common in 100-merger sample.\nApplying GW anisotropy bias correction raises the inferred value of \ud835\udc3b0 to 69.89+0.65\u22120.47 km s\n\u22121 Mpc\u22121, correcting for 50.00% of the bias. This demonstrates that our method for GW anisotropy bias correction works whether the bias is positive or negative. Including EM anisotropy changes the inferred value of \ud835\udc3b0 to 69.93+0.59\u22120.51 km s\u22121 Mpc\u22121, increasing the level of bias correction to 68.18%.\nIn C2, the GW localization of GW190425 and the GOTO follow-up campaign for that merger is assumed. Due to the poor localization coverage of the follow-up, this resulted in our method being unable to correct for EM anisotropy bias, although the degree of GW anisotropy bias correction remained the same. This is sensible, since any given GW-only merger is far more likely to lie outside the EM follow-up coverage than to be too dim to be seen by the detector."
        },
        {
            "heading": "5.3.2 C3 and C4",
            "text": "C3 and C4 consider the same sample of 100 mergers as the other combined tests, while assuming that the EM follow-up detection sensitivity reaches 25 \ud835\udc5aAB. C3 assumes that all mergers lie within the follow-up campaign\u2019s sky coverage, while C4 assumes the sky localization of GW190425 and that merger\u2019s GOTO EM followup campaign for all mergers. The posterior distributions for \ud835\udc3b0 produced in C3 is shown in Figure 9, referred to therein as the \u2018unrealistic follow-up\u2019 case.\nWhen perfect localization coverage is assumed (C3), the biased posterior of \ud835\udc3b0 is 69.49+0.69\u22120.51 km s\n\u22121 Mpc\u22121. Once GW anisotropy correction is applied, this becomes 70.47+1.50\u22121.48 km s\n\u22121 Mpc\u22121. GW anisotropy correction in this sample of mergers acts to broaden the posterior significantly due uncertainty in the level of GW anisotropy bias itself.OnceEManisotropy bias is also corrected for, the inferred value of \ud835\udc3b0 becomes 69.96+1.16\u22121.06 km s\n\u22121 Mpc\u22121, constituting a bias correction level of 92.12% at the cost of broadening the posterior by roughly a factor of 2.\nAssuming realistic localization coverage (C4), the biased posterior of \ud835\udc3b0 is 70.61+1.06\u22120.90 km s\n\u22121 Mpc\u22121. Applying GW anisotropy bias correction changes this to 70.38+1.01\u22120.96, constituting a 37.71% correction in the bias level. Applying the EM anisotropy bias correction in addition to this changes the inferred value of \ud835\udc3b0 to 69.81+0.99\u22121.09, constituting a 68.85% reduction in the bias level. This\nMNRAS 000, 1\u201314 (2022)\ndemonstrates that increasing the depth of follow-up imaging can allow for EM anisotropy bias correction even when the localization coverage is poor."
        },
        {
            "heading": "5.3.3 C5",
            "text": "C5 is similar to C4, except that the sky localization of GW190814 is used along with that merger\u2019s Canada-France-Hawaii Telescope follow-up campaign. The purpose of this test is to illustrate the quality with which EM and GW anisotropy biases may be corrected for when exposures are deep and the EM follow-up campaign coverage is extensive. In this test, the biased posterior of \ud835\udc3b0 is 69.40+1.22\u22121.14 km s\u22121 Mpc\u22121. Once GW anisotropy correction is applied, this becomes 70.23+1.38\u22120.96 km s\n\u22121 Mpc\u22121. Once EM anisotropy bias is also corrected for, the inferred value of \ud835\udc3b0 becomes 70.14+1.20\u22121.34 km s \u22121 Mpc\u22121, constituting a bias correction level of 76.67%. The posterior distributions for \ud835\udc3b0 produced in this test are displayed in Figure 9, labelled therein as the \u2018realistic follow-up\u2019 case. Due to the incompleteness of the follow-up campaign, all posteriors are broader than those produced in the case where perfect follow-up is assumed (C3). We find that bias correction in a regime where EM follow-up is nearly complete achieves a similar level of bias correction to C3."
        },
        {
            "heading": "6 CONCLUSIONS",
            "text": "In this study, we have demonstrated how simulation-based inference can be used to produce an unbiased measurement of \ud835\udc3b0 using mergers detected with EM+GW in addition to GW-only mergers. In doing so, we account for both GW and EM selection effects. Our GW anisotropy bias correction method matches the performance of the SBI method presented by Gerardi et al. (2021) and further generalizes its inference to account for EManistropy bias in standard siren measurements of \ud835\udc3b0.\nThe key to EM anisotropy correction is the inclusion of GWonly events \u2013 mergers whose GW signal is detected in the absence of a detected EM counterpart. For many such mergers, the fact of EM non-detection places a constraint on the merger\u2019s apparent magnitude, which in turn constrains the range of possible inclination angles and luminosity distances for the merger. These constraints in turn act to temper, and in many cases fully remove, EM anisotropy bias in the inferred value of \ud835\udc3b0.\nWe found that the inclusion of EM anisotropy correction in scenarios where EM anistropy bias is negligible can reduce the bias correction level of our method by a few percent. However, this slight reduction in correction efficacy in low-EM anisotropy bias scenarios is outweighed by the high efficacy of EM anisotropy bias correction in high-EM anisotropy bias scenarios. Without an ab initio method of determining whether a population of BNS mergers is significantly EM anisotropy biased, it is safest to include EM anisotropy correction in the analysis of a merger sample alongside GW anisotropy correction.\nThe tests which consider the GW footprint of GW190425 and its GOTOEM follow-up campaign (C3 and C4) illustrate the importance of a comprehensive EM follow-up campaign for each merger. In these tests, the probability of a merger not lying within the EM follow-up region is considered. When the probability that a GWonly merger only lacks a detected EM counterpart because it was not localized within any telescope pointings is high, only weak constraints can be placed on that merger\u2019s inclination angle and luminosity distance. Such was the case for GW190425, where the\nlocalization was poor and the GOTO campaign only had \u223c25% localization coverage. This in turn weakens the correction level on the EM anisotropy bias. Thus, a maximally-informative EM followup campaign should seek to maximize its coverage of the BNS merger\u2019s sky localization. We make this point by including a test where we consider a more complete EM follow-up scenario, the Canada-France-Hawaii Telescope follow-up of GW190814 (C5), wherein the bias correction level is comparable to that of perfect localization coverage.\nFuture extensions of this work should focus on more realistic inference scenarios. For example, in this work we assumed the neutron star masses of each merger to be precisely measured from the GWs, when in reality a GWmeasurement provides a joint probability distribution for the merger\u2019s neutron star masses. We also assumed the same EM follow-up routine for each merger with the same underlying sky localization. A more realistic treatment of EM follow-up should consider the real sky localizations of each merger with merger-specific EM follow-up routines. Future work should also address the uncertainty in the kilonova parameters themselves, as incorrectly assuming their values can lead to either insufficient or overzealous bias correction.\nThe significance of the biases addressed in this study will only increase as more BNS mergers are detected in the coming years, underscoring the importance of a reliable bias correction method. SBI-based approaches such as ours enable cosmologists to take full advantage of the incoming deluge of BNS merger detections to produce unbiased measurements of the Hubble constant, and possibly resolve the Hubble tension."
        },
        {
            "heading": "ACKNOWLEDGMENTS",
            "text": "The authors thank Sabrina Berger, Michael Matesic, Carter Rhea, Jason Rowe, Nicholas Vieira, and Clovis Vinant-Tang for helpful discussions. S.G.H. acknowledges support from the Natural Sciences and Engineering Research Council of Canada (NSERC) through their Canada Graduate Scholarships - Master\u2019s programme, as well as from the Bishop\u2019s University Foundation through their Graduate Entrance Scholarship. J.J.R. and D.H. acknowledge support from the Canada Research Chairs (CRC) program, the NSERC Discovery Grant program, the FRQNTNouveaux Chercheurs Grant program, and the Canadian Institute for Advanced Research (CIFAR). J.J.R. acknowledges support from the Canada Foundation for Innovation (CFI), and the Qu\u00e9bec Minist\u00e8re de l\u2019\u00c9conomie et de l\u2019Innovation. Computations were performed on the Cedar and B\u00e9luga supercomputing clusters managed by Compute Canada.\nDATA AVAILABILITY\nThe data underlying this article is available upon request. The inference code is available on the author\u2019s GitHub page: https: //github.com/samgagnon/kilonova_sim."
        },
        {
            "heading": "APPENDIX A: METHODS SUPPLEMENTAL MATERIAL",
            "text": ""
        },
        {
            "heading": "A1 Kilonova Parameters",
            "text": "We generate kilonova light curves using the MOSFiT software. We assume that kilonovae have two merger ejecta components, one red and one blue (Metzger 2019), with opacities \ud835\udf05red and \ud835\udf05blue respectively. We use fiducial values of \ud835\udf05red = 10 cm2 g\u22121 and \ud835\udf05blue = 0.5 cm2 g\u22121, following the results of Radice et al. (2018).\nA kilonova\u2019s peak luminosity scales with the quantity of ejecta produced in the NS merger, and thus to the masses of the NS themselves. Our light curve simulation requires as inputs the BNS merger chirp mass, M = ( (\ud835\udc5a1\ud835\udc5a2)3/5\n(\ud835\udc5a1 + \ud835\udc5a2)1/5\n) , (A1)\nand NSmass ratio, \ud835\udc5e = \ud835\udc5a1/\ud835\udc5a2, where\ud835\udc5a1 < \ud835\udc5a2. We compute these quantities from the true NS masses provided by GWToolbox.\nThe luminosities of red and blue components also depend on their temperatures, which are influenced by the disk ejection fraction, \ud835\udf16disk, and the blue component enhancement factor \ud835\udefc. \ud835\udf16disk governs the fraction of the BNS remnant accretion disk ejected post-merger. We use a fiducial value of \ud835\udf16disk = 0.15, while Nicholl et al. (2021) state that the true value may range anywhere from 0.05 to 0.5, following Metzger (2019). Meanwhile, surface winds from the merger remnant enhance the temperature of the blue ejecta, encapsulated by \ud835\udefc. Nicholl et al. (2021) assign \ud835\udefc a flat prior from 0.1 to 1.0, while we set it to 1.0 (maximum enhancement).\nFinally, the geometry of the kilonova influences which component we actually observe. In MOSFiT, kilonova geometry is simplified into two distinct angular regions defined by the half-opening angle of the blue component, \ud835\udf03. We follow Nicholl et al. (2021) by setting \ud835\udf03 = 45\u25e6. BNS mergers also produce an associated gammaray burst (GRB), which shocks ejecta material in its vicinity. For the purposes of this study, we assume that the GRB shock negligibly effects the blue component, thus setting the half-opening angle of the GRB shock to \ud835\udf03\ud835\udc50 = 0. We do this since the half-opening angle of the shocked cone is uncertain and its physics are poorly understood."
        },
        {
            "heading": "A2 Summary Statistic",
            "text": "Wemeasure the consistency of\u0398with x explicitly using the (\ud835\udc37\ud835\udc3f , \ud835\udf04) distributions of each GW-detected merger as measured from its gravitational wave emission. The likelihood of guessed parameters \ud835\udc37\ud835\udc3f and \ud835\udf04 for any particular merger are taken as L = \ud835\udc43(\ud835\udc37\ud835\udc3f , \ud835\udf04|\ud835\udc65GW)\nMNRAS 000, 1\u201314 (2022)\nwhere \ud835\udc65GW is the gravitational wave strain for that merger. Each merger\u2019s likelihood contributes to the informative summary statistic S, defined as\nS = \ud835\udc41\u2211\ufe01 \ud835\udc56 log(L(\ud835\udc37\ud835\udc3f,\ud835\udc56 , \ud835\udf04\ud835\udc56 |\ud835\udc65GW,\ud835\udc56)), (A2)\nor the sum of log-likelihoods of each merger. We use this definition of S since it is based on an analytic likelihood, allowing the neural ratio estimator to easily learn the true likelihood-to-evidence ratio. Furthermore, variance in S originates entirely from uncertainty in the proposed parameters \ud835\udc37\ud835\udc3f,\ud835\udc56 and \ud835\udf04\ud835\udc56 , meaning that our selected summary statistic does not introduce any new biases that are not already present in the source data. This follows the principles of summary statistic selection laid out by Raynal & Onnela (2021).\nOur choice of the minimum value of S for null returns follows from the form of Equation A2. Since the neural ratio estimator is trained to maximize the log-likelihood of the target parameter, a null return must be lower than the lowest informative return. To this end, we set a minimum allowable likelihood for each merger within a sample, Lmin = 10\u22126. We choose this as the minimum likelihood since it is equivalent to the likelihood of sampling \ud835\udc37\ud835\udc3f and \ud835\udf04 from a 2D uniform distribution, given that our likelihood distributions have a resolution of 1000\u00d71000. As such, any sampled (\ud835\udc37\ud835\udc3f , \ud835\udf04) with this likelihood or below is no more informative than a sample drawn from a uniform distribution, and we therefore deem it \u2018non-informative\u2019. If a parameter sample is non-informative for all mergers in a data set (i.e., if S < \u22126 \u00b7 \ud835\udc41) then the summary statistic is automatically returned as null, or Snull = \u22126 \u00b7 \ud835\udc41 .\nA careful inspection of Equation A2 reveals that its maximum and minimum vary with the number of mergers in a sample. Furthermore, only a fraction of all BNS mergers within a sample have detected GWs in any given sample. To maintain consistent bounds for the summary statistic, we treat each merger not detected in GWs as contributing their maximum log-likelihood to the summary statistic. Thus, the summary statistic for each sample is computed as\nS = \ud835\udc37\u2211\ufe01 \ud835\udc56 \ud835\udc59\ud835\udc56 (\u0398|\ud835\udc37\ud835\udc3f,\ud835\udc56 , \ud835\udf04\ud835\udc56) + \ud835\udc41\u2211\ufe01 \ud835\udc56 max(\ud835\udc59\ud835\udc56 (\u0398)), (A3)\nwhere \ud835\udc37 is the number of GW-detected mergers, \ud835\udc41 is the number of mergers not detected in GWs, \ud835\udc59\ud835\udc56 (\u0398) is the log-likelihood of an merger indexed \ud835\udc56 with the parameter sample \u0398, and (\ud835\udc37\ud835\udc3f,\ud835\udc56 , \ud835\udf04\ud835\udc56) are the luminosity distance and inclination angle sampled for themerger \ud835\udc56.\nA3 Intermediate Processing\nProducing an unbiased \ud835\udc3b0 posterior from SGW is not as simple as training another MNRE. This is because the nonzero returns in SGW are noise-dominated. Each summary statistic S is the sum of log-likelihoods for eachmerger given the sampled parameter vector. EM+GWmergers are governed by only two free variables:\ud835\udc3b0 and \ud835\udf04, the former of the two is shared for all mergers within a sample. This means that at a particular \ud835\udc3b0, the variance in log-likelihoods is entirely determined by the uncertainty in \ud835\udf04 for eachmerger. The redshift of a EM+GWmerger is known from EM observations, fixing the luminosity distance when a cosmology is assumed ((\ud835\udc3b \u20320, \ud835\udc67) \u2212\u2192 \ud835\udc37 \u2032 \ud835\udc3f ). Meanwhile, GW-only mergers are governed by an additional parameter, \ud835\udc37\ud835\udc3f . Without a known redshift, the luminosity distance of\na GW-only merger is free to be sampled independently of \ud835\udc3b0. This means that for a particular \ud835\udc3b0, the variance in the log-likelihood is driven by both the uncertainty in \ud835\udc37\ud835\udc3f and the uncertainty in \ud835\udf04. We find that this drives the variance in nonzero returns to a point where anMNRE is no longer capable of recovering the underlying pattern, rendering direct posterior inference impossible.\nWith nonzero returns rendered useless, we are forced to look to the zero returns for answers. Zero returns are not non-informative: they show the values of \ud835\udc3b0 which are forbidden given a sample of mergers. Taking the ratio between the number of zero returns and the number of total samples as a function of \ud835\udc3b0, the \u2018rejection\u2019 rate, or \ud835\udc45(\ud835\udc3b0), may be constructed. Any set of summary statistics has an associated rejection rate function, and we denote the rejection rate produced from SS as \ud835\udc45S (\ud835\udc3b0), and that produced from SGW as \ud835\udc45GW (\ud835\udc3b0).\nThese rejection rates differ from one another, as including GW-only mergers increases the selectiveness of the forward model. Crucially, the selectiveness does not change uniformly with \ud835\udc3b0, but follows some functional relationship encoded within \ud835\udc45GW (\ud835\udc3b0). The objective in correcting for EM anisotropy bias is thus to modify the set SS such that it accounts for the information in \ud835\udc45GW (\ud835\udc3b0). A responsible modification to SS is one that does not introduce any information beyond what is encoded in GW-only mergers. The most obvious modification is to apply \ud835\udc45GW (\ud835\udc3b0) to SS by changing some portion of the informative summary statistics to zero returns according to the target rejection rate. This does not change the posterior learned from the distribution since the MNRE explicitly ignores null returns in favour of informative samples. Therefore, the solution must modify the informative samples in SS without setting them to zero. We define the modified set of summary statistics as the product of SS and \ud835\udc45GW (\ud835\udc3b0), i.e.\nS\u2032S = SS |SGW = \ud835\udc45GW (\ud835\udc3b0) \u00b7 SS. (A4)\nThis modified set of summary statistics, S\u2032S, includes all information granted by the EM+GW mergers, while also incorporating the rejection rate required by GW-only mergers. \ud835\udc3b0 posteriors learned from this modified set correct for the bias introduced by EM anisotropy without broadening the distribution by including noisy GW-only mergers."
        },
        {
            "heading": "A4 Neural Ratio Estimation",
            "text": "Neural ratio estimation (NRE) involves training a classifier network \ud835\udc51\ud835\udf19 : \u0398 \u00d7 \ud835\udc4b \u2212\u2192 [0, 1] to discriminate between pairs (\ud835\udf03, \ud835\udc65) sampled from the joint posterior distribution \ud835\udc5d(\ud835\udf03, \ud835\udc65) and the product of the marginals \ud835\udc5d(\ud835\udf03)\ud835\udc5d(\ud835\udc65). By the Neyman-Pearson lemma, the probability that a data pair belongs to the joint posterior is proportional to the posterior density (Neyman & Pearson 1933). Formally, the neural network optimizes\n\ud835\udf19\u2217 = argmin \ud835\udf19 E \ud835\udc5d (\ud835\udf03,\ud835\udc65) \ud835\udc5d (\ud835\udf03\u2032) [L(\ud835\udc51\ud835\udf19 (\ud835\udf03, \ud835\udc65)) + L(1 \u2212 \ud835\udc51\ud835\udf19 (\ud835\udf03 \u2032, \ud835\udc65))], (A5)\nwhere L(\ud835\udc5d) = \u2212 log \ud835\udc5d is the negative log-likelihood. For this task, the Bayes optimal classifier uses the decision function\n\ud835\udc51 (\ud835\udf03, \ud835\udc65) = \ud835\udc5d(\ud835\udf03, \ud835\udc65) \ud835\udc5d(\ud835\udf03, \ud835\udc65) + \ud835\udc5d(\ud835\udf03)\ud835\udc5d(\ud835\udc65) , (A6)\nMNRAS 000, 1\u201314 (2022)\nwhich defines the likelihood-to-evidence (LTE) ratio\n\ud835\udc5f (\ud835\udf03, \ud835\udc65) = \ud835\udc51 (\ud835\udf03, \ud835\udc65) 1 \u2212 \ud835\udc51 (\ud835\udf03, \ud835\udc65) = \ud835\udc5d(\ud835\udf03, \ud835\udc65) \ud835\udc5d(\ud835\udf03)\ud835\udc5d(\ud835\udc65) = \ud835\udc5d(\ud835\udc65 |\ud835\udf03) \ud835\udc5d(\ud835\udc65) = \ud835\udc5d(\ud835\udf03 |\ud835\udc65) \ud835\udc5d(\ud835\udf03) . (A7)\nThus, NRE grants us an estimator log \ud835\udc5f\ud835\udf19 (\ud835\udf03, \ud835\udc65) = logit(\ud835\udc51\ud835\udf19 (\ud835\udf03, \ud835\udc65)) of the LTE log-ratio and a surrogate \ud835\udc5d(\ud835\udf03 |\ud835\udc65) = \ud835\udc5f\ud835\udf19 (\ud835\udf03, \ud835\udc65)\ud835\udc5d(\ud835\udf03) for the posterior density.\nThis paper has been typeset from a TEX/LATEX file prepared by the author.\nMNRAS 000, 1\u201314 (2022)"
        }
    ],
    "title": "Debiasing Standard Siren Inference of the Hubble Constant with Marginal Neural Ratio Estimation",
    "year": 2023
}