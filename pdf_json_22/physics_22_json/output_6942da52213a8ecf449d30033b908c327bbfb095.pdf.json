{
    "abstractText": "Although the basic concept of a stellarator was known since the early days of fusion research, advances in computational technology have enabled the modeling of increasingly complicated devices, leading up to the construction of Wendelstein 7-X, which has recently shown promising results. This recent success has revived interest in the nonlinear 3D MHD modeling of stellarators in order to better understand their performance and operational limits. This study reports on the extension of the JOREK code to 3D geometries and on the first stellarator simulations carried out with it. The first simple simulations shown here address the classic Wendelstein 7-A stellarator using a reduced MHD model previously derived by us. The results demonstrate that stable full MHD equilibria are preserved in the reduced model: the flux surfaces do not move throughout the simulation and closely match the flux surfaces of the full MHD equilibrium. Furthermore, both tearing and ballooning modes were simulated, and the linear growth rates measured in JOREK are in reasonable agreement with the growth rates from the CASTOR3D linear MHD code. VC 2022 Author(s). All article content, except where otherwise noted, is licensed under a Creative Commons Attribution (CC BY) license (http:// creativecommons.org/licenses/by/4.0/). https://doi.org/10.1063/5.0087104",
    "authors": [
        {
            "affiliations": [],
            "name": "N. Nikulsin"
        },
        {
            "affiliations": [],
            "name": "R. Ramasamy"
        },
        {
            "affiliations": [],
            "name": "M. Hoelzl"
        },
        {
            "affiliations": [],
            "name": "F. Hindenlang"
        },
        {
            "affiliations": [],
            "name": "E. Strumberger"
        },
        {
            "affiliations": [],
            "name": "K. Lackner"
        }
    ],
    "id": "SP:75dfab1510e6cfe78120e9fa4576d71c1449a855",
    "references": [
        {
            "authors": [
                "APS-DPP"
            ],
            "title": "13M",
            "venue": "Schlutt, C. Hegna, C. Sovinec, S. Knowlton, and J. Hebert, Nucl. Fusion 52,",
            "year": 2020
        },
        {
            "authors": [
                "Yu",
                "E. Strumberger",
                "V. Igochine",
                "K. Lackner",
                "H. Laqua",
                "M. Zanini",
                "H. Braune",
                "M. Hirsch",
                "U. H\u20acofel",
                "S. Marsen",
                "T. Stange",
                "R. Wolf",
                "S. G"
            ],
            "title": "unter, and Wendelstein 7-X Team, Nucl",
            "venue": "Fusion 60,",
            "year": 2020
        }
    ],
    "sections": [
        {
            "text": "Although the basic concept of a stellarator was known since the early days of fusion research, advances in computational technology have enabled the modeling of increasingly complicated devices, leading up to the construction of Wendelstein 7-X, which has recently shown promising results. This recent success has revived interest in the nonlinear 3D MHD modeling of stellarators in order to better understand their performance and operational limits. This study reports on the extension of the JOREK code to 3D geometries and on the first stellarator simulations carried out with it. The first simple simulations shown here address the classic Wendelstein 7-A stellarator using a reduced MHD model previously derived by us. The results demonstrate that stable full MHD equilibria are preserved in the reduced model: the flux surfaces do not move throughout the simulation and closely match the flux surfaces of the full MHD equilibrium. Furthermore, both tearing and ballooning modes were simulated, and the linear growth rates measured in JOREK are in reasonable agreement with the growth rates from the CASTOR3D linear MHD code.\nVC 2022 Author(s). All article content, except where otherwise noted, is licensed under a Creative Commons Attribution (CC BY) license (http:// creativecommons.org/licenses/by/4.0/). https://doi.org/10.1063/5.0087104\nI. INTRODUCTION\nThe stellarator, having been proposed by Lyman Spitzer in 1951, is one of the oldest plasma confinement concepts potentially applicable as a fusion power plant. However, early stellarators were plagued with problems stemming from neoclassical transport losses, leading to them being largely phased out in favor of tokamaks by the 1970s.2\u20134 However, improved mathematical models and increased computational power, which became available by the late 1980s, allowed us to overcome the main challenges faced by the stellarator concept. Moreover, the revival of stellarators brought with it a new strategy for fusion research, where numerical modeling drives the development of future machines, as opposed to the traditional strategy, where smaller-scale machines had to be built and experimented on before advancing to larger-scale machines. The creation of Wendelstein 7-X is one example of the successful application of this new strategy. The advantages are clear: not only is it more cost-effective, but it also allows one to consider a much wider range of potential machine designs in a much shorter amount of time.2\nMost of the computational developments mentioned above focused on the optimization of stellarator equilibria. While there has been work on nonlinear magnetohydrodynamic (MHD) simulations of stellarators since the 1970s,5 this area is not as developed as stellarator optimization. Most early studies applied the straight stellarator approximation by neglecting toroidicity,5\u20137 and it was not until the 2000s that fully 3D geometries were simulated.8,9 At present, several well-known MHD codes exist, with a few of them, including M3DC1,10 M3D,8 and MIPS,11 having been extended to stellarators. All three of these codes use full MHD on flux-surface-aligned grids, except for MIPS, which uses a cylindrical grid. NIMROD, another major tokamak code, is still in the process of being extended to stellarators,12 although the tokamak capabilities of NIMROD are already enough to simulate a stellarator with an axisymmetric vacuum vessel.13 Also, the FLUXO nonlinear MHD code14 is applicable to stellarator geometries. However, the stellarator capabilities of these codes have not been used much so far. This study reports on a similar extension of JOREK, one of the leading nonlinear MHD codes for tokamaks,1,15,16 to model stellarators. The work consists of two parts: first, a reduced MHD model\nPhys. Plasmas 29, 063901 (2022); doi: 10.1063/5.0087104 29, 063901-1\nVC Author(s) 2022\n18 January 2024 21:27:55\ncompatible with three-dimensional geometries was derived by generalizing the ideas of Breslau et al., Izzo et al., and Strauss;17\u201319 then, this model is implemented in the JOREK code and tested on a simple stellarator. The first part of the work has already been published in previous studies,20,21 and so this study will present the results of the second part of this effort.\nAs discussed in our previous studies,20,21 the magnetic field ansatz and equations in stellarator-capable reduced MHD involve a magnetic scalar potential v, which represents the part of the magnetic field that is generated by the coils. In the tokamak limit, this potential reduces to v \u00bc F0/, where / is the toroidal angle; however, a stellarator-capable code using this model will need to allow arbitrary scalar potentials. Fortunately, it is possible to analytically represent an arbitrary v: sincerv is a magnetic field, it must be divergence-free, so Dv \u00bc 0. One then needs to find a general solution to the Laplace equation in the toroidal coordinate system \u00f0R; z;/\u00de. This was done by Dommaschk,22 who provides his solution as a sum over harmonics, where any particular solution is determined by the coefficients of these harmonics. Naturally, each harmonic individually satisfies the Laplace equation. In order to determine the coefficients for a particular equilibrium, one needs to first calculate the vacuum field on an \u00f0R; z;/\u00de grid, which we do using the EXTENDER_P code.23\nUsing the Dommaschk potential formulation for v in conjunction with nonaxisymmetric flux-surface-aligned grids allows one to relatively efficiently simulate stellarators. The steps to run a stellarator simulation can then be summarized as follows:\n(1) Calculate an equilibrium for the stellarator in question using the GVEC code.24 (2) Use the output of GVEC to calculate the contribution to the stellarator\u2019s magnetic field from the coils (i.e., the curl-free/vacuum field) with the EXTENDER_P code. (3) Calculate the coefficients for the Dommaschk representation of the scalar potential from the output of EXTENDER_P. (4) Build a flux-surface-aligned grid from the geometry data in the GVEC solution and import it into JOREK. (5) Calculate the initial values for the reduced MHD variables from the GVEC solution. (6) Evolve the system implicitly in time using the stellarator reduced MHD equations in JOREK.\nThe GVEC24 code mentioned above is a new fixed-boundary 3D MHD equilibrium solver, which follows the ideas of the wellestablished VMEC code,25,26 assuming nested flux surfaces and using a constraint minimization of the MHD energy. In contrast to VMEC, the radial discretization is based on nonuniform B-splines of arbitrary order, allowing smooth representation of equilibrium quantities.\nThe rest of this paper is organized as follows. Section II states the reduced MHD equations that will be used throughout the rest of the paper. The same section also discusses the compatibility of full MHD equilibria with reduced MHD and shows that the error introduced by reduced MHD is small. Section III explains how the coefficients of the Dommaschk representation can be calculated from EXTENDER_P output, while Sec. IV explains how the initial conditions for the reduced MHD variables can be calculated from the GVEC equilibrium. In Sec. V, several simulations of stable equilibria in the Wendelstein 7-A stellarator27 are presented to show that spurious instabilities and problems with maintaining equilibrium do not\nappear. Finally, Sec. VI shows tearing mode simulations in Wendelstein 7-A and benchmarks the growth rates against the CASTOR3D linear MHD code.28,29 Section VII presents a similar benchmark for ballooning modes in the same device. In addition, Appendix A briefly discusses the new nonaxisymmetric grid feature in JOREK, which allows the stellarator simulations to have flux surfacealigned grids. In Appendix B, we show that the linearized ideal version of the model presented in Sec. II has a self-adjoint operator, and thus, ideal perturbations will have real eigenvalues."
        },
        {
            "heading": "II. REDUCED MHD AND THE RESIDUAL FORCE",
            "text": "Throughout this paper, we will use the reduced MHDmodel that was derived in Ref. 21. The advantage of reduced MHD is that it allows one to use a larger time step than full MHD by eliminating the shortest timescale in the system; even if implicit time stepping is used, accuracy will deteriorate if the time step is too much larger than the shortest timescale. In the tokamak limit, reduced MHD is well tested and can accurately model tearing and ballooning modes in a wide range of betas and resistivities.30 As discussed in Refs. 20 and 21, the full MHD magnetic field can be written as (no approximations)\n~Bf \u00bc rv\u00ferW rv\u00ferX rwv; (1)\nwhere the first term is the part of the magnetic field generated by the coils, the second is field line bending, and the last term mostly corresponds to field compression but also adds a small correction to field line bending. Since the vacuum field rv must be divergence-free, it can be written in terms of Clebsch potentials: rv \u00bc rwv rbv. As discussed in Ref. 20, one can construct a Clebsch-type coordinate system with coordinates \u00f0wv;bv; v\u00de; this coordinate system will be used further in this section. Expression (1) can be seen as just the plasma current-induced magnetic field (whose vector potential is Wrv\u00fe Xrwv, with the rbV component removed by a gauge transform) added to the coil field. The full MHD velocity can be written as (no approximations)\n~vf \u00bc rU rv\nB2v \u00fe vk~B \u00fer?f: (2)\nThe terms approximately separate the MHD waves, with the first term containing Alfv en waves, the second containing slow magnetosonic waves, and the last one containing fast magnetosonic waves. Here, Bv \u00bc jrvj. The reduced model is obtained by setting f\u00bc 0 and X\u00bc 0, and dropping the component of current perpendicular to rv in Ohm\u2019s law. In addition to that, we perform a further reduction in this paper by setting vk \u00bc 0. The removal of vk decreases the accuracy of the model and narrows the range of scenarios where it is valid31,32 (note that the model tested in Ref. 30 has vk 6\u00bc 0.); however, the simplified model without vk is still applicable to the cases considered here, as will be seen. The resulting model consists of Eqs. (2.9), (2.13), (2.15), and (2.18) from Ref. 21, with f, X, and vk zeroed out,\nr q B2v r? @U @t \u00bc Bv 2 q B2v ; \u00f0U;U\u00de B2v\n\" # \u00fe Bv\nq~x B4v ;U\nr P B2v r?U \u00fer \u00f0~j~B\u00de \u00fe Bv 1 B2v ; p\n\u00fer \u00f0l?r? ~x\u00de D?\u00f0lhD? ~x\u00de; (3a)\nPhys. Plasmas 29, 063901 (2022); doi: 10.1063/5.0087104 29, 063901-2\nVC Author(s) 2022\n18 January 2024 21:27:55\n@q @t \u00bc Bv q B2v ;U \u00fe P; (3b)\n@p @t \u00bc 1 Bv p;U\u00bd cpBv 1 B2v ;U\n\u00fer \u00f0c 1\u00dej?r?T \u00fe \u00f0c 1\u00dejkrkT \u00fe pD? q r?q\n\u00fe pDk q rkq \u00fe\u00f0c 1\u00de\u00f0Se \u00fe gOhmB2v~j 2\u00de; (3c)\n@W @t \u00bc @ kU W;U\u00bd Bv g\u00f0~j ~j0\u00de \u00fe r \u00f0ghr?~j\u00de; (3d)\n~j \u00bc D W; (3e) ~x \u00bc D?U; (3f)\nwhere the ideal gas law p \u00bc qRT applies, and the shorthand P \u00bc r \u00f0D?r?q\u00fe Dkrkq\u00de \u00fe Sq was used. The operators are defined as follows:\n@k \u00bc B 1v rv r; r? \u00bc r B 1v rv@k; D? \u00bc r r?; D \u00bc B 2v r \u00f0B2vr?; rk \u00bc B 2~B~B r; r? \u00bc r rk\nIn addition, \u00bdf ; g \u00bc B 1v rv \u00f0rf rg\u00de is the Poisson bracket of two scalar functions f and g, and \u00f0f ; g\u00de \u00bc r?f r?g is the inner product of their gradients. In the reduced model, the ansatzes (1) and (2) become\n~B \u00bc rv\u00ferW rv; ~v \u00bc rU rv B2v : (4)\nIn Eq. (3), g is the resistivity, l? is a viscosity-like parameter (it is not the same as physical dynamic viscosity, as discussed in Ref. 21), lh is the hyperviscosity, gh is the hyper-resistivity (artificial dissipation parameters in the U and W equations, respectively, that can help with numerical stabilization), D? is mass diffusion across field lines, j? and jk are the heat conduction coefficients across and along field lines, respectively, and Sq and Se are the mass and energy sources, respectively. The Ohmic resistivity gOhm is a separate parameter, which allows one to neglect part of or all of the resistive contribution to internal energy and simply remove that energy from the system, which can be useful if the resistivity is artificially high.\nFinally, there are two auxiliary variables: the normalized current in therv direction~j \u00bc rv ~j=B2v \u00bc rv r ~B=\u00f0l0B2v\u00de and the contravariant v component of vorticity ~x \u00bc rv ~x \u00bc rv r ~v, both taken with the opposite sign. The definition equations [Eqs. (3e) and (3f)] can be obtained by taking the dot product of rv with the curl of~B and~v, respectively, and then using the identityrf r ~Q \u00bc r \u00f0rf ~Q\u00de, where f is an arbitrary scalar field and ~Q is an arbitrary vector field. Instead of simply substituting the definition equations [Eqs. (3e) and (3f)] into the rest of the Eq. (3),~j and ~x were treated as separate variables, each with their own degrees of freedom on the finite element grid. These degrees of freedom are simultaneously evaluated at each time step with the degrees of freedom for the other variables by using the definition equations [Eqs. (3e) and (3f)] alongside with the rest of Eq. (3). This approach, used in combination with transforming the equations to weak form, allows one to\navoid second-order derivatives in Eq. (3), except for the hyperviscosity term in Eq. (3a). Second-order derivatives can have discontinuities, as the finite elements in JOREK presently only have G1 continuity.1 This also means that if one tries to represent v in the finite element basis instead of using the Dommaschk analytical form, one will not be able to avoid discontinuities in the first term on the RHS of Eq. (3a) even after applying integration by parts. In our experience, having discontinuities in the advective terms can decrease numerical accuracy or may lead to numerical instabilities, which was one of the reasons for the existence of ~x as a separate variable. A recent development in JOREK allows one to use basis functions with higher-order Gn continuity, where n is a user-selected parameter.33 This will allow one to eliminate ~j and ~x as separate variables; however, it has not been ported to JOREK3D yet.\nIt is important to note that the U evolution equation [Eq. (3a)] was obtained in Ref. 21 by applying a projection operator to the MHD momentum equation\n@ @t \u00f0q~v\u00de \u00fe r \u00f0q~v~v\u00de \u00bc~j ~B rp; (5)\nand then inserting the ansatzes (4). The viscosity and hyperviscosity terms are separately added after the projection operator is applied (see Ref. 21 for more details). The projection operator that produces Eq. (3a) is\nrv r \u00f0B 2v : (6)\nIf the vk variable is kept in the reduced model, then the following projection operator produces the vk evolution equation (not shown here) when applied to Eq. (5):\n~B (7)\nThe vk evolution equation is not included in the model (3) and was not used in any of the simulations presented in this paper, but it will be considered in the equilibrium error discussion, which comprises the remainder of this section.\nA natural question that arises when considering reduced MHD is whether or not the reduction preserves equilibria. In other words, if a particular equilibrium solution to the full MHD equations is known, will it also be a solution to the reduced MHD equilibrium equations? As shown in Refs. 1 and 21, a simple argument involving the Grad\u2013Shafranov equation shows that this is indeed the case in the tokamak limit, where the reduced MHD model (3) reduces to the model that was already used in the tokamak version of JOREK. However, this does not work for a general stellarator, where a full MHD equilibrium does not exactly satisfy the reduced MHD equilibrium equations, and a residual force arises and contributes to Eq. (3a). However, it can be shown that this contribution is small using an ordering argument.\nLet L? be the length scale perpendicular to rv and Lk be the length scale along rv. Then, defining k L?=Lk as the ordering parameter, the spatial derivatives must satisfy j@kj kjr?j. The terms in the full magnetic field (1) are ordered as follows:\njrW rvj jrvj jr ?Wj k\nand\nPhys. Plasmas 29, 063901 (2022); doi: 10.1063/5.0087104 29, 063901-3\nVC Author(s) 2022\n18 January 2024 21:27:55\njrX rwvj jrvj Fv Bv jrXj k2;\nwhere Fv \u00bc jrwvj. Identifying L?, Bv, and Fv as zeroth-order quantities, L? \u00bc O\u00f01\u00de; Bv \u00bc O\u00f01\u00de; Fv \u00bc O\u00f01\u00de, it follows that Lk \u00bc O\u00f0k 1\u00de; r? \u00bc O\u00f01\u00de; @k \u00bc O\u00f0k\u00de; W \u00bc O\u00f0k\u00de, and X \u00bc O\u00f0k2\u00de. Meanwhile, the residual force due to the reduction is ~f res \u00bc rp ~j ~B \u00bc~jf ~Bf ~j ~B, where ~B is the reduced MHD magnetic field (4), ~Bf is the full magnetic field (1), and~j and~jf are the curls of the corresponding field divided by l0. Note that the residual force is just the difference between the full and reduced MHD Lorentz forces. It arises due to the neglect of the last term of (1) in reduced MHD and will be present even in the zero b limit. Inserting the ansatzes, the following expression is obtained for the residual force:\n~f res \u00bc 1 l0 r \u00f0rW rv\u00de\u00bd \u00f0rX rwv\u00de\n\u00fe 1 l0 r \u00f0rX rwv\u00de\u00bd rv \u00fe 1 l0 r \u00f0rX rwv\u00de\u00bd \u00f0rW rv\u00de \u00fe 1 l0 r \u00f0rX rwv\u00de\u00bd \u00f0rX rwv\u00de: (8)\nAfter some algebra, the reduced MHD current can be written as\n~j \u00bc 1 l0 r \u00f0rW rv\u00de \u00bc 1 l0 D Wrv\u00fe~j?;\n~j ? \u00bc 1\nl0 Bv@ k @W @qi ~e i gkn @W @qk Bv@ kgni~e i ;\n(9)\nwhere the Einstein summation convention is used, with k; n 2 fwv; bv; vg and i 2 fwv; bvg. Here, g is the metric tensor of the Clebsch-type coordinate system aligned to rv, which was introduced in Ref. 20, qi represents the actual coordinates: qi 2 fwv;bvg, and~e i are the contravariant basis vectors:~e i 2 frwv;rbvg. With this, the first term in the residual force (8) expands to\n@X @bv ~j ? rv D W l0 Bv@ kXrv ~ebv \u00fe Bv@ kX~j ? ~ebv :\nSince~j ? \u00bc O\u00f0k2\u00de, it is easy to see that the first two terms above are O\u00f0k4\u00de and the third term is O\u00f0k5\u00de. The second term in the residual force (8) can be expanded as\nrwvBv@k\u00f0rX rwv\u00dewv \u00ferbvBv@ k\u00f0rX rwv\u00debv\nB2vr?\u00f0rX rwv\u00dev: (10)\nNote that rX rwv \u00bc \u00f0@X=@bv\u00derv\u00fe \u00f0@X=@v\u00de~ebv=J , where~ebv \u00bc Jrv rwv is the covariant basis vector in the bv direction in the Clebsch-type coordinate system aligned to rv, and J \u00bc \u00bd\u00f0rwv rbv\u00de rv 1 \u00bc 1=B2v is the Jacobian. Furthermore, since Bv@=@v \u00bc @k, one has \u00f0rX rwv\u00dewv \u00bc gwvbvBv@\nkX and \u00f0rX rwv\u00debv \u00bc gbvbvBv@kX. Thus, the first two terms in (10) are O\u00f0k\n4\u00de and the third term is O\u00f0k2\u00de. However, it is easy to see that the third term in (10) is in the kernel of the projection operator (6), and so this term\nwill not contribute to the residual force in the U evolution equation [Eq. (3a)]. On the other hand, the third term in (10) is not in the kernel of the projection operator (7), but its image under the operator, which can be written as B3v \u00bd@X=@bv;W , will be canceled by the image of another term, as will be shown below.\nThe curl of the last term of the full magnetic field (1) can be written as\nr \u00f0rX rwv\u00de \u00bc r @X @bv rv\u00fer\u00f0Bv@kX\u00de ~ebv\n\u00feBv@kXr ~ebv : (11)\nNote that the first term in (11) is O\u00f0k2\u00de, and the other two terms are O\u00f0k3\u00de. Using (11), the third term in the residual force (8) becomes\nr @X @bv rv\n\u00f0rW rv\u00de \u00fe O\u00f0k4\u00de\n\u00bc rW r @X @bv rv rv\u00fe O\u00f0k4\u00de: (12)\nTerms of the order k4 are not written out explicitly in (12), since there is no need to consider them, as it is already established that there is at least anO\u00f0k4\u00de contribution to equation (3a). As can be seen, the O\u00f0k3\u00de term in (12) will be canceled by the projection operator (6) and as such will not contribute to the U evolution equation [Eq. (3a)]; however, it will not be canceled by the projection operator (7). Indeed, its image under the operator (7) will be B3v \u00bdW; @X=@bv . Note that this image is equal to the negative image of the third term in (10), which was discussed above. These two images will cancel, and thus, the lowest order in which the residual force will contribute to the vk evolution equation is k\n4. Finally, the last term in the residual force (8) is clearly of order k4 or higher, so there is no need to consider it in detail like the other terms. In order to compare the residual force contributions to the other terms in Eq. (3a) and the vk evolution equation, some more ordering needs to be done. Consider that the shortest timescale in the reduced system is the Alfv en time sA Lk=cA, where the parallel length scale is used because the Alfv en wave travels along field lines, and so the time derivative is ordered as j@=@tj 1=sA. As such, @=@t \u00bc O\u00f0k\u00de. The U and vk terms in the velocity ansatz are then ordered as\njvk~Bj jrU rvj\nB2v B2v jvkj jr?Uj 1:\nAssuming that the partial and convective terms in the material derivative are of the same order, j@=@tj j~v rj, one has U; vk \u00bc O\u00f0k\u00de. After identifying q \u00bc O\u00f01\u00de and p \u00bc O\u00f0k2\u00de, it is clear that the lowestorder terms in Eq. (5) are O\u00f0k2\u00de, and both projection operators (6) and (7) are O(1). As such, the lowest-order terms in both Eq. (3a) and the vk evolution equation are O\u00f0k2\u00de. Thus, the residual force contribution to the reduced MHD equations is at least two orders of k higher than the lowest-order terms. In Sec. V, it will be confirmed with numerical simulations that the residual force is indeed small."
        },
        {
            "heading": "III. FINDING THE DOMMASCHK REPRESENTATION",
            "text": ""
        },
        {
            "heading": "OF A SCALAR POTENTIAL",
            "text": "Since v is a solution of the Laplace equation in a torus, it can be represented as a summation over toroidal harmonics\nPhys. Plasmas 29, 063901 (2022); doi: 10.1063/5.0087104 29, 063901-4\nVC Author(s) 2022\n18 January 2024 21:27:55\nv \u00bc F0/\u00fe X n;m vn;m; (13)\nwhere F0/ corresponds to a tokamak-like toroidal field, n is the toroidal mode number,m is the poloidal mode number, and each harmonic individually satisfies the Laplace equation: Dvn;m \u00bc 0. Dommaschk gives a more explicit representation for v,22\n~v \u00bc/\u00fe X n;m \u00f0an;m cos n/\u00fe bn;m sin n/\u00deDn;m\u00f0~R;~z\u00de\n\u00fe\u00f0cn;m cos n/\u00fe dn;m sin n/\u00deNn;m 1\u00f0~R;~z\u00de ; (14) where a tilde denotes normalization: v \u00bc F0~v; R \u00bc R0~R and z \u00bc R0~z ; the normalization factor R0 is the toroidally averaged radial position of the magnetic axis of the vacuum field. The functions Dn;m and Nn;m are defined as\nfD;Ngn;m\u00f0~R;~z\u00de \u00bc X2k m k\u00bc0 ~zm 2k \u00f0m 2k\u00de!C fD;Ng n;k \u00f0~R\u00de (15)\nand\nCDn;k\u00f0~R\u00de\u00bc Xk j\u00bc0\naj\u00f0a k n j ln~R\u00fe c k n j ak n j\u00de\ncja k n j\u00feajb k j ~R 2j\u00fen\u00febja k j~R 2j n ;\nCNn;k\u00f0~R\u00de\u00bc Xk j\u00bc0 aj\u00f0ak n j ln~R\u00feck n j\u00de h\ncjak n j\u00feajbk j ~R 2j\u00fen bjak j~R 2j ni :\n(16)\nThe coefficients ai, bi, and ci are defined as\nai \u00bc \u00f0 1\u00dei\n22i\u00fenC\u00f0n\u00fe i\u00fe 1\u00deC\u00f0i\u00fe 1\u00de ; a i \u00bc \u00f02i\u00fe n\u00deai;\nbi \u00bc C\u00f0n i\u00de\n22i n\u00fe1C\u00f0i\u00fe 1\u00de ; b i \u00bc \u00f02i n\u00debi;\nci \u00bc ai 2 Xi j\u00bc1 1 j \u00fe 1 n\u00fe j ; c i \u00bc \u00f02i\u00fe n\u00deci:\n(17)\nAlthough not written out explicitly, it can be seen that the coefficients also depend on n, the toroidal mode number of the D or N function that is being evaluated. The expressions above are only well defined if the following conditions on i and n are met: i 0 for ai and a i ; i 0 and n> i for bi and b i , and i> 0 for ci and c i . Otherwise, the corresponding coefficient and its starred version are zero. Finally, the coefficients an;m; bn;m; cn;m, and dn;m in Eq. (14) are what determine a particular configuration and must be calculated from the EXTENDER_P output.\nNote that, since the harmonics vn;m are analytically given, the property that Dvn;m \u00bc 0 is exactly satisfied. This is an important advantage of using the Dommaschk representation for v instead of the finite element representation (see Appendix A), as it guarantees that the divergence-free condition on the magnetic field will be satisfied to machine precision. The second advantage is that v and its derivatives are smooth.\nEXTENDER_P provides the values of the three cylindrical components of the vacuum magnetic field, which will be referred to as~BE,\non an \u00f0R; z;/\u00de grid. Setting rv \u00bc ~BE and considering the / component BE;/ \u00bc /\u0302 ~BE \u00bc R 1@v=@/, one has the following:\nR0 F0 BE;/ \u00bc ~R 1 @~v @/\n\u00bc ~R 1\u00fe~R 1 X n;m n \u00f0 an;m sin n/\u00fe bn;m cos n/\u00deDn;m\u00f0~R;~z\u00de\n\u00fe\u00f0 cn;m sin n/\u00fe dn;m cos n/\u00deNn;m 1\u00f0~R;~z\u00de : (18)\nWe will make use of the properties [from Ref. 22, Eqs. (10) and (11)] Dn;mj~R\u00bc1 \u00bc ~zm=m! and Nn;mj~R\u00bc1 \u00bc 0. Evaluating Eq. (18) at ~R \u00bc 1 gives\nR0 F0 BE;/j~R\u00bc1 \u00bc 1\u00fe X n;m n\u00f0 an;m sin n/\u00fe bn;m cos n/\u00de ~zm m! : (19)\nIf one also evaluates at ~z \u00bc 0 and integrates over /, F0 can be calculated\nF0 \u00bc R0 2p \u00f02p 0 BE;/j~R\u00bc1;~z\u00bc0d/: (20)\nTo calculate the coefficients an;m and bn;m, one must first multiply by either sin n/ or cos n/ and then use the orthogonality property of trigonometric functions\nn X m an;m ~zm m! \u00bc R0 F0p \u00f02p 0 BE;/j~R\u00bc1 sin n/ d/;\nn X m bn;m ~zm m! \u00bc R0 F0p \u00f02p 0 BE;/j~R\u00bc1 cos n/ d/:\n(21)\nThe number of terms M in the summations over m in Eq. (21) that is necessary to accurately represent the magnetic field is usually less than the number of poloidal modes used in the GVEC equilibrium. In practice, it is best to scan through different values ofM, starting with the number of poloidal modes and decreasing from there while trying to minimize the error in rv as compared to ~BE. Note that using higher values of M than necessary can lead to higher errors away from the ~R \u00bc 1 surface due to overfitting, as the integration in Eqs. (22), (23), (26), and (27), which will be derived shortly, is only over the ~R \u00bc 1 surface. Figure 1 shows the volume-averaged relative squared error of the Dommaschk potential representation as a function of the number M of poloidal modes kept in a Wendelstein 7-A equilibrium with b \u00bc 2:3 10 3 % (see Sec. V for more details about this equilibrium).\nOne can convert equations (21) into two linear algebraic systems with triangular matrices by changing the variable to z0 \u00bc ~z=Z and, after multiplying both equations by a Legendre polynomial Pi\u00f0z0\u00de, integrating from 1 to 1. Here, Z is determined as follows. In each poloidal plane at ~R \u00bc 1; ~z 2 \u00bd ~z \u00f0/\u00de;~z\u00fe\u00f0/\u00de , so Z < min/f~z \u00f0/\u00de; ~z\u00fe\u00f0/\u00deg. The value of Z is chosen to be slightly smaller than the minimum to avoid using the components of ~BE close to the boundary, where the output of EXTENDER_P can be less accurate. There is some freedom in choosing the specific value of Z, and it may take some trial and error to find the best value. As an example, Fig. 2 shows a segment of the surface of integration in one field period of the Wendelstein 7-A equilibria as described in Sec. V.\nPhys. Plasmas 29, 063901 (2022); doi: 10.1063/5.0087104 29, 063901-5\nVC Author(s) 2022\n18 January 2024 21:27:55\nThe Legendre polynomials are orthogonal to monomials of a lower order than the polynomial, since a monomial zm can be expanded exactly in the Legendre polynomial basis of the same orderm\nzm \u00bc Xm i\u00bc0 Cm;iPi\u00f0z\u00de:\nUsing the orthogonality property discussed above, one has, starting with i\u00bcM and descending to i\u00bc 0, the following linear algebraic system for an;m:\nXM m\u00bci an;m m! Zmhzm;Pi\u00f0z\u00dei\n\u00bc R0 nF0p \u00f02p 0 \u00f01 1 BE;/j~R\u00bc1;~z\u00bcZz0Pi\u00f0z0\u00de sin n/ dz0 d/;\ni \u00bc M;M 1;\u2026; 0; (22) where hzi; Pj\u00f0z\u00dei \u00bc \u00d0 1 1 z\niPj\u00f0z\u00dedz. Similarly, for the coefficient bn;m, one has the following linear algebraic system:\nXM m\u00bci bn;m m! Zmhzm;Pi\u00f0z\u00dei\n\u00bc R0 nF0p \u00f02p 0 \u00f01 1 BE;/j~R\u00bc1;~z\u00bcZz0Pi\u00f0z0\u00de cos n/ dz0 d/;\ni \u00bc M;M 1;\u2026; 0: (23)\nAs can be seen, both of these systems of equations have triangular matrices.\nAt this point, the equations for the coefficients cn;m and dn;m have yet to be determined. Consider now the R component of ~BE: BE;R \u00bc R\u0302 ~BE \u00bc @v=@R. One has the following:\nR0 F0 BE;R \u00bc @~v @~R \u00bc X n;m \u00f0an;m cos n/\u00fe bn;m sin n/\u00de @Dn;m @~R\n\u00fe\u00f0cn;m cos n/\u00fe dn;m sin n/\u00de @Nn;m 1 @~R : (24)\nAgain, evaluating at ~R \u00bc 1 and using the properties @Dn;m=@~Rj~R\u00bc1 \u00bc 0 and @Nn;m=@~Rj~R\u00bc1 \u00bc ~zm=m! [also from Ref. 22, Eqs. (10) and (11)], one has the following:\nR0 F0 BE;Rj~R\u00bc1 \u00bc X n;m \u00f0cn;m cos n/\u00fe dn;m sin n/\u00de ~zm 1 \u00f0m 1\u00de! : (25)\nFrom here, it is straightforward to follow the same steps as for an;m and bn;m, obtaining the following linear algebraic systems for cn;m:\nXM 1 m\u00bci cn;m\u00fe1 m! Zmhzm; Pi\u00f0z\u00dei\n\u00bc R0 F0p \u00f02p 0 \u00f01 1 BE;Rj~R\u00bc1;~z\u00bcZz0Pi\u00f0z0\u00de cos n/ dz0 d/;\ni \u00bc M 1;M 2;\u2026; 0; (26)\nand for dn;m:\nXM 1 m\u00bci dn;m\u00fe1 m! Zmhzm; Pi\u00f0z\u00dei\n\u00bc R0 F0p \u00f02p 0 \u00f01 1 BE;Rj~R\u00bc1;~z\u00bcZz0Pi\u00f0z0\u00de sin n/ dz0 d/;\ni \u00bc M 1;M 2;\u2026; 0: (27)\nNote that there are onlyM equations in each system for the unknowns cn;1;\u2026; cn;M and dn;1;\u2026; dn;M because Nn; 1 is not defined, and so terms with cn;0 and dn;0 are not included in the sum (14).\nThe only coefficients for which a system of equations has not yet been obtained are a0;m (there are no b0;m coefficients since sin 0 \u00bc 0). These coefficients cannot be obtained from the system (22) since the matrices of this system are singular when n\u00bc 0. To get a solvable system, one must use the z component of~BE as follows:\nR0 F0 BE;z \u00bc @~v @~z \u00bc X n;m \u00f0an;m cos n/\u00fe bn;m sin n/\u00de @Dn;m @~z\n\u00fe\u00f0cn;m cos n/\u00fe dn;m sin n/\u00de @Nn;m 1 @~z : (28)\nEvaluating at ~R \u00bc 1 using the properties [from Ref. 22, Eqs. (10) and (11)] Dn;mj~R\u00bc1 \u00bc ~zm=m! and Nn;mj~R\u00bc1 \u00bc 0 after differentiating by ~z gives\nR0 F0 BE;zj~R\u00bc1 \u00bc X n;m \u00f0an;m cos n/\u00fe bn;m sin n/\u00de ~zm 1 \u00f0m 1\u00de! : (29)\nPhys. Plasmas 29, 063901 (2022); doi: 10.1063/5.0087104 29, 063901-6\nVC Author(s) 2022\n18 January 2024 21:27:55\nIntegrating over / leaves only the n\u00bc 0 term in the sum, as all others are harmonic,\nX m a0;m ~zm 1 \u00f0m 1\u00de! \u00bc R0 2F0p \u00f02p 0 BE;zj~R\u00bc1d/: (30)\nTo finalize the derivation, we multiply the equation by a Legendre polynomial Pi\u00f0z0\u00de and integrate from -1 to 1. Starting from i \u00bc M 1 and descending to i\u00bc 0, the system of equations is\nXM 1 m\u00bci a0;m\u00fe1 m! Zmhzm;Pi\u00f0z\u00dei\n\u00bc R0 2F0p \u00f02p 0 \u00f01 1 BE;zj~R\u00bc1;z\u00bcZz0Pi\u00f0z0\u00dedz0d/;\ni \u00bc M 1;M 2;\u2026; 0: (31)\nJust as in the case of systems (26) and (27), there are onlyM equations for the unknowns a0;1;\u2026; a0;M . This is because D0;0 \u00bc 1, and so a0;0 is an additive constant in the scalar potential, which has no effect on the vacuummagnetic field.22\nThe linear algebraic systems of Eqs. (22), (23), (26), (27), and (28) are solved in a Python script using the NumPy library.36 The solution is then written out to a Fortran namelist file, which can be read by JOREK.When evaluating the Dommaschk potential and its derivatives at any particular point, JOREK will then use the analytical representation (14)."
        },
        {
            "heading": "IV. DETERMINING INITIAL CONDITIONS FROM THE GVEC SOLUTION",
            "text": "As was mentioned in the Sec. II, although~j and W are related by ~j \u00bc D W; ~j is stored as a separate variable in finite element representation for numerical purpose. It makes sense to first calculate the initial condition for ~j from the GVEC data and then calculate W0 from ~j0 using Eq. (3e) at t\u00bc 0,\nD W0 \u00bc ~j0: (32)\nHere, the subscript 0 refers to the fact that W0 and~j0 are the initial values of W and~j.\nThe equilibrium magnetic field provided by the GVEC solution will be referred to as ~BGVEC. Since GVEC works with full MHD, one needs to consider the full MHD ansatz, as given by (21), when working with~BGVEC,\n~BGVEC \u00bc rv\u00ferW0 rv\u00ferX0 rwv:\nTaking the curl of the above equation and dotting it with rv, after some algebra, one has the following:\njvGVEC \u00bc rv r ~BGVEC \u00bc r \u00f0B2vr?W0\u00de \u00fe r \u00f0Bv@kX0rwv\u00de:\nUsing the same ordering as in Sec. II, where Bv \u00bc O\u00f01\u00de; W \u00bc O\u00f0k\u00de; X \u00bc O\u00f0k2\u00de and @k \u00bc O\u00f0k\u00de, it can be seen that the first term is O\u00f0k\u00de and the second term is O\u00f0k3\u00de. Thus, the second term can be neglected, due to being two orders of k higher than the first term. This significantly simplifies the calculation, as now one can just set ~j0 \u00bc j v GVEC=B 2 v \u00bc rv r ~BGVEC=B2v . Having determined ~j0, it remains to solve Eq. (32) for W0. First, however, one needs to determine the boundary condition on W. Note\nthat W is not constant on flux surfaces in stellarator geometry, unlike the tokamak situation. When running a fixed boundary simulation, as done in this study, it is usually assumed that the plasma is surrounded by a perfect conductor, so the magnetic field at the boundary does not have a normal component: ~n ~B \u00bc 0. In the reduced MHD model, this means that W has to satisfy ~n \u00f0rW rv\u00de \u00bc ~n rv at all times. This is a nonhomogeneous linear differential equation, which must be solved on the boundary of the torus; the solution to this differential equation then provides a nonhomogeneous Dirichlet boundary condition for Eq. (32). Note that the kernel of the differential operator in the boundary equation is quite large, consisting of all functions f \u00f0v\u00de. Using a flux-surface-aligned coordinate system \u00f0w; h;/\u00de, where w is a flux surface label, h is the GVEC poloidal angle, which, like in VMEC, is constructed for each particular equilibrium in the course of minimization, and / is the geometric toroidal angle, the boundary equation becomes\n@W @h @v @/ @W @/ @v @h \u00bc Jrw rv; (33)\nwhere J \u00bc \u00bdrw \u00f0rh r/\u00de 1 is the Jacobian. Note that \u00f0w; h;/\u00de is not a straight field line coordinate system. However, solving the equation in this form is numerically difficult because one cannot easily separate the kernel and remove it from the solution space. To do so, one must switch to a coordinate system where v is one of the coordinates. It is best to switch out / for v, since a stellarator must have a nonvanishing toroidal component to its vacuum field [c.f. the F0/ term in Eq. (13)], so @v=@/ is nonvanishing and the Jacobian of the new coordinates is nowhere singular. The boundary equation in \u00f0w; h; v\u00de coordinates is\n@W @h \u00bc J 0rw rv; (34)\nwhere J 0 \u00bc \u00bdrw \u00f0rh rv\u00de 1 is the new Jacobian. It is easy to solve this equation in JOREK. Due to the JOREK grid for our applications here being flux-surface-aligned, the element local coordinates s and t (see Appendix A) can be related to the coordinates w and h as w \u00bc s; h \u00bc 2p\u00f0t \u00fe ibnd elm\u00de=Nbnd elm, where ibnd elm is the zero-based index of the current boundary element, and Nbnd elm is the total number of boundary elements. Finally, the v coordinate is given by the Dommaschk representation (14). The solution space in which the solution to Eq. (34) is searched for can now be represented as\nVsol \u00bc span f cosmh; sinmhjm \u00bc 1;\u2026;mpolg\nf1; cos nNp~v; sin nNp~vjn \u00bc 1;\u2026; ntorg ; (35)\nwhere Ncp is defined in Appendix A, and ~v \u00bc v=F0. Excluding the m\u00bc 0 mode removes the kernel of the differential operator of Eq. (34) from Vsol, and the equation can then be solved using the standard Fourier\u2013Galerkin method. The solution obtained this way is then projected back onto the JOREK finite element basis and written to the boundary nodes. Finally, Eq. (32) is solved by splitting W0 \u00bc W0;i \u00feWb, where Wb is the solution to Eq. (34) and thus satisfies the nonhomogeneous Dirichlet boundary condition, while W0;i is an unknown function, which is zero at the boundary. The solution W0;i is then found using the standard JOREK solver with homogeneous Dirichlet boundary conditions. When W is evolved in time, JOREK will solve for the increment dW at each time step, which must\nPhys. Plasmas 29, 063901 (2022); doi: 10.1063/5.0087104 29, 063901-7\nVC Author(s) 2022\n18 January 2024 21:27:55\nalso be zero at the boundary (and thus can also be obtained using the standard solver with homogeneous Dirichlet boundary conditions), so that the nonhomogeneous boundary condition continues to be satisfied for the totalW.\nThe last step is determining an initial condition for temperature, which is almost trivial. The GVEC solution provides a pressure profile pGVEC, which must be simply converted to JOREK units and divided by the initial density profile q0. In all of the stellarator simulations presented in this paper, the initial density is taken to be constant for simplicity, which corresponds to q0 \u00bc 1 in JOREK units."
        },
        {
            "heading": "V. A CONSISTENCY CHECK FOR THE STELLARATOR MODEL",
            "text": "After having derived and implemented the stellarator model, it remains to validate it for stellarators, showing that it does work. However, before proceeding to more complicated cases, a set of initial tests must be performed using stable equilibria to demonstrate that the model is indeed consistent, the error due to the neglect of fourth-order terms in the Lorentz force, which was discussed in Sec. II, is small, and no significant change is observed in the stable cases after simulating them for some time.\nThe consistency checks were done using four equilibria based on the historic Wendelstein 7-A stellarator27 with different values of b. Note that the b values here and throughout the rest of this paper are volume-averaged. These equilibria were intended to be unstable to the (2,1) tearing mode; however, sinceWendelstein 7-A had five field periods, the simulations can be performed with fivefold periodicity, excluding the unstable n\u00bc 1 Fourier mode and its mode family. Thus, in the computational setting used in this section, there are no physical instabilities. The equilibria were first calculated with NEMEC,37 and then, GVEC was used to refine them. Poloidal modesm \u00bc 0;\u2026; 12 and toroidal modes n \u00bc 0; 5; 10;\u2026; 50, which correspond to Nctor \u00bc 21 and Ncp \u00bc 5 in JOREK (see Appendix A), were used to calculate the equilibrium. All of the equilibria have the same boundary: a rotating ellipse with a minor axis of 0.09131 m and a major axis of 0.1178m; the major radius of the torus is 1.99m. The normalized toroidal current profile was also the same for all equilibria,\nIn\u00f0wtn\u00de \u00bc 3wtn 3w2tn \u00fe w 3 tn; (36)\nwhere wtn is the toroidal flux normalized so that wtn \u00bc 0 at the axis and wtn \u00bc 1 at the boundary. In\u00f0wtn\u00de, which represents the toroidal current enclosed by the flux surface wtn, is normalized by the total toroidal current, which was 17.5 kA in the cases considered, such that In\u00f01\u00de \u00bc 1. The total toroidal magnetic flux through a poloidal plane was 0.08Wb. The pressures at the axis were 1, 100, and 500Pa, and 1kPa, which correspond to the b-values of 2:3 10 5 %; 2:3 10 3 %, 0.011%, and 0.022%, respectively. The pressure profiles are given by\np\u00f0wtn\u00de \u00bc pa \u00f0pa pb\u00dewtn; (37)\nwhere p is the pressure in pascals, pa is the pressure at the axis, and pb is the pressure at the boundary. For the b \u00bc 2:3 10 5 % (pa \u00bc 1 Pa) case, pb \u00bc 0:01 Pa, while for the other three cases, pb \u00bc 1 Pa. When finding the initial conditions from the GVEC equilibrium, Ntor \u00bc 9 and Np \u00bc 5 (see Appendix A) were used for the variables, which correspond to Fourier modes n \u00bc 0; 5;\u2026; 20. The profile of the rotational transform i, which was the same for all equilibria considered in this study, is shown in Fig. 3.\nAll of the simulations were run with a spatially constant resistivity g \u00bc 1:938 10 9 Xm and viscosity l \u00bc 2:90 10 9 kg=\u00f0ms\u00de. In addition, a hyperviscosity lh \u00bc 2:90 10 12 kgm=s was applied. The radial resolution of the finite elements was 41 nodes, and the poloidal resolution was 48 nodes, that is, moving from the axis to the edge, 41 grid nodes will be passed, counting the nodes at the axis and edge, and 48 grid nodes will be passed in one poloidal turn. The first part of the simulation was run using the implicit Euler time-stepping scheme to damp out small oscillations that were present due to the neglect of fourth-order terms in the Lorentz force and different discrete representations in JOREK and GVEC (see Fig. 4). This consisted of 20 time steps of length 6:484 10 4 ms (1 in JOREK units), followed by 20 time steps of length 6:484 10 3 ms (10 in JOREK units), followed by 10 time steps of length 6:484 10 2 ms (100 in JOREK units). For the b \u00bc 0:022% case, but not for the others, this was followed by another 10 time steps of length 6:484 10 2 ms. In the second part of the simulation, the Crank\u2013Nicolson time-stepping scheme was used,38 and all four cases were simulated for 6.484ms (10 000 in JOREK units). The b \u00bc 2:3 10 5 % and b \u00bc 2:3 10 3 % cases used time steps of length 6:484 10 2 ms in the\nFIG. 3. The i profile as a function of wtn. This profile is the same for all configurations considered in this paper.\nPhys. Plasmas 29, 063901 (2022); doi: 10.1063/5.0087104 29, 063901-8\nVC Author(s) 2022\n18 January 2024 21:27:55\nsecond part; however, the b \u00bc 0:011% and b \u00bc 0:022% required shorter time steps (3:242 10 2 and 1:621 10 2 ms, respectively) for numerical stability. When evaluating the integrals in the weak form of Eq. (3), the toroidal integration was performed by summing over 40 poloidal planes evenly spread over one period.\nAs expected, no large-scale motion was observed in any of the four simulations, confirming in fact that equilibrium is maintained in the reduced MHD model and its implementation. This can be seen in Fig. 5, where the R coordinate of the magnetic axis is plotted as a function of time for each of the four simulations, along with the error bars. The straight line of the same color outside the error bars represents the axis position in the full MHD equilibrium as calculated in GVEC. The difference between the JOREK and GVEC axis positions is due to the magnetic field being approximated by the reduced MHD ansatz. The axis was determined by making an initial guess for its (R, z) position in the / \u00bc 0 poloidal plane and then tracing the field line at that position for ten toroidal turns, after which the tolerance T \u00bc 0:1\nffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffiffi \u00f0maxRi minRi\u00de\u00f0max zi min zi\u00de p , where i \u00bc 1;\u2026; 10, is calculated. If this tolerance is smaller than the cutoff, which was set to 5 10 5 m, then the axis is considered found: the axis position at\n/ \u00bc 0 is \u00f0Rc; zc\u00de \u00bc \u00f0\u00f0maxRi \u00feminRi\u00de=2; \u00f0max zi \u00femin zi\u00de=2\u00de. If not, then the field line tracing is restarted at \u00f0Rc; zc\u00de, and the process is repeated until the tolerance is less than the cutoff. The error in the Rcoordinate was estimated as ER \u00bc 0:1\u00f0maxRi minRi\u00de and plotted as error bars in Fig. 5.\nTo demonstrate that there is no significant motion even away from the axis, the Poincare plots for the b \u00bc 0:022% case are shown in Fig. 6, both before and after the simulation, along with the flux surfaces of the GVEC equilibrium. As can be seen, the flux surfaces in JOREK coincide with the GVEC flux surfaces, so the error introduced by using the reduced MHD ansatz for the magnetic field has no noticeable effect on the flux surfaces. Moreover, the flux surfaces do not move during the simulation, preserving the stable equilibrium as expected."
        },
        {
            "heading": "VI. TEARING MODE BENCHMARK",
            "text": "Having demonstrated that basic stellarator simulations can be run with the correct equilibrium in the newly implemented model in JOREK, the next step is to simulate instabilities and benchmark them against known results. Tearing modes in the Wendelstein 7-A stellarator were used for this purpose. Three cases at different values of b were considered: 2:3 10 5 %; 2:3 10 4 %, and 2:3 10 3 %. For reference, Fig. 7 shows the velocity stream function U without the n\u00bc 0, 5, 10 Fourier modes, which do not contribute to the tearing mode, on the / \u00bc 0 poloidal plane during the presaturation (linear) phase of the full-torus simulation (see below). The characteristic (2,1) structure of the mode is clearly visible. The b \u00bc 2:3 10 5 % and b \u00bc 2:3 10 3 % are the same equilibria that were used in the previous section, with the b \u00bc 2:3 10 4 % being a new equilibrium with the same boundary and current profile as the other two and an intermediate value of b. In this new intermediate equilibrium, pa \u00bc 10 Pa and pb \u00bc 0:1 Pa. When finding the initial conditions from the GVEC equilibrium, Ntor \u00bc 5 and Np \u00bc 5 (see Appendix A) were used for the variables, which correspond to Fourier modes n\u00bc 0, 5, and 10.\nJust as before, the stellarator simulations were run with the implicit Euler time-stepping scheme and fivefold periodicity to damp out oscillations. This consisted of 20 time steps of length 6:484 10 4 ms, followed by 20 time steps of length 6:484 10 3 ms, followed by 5 time steps of length 6:484 10 2 ms. The resistivity was\nPhys. Plasmas 29, 063901 (2022); doi: 10.1063/5.0087104 29, 063901-9\nVC Author(s) 2022\n18 January 2024 21:27:55\nset to g \u00bc 1:938 10 6 Xm, and the viscosity was zero. The hyperviscosity was lh \u00bc 2:90 10 15 kgm=s for the b \u00bc 2:3 10 5 %, and the b \u00bc 2:3 10 4 % cases, and lh \u00bc 7:25 10 15 kgm=s for the b \u00bc 2:3 10 3 % case. The finite element resolution was 41 nodes radially and 48 nodes poloidally, just as before. Both heat conduction and mass diffusion were set to zero. It should be noted that, when using Ntor \u00bc 5, anisotropic transport cannot be properly modeled, as field lines tend to slightly drift from flux surfaces after many toroidal turns, which leads to parallel transport contributing to perpendicular transport after enough time steps. This problem can be remedied by including more toroidal modes.\nIn the second part of the simulation, the domain was extended to the full torus, taking now into account all of the n \u00bc 0;\u2026; 10 Fourier modes, corresponding to Ntor \u00bc 21 and Np \u00bc 1 (see Appendix A). The Crank\u2013Nicolson scheme was used with time steps of length 1:621 10 2 ms. The toroidal integration in the weak form of equations (3) was performed by summing over 40 poloidal planes evenly spread throughout the full torus. The number of Fourier modes, the number of poloidal planes, and the values of hyperviscosity, resolution, and time step size were chosen after scanning over several values for each parameter and choosing the value at which the growth rate of the tearing mode converged. For the present purposes, convergence is considered to be achieved when halving the time step size or hyperviscosity, or doubling the resolution, the number of modes, or the number of planes leads to a change in the growth rate of less than 1.5%. The convergence test was performed for the b \u00bc 2:3 10 3 % and b \u00bc 2:3 10 5 % cases, resulting in all of the parameters converging to the same values, except for hyperviscosity, which converged to lh \u00bc 7:25 10 15 kgm=s for the b \u00bc 2:3 10 3 % case and lh \u00bc 2:90 10 15 kg m=s for the b \u00bc 2:3 10 5 % case. The b \u00bc 2:3 10 4 % case was then run using the lower value of hyperviscosity. Figure 8(a) shows the values of the growth rates from\nJOREK alongside the values calculated in the linear MHD code CASTOR3D.28,29 The maximum deviation between the two codes is 13.2% and occurs at b \u00bc 2:3 10 4 %.\nFor reference, Fig. 9 shows the magnetic energies of each individual Fourier mode in the b \u00bc 2:3 10 5 % case, except for modes that belong to the n\u00bc 0 mode family (n\u00bc 0, 5, 10). The time axis starts slightly before 0.5ms, as that is where the full-torus simulation begins and the Fourier modes shown are initialized. As expected, the n\u00bc 1\nFIG. 8. The JOREK and CASTOR3D growth rates at g \u00bc 1:938 10 6 Xm and differing betas (a), and at b \u00bc 2:3 10 5 % and differing resistivities (b).\nFIG. 7. The velocity stream function U without the n\u00bc 0, 5, and 10 Fourier modes on the / \u00bc 0 poloidal plane in the b \u00bc 2:3 10 5 %; g \u00bc 1:938 10 6 Xm case at t\u00bc 0.969ms.\nPhys. Plasmas 29, 063901 (2022); doi: 10.1063/5.0087104 29, 063901-10\nVC Author(s) 2022\n18 January 2024 21:27:55\nFourier mode drives the instability, with the rest of its mode family (n\u00bc 4, 6, and 9) growing with it due to linear mode coupling. Around 2ms, the n\u00bc 1 mode begins to drive the n\u00bc 2 mode via nonlinear coupling, which in turn drives the rest of its mode family (n\u00bc 3, 7, and 8) via linear coupling. Finally, the mode saturates around 3\u20133.5ms. The saturated magnetic island structure is shown in the Poincare plot in Fig. 10. Note that, aside from the dominant (2,1) island chain, there is a secondary (3,2) island chain toward the interior of the plasma, which is nonlinearly excited by the mode.\nTwo more simulations were performed with the b \u00bc 2:3 10 5 % case, this time using resistivities of g \u00bc 1:938 10 7 and g \u00bc 1:938 10 5 Xm, while all of the other parameters were kept the same as before. For the g \u00bc 1:938 10 7 Xm case, a hyperresistivity of gh \u00bc 9:691 10 14 Xm2 (5 10 14 in JOREK units) had to be introduced in order for the iterative solver to converge in a reasonable amount of time. However, it was first confirmed that introducing this amount of hyper-resistivity in the g \u00bc 1:938 10 6 Xm case, which could be run with or without hyper-resistivity, changes the growth rate by less than 1.5%. Figure 8(b) shows the growth rates for the b \u00bc 2:3 10 5 % case at different values of resistivity alongside the growth rates calculated by CASTOR3D. The maximum deviation between the two codes is 26.2%, occurring at g \u00bc 1:938 10 5 Xm. This is most likely due to the neglect of vk by the model used in these simulations, as vk can be large within the resistive layer, and the size of the resistive layer increases with resistivity. A similar effect is known to exist for quasi-interchange modes. Neglecting the parallel velocity leads to an overestimation of the quasi-interchange growth rates by a factor of ffiffiffiffiffiffiffiffiffiffiffiffiffiffiffi 1\u00fe 2q2s p , where qs is the safety factor of the flux surface where the mode appears.39 In general, the agreement on the growth rates for the (2,1) tearing mode looks convincing, with deviations on the order of 10% from CASTOR3D, which solves the linearized full MHD equations."
        },
        {
            "heading": "VII. BALLOONING MODE BENCHMARK",
            "text": "A similar benchmark with CASTOR3D for ballooning mode growth rates in Wendelstein 7-A using equilibria with b \u00bc 0:11% and\nb \u00bc 0:21% (corresponding to axis pressures of 5 and 10 kPa) has been performed at resistivities of g \u00bc 1:938 10 7 Xm and g \u00bc 5:814 10 7 Xm. For reference, the velocity stream function U is shown in\nFig. 11 during the linear phase of the b \u00bc 0:21%; g \u00bc 1:938 10 7 Xm simulation. These equilibria have the same toroidal current and pressure profiles as the equilibria in Sec. V, with pb set to 1Pa and 100Pa, respectively. As before, the simulations were initially run with the implicit Euler scheme to damp out oscillations. This first phase of the simulation consisted of 30 time steps of length 6:484 10 4 ms. In the second part of the simulation, the Crank\u2013Nicolson scheme was used; however, both parts were run with a fivefold periodicity, since ballooning modes can be simulated with just one period.\nBased on linear ballooning mode theory in the tokamak limit, ballooning mode growth rates are known to diverge as n!1 if there are no background flows present in the initial equilibrium.4 In order to realistically model ballooning modes, one would have to include an equilibrium flow, such as diamagnetic drift, which will stabilize modes with n > nmax.\n40 However, since we only want to do a benchmark, we do not use equilibrium flows in either JOREK or CASTOR3D, but simply cut off the number of Fourier modes in the JOREK simulations, and then limit the CASTOR3D run to the same number of modes. We chose to keep only the n\u00bc 0, 5, 10 modes in the simulations considered here; the highest mode (n\u00bc 10) is dominant in this case, as it grows the fastest, and its energy quickly exceeds that of the other modes. We have also tried including the n\u00bc 15 and n\u00bc 20 modes in case the prediction about increasing growth rates from the tokamak limit is no longer valid for Wendelstein 7-A; however, we found that the highest-n mode is the fastest-growing one in those simulations as well.\nHolding the number of modes fixed at Ntor \u00bc 5, a convergence test was performed for the b \u00bc 0:21% equilibrium while using a resistivity of g \u00bc 1:938 10 7 Xm. The growth rate converged at a finite element resolution of 61 nodes radially and 72 nodes poloidally, time step size of 6:484 10 4 ms, and a hyperviscosity of\ng \u00bc 1:938 10 6 Xm case at t\u00bc 4.03ms. FIG. 11. The velocity stream function U on the / \u00bc 0 poloidal plane in the b\u00bc 0:21%; g \u00bc 1:938 10 7 Xm case at t\u00bc 0.074ms.\nPhys. Plasmas 29, 063901 (2022); doi: 10.1063/5.0087104 29, 063901-11\nVC Author(s) 2022\n18 January 2024 21:27:55\nlh \u00bc 7:25 10 15 kgm=s. The other three simulations were then run with these parameters. Both heat conductivity and mass diffusion parameters were set to zero in all four simulations. Figure 12 shows the growth rates measured in the four cases, along with the growth rates calculated in CASTOR3D for the same four cases. The maximum deviation is 6.4% and occurs at b \u00bc 0:11%; g \u00bc 1:938 10 7 Xm, with the other three deviations all being less than 3%.\nCutting off the Fourier series without stabilizing the high-n modes could lead to spectral blocking,41 where existing modes couple to higher modes that are not included in the Fourier series, and these coupling contributions are aliased back onto the existing modes, leading to inaccurate results. To check whether our results are affected by this numerical error, we first repeated the CASTOR3D run for the b \u00bc 0:21%; g \u00bc 1:938 10 7 Xm case with the n\u00bc 15 mode included and compared the individual growth rate of the n\u00bc 10 Fourier mode in this simulation to that in the simulation without the n\u00bc 15 mode also included. We found that the n\u00bc 10 growth rate changed by less than 0.003%, indicating that the CASTOR3D result is trustworthy. We then took a time step from the n\u00bc 0, 5, and 10 JOREK simulation of the b \u00bc 0:21%; g \u00bc 1:938 10 7 Xm case where the ballooning mode had already emerged and was linearly growing, and restarted it with the n\u00bc 15 mode also included. We found that the n\u00bc 10 growth rate decreased by about 5%\u20136% (depending on the exact time step at which it was restarted), becoming much closer to the CASTOR3D value. Thus, in JOREK simulations spectral blocking has more of an effect and it accounts for most of the discrepancy between JOREK and CASTOR3D results. Generally, in both codes, the growth rates of the n\u00bc 10 dominated mode are only weakly affected by the choice of including or excluding the n\u00bc 15 mode in the simulation."
        },
        {
            "heading": "VIII. CONCLUSIONS",
            "text": "Continuing the work of previous studies,20,21 we implement a stellarator-capable reduced MHD model in JOREK and run several test cases based on the simple geometry of the Wendelstein 7-A stellarator. This paper presents the results, starting with Sec. II, which shows that the reduced model introduces an error into Lorentz force, but the error is negligible. The implementation is discussed in Secs. III and IV. In order to guarantee r ~B \u00bc 0 to machine precision, an analytical representation of the vacuum magnetic field (i.e., the curl-free component), as derived by Dommaschk,22 was used. This representation is compatible with arbitrary vacuum fields in a toroidal device. In order\nto run a simulation, the GVEC code is used to calculate an equilibrium, which is then used as an initial condition for the JOREK run. The actual Wendelstein 7-A simulations are presented in Secs. V\u2013VII. Stable full MHD equilibria are preserved in the reduced model: the flux surfaces do not move throughout the simulation and closely match the flux surfaces calculated in GVEC, just as one would expect from the ordering argument in Sec. II. Furthermore, both tearing and ballooning modes were simulated, and the linear growth rates measured in JOREK are in decent agreement with the growth rates calculated by the CASTOR3D linear full MHD code.\nAlready in its current form, JOREK is capable of handling more complicated machines, such as Wendelstein 7-X and LHD. Benchmarks involving instabilities in these advanced devices are in progress, and the results will be reported in a future publication. We also plan to look for pressure-induced islands in high-b simulations to see how well their widths match the theoretical predictions of Cary and Kotschenreuther.42 Studies of scenarios relevant to ongoing experiments are also planned. Of particular interest are the current-driven sawtoothlike crashes observed in Wendelstein 7-X.43 Previous studies, which included both linear fully three-dimensional simulations with CASTOR3D44 and nonlinear simulations in a simplified cylindrical geometry with the TM1 code,45 have found that the corresponding Wendelstein 7-X equilibria are unstable to single and double modes, as well as resistive kink modes, and that the coupling of double-tearing modes with kink modes produces the sawtooth-like crashes. While the family of reduced MHD models used in JOREK, including the models derived in our previous work, cannot accurately reproduce kink modes at higher b,1 similar sawtooth-like crashes have also been simulated in TM1 at zero b.45 Using JOREK will allow us to nonlinearly simulate these modes in a fully three-dimensional geometry.\nAnother line of work that we intend to pursue is implementing more advanced models for stellarators than the one studied here. The most immediate improvement to the model used here would be to add vk; other improvements include implementing separate temperatures for electrons and ions, adding a neutral density, and other model extensions already implemented for the tokamak models.1 Going further, we also intend to implement a full MHD model for stellarators. This will most likely involve extending the full MHD model described in Ref. 46, which uses the standard MHD variables f~A;~v;q;Tg and does not involve any ansatzes or projections, to stellarators. This may require that the vector components of~v and ~A are stored in a fluxsurface-aligned coordinate system instead of the cylindrical \u00f0R; z;/\u00de coordinate system as in Ref. 46. However, implementing the full MHD model with the fW;X;U; vk; f;q;Tg variables, which was derived in Ref. 21 and can be seen as a direct extension of the model used in this study, would also be interesting for comparison purposes. Finally, although we do not expect any issues, it remains to be seen if the model used in this study will hold up for b 3 5%. Further modifications to the model may be needed if future work does not produce satisfactory results for this range of b."
        },
        {
            "heading": "ACKNOWLEDGMENTS",
            "text": "The authors thank Alessandro Zocco and Carolin Nuehrenberg for fruitful discussions, and Michael Drevlak for providing access to his EXTENDER_P code and patiently answering questions about code use.\nPhys. Plasmas 29, 063901 (2022); doi: 10.1063/5.0087104 29, 063901-12\nVC Author(s) 2022\n18 January 2024 21:27:55\nThis work has been carried out within the framework of the EUROfusion Consortium, funded by the European Union via the Euratom Research and Training Programme (grant agreement no. 101052200\u2014EUROfusion). Views and opinions expressed are, however, those of the author(s) only and do not necessarily reflect those of the European Union or the European Commission. Neither the European Union nor the European Commission can be held responsible for them.\nAUTHOR DECLARATIONS Conflict of Interest\nThe authors have no conflicts to disclose.\nDATA AVAILABILITY\nThe data that support the findings of this study are available from the corresponding author upon reasonable request."
        },
        {
            "heading": "APPENDIX A: THE JOREK NONAXISYMMETRIC GRID",
            "text": "The spatial discretization in JOREK is performed via twodimensional quadrilateral finite elements in the poloidal plane and a toroidal Fourier expansion. The finite element discretization has G1 continuity, meaning that any discretized functions and their first derivatives are continuous across element boundaries, but second derivatives can jump.\nIn each element, an element-local coordinate system \u00f0s; t;/\u00de; s; t 2 \u00bd0; 1 is set up, where \u00f0s; t\u00de \u00bc \u00f00; 0\u00de; \u00f00; 1\u00de; \u00f01; 0\u00de; \u00f01; 1\u00de corresponds to the four vertices of the element, and / is the geometric toroidal angle, identical to the / coordinate of the cylindrical coordinate system \u00f0R; z;/\u00de. In general, s and t can have arbitrary orientations in the poloidal plane; however, in most configurations without an X-point, s is the radial coordinate and t is the poloidal coordinate. All quantities, including the cylindrical coordinates R and z, are expressed in terms of the element-local coordinates. Expressing R and z in terms of element-local coordinates allows one to adjust the positions of the vertices of an element, which is normally used to build a flux-surface-aligned grid. Previously, R and z could only depend on s and t, but not /;1 however, this constraint was removed as part of the JOREK stellarator effort. Now, the cylindrical coordinates inside a particular element are represented as\nfR; zg\u00f0s; t;/\u00de \u00bc XNctor n\u00bc1 X4 i\u00bc1 X4 j\u00bc1 fRijn; zijngBij\u00f0s; t\u00deZcn\u00f0/\u00de; (A1)\nwhere i sums over the four vertices of the element, j sums over the degrees of freedom at each vertex, and n sums over the toroidal Fourier modes, with Nctor being an adjustable parameter. In addition, Bij\u00f0s; t\u00de are Bezier basis functions, and\nZcn\u00f0/\u00de \u00bc\n1; n \u00bc 1;\ncos Ncp n 2 / ; n even;\nsin Ncp n 1 2 / ; n odd and n > 1;\n8>>>>< >>>>:\nwhere Ncp is the periodicity of the underlying geometry. Allowing R and z to depend on / makes it possible to build a flux-surface-\naligned grid in a stellarator configuration. The physical quantities, such as density, temperature, and w, are represented in a similar way\nQ\u00f0s; t;/\u00de \u00bc XNtor n\u00bc1 X4 i\u00bc1 X4 j\u00bc1 QijnBij\u00f0s; t\u00deZn\u00f0/\u00de: (A2)\nNote that Ntor and Nctor are distinct parameters; on a flux surfacealigned grid, less modes are needed to reasonably represent the physical quantities than the geometry. The Fourier basis function Zn\u00f0/\u00de is defined in a similar way to Zcn\u00f0/\u00de, with the difference that Ncp is replaced by Np; this allows running full-torus simulations without having to add unnecessary modes to the geometry."
        },
        {
            "heading": "APPENDIX B: SELF-ADJOINTNESS OF THE LINEARIZED REDUCED MHD OPERATOR",
            "text": "If Eq. (3) is linearized and the nonideal terms are dropped, then the operator of the resulting linear equation will be selfadjoint. In the ideal case, Eq. (3) can be linearized as follows:\nr q0 B2v r? @U @t \u00bc r \u00f0~j0~B \u00fe~j~B0\u00de \u00fe Bv 1 B2v ; p ; (B1a)\n@q @t \u00bc Bv q0 B2v ;U ; (B1b)\n@p @t \u00bc 1 Bv p0;U\u00bd cp0Bv 1 B2v ;U ; (B1c)\n@W @t \u00bc @ kU W0;U\u00bd Bv ; (B1d)\nwhere a subscript of 0 denotes the equilibrium value of the corresponding quantity, and perturbations do not have any decorations. Now, analogous to the standard textbook derivation, let U \u00bc @n =@t integrate Eqs. (B1b)\u2013(B1d) over time and insert them back into Eq. (B1a). The following linear equation is obtained as follows:\nr q0 B2v r? @ 2n @t2\n! \u00bc L\u00f0n \u00de;\nL\u00f0n \u00de \u00bc r ~j0r @kn W0; n \u00bd\nBv\n! rv \"\n\u00fe~B0D @kn W0; n \u00bd\nBv\n!#\nBv 1 B2v ; 1 Bv p0; n \u00bd \u00fe cp0Bv 1 B2v ; n :\n(B2)\nThe linear operator L\u00f0n \u00de is analogous to the force operator ~F\u00f0~n\u00de of linear full MHD but has a different dimensionality and cannot be interpreted as the force.\nTo demonstrate self-adjointness, one has to show that for any two scalar functions n and g , which satisfy n \u00bc 0 and g \u00bc 0 on the boundary, one has \u00d0 g L\u00f0n \u00dedV \u00bc \u00d0 n L\u00f0g \u00dedV . Since L\u00f0n \u00de can be obtained by applying the projection operator (6) to the negative force operator ~F\u00f0rn rv=B2v\u00de, one can use the identity rf r ~U \u00bc r \u00f0rf ~U \u00de and integration by parts to write the following:\nPhys. Plasmas 29, 063901 (2022); doi: 10.1063/5.0087104 29, 063901-13\nVC Author(s) 2022\n18 January 2024 21:27:55\n\u00f0 g L\u00f0n \u00dedV \u00bc \u00f0rg rv B2v \u00f0~j0 ~B \u00fe~j ~B0 rp\u00dedV ; (B3)\nas in Ref. 21. Here, ~B0 \u00bc rv\u00ferW0 rv, which allows one to express the magnetic field and pressure perturbations in a familiar way\n~B \u00bc rW rv \u00bc r rn rv B2v ~B0 ; p \u00bc p0; n \u00bd =Bv cp0Bv B 2v ; n\n\u00bc rp0 rn rv\nB2v\ncp0r rn rv B2v :\n(B4)\nNow identify ~n \u00bc rn rv=B2v and ~g \u00bc rg rv=B2v , and note that the boundary conditions on n and g imply that the vector fields~n and~g satisfy the usual boundary condition for displacement in a plasma surrounded by a wall: ~n ~n \u00bc~g ~n \u00bc 0. Finally, one can apply the self-adjointness property of the force operator ~F\u00f0~n\u00de, which allows us to write\u00f0\ng L\u00f0n \u00dedV \u00bc \u00f0 ~g ~F\u00f0~n\u00dedV \u00bc \u00f0 ~n ~F\u00f0~g\u00dedV\n\u00bc \u00f0 n L\u00f0g \u00dedV : (B5)\nThis concludes the self-adjointness proof for the linear operator L\u00f0n \u00de."
        }
    ],
    "title": "JOREK3D: An extension of the JOREK nonlinear MHD code to stellarators",
    "year": 2024
}