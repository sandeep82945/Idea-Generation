{
    "abstractText": "An attempt to obtain market directional information from non\u2013stationary solution of the dynamic equation: \u201cfuture price tends to the value maximizing the number of shares traded per unit time\u201d is presented. A remarkable feature of the approach is an automatic time scale selection. It is determined from the state of maximal execution flow calculated on past transactions. Both lagging and advancing prices are calculated.",
    "authors": [
        {
            "affiliations": [],
            "name": "Vladislav Gennadievich Malyshkin"
        },
        {
            "affiliations": [],
            "name": "Mikhail Gennadievich Belov"
        }
    ],
    "id": "SP:1bf92752effa1a3f6f9b9e0f10474554c60c7af1",
    "references": [
        {
            "authors": [
                "V.G. Malyshkin"
            ],
            "title": "Market Dynamics: On Directional Information Derived From (Time",
            "venue": "Execution Price, Shares Traded) Transaction Sequences., ArXiv e-prints ",
            "year": 2019
        },
        {
            "authors": [
                "V.G. Malyshkin",
                "R. Bakhramov"
            ],
            "title": "Mathematical Foundations of Realtime Equity Trading",
            "venue": "Liquidity Deficit and Market Dynamics. Automated Trading Machines., ArXiv e-prints ",
            "year": 2015
        },
        {
            "authors": [
                "V.G. Malyshkin",
                "R. Bakhramov"
            ],
            "title": "Market Dynamics vs",
            "venue": "Statistics: Limit Order Book Example, ArXiv e-prints ",
            "year": 2016
        },
        {
            "authors": [
                "V.G. Malyshkin"
            ],
            "title": "Market Dynamics",
            "venue": "On Supply and Demand Concepts, ArXiv e-prints ",
            "year": 2016
        },
        {
            "authors": [
                "V.G. Malyshkin"
            ],
            "title": "On The Radon\u2013Nikodym Spectral Approach With Optimal Clustering",
            "venue": "arXiv preprint arXiv:1906.00460 ",
            "year": 2019
        },
        {
            "authors": [
                "V.G. Malyshkin"
            ],
            "title": "On Lebesgue Integral Quadrature",
            "venue": "ArXiv e-prints ",
            "year": 2018
        },
        {
            "authors": [
                "B. Beckermann"
            ],
            "title": "On the numerical condition of polynomial bases: estimates for the condition number of Vandermonde",
            "venue": "Krylov and Hankel matrices, Ph.D. thesis, Habilitationsschrift, Universit\u00e4t Hannover ",
            "year": 1996
        },
        {
            "authors": [
                "G. V"
            ],
            "title": "Malyshkin, (2014), the code for polynomials calculation, http://www.ioffe.ru/LNEPS/ malyshkin/code.html, there is also an alternative location",
            "year": 2014
        },
        {
            "authors": [
                "G.S. Malyshkin"
            ],
            "title": "The comparative efficiency of classical and fast projection algorithms in the resolution of weak hydroacoustic signals (\u0421\u0440\u0430\u0432\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u0430\u044f \u044d\u0444\u0444\u0435\u043a\u0442\u0438\u0432\u043d\u043e\u0441\u0442\u044c \u043a\u043b\u0430\u0441\u0441\u0438\u0447\u0435\u0441\u043a\u0438\u0445 \u0438 \u0431\u044b\u0441\u0442\u0440\u044b\u0445 \u043f\u0440\u043e\u0435\u043a\u0446\u0438\u043e\u043d\u043d\u044b\u0445 \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c\u043e\u0432 \u043f\u0440\u0438 \u0440\u0430\u0437\u0440\u0435\u0448\u0435\u043d\u0438\u0438 \u0441\u043b\u0430\u0431\u044b\u0445 \u0433\u0438\u0434\u0440\u043e\u0430\u043a\u0443\u0441\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0445 \u0441\u0438\u0433\u043d\u0430\u043b\u043e\u0432)",
            "venue": "Acoustical Physics 63, 216 (2017), doi:10.1134/S1063771017020099 ",
            "year": 2009
        }
    ],
    "sections": [
        {
            "text": "Market Directional Information Derived From (Time, Execution\nPrice, Shares Traded) Sequence of Transactions."
        },
        {
            "heading": "On The Impact From The Future.",
            "text": "Vladislav Gennadievich Malyshkin\u2217\nIoffe Institute, Politekhnicheskaya 26, St Petersburg, 194021, Russia\nMikhail Gennadievich Belov\u2020\nLomonosov Moscow State University, Faculty of Mechanics and Mathematics,\nGSP-1, Moscow, Vorob\u2019evy Gory, 119991, Russia\n(Dated: September, 20, 2022)\n$Id: ImpactFromTheFuture.tex,v 1.269 2022/10/09 10:41:55 mal Exp $\nAn attempt to obtain market directional information from non\u2013stationary solution\nof the dynamic equation: \u201cfuture price tends to the value maximizing the number of\nshares traded per unit time\u201d is presented. A remarkable feature of the approach is an\nautomatic time scale selection. It is determined from the state of maximal execution\nflow calculated on past transactions. Both lagging and advancing prices are calculated.\n\u2217 malyshki@ton.ioffe.ru \u2020 mikhail.belov@tafs.pro\nar X\niv :2\n21 0.\n04 22\n3v 1\n[ q-\nfi n.\nC P]\n9 O\nct 2\n02 2\n2 \u0412\u0440\u0435\u043c\u0435\u043d\u0430 \u041f\u0443\u0433\u0430\u0447\u0451\u0432\u0441\u043a\u043e\u0433\u043e \u0431\u0443\u043d\u0442\u0430.\n\u0421\u0430\u043c\u043e\u0437\u0432\u0430\u043d\u0435\u0446 \u0432\u044b\u0441\u0442\u0443\u043f\u0430\u0435\u0442 \u043f\u0435\u0440\u0435\u0434 \u043d\u0430\u0440\u043e\u0434\u043e\u043c,\n\u0433\u043e\u0432\u043e\u0440\u0438\u0442 \u043e \u0433\u0440\u044f\u0434\u0443\u0449\u0435\u043c \u0441\u0447\u0430\u0441\u0442\u044c\u0435, \u043a\u043e\u0442\u043e\u0440\u043e\u0435\n\u043f\u0440\u0438\u0434\u0451\u0442 \u0432 \u0444\u043e\u0440\u043c\u0435 \u043c\u0443\u0436\u0438\u0446\u043a\u043e\u0433\u043e \u0446\u0430\u0440\u0441\u0442\u0432\u0430.\n\u041f\u043b\u0435\u043d\u043d\u044b\u0439 \u043e\u0444\u0438\u0446\u0435\u0440 \u0441\u043f\u0440\u0430\u0448\u0438\u0432\u0430\u0435\u0442:\n\u201c\u041e\u0442\u043a\u0443\u0434\u0430 \u0434\u0435\u043d\u044c\u0433\u0438 \u0431\u0443\u0434\u0443\u0442 \u043d\u0430 \u0432\u0441\u044e \u044d\u0442\u0443\n\u0431\u043b\u0430\u0433\u043e\u0434\u0430\u0442\u044c\u201d? \u041f\u0443\u0433\u0430\u0447\u0451\u0432 \u043e\u0442\u0432\u0435\u0442\u0438\u043b: \u201c\u0422\u044b\n\u0447\u0442\u043e, \u0434\u0443\u0440\u0430\u043a? \u0418\u0437 \u043a\u0430\u0437\u043d\u044b \u0436\u0438\u0442\u044c \u0431\u0443\u0434\u0435\u043c!\u201d\n\u041d\u0430\u0440\u043e\u0434\u043d\u0430\u044f \u043b\u0435\u0433\u0435\u043d\u0434\u0430, 1774.\nI. INTRODUCTION\nIntroduced in [1] the ultimate market dynamics problem: an evidence of existence (or a proof of non\u2013existence) of an automated trading machine, consistently making positive P&L trading on a free market as an autonomous agent can be formulated in its weak and strong forms[2]: whether such an automated trading machine can exist with legally available data (weak form) and whether it can exist with transaction sequence triples (time, execution price, shares traded) as the only information available (strong form); in the later case execution flow I = dV/dt is the only available characteristic determining market dynamics.\nLet us formulate the problem in the third, \u201csuperstrong\u201d, form: Whether the future value of price can be predicted from (time, execution price, shares traded) sequence of past transactions? Previously[3, 4] we thought this is not possible, only P&L that includes not only price dynamics but also trader actions can be possibly predicted. Recent results changed our opinion.\nThere are two types of predicted price: \u201clagging\u201d (retarded) and \u201cadvancing\u201d (future) Lagging price PRet corresponds to past observations; future direction is determined by the difference of last price P last and PRet. An example of PRet is moving average. A common problem with lagging price is that it typically assumes an existence of a time scale the PRet is calculated with, what gives incorrect direction for market movements with time scales lower than the one of PRet; however making the time scale too low creates a large amount of\n3 false signals. Advancing price PAdv is predicting actual value of future price; the direction is determined by the difference of PAdv and P last. The PAdv is typically calculated from limit order book information, brokerage clients order flow timings, etc.\nIn this work both lagging and advancing prices are calculated from (time, execution price, shares traded) sequence of past transactions. The key element is to determine the state\u2223\u2223\u03c8[IH]\u232a of maximal execution flow I = dV/dt (eigenvalue problem (10)), as experiments show it\u2019s importance for market dynamics. Found\n\u2223\u2223\u03c8[IH]\u232a state automatically selects the time scale what makes the approach robust.\nFound lagging price (49) is the price in \u2223\u2223\u03c8[IH]\u232a state P [IH] plus trending term that suppresses false signals. The advancing price is obtained by considering density matrix state\n\u2016\u03c1JIH\u2016 corresponding to the state \u201csince \u2223\u2223\u03c8[IH]\u232a till now\u201d and experimentally observed fact\nthat operators \u2225\u2225pdI\ndt \u2225\u2225 and \u2225\u2225I dp dt \u2225\u2225 have to be equal in \u2016\u03c1JIH\u2016 state. This corresponds to the result of our previous works [3, 5]: execution flow I = dV/dt (the number of shares traded per unit time), not trading volume V (the number of shares traded), is the driving force of the market: asset price is much more sensitive to execution flow I (dynamic impact), rather than to traded volume V (regular impact).\nThis paper is concerned only with obtaining directional information from a sequence of past transaction in a \u201csingle asset universe\u201d just for simplicity, see Section VIII below for multi asset universe generalization. Whereas the dynamics theory of Section IV definitely requires additional research, the lagging indicator (49) of Section VI, see Fig. 8, can be practically applied to trading even in a single asset universe. In this work we do not implement any trading ideas of [3, 4], where a concept of liquidity deficit trading: open a position at low I, then close already opened position at high I, as this is the only strategy that avoids eventual catastrophic P&L losses. This paper is concerned only with obtaining a directional information that is required to determine what side the position has to be open on a liquidity deficit event."
        },
        {
            "heading": "II. THE STATE OF MAXIMAL EXECUTION FLOW",
            "text": "Introduce a wavefunction \u03c8(x) as a linear combination of basis function Qk(x):\n\u03c8(x) = n\u22121\u2211 k=0 \u03b1kQk(x) (1)\n4 Then an observable market\u2013related value f , corresponding to probability density \u03c82(x), is calculated by averaging timeserie sample with the weight d\u00b5 = \u03c82(x(t))\u03c9(t)dt; the expression corresponds to an estimation of Radon\u2013Nikodym derivative[6]:\nf\u03c8 = \u3008\u03c8 | f |\u03c8\u3009 \u3008\u03c8 |\u03c8\u3009\n(2)\nf\u03c8 =\nn\u22121\u2211 j,k=0 \u03b1j \u3008Qj | f |Qk\u3009\u03b1k\nn\u22121\u2211 j,k=0 \u03b1j \u3008Qj |Qk\u3009\u03b1k (3)\nFor averages we use bra\u2013ket notation by Paul Dirac: \u3008\u03c8| and |\u03c8\u3009. The (2) is plain ratio of two moving averages, but the weight is not regular decaying exponent \u03c9(t) from (A3), but exponent multiplied by wavefunction squared as d\u00b5 = \u03c82(x(t))\u03c9(t)dt, the \u03c82(x) defines how to average a timeserie sample. Any \u03c8(x) function is defined by n coefficients \u03b1k, the value of an observable variable f in \u03c8(x) state is a ratio of two quadratic forms on \u03b1k (3); as an example of a wavefunction see localized state (13), it can be used for Radon\u2013\nNikodym interpolation: f(y) \u2248 \u3008\u03c8y | f |\u03c8y\u3009 / \u3008\u03c8y |\u03c8y\u3009; familiar least squares interpolation is\nalso available: f(y) \u2248 \u3008\u03c8y | f\u3009\u03c8y(y) = \u2211n\u22121 j,k=0 \u3008Qjf\u3009G \u22121 jk Qk(y).\nOne can also consider a more general form of average, d\u00b5 = P (x(t))\u03c9(t)dt, where P (x) is an arbitrary polynomial, not just the square of a wavefunction. These states correspond to a density matrix average:\nf\u03c1P = Spur \u2016f |\u03c1P\u2016 Spur \u2016\u03c1P\u2016\n(4)\nThis average, the same as (2), is a ratio of two moving averages. For an algorithm to convert a polynomial P (x) to the density matrix \u2016\u03c1P\u2016 see Theorem 3 of [7]. A useful application of the density matrix states is to study an average \u201csince |\u03c8\u3009\u201d; for example if |\u03c8\u3009 corresponds to a past dV/dt spike, then the polynomial \u201csince |\u03c8\u3009 till now\u201d is P (x) = J(\u03c82(x)) with J(\u00b7) defined in\n(A9); price change between \u201cnow\u201d and the time of spike is P last\u2212\u3008\u03c8 | p |\u03c8\u3009 = Spur \u2225\u2225dp dt \u2223\u2223\u03c1J(\u03c82)\u2225\u2225, similarly, total traded volume on this interval is Spur \u2225\u2225dV dt\n\u2223\u2223\u03c1J(\u03c82)\u2225\u2225. The main idea of [3] is to consider a wavefunction (1) then to construct (3) quadratic forms ratio. A generalized eigenvalue problem can be considered with the two matrices from (3). The most general case corresponds to two operators A and B. Consider an eigenvalue problem with the matrices \u3008Qj |A |Qk\u3009 and \u3008Qj |B |Qk\u3009:\u2223\u2223A\u2223\u2223\u03c8[i]\u232a = \u03bb[i] \u2223\u2223B\u2223\u2223\u03c8[i]\u232a (5)\n5 n\u22121\u2211 k=0 \u3008Qj |A |Qk\u3009\u03b1[i]k = \u03bb [i] n\u22121\u2211 k=0 \u3008Qj |B |Qk\u3009\u03b1[i]k (6)\n\u03c8[i](x) = n\u22121\u2211 k=0 \u03b1 [i] k Qk(x) (7)\n\u03b4ij = \u2329 \u03c8[i] \u2223\u2223B \u2223\u2223\u03c8[j]\u232a = n\u22121\u2211\nk,m=0\n\u03b1 [i] k \u3008Qk |B |Qm\u3009\u03b1 [j] m (8)\n\u03bb[i]\u03b4ij = \u2329 \u03c8[i] \u2223\u2223A \u2223\u2223\u03c8[j]\u232a = n\u22121\u2211\nk,m=0\n\u03b1 [i] k \u3008Qk |A |Qm\u3009\u03b1 [j] m (9)\nIf at least one of these two matrices is positively defined \u2013 the problem has a unique solution (within eigenvalues degeneracy). In the found basis \u2223\u2223\u03c8[i]\u232a the two matrices are simultaneously\ndiagonal: (8) and (9). See (A28) to convert an operator\u2019s matrix from \u2223\u2223\u03c8[i]\u232a to Qj basis and\n(A29) to convert it from Qj to \u2223\u2223\u03c8[i]\u232a basis.\nIn our previous work [1\u20133, 5] we considered various A and B operators, with the goal to find operators and states that are related to market dynamics. We established, that execution flow I = dV/dt (the number of shares traded per unit time), not trading volume V (the number of shares traded), is the driving force of the market: asset price is much more sensitive to execution flow I (dynamic impact), rather than to traded volume V (regular impact). This corresponds to the matrices \u3008Qj | I |Qk\u3009 = \u3008Qj |A |Qk\u3009 and \u3008Qj |Qk\u3009 = \u3008Qj |B |Qk\u3009. These two matrices are volume- and time- averaged products of two basis functions. Generalized eigenvalue problem for operator I = dV/dt is the equation to determine market dynamics:\n\u2223\u2223I\u2223\u2223\u03c8[i]\u232a = \u03bb[i] \u2223\u2223\u03c8[i]\u232a (10) n\u22121\u2211 k=0 \u3008Qj | I |Qk\u3009\u03b1[i]k = \u03bb [i] n\u22121\u2211 k=0 \u3008Qj |Qk\u3009\u03b1[i]k (11)\n\u03c8[i](x) = n\u22121\u2211 k=0 \u03b1 [i] k Qk(x) (12)\n\u03c8y(x) =\nn\u22121\u2211 i=0\n\u03c8[i](y)\u03c8[i](x)\u221a n\u22121\u2211 i=0 [\u03c8[i](y)] 2 = n\u22121\u2211 i=0\n\u2223\u2223\u03c8[i]\u232a \u2329\u03c8y \u2223\u2223\u03c8[i]\u232a = n\u22121\u2211 j,k=0 Qj(x)G \u22121 jk Qk(y)\u221a\nn\u22121\u2211 j,k=0 Qj(y)G \u22121 jk Qk(y)\n(13)\n\u2329 \u03c8y \u2223\u2223\u03c8[i]\u232a2 = [\u03c8[i](y)\n\u03c8y(y)\n]2 = [ \u03c8[i](y) ]2 n\u22121\u2211 k=0 [\u03c8[k](y)] 2\n(14)\nThe y = x0 is the time \u201cnow\u201d, \u03c8y(x) is a wavefunction localized at x = y. Here and below we write \u03c80(x) instead of \u03c8x0(x) to simplify notations. The \u2329 \u03c80 \u2223\u2223\u03c8[i]\u232a is the projection of the\u2223\u2223\u03c8[i]\u232a state of (10) eigenproblem to the state \u201cnow\u201d |\u03c80\u3009.\nOur analysis[1\u20133, 5] shows that among the states \u2223\u2223\u03c8[i]\u232a of the problem (10) the state corresponding to the maximal eigenvalue among all \u03bb[i], i = 0 . . . n\u2212 1, is the most important\nfor market dynamics. Consider various observable characteristics in this state \u2223\u2223\u03c8[IH]\u232a.\nIn Fig. 1 a demonstration of several observables: the price in \u2223\u2223\u03c8[IH]\u232a state (15), maximal\neigenvalue \u03bb[IH] of (10) problem, and minimal eigenvalue \u03bb[IL] (for completeness) are presented.\nP [IH] =\n\u2329 \u03c8[IH] \u2223\u2223 pI \u2223\u2223\u03c8[IH]\u232a \u3008\u03c8[IH] | I |\u03c8[IH]\u3009\n(15)\nFrom these observable one can clearly see that singularities in I cause singularities in price, and that a change in \u2223\u2223\u03c8[IH]\u232a localization causes an immediate \u201cswitch\u201d in an observable. This switch is caused by the presence of n\u2212 1 internal degrees of freedom \u03b1k (n coefficients, one\n7 less due to normalizing 1 = \u3008\u03c8 |\u03c8\u3009, Eq. (8)). Such a \u201cswitch\u201d is not possible in regular moving average (16) since it has no any internal degree of freedom, hence, all regular moving average dependencies are smooth.\nThe state \u2223\u2223\u03c8[IH]\u232a that maximizes the number of shares traded per unit time on past\nobservations sample is the main result of our initial work [3]."
        },
        {
            "heading": "III. ON TIME SCALE SELECTION OF A TRADING STRATEGY",
            "text": "Financial markets have no intrinsic time scales1 (at least those a market participant can take an advantage of). For US equity market \u2014 market timeserie data manifests an existence of time scales from microseconds to decades. For NASDAQ ITCH [8] data feed time-discretization is one nanosecond. Whereas real markets typically have no intrinsic time scale, any trading strategy typically does have an intrinsic time scale. This time scale is determined by: available data feeds, available execution, trader personal preferences, etc. An implementation of trading strategies with time scales under one second requires a costly IT infrastructure of data feed/execution, and is hard to program algorithmically; moreover, market liquidity at such a low time scale is low, a situation when a dozen of HFT firms are chasing a single limit order of 100 shares is very common. For trading strategies with a large time scale the major difficulty is that a trader, observing post-factum missed opportunities, often starts to \u201cadjust\u201d the strategy to lower time scales. For professional money managers (managing other people money), with the rare exception of \u201csuper-stars\u201d, the maximal possible time scale is one month: once a month a letter to investors explaining the fund performance is required to be sent. There is no such a \u201cmonthly\u201d constraint for somebody managing his own money, for example, an individual crypto investor may be 50% down in April 2022 \u2013 but for him this problem is not as big as it were for a fund. For traders the most popular time scales are between \u201cdaily trading\u201d and \u201cmonthly P&L\u201d; these time scales provide sufficient number of opportunity events along with market data availability (e.g. Bloomberg). Important that these time scales are \u201ccompatible\u201d with human reaction time.\nThe major drawbacks of trading systems the authors observed among institutional investors/hedge funds/individual investors is that all of them typically have a few time scales.\n1 Trivial time scales such as seasonal, daily open/close, year end, etc. while actually do exist provide little\ntrading opportunities.\nMost often \u2013 a single time scale. It may be explicit or implicit, but it almost always exists. The contradiction between a spectrum of time scales of the financial markets and a single time scale of a trading system is the most common limitation in trading systems design.\nConsider familiar demonstration with a moving average. Let P \u03c4 be a regular exponential\nmoving average. The average \u3008\u00b7\u3009 is calculated with the weight (A3):\nP \u03c4 (tnow) = \u3008pI\u3009 \u3008I\u3009 = \u3008Q0pI\u3009 \u3008Q0I\u3009 = \u3008Q0 | pI |Q0\u3009 \u3008Q0 | I |Q0\u3009 = \u222b tnow \u2212\u221e dV \u03c9(t)p(t)\u222b tnow \u2212\u221e dV \u03c9(t)\n(16)\nThe averaging d\u00b5 = \u03c9(t)dt takes place between the past and tnow using exponentially decaying weight \u03c9(t) = exp (\u2212(tnow \u2212 t)/\u03c4). With \u03c4 increase, the contributing to integral interval becomes larger and moving average \u201cshifts to the right\u201d (\u03c4 -proportional time delay, lagging indicator). The (16) has no single parameter that can \u201cadjust\u201d the time scale as \u03b1k do in (3) where d\u00b5 = \u03c82(x(t))\u03c9(t)dt. In (16) we have \u03c8(x) = const. Trading strategies that watch\n9 crossing between price and moving average, or between two moving averages calculated with different values of \u03c4 , have the problem that the specific values of time scales are initially preset. We personally observed a number of successful (and failed) traders who were constantly watching moving averages on Bloomberg \u2014 we may tell that their success is caused by intuitively switching from one scale to another; if you ask such a person what he is doing \u2013 he cannot explain; but looking at him from a side it is clear \u2013 the person is trying to\nidentify relevant time- and price- scales. Successful traders also jump frequently by observing assets of different classes; it is a common situation before placing a trade on GOOG to observe: DJI, AAPL, commodity, power generating industry, chemical industry \u2013 all withing less than a minute. If you go from a human (who select the time scale based on intuition, market knowledge, news, personal communications, experience, etc.) to an \u201cautomated trading machine\u201d that has none of that \u2013 the problem of selecting the time scale becomes very difficult. The problem of automatic time scale selection is crucial in trading systems design. Another critically important problem is to adsorb information of different financial instruments. The theory presented below is perfectly applicable in multi asset universe; the analysis and interpretation, however, become more complicated, see Section VIII below for a discussion. In this paper we will be concerned only with a single asset universe to demonstrate the main ideas, and a detailed generalization of the theory to multi asset universe will be published elsewhere.\nWhereas we still have no approach to price scale selection (the [5] uses price basis pk as Qk, but in the stationary case this is actually a time scale equivalent), we do have a practical method for an authomatic selection of the time scale.\nConsidered in Section II above the state \u2223\u2223\u03c8[IH]\u232a that maximizes the number of shares traded per unit time on past observations sample determines the time scale. Let us consider in this state not the price and execution flow as we studied before, but simply time distance\nto \u201cnow\u201d in \u2223\u2223\u03c8[IH]\u232a state:\nT [IH] =\n\u2329 \u03c8[IH] \u2223\u2223 (tnow \u2212 t)I \u2223\u2223\u03c8[IH]\u232a \u3008\u03c8[IH] | I |\u03c8[IH]\u3009\n(17)\nT \u03c4 = \u3008(tnow \u2212 t)I\u3009\n\u3008I\u3009 (18)\nhere T \u03c4 is regular moving average. As all the values of time (future and past) are known, the (17) carry information about \u2223\u2223\u03c8[IH]\u232a localization. When the value is small \u2013 a large dV/dt\n10\nspike event happened very recently. When it is large \u2013 a large spike happened a substantial time ago, the value is an information when a large spike in dV/dt took place.\nIn Fig. 3 (top) the value of T [IH] (scaled by the factor 10\u22123 and shifted up to fit the chart)\n11\nis presented for \u03c4 = 128s and \u03c4 = 256s. One can clearly see that there is no smooth transition between the states, the \u201cswitch\u201d happens instantly, there is no \u03c4 -proportional time delay, what is typical for regular moving averages T \u03c4 . A linear dependence of T [IH] on time is also\nobserved, this is an indication of stability of \u2223\u2223\u03c8[IH]\u232a state identification. The value of T [IH] is the time scale; typically it is easier to work with the density matrix \u03c1J(\u03c82) obtained from \u03c8(x) = \u03c8[IH](x) rather than with the time scale itself; a typical operation with time scale \u2013 calculate an average of some observable in the interval of time scale length till \u201cnow\u201d: the density matrix does exactly this.\nWe have tried a number of other operator pairs in generalized eigenvalue problem (6)\nA B eigenvalue meaning\n\u3008Qj | I |Qk\u3009 \u3008Qj |Qk\u3009 I = dV/dt (execution flow) \u3008Qj |V |Qk\u3009 \u3008Qj |T |Qk\u3009 V/T (aggregated execution flow) \u3008Qj |TI \u2212 V |Qk\u3009 \u3008Qj |T |Qk\u3009 I \u2212 V/T \u3008Qj |V |Qk\u3009 \u3008Qj |Qk\u3009 V (traded volume) \u3008Qj | p |Qk\u3009 \u3008Qj |Qk\u3009 p (price) \u3008Qj | pI |Qk\u3009 \u3008Qj | I |Qk\u3009 p (price)\u2329 Qj \u2223\u2223 dp dt\n\u2223\u2223Qk\u232a \u3008Qj |Qk\u3009 dp/dt\u2329 Qj \u2223\u2223 dp dt\n\u2223\u2223Qk\u232a \u3008Qj | I |Qk\u3009 dp/dV (market impact)\u2329 Qj \u2223\u2223P last \u2212 p \u2223\u2223Qk\u232a \u3008Qj |V |Qk\u3009 P last\u2212pV (aggregated market impact)\n. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .\namong many others[1, 2]. An eigenproblem with an additional constraint was also considered, see \u201cAppendix F\u201d of [2] and, more generally, \u201cAppendix G\u201d of [6]. All price-related operators cause noisy behavior, no \u201cswitching\u201d whatsoever. Only the operator V/T does have similar to I = dV/dt switching (but less pronounced); it is also more sensitive to \u03c4 selection. Time to max spike in V/T is presented in Fig. 3 (bottom). See [2] about the properties of |V |\u03c8\u3009 = \u03bb |T |\u03c8\u3009 states: \u201cAppendix C: The state of maximal aggregated execution flow V/T \u201d.\nThis makes us to conclude that the state to determine the time scale is the state \u2223\u2223\u03c8[IH]\u232a that maximizes the number of shares traded per unit time on past observations sample. This state allows us to average an observable f with the weights:\n12\nmeaning measure \u222b fd\u00b5\n\u201cat spike\u201d d\u00b5 = \u03c8[IH]2(x(t))\u03c9(t)dt \u2329 \u03c8[IH] \u2223\u2223 f \u2223\u2223\u03c8[IH]\u232a variation \u201cat spike\u201d d\u00b5 = 2 ED ( \u03c8[IH] ) \u03c8[IH](x(t))\u03c9(t)dt 2 \u2329 ED ( \u03c8[IH]\n) \u2223\u2223 f \u2223\u2223\u03c8[IH]\u232a \u201csince spike till now\u201d d\u00b5 = P (x(t))\u03c9(t)dt; P (x) = J ( \u03c8[IH] 2 ) Spur\u2016f |\u03c1P\u2016\n\u201csince since spike\u201d d\u00b5 = P (x(t))\u03c9(t)dt; P (x) = J ( J ( \u03c8[IH] 2 )) Spur\u2016f |\u03c1P\u2016\nFound solution automatically adjusts averaging weight what makes the value of parameter \u03c4 in (A3) much less important. The \u201cswitch\u201d happens instantly, without a \u03c4 -proportional time delay as it were for a regular moving average."
        },
        {
            "heading": "IV. ON THE IMPACT FROM THE FUTURE",
            "text": "The concept of the Impact From The Future was introduced in [1]. It predicts the value of future execution flow. Given currently observed (at t = tnow) value of execution flow I0 = \u3008\u03c80 | I |\u03c80\u3009 we know with certainty that future value of execution flow IF0 will be greater than I0 because more trading will definitely occur in the future. But how to estimate the value of IF0 ? The maximal eigenvalue \u03bb[IH] of (10) is used as the estimation of future execution flow IF0 :\nIF0 = \u03bb [IH] (19) dIF = IF0 \u2212 I0 (20) dIF \u2265 0 (21)\nWhereas the I0 is an \u201cimpact from the past\u201d (already observed current execution flow), the dIF is an \u201cimpact from the future\u201d (not yet observed contribution to current execution flow); it\u2019s value is non\u2013negative by construction. Similar ideology (use past maximal value as an estimator of future value) is often applied by market practitioners to asset prices or their standard deviations. This is incorrect. Experimental observations show: this ideology is applicable only to execution flow I = dV/dt, not to the trading volume, asset price standard deviation or any other observable.\nA criterion of no information about the future can be formulated. If current I0 is close to \u03bb[IH], this means that we have a \u201cvery dramatic market\u201d right now and there is no information\n13\nabout the future of this market:\ndIF = 0 (22)\nAn alternative form of (22) is more convenient in practice because the value is [0 : 1] bounded:\n\u2329 \u03c80 \u2223\u2223\u03c8[IH]\u232a2 = 1 (23)\nThis means that \u2223\u2223\u03c8[IH]\u232a and |\u03c80\u3009 are the same (14). In practice a good value of the threshold is between [0.2 : 0.8] instead of the maximal value of 1. In Fig. 1 one can clearly see the spikes in \u03bb[IH] when (23) approaches 1, for I0(t) see Fig. 1 of [2], it is not presented in Fig. 1 to save the place.\nWe have the state \u2223\u2223\u03c8[IH]\u232a and the criterion (23) of no information about the future. How to obtain directional information? Previously [3] we considered the price P [IH] (15) in the\nfound state \u2223\u2223\u03c8[IH]\u232a as an indicator related to market direction. The difference between P last and P [IH] was used as a directional indicator. A typical result is presented in Fig. 1. The price P [IH] is actually a moving average with positive weight having n\u2212 1 internal degrees of freedom. It determines the direction (and can possibly work for \u201creverse to the mean\u201d type of strategy), but this is not the future price.\nConsider a concept from classical machanics. Let us introduce a Lagrangian\u2013like function:\nS = t2\u222b t1 L(p, V, t)dt (24)\nand try to variate it. Let us first take L to be an exact differential (e.g. total energy in classical mechanics L = T + U). Then (24) carry no information about the dynamics, but\nwe obtain two distinct terms \u222b t2 t1 Tdt and \u222b t2 t1 Udt that we can consider the difference of and obtain actual equation of motion. We implemented this strategy below by considering various hypothesises for action S and testing them experimentally.\nA. Volume Driven Dynamics\nAssume that price changes are caused by trading volume. Introduce\nL(p, V ) = d\ndt (p\u2212 P last)(V \u2212 V last)\n14\n= (V \u2212 V last)dp dt + (p\u2212 P last)dV dt\n(25)\nThen \u201cexact differential action\u201d Sed = \u2329 \u03c8[IH] \u2223\u2223\u2223\u2223(V \u2212 V last)dpdt \u2223\u2223\u2223\u2223\u03c8[IH]\u232a+ \u2329\u03c8[IH] \u2223\u2223(p\u2212 P last)I\u2223\u2223\u03c8[IH]\u232a (26) To obtain \u201cactual\u201d action we have to change the sign in between:\nS = \u2329 \u03c8[IH] \u2223\u2223\u2223\u2223(V \u2212 V last)dpdt \u2223\u2223\u2223\u2223\u03c8[IH]\u232a\u2212 \u2329\u03c8[IH] \u2223\u2223(p\u2212 P last)I\u2223\u2223\u03c8[IH]\u232a (27)\nThese two terms can be considered as \u201ckinetic\u201d and \u201cpotential\u201d energy. It is difficult to variate (27) so let us just find the price P last that makes these two terms equal2:\n\u2206V D =\n\u2329 \u03c8[IH] \u2223\u2223\u2223\u2223(V \u2212 V last)dpdt \u2223\u2223\u2223\u2223\u03c8[IH]\u232a (28)\nPEQ = P [IH] \u2212 1 \u03bb[IH] \u2206V D (29)\nThe dynamics with (27) action is a volume-driven dynamics. Let I = dV dt = const then both price and volume are linear functions on time, P = \u03b1t+C and V \u2212V last = It, and two terms in (27) are equal exactly in any state: (p\u2212 P last)I = (V \u2212 V last)dp dt . Taking into account that\u2223\u2223\u03c8[IH]\u232a is typically localized (see Fig. 6 of Ref. [2]) obtain \u2329\u03c8[IH] \u2223\u2223(V \u2212 V last)dp\ndt \u2223\u2223\u03c8[IH]\u232a \u2248\u2329 \u03c8[IH] \u2223\u2223V \u2212 V last \u2223\u2223\u03c8[IH]\u232a \u2329\u03c8[IH] \u2223\u2223 dp dt\n\u2223\u2223\u03c8[IH]\u232a. Since V \u2212V last is negative, the (29) means trend following, the trend is determined in\n\u2223\u2223\u03c8[IH]\u232a state. In this state we have price equals to P [IH] and dp/dt = \u2329 \u03c8[IH] \u2223\u2223 dp dt\n\u2223\u2223\u03c8[IH]\u232a. The (29) means that reference price will slowly follow the trend as trading proceed. This trend following stops only with\n\u2223\u2223\u03c8[IH]\u232a state switch, what means a new spike in I has been observed and this new spike is now the \u201cmost dramatic market observed\u201d.\nAn important feature of PEQ is that in (29) there are only the moments that are calculated directly from sample using (A14): \u3008QmI\u3009, \u3008QmpI\u3009, and \u2329 QmV dp dt \u232a . This makes all the calculations easy. In Fig. 4 we present the PEQ along with P [IH]. In [3] the best directional indicator found was the difference between last price and P [IH], without trending term. As the price reaches some trading band \u2013 it starts crossing P [IH] multiple times thus creating false signals. The PEQ has a great advantage of extra trend following contribution in (29), what very much suppresses false signals. The result is also stable in situations when max I \u201cswitch\u201d is missed. 2 Similar concept in mechanics corresponds to finding the state in which kinetic energy equals to potential\nenergy. This gives an exact result for oscillators and approximate result for many other systems, see Virial\ntheorem.\n15"
        },
        {
            "heading": "B. Execution Flow Driven Dynamics",
            "text": "Consider \u201cexact differential\u201d action with \u2212 \u2329 \u03c8[IH] \u2223\u2223(p\u2212 P last)dV dt \u2223\u2223\u03c8[IH]\u232a term from (25): Sed = \u2329 \u03c8[IH] \u2223\u2223(P last \u2212 p)I\u2223\u2223\u03c8[IH]\u232a = Spur\u2225\u2225\u2225\u2225 ddt(p\u2212 P last)I \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225\n= Spur \u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225+ Spur \u2225\u2225\u2225\u2225pdIdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 (30) Then \u201cactual\u201d action3 is considered as \u201ckinetic\u201d and \u201cpotential\u201d terms split; the kinetic term is defined as the one with first derivative of price in Spur with \u2016\u03c1JIH\u2016.\nS = Spur \u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225\u2212 Spur\u2225\u2225\u2225\u2225pdIdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 (31)\n3 Note that if one put in (31) \u2225\u2225\u2225 ddt (V last \u2212 V )dpdt \u2225\u2225\u2225 and \u2225\u2225 ddt (P last \u2212 p)I\u2225\u2225 instead of \u2225\u2225\u2225I dpdt \u2225\u2225\u2225 and \u2225\u2225pdIdt \u2225\u2225 the (27)\nis obtained.\n16\nHere and below \u2016\u03c1JIH\u2016 is the densitity matrix corresponding to the state \u201csince \u2223\u2223\u03c8[IH]\u232a till\nnow\u201d (A8), obtained from the polynomial J ( \u03c8[IH] 2 ) (A11) by applying Theorem 3 of [7], see com/polytechnik/utils/BasisFunctionsMultipliable.java:getMomentsOfMeasurePr oducingPolynomialInKK_MQQM for numerical implementation; the \u2016\u03c1JJIH\u2016 is the densitity\nmatrix corresponding to the polynomial J ( J ( \u03c8[IH] 2 )) (A12);\n\u2016\u03c1JIH\u2016 = \u2225\u2225\u2225\u03c1J(\u03c8[IH]2)\u2225\u2225\u2225 (32)\n\u2016\u03c1JJIH\u2016 = \u2225\u2225\u2225\u03c1J(J(\u03c8[IH]2))\u2225\u2225\u2225 (33)\nsee com/polytechnik/freemoney/IandDM.java:{QQDensityMatrix,QQDensityMatrix2} for numerical calculation of \u2016\u03c1JIH\u2016 and \u2016\u03c1JJIH\u2016 from \u03c8[IH](x). The second term in (31) does not depend on price shift p \u2192 p + const as with (19) boundary condition we have\nSpur \u2225\u2225dI dt \u2223\u2223\u03c1JIH\u2225\u2225 = 0. The dynamics with (31) action is execution flow driven dynamics. Let I = dV\ndt = const then the volume is a linear functions on time V \u2212 V last = It and the price\nis constant dp/dt = 0, both terms in (31) are zero in any state; moreover when p(t) = I(t) the two terms are equal exactly for any I(t). This is different from the dynamics defined by (27) action where constant I causes linear dependence of price on time. With (31) action all changes in price are caused by changes in execution flow. Our previous observations [3, 5] show that asset prices are much more sensitive to execution flow I (dynamic impact), rather than to traded volume V (regular impact).\nWhereas the calculation of (27) action was easy because the moments were calculated directly from sample, the calculation of (31) is much more difficult. We can obtain directly\nfrom sample only operator \u2016pI\u2016 and then, using (A20), operator \u2225\u2225dpI dt \u2225\u2225 = \u2225\u2225I dp dt \u2225\u2225+ \u2225\u2225pdI dt \u2225\u2225:\u2225\u2225\u2225\u2225I dpdt \u2225\u2225\u2225\u2225\u2212 \u2225\u2225\u2225\u2225pdIdt \u2225\u2225\u2225\u2225 = 2\u2225\u2225\u2225\u2225I dpdt \u2225\u2225\u2225\u2225\u2212 \u2225\u2225\u2225\u2225dpIdt\n\u2225\u2225\u2225\u2225 (34) The problem left is to calculate the operator \u2225\u2225I dp dt\n\u2225\u2225. Currently we do not have a method to obtain it exactly. The problem is simplified by the fact that we need not the operator\u2225\u2225I dp\ndt \u2225\u2225 per se, but just Spur\u2225\u2225I dp dt \u2223\u2223\u03c1JIH\u2225\u2225, what enables us to work with it\u2019s approximation. See Appendix A below for several approximations for \u2225\u2225I dp dt\n\u2225\u2225; one can possibly try secondary sampling approach of Appendix D as an alternative route. Different approximations give\nnoticeably different results. Nevetheless, assume we know the value of Spur \u2225\u2225I dp\ndt \u2223\u2223\u03c1JIH\u2225\u2225 on past sample. Then, assume one more observation with price PEQ is coming. With the knowledge of future execution flow (19) we can put equal \u201ckinetic\u201d and \u201cpotential\u201d terms in (31), thus\n17\nto obtain the value of price PEQ at which (31) is zero (use (19) boundary condition with (A20) expansion):\n\u2206I = Spur \u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225\u2212 Spur\u2225\u2225\u2225\u2225pdIdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 = 2Spur \u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225\u2212 Spur\u2225\u2225\u2225\u2225dpIdt\n\u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 (35) PEQ = P last \u2212 \u2206I\n\u03bb[IH] (36)\n= 2P last \u2212 P [IH] \u2212 2 \u03bb[IH] Spur \u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225\nIn (36) all \u201cfuture\u201d price contributions are moved to the left hand side and in the right hand side all the integration is performed till last observed point with p = P last. Technically (36) means: calculate the difference \u2206I (35) on observed sample, and if it is not zero \u2013 the price will move on \u2212\u2206I/\u03bb[IH] to compensate. Our experiments show that these two terms are very close to each other and the value of \u2206I is small. One may also try other states,\nsuch as \u2016\u03c1JJIH\u2016 (33) to consider the operators in, but the property of operators \u2225\u2225I dp\ndt \u2225\u2225 and\u2225\u2225pdI dt\n\u2225\u2225 being equal in some density matrix state seems to be special to the state \u2016\u03c1JIH\u2016, see Appendix F below for a study of the state \u2016\u03c1JJIH\u2016."
        },
        {
            "heading": "C. Local Volume Driven Dynamics",
            "text": "Similarly to (30) one can consider the term \u2212 \u2329 \u03c8[IH] \u2223\u2223(V \u2212 V last)dp dt \u2223\u2223\u03c8[IH]\u232a from (25) to be an \u201cexact differential\u201d action:\nSed = \u2329 \u03c8[IH] \u2223\u2223\u2223\u2223(V last \u2212 V )dpdt \u2223\u2223\u2223\u2223\u03c8[IH]\u232a = Spur\u2225\u2225\u2225\u2225 ddt(V \u2212 V last)dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 = Spur \u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225+ Spur \u2225\u2225\u2225\u2225(V \u2212 V last)d2pdt2\n\u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 (37) Then \u201cactual\u201d action is:\nS = Spur \u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225\u2212 Spur\u2225\u2225\u2225\u2225(V \u2212 V last)d2pdt2 \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 (38)\nThe dynamics with (38) action is local volume driven dynamics. Let I = dV dt = const, then the volume is a linear functions on time V \u2212 V last = It. Two terms equal give quadratic dependence of price on time: P = \u03b1t2 + C; then two terms in (38) are equal exactly in any state: I dp dt = (V \u2212 V last)d2p dt2 . There is a similar problem with calculation of the derivatives to\n18\nthe one considered above. Taking into account \u2225\u2225 d dt (V \u2212 V last)dp dt \u2225\u2225 = \u2225\u2225I dp dt \u2225\u2225+\u2225\u2225\u2225(V \u2212 V last)dp2dt2 \u2225\u2225\u2225 obtain: \u2225\u2225\u2225\u2225I dpdt \u2225\u2225\u2225\u2225\u2212 \u2225\u2225\u2225\u2225(V \u2212 V last)d2pdt2 \u2225\u2225\u2225\u2225 = 2\u2225\u2225\u2225\u2225I dpdt \u2225\u2225\u2225\u2225\u2212 \u2225\u2225\u2225\u2225 ddt(V \u2212 V last)dpdt \u2225\u2225\u2225\u2225 (39) As with (34) above the second term is obtained by applying (A20) to the moments\u2225\u2225(V \u2212 V last)dp dt\n\u2225\u2225 that are available directly from sample. Consider one more observation with price PEQ coming. With the knowledge of future execution flow (19) we can obtain the equilibrium price:\n\u2206V = Spur \u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225\u2212 Spur\u2225\u2225\u2225\u2225(V \u2212 V last)d2pdt2 \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 = 2Spur \u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225\u2212 Spur\u2225\u2225\u2225\u2225 ddt(V \u2212 V last)dpdt\n\u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 (40) PEQ = P last \u2212 \u2206V\n\u03bb[IH] (41)\nTechnically (41) means: calculate the difference \u2206V (40) on observed sample, and if it is not zero \u2013 the price will move on \u2212\u2206V /\u03bb[IH] to compensate."
        },
        {
            "heading": "D. Total Lagrangian Driven Dynamics",
            "text": "The same as in Sections IVB and IVC above we can consider the entire L(p, V ) from (25) in \u2223\u2223\u03c8[IH]\u232a state \u2212 \u2329\u03c8[IH] \u2223\u2223L(p, V ) \u2223\u2223\u03c8[IH]\u232a to be an \u201cexact differential\u201d action: Sed = \u2329 \u03c8[IH] \u2223\u2223(P last \u2212 p)I\u2223\u2223\u03c8[IH]\u232a+\u2329\u03c8[IH] \u2223\u2223\u2223\u2223(V last \u2212 V )dpdt \u2223\u2223\u2223\u2223\u03c8[IH]\u232a\n= 2Spur \u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225+ Spur \u2225\u2225\u2225\u2225pdIdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225+ Spur \u2225\u2225\u2225\u2225(V \u2212 V last)d2pdt2 \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 (42)\nThis is actually the same expression as (26) above (with changed sign), but split differently into \u201ckinetic\u201d and \u201cpotential\u201d energy terms. The \u201cactual\u201d action is then obtained by changing the sign of \u201cpotential\u201d contributions:\nS = 2Spur \u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225\u2212Spur\u2225\u2225\u2225\u2225pdIdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225+ Spur \u2225\u2225\u2225\u2225(V \u2212 V last)d2pdt2 \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 (43) The dynamics for I = dV\ndt = const can be obtained in a regular way. The volume is a linear\nfunctions on time V \u2212 V last = It. The price with \u201ckinetic\u201d and \u201cpotential\u201d terms equal gives cubic dependence of price on time: P = \u03b1t3 + C; the terms in (43) are equal exactly in any state: 2I dp dt = 0 + (V \u2212 V last)d2p dt2 .\n19\nThe \u2206T correponds to the sum of (35) and (40):\n\u2206T = \u2206I + \u2206V (44)\n= 4Spur \u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225\u2212 Spur\u2225\u2225\u2225\u2225dpIdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225\u2212 Spur\u2225\u2225\u2225\u2225 ddt(V \u2212 V last)dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 (45)\nPEQ = P last \u2212 \u2206T \u03bb[IH]\n(46)\nWhereas this \u201cTotal Lagrangian Driven\u201d and \u201cVolume Driven\u201d dynamics of Section IVA above use the same \u201cexact differential action\u201d: (42) and (26), they generate different dynamics as we differently split action into \u201ckinetic\u201d and \u201cpotential\u201d terms. The dynamics of Section\nIVA is of trend following type, the direction changes only when \u2223\u2223\u03c8[IH]\u232a \u201cswitches\u201d. The direction of \u201cTotal Lagrangian Driven\u201d dynamics takes into account a number of factors in\n(43), thus it may reverse the direction even without a \u201cswitch\u201d in \u2223\u2223\u03c8[IH]\u232a."
        },
        {
            "heading": "V. ON SELECTION OF A TYPE OF THE DYNAMICS",
            "text": "In Sections IVA, IVB, IVC, and IVD we chose an \u201cexact differential\u201d action from which price dynamics was determined. The \u201cvolume driven\u201d dynaimcs of Section IVA stays separately as it is a trend\u2013following model with automatic time\u2013scale selection of Section III, it is the simplest \u201cpractical\u201d model. An important feature of possible \u201caction\u201d of the forms: (31), (38), and (43) is that all of them include fluctuations of execution flow dI/dt. Now we have to choose which one corresponds to market dynamics most closely. Technically, we have\nthree calculated characteristics: Spur \u2225\u2225dpI dt \u2223\u2223\u03c1JIH\u2225\u2225 and Spur\u2225\u2225 ddt(V \u2212 V last)dpdt \u2223\u2223\u03c1JIH\u2225\u2225 that are obtained exactly and Spur \u2225\u2225I dp dt\n\u2223\u2223\u03c1JIH\u2225\u2225 that is obtain from an approximation, such as in the Appendix A. Now we need to select from them the most appropriate linear combination to obtain the future price according to (35), (40), or (44).\nExperiments show that only execution flow driven dynamics of (31) form can possibly work to determine the future price. This type of dynamics has only two contributing terms: I dp dt and pdI dt , that are very close to each other in \u2016\u03c1JIH\u2016 state. The sum of them is equal\nexactly to \u03bb[IH](P last \u2212 P [IH]) = Spur \u2225\u2225dpI dt \u2223\u2223\u03c1JIH\u2225\u2225 (the result of [3]), and their difference determines (35) future price (a new result of this paper). In Fig. (5) a demonstration of PEQ (35) (field com/polytechnik/freemoney/PFuture.java:PEQ_I_fromDPI, obtained with \u2016I dp dt \u2016 from (A26) is presented. The result is almost identical to (A36) approximation,\n20\n[IH] is also presented (shifted up to 693); it is about 1/2 in\u2223\u2223\u03c8[IH]\u232a state. The calculations in shifted Legendre basis with n = 12 and \u03c4=256sec.\nfield com/polytechnik/freemoney/PFuture.java:PEQ_I_fromI2DtpDivI, and the \u2206I is slightly lower with (A25)). This is the only \u201cadvancing\u201d (not lagging!) indicator we managed\nto obtain so far. A very important feature is that operators \u2225\u2225pdI\ndt \u2225\u2225 and \u2225\u2225I dp dt \u2225\u2225 from (34) are very close in \u03c1JIH state, and the difference determines future direction (35). This corresponds to 2 \u03bb[IH] Spur \u2225\u2225I dp dt\n\u2223\u2223\u03c1JIH\u2225\u2225 \u2248 Spur\u2225\u2225dpdt \u2223\u2223\u03c1JIH\u2225\u2225; the ratio of aggregated execution flow V\nT = Spur\u2016I|\u03c1JIH\u2016 Spur\u2016\u03c1JIH\u2016 and execution flow \u03bb[IH] is about 0.5 in \u2223\u2223\u03c8[IH]\u232a state, see green line in Fig. 5.\nOne may also consider other states, e.g. from [2]: \u201cAppendix C: The state of maximal\naggregated execution flow V/T \u201d, that corresponds to eigenvalue problem \u2223\u2223V \u2223\u2223\u03c8[i]\u232a = \u03bb[i] \u2223\u2223T \u2223\u2223\u03c8[i]\u232a (47) and using this V/T maximal \u03bb in boundary condition (19). A remarkable feature of this state\n21\n\u2223\u2223\u03c8[V T ]\u232a is that in it dV/dT = V/T = \u03bb[V/T ]:\u2329 \u03c8[V T ] |I|\u03c8[V T ]\n\u232a \u3008\u03c8[V T ] |\u03c8[V T ]\u3009 = \u2329 \u03c8[V T ] |V |\u03c8[V T ] \u232a \u3008\u03c8[V T ] |T |\u03c8[V T ]\u3009 = Spur \u2016I|\u03c1JV T\u2016 Spur \u2016\u03c1JV T\u2016 = \u03bb[V/T ] \u2264 \u03bb[IH] (48)\nwhat allows us to consider \u201cdouble integrated\u201d type of the density matrix we considered in Appendix F. In this \u2223\u2223\u03c8[V T ]\u232a state we typically have Spur\u2225\u2225I dp\ndt \u2223\u2223\u03c1JV T\u2225\u2225 \u2248 Spur\u2225\u2225dpIdt \u2223\u2223\u03c1JV T\u2225\u2225, no \u201cadvancing\u201d information we managed to obtain so far.\nWhen asked about \u201cdirect application\u201d of the solution presented in Fig. 5, an \u201cadvancing\u201d\nindicator, to practical trading \u2013 it is not ready for two reasons:\n\u2022 The result strongly depends on approximation used for \u2225\u2225I dp\ndt \u2225\u2225, see Appendix A. \u2022 In Fig. 5 we have shown only the interval, where predicted future price is substantially\ndifferent from last price. For large intervals of this trading session the difference between predicted and last price is very small, this means the relation Spur \u2225\u2225pdI\ndt \u2223\u2223\u03c1JIH\u2225\u2225 = Spur \u2225\u2225I dp dt\n\u2223\u2223\u03c1JIH\u2225\u2225 holds almost exactly in \u2223\u2223\u03c8[IH]\u232a state. This makes us to conclude that execution flow driven dynamics of Section IVB, while is a very promising one and is the only one we obtained, that can possibly provide an \u201cadvancing\u201d indicator \u2013 it still requires more work for practical applications. These two directions are the most promising:\n1. Select other eigenvalue problem (6) that will be determining the time scale. The best what we found is (10) with the state \u2223\u2223\u03c8[IH]\u232a of maximal eigenvalue \u03bb[IH]. All other\ntried have been worse.\n2. Select directional indicator. The best indicator we found so far is the (35)."
        },
        {
            "heading": "VI. ON PRACTICAL SOURCE OF DIRECTIONAL INFORMATION",
            "text": "Whereas our attempts above to obtain an \u201cadvancing\u201d indicator were promising but not ready yet for practical trading, a lagging directional indicator with automatic time\u2013scale selection of Section IVA, is ready and can be applied to trading. This indicator (29) is the\nP [IH] price plus trend-following factor that is proportional to dp/dt in \u2223\u2223\u03c8[IH]\u232a state:\nPEQ = P [IH] \u2212 1 \u03bb[IH]\n\u2329 \u03c8[IH] \u2223\u2223\u2223\u2223(V \u2212 V last)dpdt \u2223\u2223\u2223\u2223\u03c8[IH]\u232a (49)\n22\nThe formula automatically selects the time scale from the interval [\u03c4/n : \u03c4 ] (in Shifted Legendre basis) or from the interval [\u03c4 : n\u03c4 ] (in Laguerre basis). The difference between last\nprice and PEQ determines the trend. Trend \u201cswitch\u201d occurs instantly as a \u201cswitch\u201d in \u2223\u2223\u03c8[IH]\u232a of (10) eigenproblem. In Fig. 8 below the (49) is presented in higher resolution than in Fig. 4 above. The situation when PEQ is close to P last corresponds to no information about the future (23) situation. Typically all the directional signals should be ignored (23) when\n\u2329 \u03c80 \u2223\u2223\u03c8[IH]\u232a2 & 0.1 (50)\nas this corresponds to little information about the future available."
        },
        {
            "heading": "VII. A BRIEF DESCRIPTION OF THE ALGORITHM",
            "text": "Whereas a theory presented is this work may look rather complicated, it\u2019s computer implementation is very straightforward. It is way simpler than multiple systems of other people the authors have seen in diversity \u00b7\u00b7_. Technically an implementation of the theory requires an integration to calculate the moments from timeserie sample (A14), polynomials multiplication (A1) to calculate the matrices from moments, and solving an eigenproblem (10) for time scale. There is no magic, simple and precise description of an algorithm implementing the theory is this: On each (Time, Execution Price, Shares Traded) tick coming do the following:\n1. Have an integrator that on each tick coming recurrently updates an internal states to calculate the moments: \u3008Qm\u3009, \u3008QmI\u3009, \u3008QmpI\u3009, and \u2329 QmV dp dt \u232a ; see com/polytechnik/\nfreemoney/CommonlyUsedMoments.java.\n2. Using these moments construct the matrices \u3008Qj |Qk\u3009, \u3008Qj | I |Qk\u3009, \u3008Qj | pI |Qk\u3009, and\u2329 Qm d dt V dp dt \u232a by applying multiplication operator (A1), then solve generalized eigenvalue\nproblem (11) to find the state of maximal execution flow \u2223\u2223\u03c8[IH]\u232a determining the time scale, see com/polytechnik/freemoney/FreeMoneyForAll.java. 3. Construct a polynomial corresponding to the state \u201csince \u2223\u2223\u03c8[IH]\u232a till now\u201d (A8), then\nobtain corresponding density matrix \u2016\u03c1 J(\u03c8[IH]2)\u2016 using Theorem 3 of [7], see com/poly technik/freemoney/IandDM.java.\n23\n4. Obtain (49) price as directional indicator. Use (50) as non-applicability criterion. See c\nom/polytechnik/freemoney/PFuture.java:PEQV_from_M.\n5. Optionally. Try (36), but this calculation requires an approximation for \u2225\u2225I dp\ndt \u2225\u2225 and is much more sensitive to time-scale selection than (49). The result for \u201cadvancing\u201d directional indicator (36) is not always satisfactory.\nSee Appendix C below with a description of the software implementing the algorithm. This software reads a sequence of (Time, Execution Price, Shares Traded) ticks (line after line, one tick per line), and for every tick read prints the results."
        },
        {
            "heading": "VIII. CONCLUSION",
            "text": "An approach to obtain directional information from a sequence of past transactions with an automatic time\u2013scale selection from execution flow I = dV/dt is presented. Whereas a regular moving average has a built-in fixed time scale, the approach of this paper uses the state of maximal execution flow (10) to automatically determine the one. Contrary to regular moving average the developed approach has n \u2212 1 internal degrees of freedom to adjust averaging weight according to spikes in execution flow I = dV/dt. These internal degrees of freedom allow to obtain an immediate \u201cswitch\u201d, what is not possible in regular moving average that always has a \u03c4 -proportional time delay, lagging indicator. For a problem of dimension n in Shifted Legendre basis the system automatically selects the time scale from the interval [\u03c4/n : \u03c4 ], and in Laguerre basis from the interval [\u03c4 : n\u03c4 ]. Among unsolved problem we\nwould note a selection of optimal \u2225\u2225I dp\ndt \u2225\u2225 interpolation to obtain an advancing price from (35), see Appendix A, and studying a possibility to \u201csplit\u201d some average value based on some other operator spectrum, see Appendix E, Eq. (E6). The software implementing the theory is available from the authors. Among directly applicable to trading results we would note the price (49) that includes both \u201cswitching\u201d and \u201ctending\u201d contributions, see Fig. 8.\nA generalization of the developed theory to a multi asset universe creates a number of new opportunities. Now from a sequence of past transactions l = 1 . . .M for Na financial instruments: ( tl, p (a) l , dV (a) l ) a = 1 . . . Na (51)\n24\none can construct Na execution flow operators \u2329 Qj \u2223\u2223I(a)\u2223\u2223Qk\u232a, each one with it\u2019s own state\u2223\u2223\u2223\u03c8[IH](a)\u232a of maximal I(a) and corresponding to it \u03c1(a)JIH . In addition to this an operator of capital-flow index\nI\u0303 = Na\u2211 a=1 p(a) dV (a) dt = Na\u2211 a=1 p(a)I(a) (52)\ncan be constructed to determine market overall activity; it also has it\u2019s own state \u2223\u2223\u2223\u03c8[IH]I\u0303\u232a of maximal I\u03034. Critically important that all these |\u03c8\u3009 are in the same basis (the one of (A4)) and their scalar products \u3008\u03c8 |\u03c6\u3009 can be readily calculated. Technically this means we can independently use Na integrators com/polytechnik/freemoney/CommonlyUsedM\noments.java, where each one calculates the moments \u2329 Qmf (a) \u232a of it\u2019s own single asset a = 1 . . . Na, and then, from here, all the cross-asset characteristics can be calculated via projections! For example: how similar is the state of high execution flow of asset a and the\none of asset b ?\u2014 it is just a regular scalar product of two wavefunctions \u2329 \u03c8[IH] (a) \u2223\u2223\u2223\u03c8[IH](b)\u232a2; \u201ccorrelated\u201d assets are not the assets which prices \u201cgo together\u201d but the assets with simultaneous spikes in execution flow. In addition to simultaneously criterion (projection) a criterion for \u201cwhich one came earlier: a spike in \u2016I(a)\u2016 or a spike in \u2016I(b)\u2016\u201d can be written in a similar\nway: \u2329 \u03c8[IH] (a) \u2223\u2223\u2223 (tnow\u2212t)I(a) \u2223\u2223\u2223\u03c8[IH](a)\u232a\u2329\n\u03c8[IH] (a) \u2223\u2223\u2223 I(a) \u2223\u2223\u2223\u03c8[IH](a)\u232a \u2212\n\u2329 \u03c8[IH] (b) \u2223\u2223\u2223 (tnow\u2212t)I(b) \u2223\u2223\u2223\u03c8[IH](b)\u232a\u2329\n\u03c8[IH] (b) \u2223\u2223\u2223 I(b) \u2223\u2223\u2223\u03c8[IH](b)\u232a obtained from directly sampled\nmoments \u2329 Qm(tnow \u2212 t)I(a) \u232a and \u2329 Qm(tnow \u2212 t)I(b) \u232a , or as Spur\u2016\u03c1(a)JIH\u2016 \u2212 Spur\u2016\u03c1 (b) JIH\u2016 what does not require other moments. There are several alternative forms of \u201cdistance\u201d to determine which |\u03c8\u3009 happened earlier, see [1], \u201cAppendix A: Time\u2013Distance Between |\u03c8\u3009 States\u201d.\nIn a multi asset univers complexity of calculations growths linearly with Na, hence the value of Na can be very high even for realtime processing. Moreover, as every integrator com /polytechnik/freemoney/CommonlyUsedMoments.java works independently, the problem can be easily parallelized to run each integrator on a separate core. Then all the cross-asset characteristics can be obtained from individual asset data (the moments from com/poly technik/freemoney/CommonlyUsedMoments.java instance) with standard linear algebra operations such as projection (scalar product), taking the difference between two Spur\u2016\u03c1JIH\u2016 to determine the distance, or considering some other operator (e.g. capital-flow index (52)) in a state like |\u03c8\u3009, \u2016\u03c1J(\u03c82)\u2016, or \u2016\u03c1J(J(\u03c82))\u2016.\n4 A one of self-evident trading strategies: when current value of I\u0303 is large \u2329 \u03c80 \u2223\u2223\u2223\u2223\u03c8[IH]I\u0303\u232a2 & 0.8 select the assets a with currently low execution flow \u2329 \u03c80\n\u2223\u2223\u2223\u03c8[IL](a)\u232a2 & 0.5 as \u201clagging\u201d and soon to follow in the direction of the market.\n25\nWe see an application of this paper theory to multi asset universe as the most promising direction of future research. The simplest, but really good, indicator is the P last(a) \u2212 PEQ(a) indicator (49) calculated for each a = 1 . . . Na asset then all summed with the \u03bb[IH] (a) weights for the terms in the sum to have the dimension of capital flow."
        },
        {
            "heading": "ACKNOWLEDGMENTS",
            "text": "This research was supported by Autretech group[9], www.\u0430\u0442\u0440\u0435\u0442\u0435\u043a.\u0440\u0444. We thank our colleagues from Autretech R&D department who provided insight and expertise that greatly assisted the research. Our grateful thanks are also extended to Mr. Gennady Belov for his methodological support in doing the data analysis.\nAppendix A: On Calculation of \u2329 QmI dp dt \u232a moments from \u3008QmpI\u3009 sampled moments.\nA theory developed in this paper works primarily with an observable f and corresponding operator (matrix) \u3008Qj | f |Qk\u3009, j, k = 0 . . . n\u2212 1 that is obtained by applying multiplication operator:\nQjQk = j+k\u2211 m=0 cjkmQm (A1)\nto sampled moments \u3008Qmf\u3009, m = 0 . . . 2n\u2212 2. The moments are defined with Qm(x) being a polynomial of order m and integration measure \u03c9(t) dt having the support t \u2208 [\u2212\u221e . . . tnow]:\n\u3008Qmf\u3009 = tnow\u222b \u2212\u221e dt \u03c9(t)Qm(x(t))f(t) (A2)\nIn this paper we use: \u03c9(t) is decaying exponent and x(t) is either linear or exponential function on time:\n\u03c9(t) = exp (\u2212(tnow \u2212 t)/\u03c4) (A3)\nx(t) = (t\u2212 tnow)/\u03c4 Laguerre basisexp (\u2212(tnow \u2212 t)/\u03c4) shifted Legendre basis (A4) These two bases correspond to a more general (also analytically approachable) form x(t) = exp (\u2212(tnow \u2212 t)/\u03c4 \u2217), where \u03c9(t) and x(t) are both exponential functions on t but with different time scales: \u03c4 and \u03c4 \u2217. Other forms can also be considered.\n26\nIf we want to consider df/dt moments, then put it to (A2) and do an integration by parts:\u2329 Qm df\ndt\n\u232a = f(tnow)\u03c9(x0)Qm(x0)\u2212 tnow\u222b \u2212\u221e dt f(t) d dt \u03c9(x(t))Qm(x(t)) (A5)\nif d dt \u03c9(x(t))Qm(x(t)) is equal to the same weight multiplied by a polynomial: \u03c9(x)P (x) then the moments of df/dt can be obtained from the moments of f according to (A5). The key element is an existence of ED(\u00b7), a polynomial\u2013to\u2013polynomial mapping function (it is obtained as a derivative of a polynomial multiplied by the weight):\nd\ndt \u03c9(x(t))\u03c8(x(t))\u03d5(x(t)) = \u03c9(x) [ED(\u03c8)\u03d5+ \u03c8ED(\u03d5)] (A6)\nED(\u03c8(x)) =  d\u03c8(x) dx + 1 2 \u03c8(x) Laguerre basis x d\u03c8(x)\ndx +\n1 2 \u03c8(x) shifted Legendre basis\n(A7)\nwhere the time-derivative of a polynomial multiplied by a weight is represented by the same weight multiplied by other polynomial. The (A5) corresponds to \u03c8 = 1 and \u03d5 = Qm.\nFor the two bases we consider in this paper it is also possible to obtain \u3008Qmf\u3009 moments from \u2329 Qm df dt \u232a moments using integration by parts, see [2], section \u201cBasic Mathematics\u201d, about J(\u00b7) polynomial-to-polynomial mapping such that for an arbitrary polynomial P (x): t\u222b\n\u2212\u221e\nP (x(t\u2032))\u03c9(t\u2032)dt\u2032 = \u03c9(t)J(P ) (A8)\nFor the bases we use such a polynomial-to-polynomial transform exists:\nJ(P ) = \n1\nexp(x) x\u222b \u2212\u221e P (x\u2032) exp(x\u2032)dx\u2032 Laguerre basis 1 x x\u222b 0 P (x\u2032)dx\u2032 shifted Legendre basis\n(A9)\nA remarkable feature of this transform is that since \u3008(f(tnow)\u2212 f)P \u3009 = \u2329 J(P )df\ndt\n\u232a and J(P )\nis also a polynomial, thus an average with it can be converted to a density matrix average, any average \u3008Pf\u3009 can be represented as the spur from a product of operator \u2016df/dt\u2016 and a density matrix \u2016\u03c1\u2016:\n\u3008Pf\u3009 = Spur \u2225\u2225\u2225\u2225\u03c1\u2223\u2223\u2223\u2223dfdt \u2225\u2225\u2225\u2225 (A10)\n27\nThis way any average of an observable f can be calculated as operator \u2016df/dt\u2016 averaged in some mixed state \u03c1 obtained from the polynomial P (x). Note, that J(\u00b7) transform can be applied in chain:\ntnow\u222b \u2212\u221e df dt J(P )\u03c9(t)dt = f \u2223\u2223\u2223 x0 J(P ) \u2223\u2223\u2223 x0 \u03c9(x0)\u2212 tnow\u222b \u2212\u221e fP (x(t))\u03c9(t)dt (A11)\ntnow\u222b \u2212\u221e d2f dt2 J(J(P ))\u03c9(t)dt = df dt \u2223\u2223\u2223 x0 J(J(P )) \u2223\u2223\u2223 x0 \u03c9(x0)\u2212 f \u2223\u2223\u2223 x0 J(P ) \u2223\u2223\u2223 x0 \u03c9(x0) + tnow\u222b \u2212\u221e fP (x(t))\u03c9(t)dt\n(A12)\nThe moments of f are usually obtained from direct sampling of all available observations\nl = 1 . . .M in a timeserie:\n\u3008Qmf\u3009 = M\u2211 l=1 f(tl)Qm(x(tl))\u03c9(tl) [tl \u2212 tl\u22121] (A13)\nthe moments of a derivative df/dt can also be obtained from direct sampling:\u2329 Qm df\ndt\n\u232a = M\u2211 l=1 Qm(x(tl))\u03c9(tl) [f(tl)\u2212 f(tl\u22121)] (A14)\nSee [1], section \u201cBasis Selection\u201d, for one more basis: price basis: Qk(t) = pk(t). It has no ED(\u00b7) and J(\u00b7) operators available, but has similar sampling formula. Given a good choice of basis polynomials:\nQm(x) = Lm(\u2212x) Laguerre basisPm(2x\u2212 1) shifted Legendre basis (A15) one can calculate (with double precision arithmetic) the moments to a very high orderm . 50 (limited by the divergence of cjkm multiplication coefficients (A1)) in Laguerre basis, and m . 150 (limited by poorly conditioned matrices) in shifted Legendre basis; Chebyshev polynomials Tm(2x \u2212 1) also provide very stable calculations in shifted Legendre basis (Chebyshev polynomials have perfectly stable multiplication: all cjkm = 0 except c jk j\u2212k = c jk j+k = 0.5, j \u2265 k). The result is invariant with respect to basis choice, Qm(x) = xm and the ones from (A15) give identical results, but numerical stability can be drastically different[3, 10].\nMoments calculated from market data timeserie using Eqs. (A13) and (A14) are the cornerstone of our theory. The most important are the moments of execution flow I = dV/dt,\n28\nthey are obtained from (A14) by putting the volume as f = V , thus the moments \u3008QmI\u3009 are obtained from timeserie sample; the matrix \u3008Qj | I |Qk\u3009 is obtained from them using multiplication operator (A1). The matrix \u3008Qj |Qk\u3009 is known analytically. These two matrices are volume- and time- averaged products of two basis functions. A generalized eigenvalue problem (5) is then formulated: \u2223\u2223I\u2223\u2223\u03c8[i]\u232a = \u03bb[i] \u2223\u2223\u03c8[i]\u232a (A16) n\u22121\u2211 k=0 \u3008Qj | I |Qk\u3009\u03b1[i]k = \u03bb [i] n\u22121\u2211 k=0 \u3008Qj |Qk\u3009\u03b1[i]k (A17)\n\u03c8[i](x) = n\u22121\u2211 k=0 \u03b1 [i] k Qk(x) (A18)\nand solved. Whereas the calculation of the moments \u3008QmI\u3009, \u3008QmpI\u3009, \u2329 Qm dp dt \u232a , \u2329 QmV dp dt \u232a , \u3008Qmp\u3009 create no problem whatsoever, an attempt to go beyond them turned out to be problematic. For example any second order derivative (e.g. d2p/dt2) cannot be obtained directly from sample (A14) and, in the same time, has singularities when applying an integration by parts (A5), not to mention difficulties to formulate a boundary condition at x = x0. However, some of these characteristics are of great interest. The most important one is\u2329 QmI dp dt \u232a . The price p = \u222b dp dt dt = \u222b dp provides an information of current market state, but little one about possible trading opportunities. Assume at a given time interval dt we have some specific constant value of execution flow I = dV/dt and some dp/dt. During this dt interval dV = Idt shares were traded and the price change was dp = dp dt dt. How much money we potentially can make during this dt? Buy at the beginning of t: dV shares at p. Sell at the end of t + dt: dV shares at p + dp. Total potential P&L (assuming we can perfectly\nfrontrun the market5) is then dP&L = Idp. The P&L = \u222b Idp tells us how much money can be potentially made (or lost) on market movements taking into account traded volume\ncapacity. This is the same sum of price changes as for regular price p = \u222b dp, but not all dp are created equal. If dp occurred on a large execution flow \u2013 it contributes more, if on a small \u2013 it contributes less6 This creates a different way to study opportunities of market movements, see Fig. 6. 5 During every dt we hold dV shares, i.e. we always hold a position S equals to execution flow I = dV/dt,\nthe P&L = \u222b S(t)dp, see [3], Section \u201cP&L operator and trading strategy\u201d.\n6 The concept of I dpdt = dV dt dp dt is very different from commonly studied market impact concept that is a price\nsensitivity to volume traded: dp/dV .\n29\nThe value of \u2329 QmI dp dt \u232a cannot be calculated directly as well as it cannot be calculated using integration by parts (A5) in a general basis. However, if we change the basis and\nvary basis functions in the basis of (A16) eigenproblem \u2223\u2223I\u2223\u2223\u03c8[i]\u232a = \u03bb[i] \u2223\u2223\u03c8[i]\u232a an approximate\nsolution can be obtained. Consider the basis \u2223\u2223\u03c8[i]\u232a, it is orthogonal (8), (9) as:\n\u03b4jk = \u2329 \u03c8[j] \u2223\u2223\u03c8[k]\u232a (A19a) \u03bb[j]\u03b4jk = \u2329 \u03c8[j]\n\u2223\u2223 I \u2223\u2223\u03c8[k]\u232a (A19b) what gives \u2329 \u03d5 \u2223\u2223 I \u2223\u2223\u03c8[i]\u232a = \u03bb[i] \u2329\u03d5 \u2223\u2223\u03c8[i]\u232a for an arbitrary |\u03d5\u3009. Then taking into account (A5) and (A6) put f = pI and P last = p(tnow). Obtain for matrix elements:\u2329 \u03c8[j] \u2223\u2223\u2223\u2223dpIdt \u2223\u2223\u2223\u2223\u03c8[k]\u232a = P lastI(tnow)\u03c9(x0)\u03c8[j](x0)\u03c8[k](x0)\n\u2212 \u2329 ED(\u03c8[j]) \u2223\u2223 pI \u2223\u2223\u03c8[k]\u232a\u2212 \u2329\u03c8[j] \u2223\u2223 pI \u2223\u2223ED(\u03c8[k])\u232a (A20) These are matrix elements of \u2329 \u03c8[j] \u2223\u2223dpI dt\n\u2223\u2223\u03c8[k]\u232a. We are going to modify them to obtain sought matrix elements \u2329 \u03c8[j] \u2223\u2223I dp dt\n\u2223\u2223\u03c8[k]\u232a, that should be zero when p = const. For this reason the average in (A20) should be reduced to an integral of an exact differential to be canceled with out of integral term. Taking into account (A16) and (A19) one can see that\u2329 \u03c8[j] \u2223\u2223\u2223\u2223I dpdt \u2223\u2223\u2223\u2223\u03c8[k]\u232a = P last\u221a\u03bb[j]\u03bb[k]\u03c9(x0)\u03c8[j](x0)\u03c8[k](x0)\n30\n\u2212 \u221a \u03bb[j]\n\u03bb[k] \u2329 ED(\u03c8[j]) \u2223\u2223 pI \u2223\u2223\u03c8[k]\u232a\u2212\u221a\u03bb[k] \u03bb[j] \u2329 \u03c8[j] \u2223\u2223 pI \u2223\u2223ED(\u03c8[k])\u232a (A21) satisfies exact differential condition. Then practically applicable expression is:\u2329 \u03c8[j] \u2223\u2223\u2223\u2223I dpdt \u2223\u2223\u2223\u2223\u03c8[k]\u232a = \u221a \u03bb[j] \u03bb[k] \u2329 ED(\u03c8[j]) \u2223\u2223 (P last \u2212 p)I \u2223\u2223\u03c8[k]\u232a+\u221a\u03bb[k] \u03bb[j] \u2329 \u03c8[j]\n\u2223\u2223 (P last \u2212 p)I \u2223\u2223ED(\u03c8[k])\u232a (A22)\nThis is an expression of operator \u2225\u2225I dp\ndt \u2225\u2225 in the basis of (A16). The reason why we were able to obtain this explicit expression is that we managed to combine differentiation of a product (A6) with eigenvalues problem (A16) to write, when p = const, each matrix element as an exact differential. This approximation can also be viewed as operators multiplication factoring:\n\u2329 \u03d5 \u2223\u2223 pI \u2223\u2223\u03c8[i]\u232a \u2248 n\u22121\u2211\nk=0\n\u2329 \u03d5 \u2223\u2223 p \u2223\u2223\u03c8[k]\u232a \u2329\u03c8[k] \u2223\u2223 I \u2223\u2223\u03c8[i]\u232a = \u2329\u03d5 \u2223\u2223 p \u2223\u2223\u03c8[i]\u232a\u03bb[i] (A23)\nwhat gives\nDPjk = 1 \u03bb[k] \u2329 ED(\u03c8[j]) \u2223\u2223 (P last \u2212 p)I \u2223\u2223\u03c8[k]\u232a+ 1 \u03bb[j] \u2329 \u03c8[j] \u2223\u2223 (P last \u2212 p)I \u2223\u2223ED(\u03c8[k])\u232a (A24) and two approximations for \u2016I dp\ndt \u2016:\u2329 \u03c8[j] \u2223\u2223\u2223\u2223I dpdt \u2223\u2223\u2223\u2223\u03c8[k]\u232a \u2248 \u221a\u03bb[j]\u03bb[k]DPjk = \u2016I1/2\u2016 \u00b7 \u2016DP\u2016 \u00b7 \u2016I1/2\u2016 (A25)\u2329 \u03c8[j] \u2223\u2223\u2223\u2223I dpdt \u2223\u2223\u2223\u2223\u03c8[k]\u232a \u2248 \u2016DP\u2016 \u00b7 \u2016I\u2016 (A26)\nUsing an approximation \u2016I\u03b2 dp dt \u2016 \u2248 \u2016I \u03b22 |dp dt |I \u03b22 \u2016 the (A25) result can be generalized to a I\u2013power \u03b2, however this result is not very accurate for \u03b2 other than 0 or 1, since it is obtained from the \u3008QmpI\u3009 moments:\u2329 \u03c8[j] \u2223\u2223\u2223\u2223I\u03b2 dpdt \u2223\u2223\u2223\u2223\u03c8[k]\u232a \u2248 (\u03bb[j]\u03bb[k])\u03b22 DPjk = \u2016I\u03b2/2\u2016 \u00b7 \u2016DP\u2016 \u00b7 \u2016I\u03b2/2\u2016 (A27)\nThis method of calculation is implemented in com/polytechnik/freemoney/MatricesFro mPI.java:getbQQIpowdpdtFromQQpi_withLastP; for DPjk see e.g. com/polytechnik/fre\nemoney/PFuture.java:bQQ_DP. A matrix obtained in \u2223\u2223\u03c8[i]\u232a basis can be converted to Qj basis in a regular way:\n\u3008Qj | f |Qk\u3009 = n\u22121\u2211\nl,i,s,m=0\nGjl\u03b1 [i] l \u2329 \u03c8[i] \u2223\u2223 f \u2223\u2223\u03c8[s]\u232a\u03b1[s]mGmk (A28)\n31\n\u2329 \u03c8[j] \u2223\u2223 f \u2223\u2223\u03c8[k]\u232a = n\u22121\u2211 s,m=0 \u03b1[j]s \u3008Qs | f |Qm\u3009\u03b1[k]m (A29)\nwhere Gram matrix Gjk = \u3008Qj |Qk\u3009, and \u03b1[i]k are (A16) eigenvectors in Qj basis, Eq. (A18), see com/polytechnik/utils/EVXData.java. 7 The expression (A25) is an approximation, similar (and slightly better) approximation is a non\u2013Hermitian matrix (A26) as it has a single approximate product compared with two in (A25).\nDifferent approximations can be obtained using a general form of (A23):\n\u2016fg\u2016 \u2248 \u2016f\u2016 \u00b7 \u2016g\u2016 (A30)\ncorresponding to an approximation \u03b4(x\u2212y) \u2248 \u2211n\u22121\nj,k=0Qj(x)G \u22121 jk Qk(y). We can obtain a result applying it to other moments available directly from sample: \u2329 QmV dp dt \u232a , \u2329 Qm dp dt \u232a along with\ntheir derivatives \u2329 Qm dI dt \u232a , \u2329 Qm dpI dt \u232a , \u2329 Qm d dt V dp dt \u232a , and \u2329 Qm d2p dt2 \u232a obtained from integration by parts formula (A5) with boundary conditions: 1). impact from the future (19) and 2). zero V at tnow; traded volume V is measured relatively tnow, it is negative for past observations. A\nfew useful approximations of operator \u2225\u2225I dp\ndt \u2225\u2225:\u2225\u2225\u2225\u2225dpdt \u2225\u2225\u2225\u2225 \u00b7 \u2016I\u2016 (A31)\u2225\u2225\u2225\u2225dpIdt \u2225\u2225\u2225\u2225\u2212 \u2016p\u2016 \u00b7 \u2225\u2225\u2225\u2225dIdt\n\u2225\u2225\u2225\u2225 (A32)\u2225\u2225\u2225\u2225 ddtV dpdt \u2225\u2225\u2225\u2225\u2212 \u2016V \u2016 \u00b7 \u2225\u2225\u2225\u2225d2pdt2\n\u2225\u2225\u2225\u2225 (A33) Despite these operators being non-Hermitian this creates no problem as they are used only in calculation of Spur with Hermitian density matrix such as in (45). The approximation (A31)\nuses directly sampled moments \u2329 Qm dp dt \u232a , it is a product of two separately sampled operators with spikes, nevertheless it gives very similar to (A26) results, without spurious artifacts; sometimes, however, there is a difficulty to combine it with \u2016dpI dt \u2016 from (34), as in this case the moments from two different samplings are used together. The approximation (A32) uses exact\u2225\u2225dpI dt \u2225\u2225 and \u2225\u2225dI dt\n\u2225\u2225 operators matrix elements but the result is noisy. The (A33) also uses exact values of \u2225\u2225 d dt V dp dt\n\u2225\u2225 and \u2225\u2225\u2225d2pdt2 \u2225\u2225\u2225 (obtained from (A5) with zero boundary condition due to V 7 A question arise whether obtained matrix \u2329 Qj\n\u2223\u2223\u2223I\u03b2 dpdt \u2223\u2223\u2223Qk\u232a, j, k = 0 . . . n \u2212 1 corresponds to a measure or not: Whether it can be obtained from some \u2329 QmI\u03b2\ndp dt\n\u232a moments, m = 0 . . . 2n \u2212 2 by applying multiplication operator (A1)? We have an\nalgorithm to establish this fact, see Theorem 3 of [7]. Numerical experiments show that this is almost the case. A mismatch may be caused either by some numerical instability or by some degeneracy in the problem. A numerical instability is very unlikely because (A10) holds exactly for both: 1). original \u2329 Qj \u2223\u2223\u2223I\u03b2 dpdt \u2223\u2223\u2223Qk\u232a matrix (A25) and 2). the matrix obtained by applying multiplication operator (A1) to the moments \u2329 QmI\u03b2\ndp dt\n\u232a obtained from Theorem 3 of [7] applied to the original\nmatrix (A25). A mismatch between these two matrices is observed starting with n \u2265 3; the difference is very small but clearly established numerically. This degeneracy (if exists) does not create any problem in calculation of the value of any observable as the density matrix used has the form: a state since \u2223\u2223\u03c8[IH]\u232a spike.\n32\nfactor) operators, but it is completely useless due to d2p/dt2 singularities; however without the last term the operator \u2225\u2225 d dt V dp dt \u2225\u2225 gives similar to \u2225\u2225dpI dt \u2225\u2225 results. Two these operators should probably be considered together as corresponding to V dp and pdV . In sufficiently localizes states\n(e.g. \u2223\u2223\u03c8[IH]\u232a) we typically have \u2329\u03c8[IH] \u2223\u2223V dp\ndt \u2223\u2223\u03c8[IH]\u232a \u2248 \u2329\u03c8[IH] \u2223\u2223V \u2223\u2223\u03c8[IH]\u232a \u2329\u03c8[IH] \u2223\u2223 dp dt \u2223\u2223\u03c8[IH]\u232a. Another possible approach to obtain \u2225\u2225I dp dt \u2225\u2225 that enters into (35) together with \u2225\u2225pdI dt\n\u2225\u2225 is to consider the operator \u2225\u2225 d dt p I\n\u2225\u2225. As above, let us take (A20) and, assuming that changes in p are much smaller than changes in I, modify it to obtain \u2225\u2225 d dt p I\n\u2225\u2225 matrix elements:\u2329 \u03c8[j]\n\u2223\u2223\u2223\u2223 ddt pI \u2223\u2223\u2223\u2223\u03c8[k]\u232a \u2248 P lastIF0 \u03c9(x0)\u03c8[j](x0)\u03c8[k](x0)\n\u2212 1 \u03bb[k] 2\n\u2329 ED(\u03c8[j]) \u2223\u2223 pI \u2223\u2223\u03c8[k]\u232a\u2212 1 \u03bb[j] 2 \u2329 \u03c8[j] \u2223\u2223 pI \u2223\u2223ED(\u03c8[k])\u232a (A34) This expression satisfies limit case conditions. When p = const the result exactly equals\nto \u2225\u2225 d dt 1 I \u2225\u2225, when I = const the result exactly equals to \u2225\u2225dp dt \u2225\u2225, and when \u2016pI\u2016 = \u2016I\u2016 \u00b7 \u2016I\u2016 the result is a differential of a constant. With IF0 = \u03bb[IH] as per (19), the (A34) also\nsatisfies Spur \u2225\u2225 d dt 1 I \u2223\u2223\u03c1JIH\u2225\u2225 = 0, the same as for Spur\u2225\u2225 ddtI\u2223\u2223\u03c1JIH\u2225\u2225 = 0. See com/polytechni k/freemoney/MatricesFromPI.java:getbQQDtpDivIFromQQpi_withLastP for numerical\nimplementation. This approximation \u2225\u2225 d dt p I \u2225\u2225 = \u2225\u2225\u2225 Idp/dt\u2212pdI/dtI2 \u2225\u2225\u2225 can be tried as a proxy to \u2016Idp/dt\u2212 pdI/dt\u2016 in (35), but the result is very poor. The problem is that (A34) has an extra common factor 1/I2. Similarly to (A24) we can modify it by \u03bb[j]\u03bb[k] factor to remove I2 from the denominator:\u2225\u2225\u2225\u2225\u03c8[j]\u2223\u2223\u2223\u2223I dpdt \u2212 pdIdt \u2223\u2223\u2223\u2223\u03c8[k]\u2225\u2225\u2225\u2225 \u2248 \u2016I\u2016 \u00b7 \u2225\u2225\u2225\u2225 ddt pI\n\u2225\u2225\u2225\u2225 \u00b7 \u2016I\u2016 (A35)\u2329 \u03c8[j]\n\u2223\u2223\u2223\u2223I dpdt \u2212 pdIdt \u2223\u2223\u2223\u2223\u03c8[k]\u232a \u2248 P lastIF0 \u03c9(x0)\u03bb[j]\u03bb[k]\u03c8[j](x0)\u03c8[k](x0)\n\u2212 \u03bb [j] \u03bb[k] \u2329 ED(\u03c8[j]) \u2223\u2223 pI \u2223\u2223\u03c8[k]\u232a\u2212 \u03bb[k] \u03bb[j] \u2329 \u03c8[j] \u2223\u2223 pI \u2223\u2223ED(\u03c8[k])\u232a (A36) but this creates a problem that the condition Spur \u2225\u2225I\u2223\u2223 d dt 1 I\n\u2223\u2223I\u2223\u2223\u03c1JIH\u2225\u2225 = 0 no longer holds, thus it cannot be applied in (35). One may try to adjust the value of IF0 in (A36) to have this condition satisfied (put p = const and take the Spur with \u2016\u03c1JIH\u2016 of (A36), let it equals to zero; the values of IF0 and \u201cadjusted\u201d IF0 are typically very close, adjusted value is often slightly\nlarger). An important difference between \u2225\u2225\u2225 Idp/dt\u2212pdI/dtI2 \u2225\u2225\u2225 and \u2016Idp/dt\u2212 pdI/dt\u2016 is that the first one is an exact differential (thus it\u2019s Spur with \u03c1JIH can be reduced to sub-differential\nexpression in \u2223\u2223\u03c8[IH]\u232a state and the boundary term), and the second one is not, thus it cannot\nbe reduced to some observable in \u2223\u2223\u03c8[IH]\u232a state.\n33\nThe (A26), (A31), and (A36) are approximations that can be used for operator \u2225\u2225I dp\ndt \u2225\u2225, see com/polytechnik/freemoney/PFuture.java for numerical implementation."
        },
        {
            "heading": "Appendix B: On Surrogate Volume",
            "text": "Another question of interest is whether all the developed theory and software of this work can be used without trading volume available. For a number of markets (such as: sovereign CDS, corporate fixed income, crypto exchanges, currency trading, etc.) it is quite common to have the price to be very accurate and available almost realtime, but the traded volume is either not available at all or provided incorrectly (sometimes intentionally incorrectly). In such a case there is an option to use the absolute value of price change as it were the volume; the calculations are the same \u2013 in (A14) instead of df = Vl \u2212 Vl\u22121 one can use da = |pl \u2212 pl\u22121|. The only problem with this approach is that market events without price\n34\nchange would not be taken into account as for them da = 0, hence the results will be less accurate. However, our past experiments, see [3], Fig. 6, show that absolute value of price tick as a \u201cpoor man volume\u201d often provides quite similar results. A feed of \u201call price ticks\u201d can be\nused as a surrogate volume. For a liquid asset it typically takes a few minutes for \u2211 da to\nexceed P last \u2212 P 0 = \u2211 dp in several orders of magnitude; for the entire trading session in Fig. 7 a typical maximal price change is about 5, but the sum of all absolute price changes is about 500; total reported by NASDAQ ITCH [8] trading volume of this session is about 3 \u00b7 106 shares. As this da sequence is all positive, we also tried it with the market impact dp/dV concept (that completely failed with actual price change dp) in a hope that with this da we may find an identifiable limit for dV/da. The result is also unsatisfactory: The dV/da is very similar to dV/dt: it fluctuates in orders of magnitude and clearly has no stable limit at any time scale below 10 minutes (for US equity marker). However the da/dt is similar to dV/dt and for liquid assets can be used as a \u201cpoor man volume\u201d I = da dt\nwith the matrices\u2329 Qj \u2223\u2223 da dt \u2223\u2223Qk\u232a and \u3008Qj |Qk\u3009 in (A17). See com/polytechnik/freemoney/CommonlyUsedMom ents.java:addObservationNoBasisShift for calculation of surrogate volume moments.\nIn Fig. 7 we present T [IH] (17) average (along with regular moving average T \u03c4 ) calculated for regular volume dV and surrogate volume da = |pl \u2212 pl\u22121|. One can see similar behavior of localization \u201cswitches\u201d. However, surrogate volume states have some \u201cswitches\u201d missed and overall picture is less detailed. In Fig. 8 the price PEQ from (29) is presented. One can see similar, but less detailed picture. This makes us to conclude that da = |pl \u2212 pl\u22121| is a \u201cpoor man volume\u201d."
        },
        {
            "heading": "Appendix C: Software Usage Description",
            "text": "The software is written in java. As with [1] follow the steps:\n\u2022 Install java 19 or later.\n\u2022 Download from [11] NASDAQ ITCH data file S092012-v41.txt.gz, and the archive\nAMuseOfCashFlowAndLiquidityDeficit.zip with the source code. There is also an alternative location of these files.\n\u2022 Decompress and recompile the program:\n35\nunzip AMuseOfCashFlowAndLiquidityDeficit.zip javac -g com/polytechnik/*/*java\n\u2022 Run the command to test the program\n36\njava com/polytechnik/algorithms/TestCall_FreeMoneyForAll \\\n--musein_file=dataexamples/aapl_old.csv.gz \\ --musein_cols=9:1:2:3 \\ --n=12 \\ --tau=256 \\ --measure=CommonlyUsedMomentsLegendreShifted \\ --museout_file=museout.dat\nProgram parameters are:\n--musein_file=aapl.csv : Input tab\u2013separated file with (time, execution price, shares traded) triples timeserie. The file is possibly gzip-compressed.\n--musein_cols=9:1:2:3 : Out of total 9 columns of dataexamples/aapl_old.csv.gz file, take column #1 as time (nanoseconds since midnight), #2 (execution price), and #3 (shares traded), column index is base 0.\n--museout_file=museout.dat : Output file name is set to museout.dat.\n--n=12 : Basis dimension. Typical values are: 2 (for testing a concept), or some value about [4 . . . 12] for more advance use.\n--tau=256 : Exponent time (in seconds) for the measure used.\n--measure=CommonlyUsedMomentsLegendreShifted The measure. The values CommonlyUsedMomentsLaguerre,CommonlyUsedMomentsMonomials correspond to Laguerre measure and CommonlyUsedMomentsLegendreShifted corresponds to shifted Legendre measures. The results of CommonlyUsedMomentsMonomials (uses Qk(x) = xk) should be identical to CommonlyUsedMomentsLaguerre (uses Qk(x) = Lk(\u2212x)), as the measure is the same and all the calculations are Qk(x)\u2013 basis invariant (but numerical stability is worse for CommonlyUsedMomentsMonom ials).\n\u2022 The results are saved in output file museout.dat. Among the values of interest are the\nfollowing:\npFV.pv_average Regular moving average P \u03c4 from (16).\npFV.Tv_average The moving average T \u03c4 from (18).\n37\npFV.totalVolume Total volume traded up to current tick.\npFV.pv_M The value of P [IH] (15). pFV.Tv_M The value of T [IH] (17), an indicator of localization of \u2223\u2223\u03c8[IH]\u232a.\npFV.I.wH_squared The value of \u2329 \u03c80 \u2223\u2223\u03c8[IH]\u232a2 (50), an indicator of applicability of any prediction.\npFV.PEQV_from_M The value of predicted \u201clagging price\u201d PEQ from (49) that includes both P [IH] and trending term, the best directional indicator we managed to obtain so far, see Fig. 8.\nThe output includes two versions: calculated with \u201cactual\u201d volume (prefixed with pFV.) and calculated with \u201csurrogate volume\u201d of Appendix B (prefixed with pFA.)."
        },
        {
            "heading": "1. Software Code Structure",
            "text": "Provided software is located in several directories:\n\u2022 com/polytechnik/utils/ General basis utilities including my Radon-Nikodym ap-\nproach [6] to machine learning.\n\u2022 com/polytechnik/lapack/ Ported to java LAPACK library.\n\u2022 com/polytechnik/lapack/ NASDAQ ITCH [8] parsing.\n\u2022 com/polytechnik/trading/ Both: \u201cscaffolding\u201d for new ideas and a \u201cgraveyard\u201d for\nold ones. Also contains unit tests. One can run all unit tests (takes >10 hours) as\njava com/polytechnik/trading/QVM\nor three simple unit test of this paper algorithms:\njava com/polytechnik/trading/PnLInPsiHstateLegendreShifted\\$PnLInPsiHstateLegendreShiftedTest\njava com/polytechnik/trading/PnLInPsiHstateLaguerre\\$PnLInPsiHstateLaguerreTest\njava com/polytechnik/trading/PnLInPsiHstateMonomials\\$PnLInPsiHstateMonomialsTest\n\u2022 com/polytechnik/freemoney/ The code implementing the theory of this paper. Most\nnoticeable are:\n38\ncom/polytechnik/freemoney/CommonlyUsedMoments.java Calculate the moments from (Time, Execution Price, Shares Traded) sequence of transactions using direct sampling.\ncom/polytechnik/freemoney/FreeMoneyForAll.java A wrapper to calculate the matrices \u3008Qj | f |Qk\u3009 from sampled moments \u3008Qmf\u3009. Secondary sampling of Appendix D is also included.\ncom/polytechnik/freemoney/PFuture.java To calculate all the theory of this paper.\n\u2022 com/polytechnik/algorithms/ Drivers to call various algorithms."
        },
        {
            "heading": "Appendix D: On Secondary Sampling",
            "text": "When direct sampling (A14) of an observable is not available an advanced technique of \u201csecondary sampling\u201d[2] can be applied to calculate the moments of it. An example. Assume on every tick a moving average is calculated. Then this calculated value is used as it were a new observable, and the moving average of this new observable is calculated. For trivial cases this gives nothing new: a moving average of a moving average is a moving average with different weight (for exponential moving average it is the moving average with twice lower exponent time). However, calculated quantity \u201cas it were an observable\u201d can be a characteristic that describes an immanent property of the system. In [2] we applied this technique to the maximal eigenvalue \u03bb[IH] of eigenproblem (10); we treated tick change in \u03bb[IH] (calculated value, see\nFig. 1) as it were a change in the observable fl = \u03bb[IH] \u2223\u2223 tl and calculated the moments with dfl = \u03bb [IH] \u2223\u2223 tl \u2212 \u03bb[IH] \u2223\u2223 tl\u22121 as \u2329 Qmg df dt \u232a = \u2211M l=1Qm(x(tl))g(tl)\u03c9(tl)dfl. The simplest application of this \u201ccalculated observable\u201d is the sum of price changes corresponding to positive \u03bb[IH] changes what gives the scalp price[2]:\nP = M\u2211 l=1 p(tl)\u2212 p(tl\u22121) if \u03bb [IH] \u2223\u2223 tl \u2212 \u03bb[IH] \u2223\u2223 tl\u22121 > 0 0 otherwise (D1)\nNormalization P(tnow) = P last is typically used for scalp price. Regular price corresponds to no condition on \u03bb[IH]. Whereas actual computation is performed in a single pass by highly optimized code using recurrent relation for moments and in-place calculation of the value to\n39\nbe used as a \u201cnew observable\u201d, for understanding the concept one may think about secondary sampling as having two-passes for input timeserie: first \u2014 scan all timeserie observations and build a \u201cnew observable\u201d for every timeserie point read; second \u2014 scan this timeserie once again treating the value calculated on the first pass as it were a regular observable. This \u201csecondary sampling\u201d approach greatly extends the types of observable that can be studied. However, while being very powerful in calculation of moments that otherwise are not approachable at all, it has difficulties in interpretation of the results.\nThe implementation of this technique is available in com/polytechnik/freemoney/Comm onlyUsedMoments.java. The methods updateWithSingleObservation recurrently adjusts the basis and adds calculated contributions corresponding to regular measures dP , dV , dA as in (A14). After this call all regular moments become available, and we have an option to calculate the value of some \u201csecondary\u201d observable from them, such as \u03bb[IH]. When the calculation is completed \u2014 the method addIHObservationSecondarySampling(double IH ) can be called. It, in addition to the moments already available from updateWithSingle Observation, calculates, as in (A14), three other moments corresponding to the measure\ndfl = IHl \u2212 IHl\u22121, specifically: \u2329 Qm df dt \u232a , \u2329 Qmp df dt \u232a , and \u2329 Qm dpf dt \u232a . The IH can be a calculated characteristic of various meaning, and the moments of this characteristic are now obtained as it were a regular observable. This technique is also very convenient for unit tests of moments calculation by using regular observable as IH.\nAppendix E: On Separation of States Based On dI/dt Sign\nThe value of future execution flow IF0 (19) allows us to obtain \u2016dI/dt\u2016 operator\u2019s matrix\nelements. Using integration by parts (put p = const in (A20)) obtain:\u2329 \u03c8[j] \u2223\u2223\u2223\u2223dIdt \u2223\u2223\u2223\u2223\u03c8[k]\u232a = IF0 \u03c9(x0)\u03c8[j](x0)\u03c8[k](x0)\u2212 \u2329ED(\u03c8[j]) \u2223\u2223 I \u2223\u2223\u03c8[k]\u232a\u2212 \u2329\u03c8[j] \u2223\u2223 I \u2223\u2223ED(\u03c8[k])\u232a (E1)\nThis operator\u2019s matrix elements cannot be obtained directly from sample (A14), however the knowledge of the impact from the future allows us to apply an integration by parts. Actually this is the only operator for which integration by parts gives exact answer; for other operators (e.g \u2016d2p/dt2\u2016) the boundary value at x0 is not known and matrix elements are typically obtained \u201cwithin a boundary term\u201d. Only having determined the exact value of IF0 (that includes both: an \u201cimpact from the past\u201d and an \u201cimpact from the future\u201d) it is possible\n40\nto have the \u2016dI/dt\u2016 matrix elements that are accurate enough to consider an eigenproblem:\u2223\u2223\u2223\u2223dIdt \u2223\u2223\u2223\u2223\u03c8[i]dI\u232a = \u03bb[i]dI \u2223\u2223\u2223\u03c8[i]dI\u232a (E2) Other than IF0 = \u03bb[IH] (19) values can be used in the boundary term of (E1), see [2] \u201cAppendix E: On calculation of dI/dt operator matrix elements from operator I\u201d for a list of reasonable options for IF0 . The concept introduced in [2] is to treat low I \u2192 high I and high I \u2192 low I transitions separately, as they lead to a very different price behavior. These I-transitions correspond to dI/dt derivative of different signs; corresponding operator \u2016dI/dt\u2016 always has\neigenvalues \u03bb[i]dI of different signs: \u2329 \u03c8[IH] \u2223\u2223 dI dt \u2223\u2223\u03c8[IH]\u232a = 0. Let us split the entire |\u03c8\u3009 space into direct sum of two subspaces8. Construct two projection operators:\n\u2016\u03a0dI+\u2016 = \u2211\ni:\u03bb [i] dI>0 \u2223\u2223\u2223\u03c8[i]dI\u232a\u2329\u03c8[i]dI\u2223\u2223\u2223 (E3) \u2016\u03a0dI\u2212\u2016 =\n\u2211 i:\u03bb\n[i] dI\u22640 \u2223\u2223\u2223\u03c8[i]dI\u232a\u2329\u03c8[i]dI\u2223\u2223\u2223 (E4) \u20161\u2016 = \u2016\u03a0dI+\u2016+ \u2016\u03a0dI\u2212\u2016 (E5)\nThis transform can be considered as eigenvalues adjustment technique[12] where the eigenvalues (not the eigenvectors!) are adjusted for an effective identification of weak hydroacoustic signals. The \u2016\u03a0dI+\u2016 can be viewed as \u2016dI/dt\u2016 operator with all negative eigenvalues set to 0 and all positive eigenvalues set to 1; the same with \u2016\u03a0dI\u2212\u2016 for opposite sign. This technique is most easy to implement in (E2) basis (where \u2016dI/dt\u2016 is diagonal), then to convert obtained projection operators back to the basis used applying (A28). Alternatively one can convert all the matrices \u2016I\u2016, \u2016pI\u2016, \u2016V dp dt \u2016, \u2016dpI dt \u2016, \u2016 d dt V dp dt \u2016, \u2016\u03c1\u2016 to the basis of (E2) eigenproblem applying (A29). All the results will be identical as the theory is gauge invariant[6]. With projection operators (E3) and (E4) any density matrix average can be written in the form:\nSpur \u2016f |\u03c1\u2016 = Spur \u2016f |\u03a0dI+|\u03c1\u2016+ Spur \u2016f |\u03a0dI\u2212|\u03c1\u2016 (E6)\nThis split allows us to separate an average of f in density matrix \u2016\u03c1\u2016 state to the ones corresponding to positive and negative dI/dt.\n8 Here we use \u2016dI/dt\u2016 matrix elements (E1) that are calculated from directly sampled \u2016I\u2016 moments. An\nalternative is to split the states according to dI/dt or d\u03bb[IH]/dt sign using the \u201csecondary sampling\u201d of [2].\nThe simplest example of it\u2019s application is the scalp price P (D1) that takes into account only \u201cimportant\u201d\nprice changes (regular price is the sum of all price changes).\n41\nFirst candidates on application of this technique are the terms from Total Lagrangian action (43) where the operators are calculated in the state of \u2016\u03c1JIH\u2016 density matrix. Every Spur that enter into the \u2206 expression (44) can be split into dI/dt contributions of different signs. There are several implementation of this technique, e.g. com/polytechnik/freemo ney/SplitdIdt.java and several others. The result, however, is not that great and this projection operators approach requires more research to be performed.\nThe property that requires special attention is that while the density matrix \u2016\u03c1JIH\u2016 is obtained from the polynomial \u03c8[IH]2(x) with J ( \u03c8[IH] 2 ) transform (A8), and all the average relations hold exactly, the density matrix itself may not have all the eigenvalues positive. This creates no problem with the total Spur but sometimes lead to spurious artifacts when combined with projection operators; the effect, however, is small. These small but negative eigenvalues of the density matrix, \u201cHermann Minkowski-style space\u201d, also require additional research."
        },
        {
            "heading": "1. Execution Flow Based Eigenvalues Adjustment Example",
            "text": "In the Appendix above we considered projection operators (E5) to \u201csplit\u201d \u2016I\u2016 or \u2016pI\u2016 based on some other operator spectrum, e.g. \u2225\u2225dI dt \u2225\u2225. To demonstrate a simplified example of this eigenvalues adjustment technique let us apply it to the operator \u2016I\u2016. Consider the state\n\u201csince \u2223\u2223\u03c8[IH]\u232a till now\u201d \u2016\u03c1JIH\u2016 and a trading strategy: buy at execution flow below aggregated execution flow VIH TIH with (F6) and (F7), and sell above it. The P&L position changes dS, see [3] Section \u201cP&L operator and trading strategy\u201d, is:\ndS = ( I \u2212 VIH\nTIH\n) dt (E7)\nThen the constraint 0 = \u222b dS is satisfied:\n0 = Spur \u2225\u2225\u2225\u2225dSdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 (E8)\nand, for this dS, the P&L = \u2212 \u222b pdS can be calculated:\nP&L = \u2212Spur \u2225\u2225\u2225\u2225pdSdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 (E9) If we want to consider (E9) as a superposition of\n\u2223\u2223\u03c8[i]\u232a states, introduce an operator: \u03a0 =\nn\u22121\u2211 i=0 \u2223\u2223\u03c8[i]\u232a(1\u2212 VIH TIH 1 \u03bb[i] )\u2329 \u03c8[i] \u2223\u2223 (E10)\n42\n\u03a0 = \u03a0+ + \u03a0\u2212 (E11)\n\u03a0+ = n\u22121\u2211\ni:\u03bb[i]> VIH TIH\n\u2223\u2223\u03c8[i]\u232a(1\u2212 VIH TIH 1 \u03bb[i] )\u2329 \u03c8[i] \u2223\u2223 (E12)\n\u03a0\u2212 = n\u22121\u2211\ni:\u03bb[i]\u2264VIH TIH\n\u2223\u2223\u03c8[i]\u232a(1\u2212 VIH TIH 1 \u03bb[i] )\u2329 \u03c8[i] \u2223\u2223 (E13)\nThe operator \u2016\u03a0\u2016 is actually the operator \u2016I\u2016 but with the eigenvalues 1\u2212 VIH TIH 1 \u03bb[i] instead of the \u03bb[i]9. Then (E8) and (E9) become (E14) and (E15) respectively:\n0 = Spur \u2016I|\u03a0|\u03c1JIH\u2016 = Spur \u2016I|\u03a0+ + \u03a0\u2212|\u03c1JIH\u2016 (E14)\nP&L = \u2212Spur \u2016pI|\u03a0|\u03c1JIH\u2016 = \u2212Spur \u2016pI|\u03a0+ + \u03a0\u2212|\u03c1JIH\u2016 (E15)\nFrom these operators \u2016\u03a0+\u2016 and \u2016\u03a0\u2212\u2016 one can obtain \u201cequilibrium prices\u201d P\u00b1 = Spur\u2016pI|\u03a0\u00b1|\u03c1JIH\u2016Spur\u2016I|\u03a0\u00b1|\u03c1JIH\u2016 and etc. The result is similar to the technique of \u201cextra volume\u201d V\u0303 and P \u2217 of the Appendix F below; no advancing information we managed to obtain from (E10)."
        },
        {
            "heading": "Appendix F: On The States Of Double Integration",
            "text": "The density matrix state \u03c1JIH (32) was obtained from the pure state of maximal execution flow \u2223\u2223\u03c8[IH]\u232a by applying J(\u00b7) transform (A8) to the polynomial \u03c8[IH]2(x), a variant of integration by parts:\nSpur \u2225\u2225\u2225\u2225dfdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 = f \u2223\u2223\u2223 x0 \u03c1JIH(x0)\u03c9(x0)\u2212 \u2329 \u03c8[IH] |f |\u03c8[IH] \u232a = f \u2223\u2223\u2223 x0 \u2212 \u2329 \u03c8[IH] |f |\u03c8[IH] \u232a (F1)\nn\u22121\u2211 j,k,l,m=0 Qj(x0)G \u22121 jk \u03c1JIHklG \u22121 lmQm(x0) = 1 (F2)\nwith (F2) due to 1 = \u2329 \u03c8[IH] \u2223\u2223\u03c8[IH]\u232a normalizing and 1 = \u03c9(x0) due to basis choice obtain familiar \u201cintegration by parts\u201d relation (A11). The \u2016\u03c1JIH\u2016 density matrix allows us to calculate\n\u201cexecution-flow\u201d-related values from \u2225\u2225dI dt \u2225\u2225 operator. We already used this relation (a special case of (A10)) to calculate e.g.\nSpur \u2225\u2225\u2225\u2225dpdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 = P last \u2212 \u3008\u03c8 | p |\u03c8\u3009 (F3)\n9 The operator \u2016\u03a0\u2016 may not correspond to a measure, i.e. it does not necessary correspond to m = 0 . . . 2n\u22122\nmoments \u3008Qm\u03a0\u3009 from which to obtain \u3008Qj |\u03a0 |Qk\u3009 using multiplication operator (A1).\n43\nSpur \u2225\u2225\u2225\u2225dpIdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 = P lastIF0 \u2212 \u2329\u03c8[IH] |pI|\u03c8[IH]\u232a (F4)\nSpur \u2225\u2225\u2225\u2225dIdt \u2223\u2223\u2223\u2223\u03c1JIH\u2225\u2225\u2225\u2225 = IF0 \u2212 \u2329\u03c8[IH] |I|\u03c8[IH]\u232a (F5)\nSpur \u2016I|\u03c1JIH\u2016 = VIH = V last \u2212 \u2329 \u03c8[IH] |V |\u03c8[IH] \u232a (F6)\nSpur \u2016\u03c1JIH\u2016 = TIH = T last \u2212 \u2329 \u03c8[IH] |T |\u03c8[IH] \u232a (F7)\nThe (F4) corresponds to (A20), (F5) with boundary condition (19) gives Spur \u2225\u2225dI dt \u2223\u2223\u03c1JIH\u2225\u2225 = 0 we used in (31), (F6) and (F7) are traded volume and time since\n\u2223\u2223\u03c8[IH]\u232a spike till \u201cnow\u201d; typically we use normalizing V last = 0 and T last = 0.\nNow consider a density matrix \u03c1JJIH (33) obtained from the pure state of maximal execution flow \u2223\u2223\u03c8[IH]\u232a by applying J(\u00b7) transform (A8) to the polynomial \u03c8[IH]2(x) twice. This density matrix corresponds to integration by parts performed twice. Obtain from (A12):\nSpur \u2225\u2225\u2225\u2225dIdt \u2223\u2223\u2223\u2223\u03c1JJIH\u2225\u2225\u2225\u2225 = IF0 Spur \u2016\u03c1JIH\u2016 \u2212 Spur \u2016I|\u03c1JIH\u2016 = IF0 TIH \u2212 VIH (F8)\n44\nSpur \u2225\u2225\u2225\u2225dpIdt \u2223\u2223\u2223\u2223\u03c1JJIH\u2225\u2225\u2225\u2225 = IF0 P lastSpur \u2016\u03c1JIH\u2016 \u2212 Spur \u2016pI|\u03c1JIH\u2016 (F9)\nThe \u2016\u03c1JJIH\u2016 density matrix allows us to calculate \u201cvolume\u201d-related values from \u2225\u2225dI dt \u2225\u2225 operator. One of the major results of this paper is established in Section IVB fact that in \u2016\u03c1JIH\u2016 state\nthe values of operators \u2225\u2225pdI\ndt \u2225\u2225 and \u2225\u2225I dp dt \u2225\u2225 are very close and their difference (if exists) gives future price (36). Let us consider these operators not in \u2016\u03c1JIH\u2016 state, but instead in the state\n\u2016\u03c1JJIH\u2016. An important difference from \u2016\u03c1JIH\u2016 state is that the condition of \u2225\u2225dI dt \u2225\u2225 being zero in \u2016\u03c1JJIH\u2016 state no longer holds, as execution flow I = dV/dt and aggregated execution flow\nVIH/TIH are different in \u2223\u2223\u03c8[IH]\u232a state. The (F8) requires an \u201cextra volume\u201d V\u0303\nV\u0303 = ( IF0 \u2212\nVIH TIH\n) TIH (F10)\nto obtain proper value of operator \u2225\u2225pdI\ndt \u2225\u2225; an alternative is to use eigenvalues adjustment technique of Appendix E 1 above. Using (35) obtain\n\u2206 = Spur \u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JJIH\u2225\u2225\u2225\u2225\u2212 Spur\u2225\u2225\u2225\u2225pdIdt \u2223\u2223\u2223\u2223\u03c1JJIH\u2225\u2225\u2225\u2225+ V\u0303 P \u2217 = 2Spur \u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JJIH\u2225\u2225\u2225\u2225\u2212 Spur\u2225\u2225\u2225\u2225dpIdt\n\u2223\u2223\u2223\u2223\u03c1JJIH\u2225\u2225\u2225\u2225+ V\u0303 P \u2217 (F11) The difference from (35) is that there is an extra term V\u0303 P \u2217 caused by the difference between IF0 and VIH TIH . We can consider |V |\u03c8\u3009 = \u03bb |T |\u03c8\u3009 providing equal execution flow and aggregated execution flow, see [2]: \u201cAppendix C: The state of maximal aggregated execution flow V/T \u201d, but these states gives little improvement. Consider instead a simplistic approach: select the value of P \u2217 that makes \u2206 equals to zero:\nP \u2217 = \u2212 1 V\u0303 2Spur\u2225\u2225\u2225\u2225I dpdt \u2223\u2223\u2223\u2223\u03c1JJIH\u2225\u2225\u2225\u2225\u2212 Spur\u2225\u2225\u2225\u2225dpIdt \u2223\u2223\u2223\u2223\u03c1JJIH\u2225\u2225\u2225\u2225 (F12) In Fig. 9 the P \u2217 is presented. We see no \u201cadvancing\u201d property as it is for (36), this is an indicator of \u201clagging\u201d type. This makes us to conclude that the state \u03c1JJIH while it has a number of interesting properties to research, does not immediately provide and \u201cadvancing\u201d\nindicator. The \u03c1JIH is probably the only state in which \u2225\u2225pdI\ndt \u2225\u2225 and \u2225\u2225I dp dt \u2225\u2225 operators are very close and their difference (if exists) gives future price (36).\n[1] V. G. Malyshkin, Market Dynamics. On A Muse Of Cash Flow And Liquidity Deficit, ArXiv\ne-prints (2017), arXiv:1709.06759 [q-fin.TR].\n45\n[2] V. G. Malyshkin, Market Dynamics: On Directional Information Derived From (Time, Execution\nPrice, Shares Traded) Transaction Sequences., ArXiv e-prints (2019), arXiv:1903.11530 [q-\nfin.TR].\n[3] V. G. Malyshkin and R. Bakhramov, Mathematical Foundations of Realtime Equity Trading.\nLiquidity Deficit and Market Dynamics. Automated Trading Machines., ArXiv e-prints (2015),\nhttp://arxiv.org/abs/1510.05510, arXiv:1510.05510 [q-fin.CP].\n[4] V. G. Malyshkin and R. Bakhramov, Market Dynamics vs. Statistics: Limit Order Book\nExample, ArXiv e-prints (2016), arXiv:1603.05313 [q-fin.TR].\n[5] V. G. Malyshkin, Market Dynamics. On Supply and Demand Concepts, ArXiv e-prints (2016),\nhttp://arxiv.org/abs/1602.04423, arXiv:1602.04423.\n[6] V. G. Malyshkin, On The Radon\u2013Nikodym Spectral Approach With Optimal Clustering, arXiv\npreprint arXiv:1906.00460 (2019), arXiv:1906.00460 [cs.LG].\n[7] V. G. Malyshkin, On Lebesgue Integral Quadrature, ArXiv e-prints (2018), arXiv:1807.06007\n[math.NA].\n[8] N. OMX, NASDAQ TotalView-ITCH 4.1 , Report (Nasdaq OMX, 2014) See data files samples\nhttps://emi.nasdaq.com/ITCH/ and newest version specification TotalView-ITCH 5.0..\n[9] AUTRETECH LLC, www.\u0430\u0442\u0440\u0435\u0442\u0435\u043a.\u0440\u0444, is a resident of the Skolkovo Technopark. In May 2019,\nthe company became the winner of the Skolkovo Cybersecurity Challenge competition.\n[10] B. Beckermann, On the numerical condition of polynomial bases: estimates for the condi-\ntion number of Vandermonde, Krylov and Hankel matrices, Ph.D. thesis, Habilitationsschrift,\nUniversita\u0308t Hannover (1996).\n[11] V. G. Malyshkin, (2014), the code for polynomials calculation, http://www.ioffe.ru/LNEPS/\nmalyshkin/code.html, there is also an alternative location.\n[12] G. S. Malyshkin, The comparative efficiency of classical and fast projection algorithms in the reso-\nlution of weak hydroacoustic signals (\u0421\u0440\u0430\u0432\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u0430\u044f \u044d\u0444\u0444\u0435\u043a\u0442\u0438\u0432\u043d\u043e\u0441\u0442\u044c \u043a\u043b\u0430\u0441\u0441\u0438\u0447\u0435\u0441\u043a\u0438\u0445 \u0438 \u0431\u044b\u0441\u0442\u0440\u044b\u0445\n\u043f\u0440\u043e\u0435\u043a\u0446\u0438\u043e\u043d\u043d\u044b\u0445 \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c\u043e\u0432 \u043f\u0440\u0438 \u0440\u0430\u0437\u0440\u0435\u0448\u0435\u043d\u0438\u0438 \u0441\u043b\u0430\u0431\u044b\u0445 \u0433\u0438\u0434\u0440\u043e\u0430\u043a\u0443\u0441\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0445 \u0441\u0438\u0433\u043d\u0430\u043b\u043e\u0432), Acoustical\nPhysics 63, 216 (2017), doi:10.1134/S1063771017020099 (eng) ; doi:10.7868/S0320791917020095\n(\u0440\u0443\u0441)."
        }
    ],
    "year": 2022
}