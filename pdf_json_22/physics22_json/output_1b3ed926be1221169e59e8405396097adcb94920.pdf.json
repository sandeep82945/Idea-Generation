{
    "abstractText": "BlueMUSE is an integral field spectrograph in an early development stage for the ESO VLT. For our design of the data reduction software for this instrument, we are first reviewing capabilities and issues of the pipeline of the existing MUSE instrument. MUSE has been in operation at the VLT since 2014 and led to discoveries published in more than 600 refereed scientific papers. While BlueMUSE and MUSE have many common properties we briefly point out a few key differences between both instruments. We outline a first version of the flowchart for the science reduction, and discuss the necessary changes due to the blue wavelength range covered by BlueMUSE. We also detail specific new features, for example, how the pipeline and subsequent analysis will benefit from improved handling of the data covariance, and a more integrated approach to the line-spread function, as well as improvements regarding the wavelength calibration which is of extra importance in the blue optical range. We finally discuss how simulations of BlueMUSE datacubes are being implemented and how they will be used to prepare the science of the instrument.",
    "authors": [
        {
            "affiliations": [],
            "name": "Peter M. Weilbachera"
        },
        {
            "affiliations": [],
            "name": "Sven Martensb"
        },
        {
            "affiliations": [],
            "name": "Martin Wendtc"
        },
        {
            "affiliations": [],
            "name": "Martin M. Rotha"
        },
        {
            "affiliations": [],
            "name": "Stefan Dreizlerb"
        },
        {
            "affiliations": [],
            "name": "Andreas Kelza"
        },
        {
            "affiliations": [],
            "name": "Roland Bacond"
        },
        {
            "affiliations": [],
            "name": "Johan Richardd"
        }
    ],
    "id": "SP:e97e83d6b7563c092115b9f4d7146b28a182fe08",
    "references": [
        {
            "authors": [
                "R. Bacon",
                "M. Accardo",
                "L. Adjali",
                "H. Anwand",
                "S Bauer"
            ],
            "title": "The MUSE second-generation VLT instrument",
            "venue": "[Ground-based and Airborne Instrumentation for Astronomy III], Proc. SPIE 7735 (July 2010).",
            "year": 2010
        },
        {
            "authors": [
                "R. Bacon",
                "J. Vernet",
                "E. Borisova",
                "N. Bouch\u00e9",
                "J Brinchmann"
            ],
            "title": "MUSE Commissioning",
            "venue": "The Messenger 157, 13\u201316 (Sept. 2014).",
            "year": 2014
        },
        {
            "authors": [
                "J. Richard",
                "R. Bacon",
                "J. Blaizot",
                "S. Boissier",
                "A Boselli"
            ],
            "title": "BlueMUSE: Project Overview and Science Cases",
            "venue": "arXiv (Jun 2019). BlueMUSE white paper, arXiv:1906.01657.",
            "year": 2019
        },
        {
            "authors": [
                "P.M. Weilbacher",
                "R. Palsa",
                "O. Streicher",
                "R. Bacon",
                "T Urrutia"
            ],
            "title": "The Data Processing Pipeline for the MUSE Instrument",
            "venue": "A&A 641, A28 (Sept. 2020).",
            "year": 2020
        },
        {
            "authors": [
                "P.G.J. Irwin",
                "D. Toledo",
                "A.S. Braude",
                "R. Bacon",
                "Weilbacher",
                "P. M"
            ],
            "title": "Latitudinal variation in the abundance of methane (CH4) above the clouds in Neptune\u2019s atmosphere from VLT/MUSE Narrow Field Mode Observations",
            "venue": "Icarus 331, 69\u201382 (Oct 2019).",
            "year": 2019
        },
        {
            "authors": [
                "C. Opitom",
                "B. Yang",
                "F. Selman",
                "C. Reyes"
            ],
            "title": "First observations of an outbursting comet with the MUSE integralfield spectrograph",
            "venue": "A&A 628, A128 (Aug. 2019).",
            "year": 2019
        },
        {
            "authors": [
                "A.F. McLeod",
                "P.M. Weilbacher",
                "A. Ginsburg",
                "J.E. Dale",
                "S. Ramsay",
                "L. Testi"
            ],
            "title": "A nebular analysis of the central Orion nebula with MUSE",
            "venue": "MNRAS 455, 4057\u20134086 (Feb. 2016).",
            "year": 2016
        },
        {
            "authors": [
                "A. Monreal-Ibero",
                "J.R. Walsh"
            ],
            "title": "The MUSE view of the planetary nebula NGC 3132",
            "venue": "A&A 634, A47 (Feb. 2020).",
            "year": 2020
        },
        {
            "authors": [
                "S. Kamann",
                "T.O. Husser",
                "S. Dreizler",
                "E. Emsellem",
                "Weilbacher",
                "P. M"
            ],
            "title": "A stellar census in globular clusters with MUSE: The contribution of rotation to cluster dynamics studied with 200 000 stars",
            "venue": "MNRAS 473, 5591\u20135616 (Feb 2018).",
            "year": 2018
        },
        {
            "authors": [
                "B. Giesers",
                "S. Kamann",
                "S. Dreizler",
                "Husser",
                "T.-O.",
                "A Askar"
            ],
            "title": "A stellar census in globular clusters with MUSE: Binaries in NGC 3201",
            "venue": "A&A 632, A3 (Dec. 2019).",
            "year": 2019
        },
        {
            "authors": [
                "M.M. Roth",
                "C. Sandin",
                "S. Kamann",
                "Husser",
                "T.-O.",
                "Weilbacher",
                "P. M"
            ],
            "title": "MUSE crowded field 3D spectroscopy in NGC 300. I. First results from central fields",
            "venue": "A&A 618, A3 (Oct. 2018).",
            "year": 2018
        },
        {
            "authors": [
                "W. Kollatschny",
                "P.M. Weilbacher",
                "M.W. Ochmann",
                "D. Chelouche",
                "A Monreal-Ibero"
            ],
            "title": "NGC 6240: A triple nucleus system in the advanced or final state of merging",
            "venue": "A&A 633, A79 (Jan. 2020).",
            "year": 2020
        },
        {
            "authors": [
                "E. Emsellem",
                "E. Schinnerer",
                "F. Santoro",
                "F. Belfiore",
                "I Pessa"
            ],
            "title": "The PHANGS-MUSE survey. Probing the chemo-dynamical evolution of disc galaxies",
            "venue": "A&A 659, A191 (Mar. 2022).",
            "year": 2022
        },
        {
            "authors": [
                "L. Wisotzki",
                "R. Bacon",
                "J. Brinchmann",
                "S. Cantalupo",
                "P Richter"
            ],
            "title": "Nearly all the sky is covered by Lyman-\u03b1 emission around high-redshift galaxies",
            "venue": "Nature 562, 229\u2013232 (Oct 2018).",
            "year": 2018
        },
        {
            "authors": [
                "R. Bacon",
                "D. Mary",
                "T. Garel",
                "J. Blaizot",
                "M Maseda"
            ],
            "title": "The MUSE Extremely Deep Field: The cosmic web in emission at high redshift",
            "venue": "A&A 647, A107 (Mar. 2021).",
            "year": 2021
        },
        {
            "authors": [
                "E. Emsellem",
                "D. Krajnovic",
                "M. Sarzi"
            ],
            "title": "A kinematically distinct core and minor-axis rotation: the MUSE perspective on M87",
            "venue": "MNRAS 445, L79\u2013L83 (Nov. 2014).",
            "year": 2014
        },
        {
            "authors": [
                "M. Fumagalli",
                "M. Fossati",
                "G.K.T. Hau",
                "G. Gavazzi",
                "R Bower"
            ],
            "title": "MUSE sneaks a peek at extreme rampressure stripping events - I. A kinematic study of the archetypal galaxy ESO137-001",
            "venue": "MNRAS 445, 4335\u20134344 (Dec. 2014).",
            "year": 2014
        },
        {
            "authors": [
                "K.T. Soto",
                "S.J. Lilly",
                "R. Bacon",
                "J. Richard",
                "S. Conseil"
            ],
            "title": "ZAP - enhanced PCA sky subtraction for integral field spectroscopy",
            "venue": "MNRAS 458, 3210\u20133220 (May 2016).",
            "year": 2016
        },
        {
            "authors": [
                "S. Cantalupo",
                "G. Pezzulli",
                "S.J. Lilly",
                "R.A. Marino",
                "Gallego",
                "S. G"
            ],
            "title": "The large- and small-scale properties of the intergalactic gas in the Slug Ly \u03b1 nebula revealed by MUSE He II emission observations",
            "venue": "MNRAS 483, 5188\u20135204 (Mar. 2019).",
            "year": 2019
        },
        {
            "authors": [
                "B. Husemann",
                "M. Singha",
                "J. Scharw\u00e4chter",
                "R. McElroy",
                "J Neumann"
            ],
            "title": "The Close AGN Reference Survey (CARS). IFU survey data and the BH mass dependence of long-term AGN variability",
            "venue": "A&A 659, A124 (Mar. 2022). 9",
            "year": 2022
        },
        {
            "authors": [
                "R. Bacon",
                "J. Brinchmann",
                "J. Richard",
                "T. Contini",
                "A Drake"
            ],
            "title": "The MUSE 3D view of the Hubble Deep Field South",
            "venue": "A&A 575, A75 (Mar. 2015).",
            "year": 2015
        },
        {
            "authors": [
                "T. Urrutia",
                "L. Wisotzki",
                "J. Kerutt",
                "K.B. Schmidt",
                "Herenz",
                "E. C"
            ],
            "title": "The MUSE-Wide Survey: survey description and first data release",
            "venue": "A&A 624, A141 (Apr 2019).",
            "year": 2019
        },
        {
            "authors": [
                "R. Bacon",
                "S. Conseil",
                "D. Mary",
                "J. Brinchmann",
                "M Shepherd"
            ],
            "title": "The MUSE Hubble Ultra Deep Field Survey. I. Survey description, data reduction, and source detection",
            "venue": "A&A 608, A1 (Nov 2017).",
            "year": 2017
        },
        {
            "authors": [
                "W. Freudling"
            ],
            "title": "The ESO Data Processing System (EDPS): A unified system for science data processing",
            "venue": "[Proc. SPIE ], 12186, 1218612 (2022).",
            "year": 2022
        },
        {
            "authors": [
                "A. Smette",
                "H. Sana",
                "S. Noll",
                "H. Horst",
                "W Kausch"
            ],
            "title": "Molecfit: A general tool for telluric absorption correction. I. Method and application to ESO instruments",
            "venue": "A&A 576, A77 (Apr. 2015).",
            "year": 2015
        },
        {
            "authors": [
                "A. Smette",
                "W. Kausch",
                "H. Sana",
                "S. Noll",
                "H Horst"
            ],
            "title": "Molecfit: Telluric absorption correction tool.",
            "venue": "Astrophysics Source Code Library (Jan",
            "year": 2015
        },
        {
            "authors": [
                "P.T. Wallace"
            ],
            "title": "The IAU SOFA Initiative",
            "venue": "[Astronomical Data Analysis Software and Systems V ], Jacoby, G. H. and Barnes, J., eds., Astronomical Society of the Pacific Conference Series 101, 207 (Jan. 1996).",
            "year": 1996
        },
        {
            "authors": [
                "M.M. Roth",
                "A. Kelz",
                "K. Madhav",
                "P.M. Weilbacher",
                "J Richard"
            ],
            "title": "The BlueMUSE Calibration Unit: Phase-A studies",
            "venue": "[Proc. SPIE ], 12184, 12184\u2013217 (2022).",
            "year": 2022
        },
        {
            "authors": [
                "M. Cappellari",
                "Y. Copin"
            ],
            "title": "Adaptive spatial binning of integral-field spectroscopic data using Voronoi tessellations",
            "venue": "MNRAS 342, 345\u2013354 (June 2003).",
            "year": 2003
        },
        {
            "authors": [
                "M. Cappellari"
            ],
            "title": "Improving the full spectrum fitting method: accurate convolution with Gauss-Hermite functions",
            "venue": "MNRAS 466, 798\u2013811 (Apr. 2017).",
            "year": 2017
        },
        {
            "authors": [
                "D.R. Law",
                "B. Cherinka",
                "R. Yan",
                "B.H. Andrews",
                "Bershady",
                "M. A"
            ],
            "title": "The Data Reduction Pipeline for the SDSS-IV MaNGA IFU Galaxy Survey",
            "venue": "AJ 152, 83 (Oct. 2016).",
            "year": 2016
        },
        {
            "authors": [
                "A. Jarno",
                "R. Bacon",
                "P. Ferruit",
                "A. P\u00e9contal-Rousset"
            ],
            "title": "Numerical Simulation of the VLT/MUSE Instrument",
            "venue": "[Astronomical Data Analysis Software and Systems XVII ], Argyle, R. W., Bunclark, P. S., and Lewis, J. R., eds., ASP Conf. Ser. 394, 701 (Aug. 2008).",
            "year": 2008
        },
        {
            "authors": [
                "A. Jarno",
                "R. Bacon",
                "P. Ferruit",
                "A. P\u00e9contal-Rousset",
                "M Pandey-Pommier"
            ],
            "title": "Introducing atmospheric effects in the numerical simulation of the VLT/MUSE instrument",
            "venue": "[Modeling, Systems Engineering, and Project Management for Astronomy IV ], Proc. SPIE 7738 (July 2010).",
            "year": 2010
        },
        {
            "authors": [
                "R. Bacon",
                "L. Piqueras",
                "S. Conseil",
                "J. Richard",
                "M. Shepherd"
            ],
            "title": "MPDAF: MUSE Python Data Analysis Framework.",
            "venue": "Astrophysics Source Code Library (Nov 2016)",
            "year": 2016
        },
        {
            "authors": [
                "S. Kamann",
                "L. Wisotzki",
                "M.M. Roth"
            ],
            "title": "Resolving stellar populations with crowded field 3D spectroscopy",
            "venue": "A&A 549, A71 (Jan. 2013).",
            "year": 2013
        },
        {
            "authors": [
                "Husser",
                "T.-O.",
                "S. Kamann",
                "S. Dreizler",
                "M. Wendt",
                "N Wulff"
            ],
            "title": "MUSE crowded field 3D spectroscopy of over 12 000 stars in the globular cluster NGC 6397. I. The first comprehensive HRD of a globular cluster",
            "venue": "A&A 588, A148 (Apr. 2016).",
            "year": 2016
        },
        {
            "authors": [
                "M. Wendt",
                "Husser",
                "T.-O.",
                "S. Kamann",
                "A. Monreal-Ibero",
                "P Richter"
            ],
            "title": "Mapping diffuse interstellar bands in the local ISM on small scales via MUSE 3D spectroscopy. A pilot study based on globular cluster NGC 6397",
            "venue": "A&A 607, A133 (Nov. 2017).",
            "year": 2017
        },
        {
            "authors": [
                "B. Giesers",
                "S. Dreizler",
                "Husser",
                "T.-O.",
                "S. Kamann",
                "G Anglada Escud\u00e9"
            ],
            "title": "A detached stellar-mass black hole candidate in the globular cluster NGC 3201",
            "venue": "MNRAS 475, L15\u2013L19 (Mar. 2018).",
            "year": 2018
        },
        {
            "authors": [
                "T.O. Husser",
                "S. Wende-von Berg",
                "S. Dreizler",
                "D. Homeier",
                "A Reiners"
            ],
            "title": "A new extensive library of PHOENIX stellar atmospheres and synthetic spectra",
            "venue": "A&A 553, A6 (May 2013). 10",
            "year": 2013
        }
    ],
    "sections": [
        {
            "text": "Keywords: Astronomy, Data processing, Pipeline, Integral field spectrocopy, BlueMUSE, VLT"
        },
        {
            "heading": "1. INTRODUCTION",
            "text": "BlueMUSE is a new project that is building on the legacy of the successful MUSE instrument1, 2 at the ESO VLT. It has just started the pre-design (\u201cPhase A\u201d) and is planned to be installed at one of the VLTs in 2030. The science cases to build this new instrument and its planned top-level parameters were already outlined in a White Paper.3\nBriefly, BlueMUSE will be a panoramic integral field spectrograph which is thought to cover at least 1\u2032\u00d71\u2032 on the sky with fine sampling of 0.\u2032\u20323/pix or better. It will cover the blue part of the optical spectrum, from the atmospheric cutoff at 350 nm to about 550 nm in one shot with high throughput. It will feature twice the spectral resolution of MUSE, i.e. \u3008R\u3009 \u2248 3600 when averaged over the wavelength range. Like MUSE, BlueMUSE will be made of 24 slicer-style integral field units and record the spectra on as many 4k\u00d74k CCDs. BlueMUSE will not, however, be coupled to an adaptive optics system, it will therefore operate with a single mode, with a stronger focus on instrument stability and even higher operational efficiency with minimal overheads.\nSince both instruments have a very similar design, it makes sense to look at the successes and failures of the MUSE pipeline4 (Sect. 2) before starting to design a pipeline for the new BlueMUSE instrument (in Sect. 3). We will discuss selected items of the new design in a bit more detail (Sect. 4) and present the basic ideas of the code to create simulated datacubes (Sect. 5).\nSend correspondence to PMW via e-mail to pweilbacher@aip.de.\nar X\niv :2\n20 9.\n06 02\n2v 1\n[ as\ntr o-\nph .I\nM ]\n1 3\nSe p\n20 22"
        },
        {
            "heading": "2. MUSE PIPELINE: LESSONS LEARNED",
            "text": "The MUSE instrument and its pipeline was a great success. As of June 2022 about 625 refereed publications are at least partially based on its data. In 2021 MUSE enabled the most publications of any ESO instrument, surpassing even HARPS and UVES.* In part, this success was due to a data reduction pipeline that could deliver science-ready datacubes with standard parameters for a large range of science topics, ranging from solar-system objects,5, 6 Galactic nebulae7, 8 and clusters,9, 10 nearby11\u201313 as well as high-redshift14, 15 galaxies.\nIn fact, that the pipeline was ready to support already the first commissioning run in February 2014 was of great importance. It could at that time already run the full suite of reduction steps to produced a datacube with most of the instrument signature and atmospheric effects removed. This allowed the pipeline team to concentrate on the most visible deficiencies, like an inverted field of view, a complete rewrite of the skyflat handling and of the computation and application of the line-spread function. All this resulted in the first MUSE science papers16, 17 getting written and submitted within a month of the science verification observations that they were based on.\n2.1 Pipeline design\nHowever, a number of issues are still present in the pipeline and/or in the reduced data. For example, while the pipeline is parallelized in a large extent, only half of its processing is done with OpenMP parallelization while the other half essentially relies on the user starting multiple processes in parallel. This was an early design choice, imposed by the processing environment that was thought to be realized in about 2008 but was not present (any more) when the instrument was commissioned in 2014. This division resulted in a somewhat artificial split into \u201cbasic\u201d- and \u201cpost\u201d-processing which also made it necessary to save large files to disk in between. Effectively, this approach costs extra (temporary) diskspace\u2020 and adds processing time (only \u223c 3%), but also complexity because the correct input files for the next step need to be determined (sometimes by user interaction)."
        },
        {
            "heading": "2.2 Issues: sky subtraction",
            "text": "The most obvious issue with the data produced by the pipeline was related to the sky subtraction: the bright sky lines left unexpectedly large residuals. Various groups of MUSE users therefore developed separate packages to handle telluric emission lines better, ZAP,18 CubEx,19 and CubePCA,20 among the most prominent. This was especially necessary for science programs that took \u201cdeep\u201d exposures of mostly empty sky regions which then tried to find faint line-emitting galaxies using automated methods.21, 22 An additional complication for these extra procedures was that the exposure-combination\n*See https://www.eso.org/sci/php/libraries/pubstats/#vlt for ESO publication statistics. \u2020about 10 GiB per MUSE exposure, compared to raw data size of 0.8 GiB and final datacube of 2.7 GiB\nalgorithm implemented in the MUSE pipeline could no longer be used, since the extra sky-subtraction procedure worked only on resampled 3D cubes and not on the (unresampled) intermediate data. On the other hand, these extra processing steps could not be implemented in the pipeline itself, because they only work well, if most of the exposure is empty, which is only the case for a small fraction of the MUSE exposures, and because PCA-methods are hard to adapt to data that are not sampled on a regular grid, like intermediate MUSE data. Finally, while these extra sky-subtraction programs very efficiently suppress telluric residuals, they often change the data in unforeseen ways. An example can be seen in Fig. 1a where both extra processing steps remove the sky artifacts, but ZAP also removes the continuum of the HII region while CubePCA does not."
        },
        {
            "heading": "2.3 Issues: flat-fielding",
            "text": "The second obvious issue are patterns visible in images created from the reduced datacubes by integrating over many wavelength planes (Fig. 1b). MUSE is built from 24 individual slicer IFUs which cover the full width of the field.\u2021 They visibly stand out in all exposures, and their pattern of dark and bright change with wavelength. On a smaller level, the four stacks of slices seem to create different patterns, especially between the two slicer stacks on the left and on the right of each IFU. Within each slicer stack, the images show an almost constant level. Finally, on the smallest scales, the horizontal intersections between the slicer stacks show a few especially dark (black arrows in Fig. 1b) and/or bright pixels.\nWhile both issues, strong sky subtraction residuals and integrated image artifacts, are very different phenomena and their root cause is not finally understood, they are both strongly tied to the quality of flat-fielding. Indeed, several calibrations (line-spread function, wavelength calibration, OH-transition flux ratios, and line flux homogeneity) were tested as to their effects on the sky subtraction accuracy. It turned out that the fluxes are varying across the field at the \u223c1.7% level, which is about the same level of variations seen in the sky background (as in Fig. 1b). The sky-line residuals visible in Fig. 1a are almost all less than 1% of the original flux of the line (this was shown to be true for most spectra4). The assumed flux ratios and the wavelengths of the telluric emission lines have systematic errors, too, but their effects are typically below this level.\nTherefore, by improving the flux calibration across the field through better flat-fielding, one could also improve the accuracy of the sky subtractions. For BlueMUSE, however, the only bright telluric emission lines in the wavelength range will be [OI]5577 and the [NI]5200 doublet. Sky subtraction will therefore be much less critical. But even to subtract fainter emission lines that would otherwise hamper detection of faint line emitters, we will strive to provide good correction for telluric emission."
        },
        {
            "heading": "2.4 Remedies",
            "text": "Under the assumption that the sky background in a MUSE exposure is really constant across the small 1\u2032\u00d7 1\u2032 field, two important approaches were used to flatten the data further. The first computed the integrated sky brightness in several wavelength ranges for each slice in the MUSE field, and compared this to the average sky brightness. Based on this, correction factors were computed. After applying them, only small gradiants along the slices and the \u201dgaps\u201d between the slicer stacks were visible in images created from the cubes. This approach was used for many MUSE datasets where most of the exposure was \u201dempty\u201d, i.e., in extragalactic fields.22, 24 For fields of nearby large objects, this approach is not feasible.\nThe \u201dgaps\u201d between the slicer stacks were often masked out before combining exposures.22, 24 Because this resulted in reduced S/N in these regions, the idea of a \u201dsuper-flat\u201d was more recently used to improve S/N and cosmetic quality of extremely deep exposures.15 For this super-flat, a large number of almost empty exposures have to be (median-)combined, onto the same grid as the exposure to be improved, but without taking into account their original dither offsets. This creates a datacube that has almost exactly the same artifacts as the science exposures, applying it to the science exposure then almost completely removes them, without affecting the scientific content of the exposure. It could, in principle, also be applied to exposures of large objects, if enough exposures without large offsets were taken with MUSE in the days around it. The drawback of this approach is the huge computational effort to create such a superflat for each science exposure.\nFor BlueMUSE, we are studying how to improve the flat-fielding so that these issues do not arise. Improved instrument stability of BlueMUSE will help in this regard."
        },
        {
            "heading": "3. BLUEMUSE PIPELINE: FIRST IDEAS",
            "text": "As all ESO pipelines, the BlueMUSE pipeline will be embedded into the ESO data flow system, i.e., it will be implemented as part of CPL/HDRL plugins to the EsoRex25 and EDPS26 systems.\nBased on the MUSE pipeline, we show a first flowchart for the science reduction of the BlueMUSE pipeline in Fig. 2. Since the instrument will be very similar, most of the steps will remain the same, from bad pixel masking using an external file, over bias subtraction, optional dark subtraction, and CCD-based flat-fielding using lamp-flat exposures. We then convert the images into tables of pixels using information on the location of the spectra (the tracing info), the wavelength calibration, and the instrument geometry. Onto these we apply the secondary sky-flat correction and correct the data for the overall shape of the lamp-flat spectrum, before correcting the data for atmospheric refraction. The refraction correction will likely work well using standard formulae and environmental measurements from the telescope telemetry in the FITS header.\nThe next step will apply the flux calibration using a response curve derived from a spectrophotometric standard, and apply an atmospheric extinction correction. This extinction correction could be derived from standard stars as well, if several were taken during photometric conditions in the same night at different airmasses. The flux calibration will include the possibility to correct telluric correction, even though no significant molecular absorption bands are expected to be visible in the wavelength range of BlueMUSE.\u00a7 The sky subtraction, distortion correction and astrometric position correction, as well as the exposure combination will work in the same way for BlueMUSE as they did for MUSE. The correction to (barycentric) velocity can be improved from recent work for other ESO pipelines (e.g., ESPRESSO), based on code from the SOFA29, 30 / ERFA\u00b6 initiative.\n\u2021The layout is described in detail in the MUSE User Manual23 and the pipeline paper.4 \u00a7The ozone bands in the UV-blue range are usually too weak and too broad and hence often not corrected in astronomical spec-\ntroscopy. Any spectrum to be used as correction could be input from external tools like ESO molecfit.27, 28 \u00b6ERFA is a re-licensed version of SOFA and available at https://github.com/liberfa/erfa.\nWhile saving of the pixel tables is no longer necessary at any step, we foresee the option of saving the intermediate files after all, to let users optimize the data in different ways, even using code outside the pipeline proper. All steps of the science reduction of BlueMUSE will be executable as one integrated pipeline and as finegrained steps using the same library functions for testing and debugging.\nAs for MUSE, we will delay the sampling of the data into the regular grid of a datacube only as the very last step of the science reduction. But for BlueMUSE we will take into account the covariance (see Sect. 4.3) and also propagate the spectral line profile throughout of resampling."
        },
        {
            "heading": "4. BLUEMUSE PIPELINE: SPECIFIC IMPROVEMENTS",
            "text": "We have so far studied at a few specific items that we will implement in a different way in the BlueMUSE pipeline. We will discuss three of them in this section."
        },
        {
            "heading": "4.1 Wavelength calibration",
            "text": "One of the main differences with regard to the MUSE instrument is that the wavelength calibration using arc lamps will not work as well in the blue wavelength range. The calibration unit (CU)31 will therefore be using a Fabry-Perot system or a laser frequency comb as the light source to densely populate the spectral range. This will create a near-equal spaced lines on the detector, so that the association of lines to reference wavelengths will not work with the pattern matching implemented before.4 Instead, we will create an initial zero-order calibration based on a standard arc-lamp exposure, and then construct the fully sampled wavelength solution using all lines from the comb or Fabry-Perot system. To save space, the full wavelength solution will be saved as a two-dimensional polynomial for each slice of the BlueMUSE instrument."
        },
        {
            "heading": "4.2 Line-spread function",
            "text": "Using the Fabry-Perot setup of the BlueMUSE CU, we should be able to improve on the estimation of the line-spread function (LSF) that was based only on a few bright arc lines in the MUSE instrument. We are planning to use scanning techniques to sample the LSF at better resolution than single arc lines allow. We will therefore be able to derive the LSF not only for each slice of the instrument, but for even for spatial positions along the slices.\nThe LSF will be used within the pipeline to improve the sky subtraction. But to make it available to users of the instrument for the science analysis we will also propagate it through the data reduction and create a datacube of the instrumental profile (at least in terms of its FWHM). First tests doing that were conducted with the MUSE pipeline for existing data, the results are shown in Fig. 3. We can see that the pattern in a single exposure (Fig. 3a) clearly shows the pattern of the slices, which are the smallest elements for which we know the LSF. When combining more exposures\nthat were taken with rotational and positional offsets, the differences are smoothed out (see Fig. 3b). In the analysis, LSF information like this can be further propagated through, e.g., Voronoi binning32 to be used for stellar population fits with tools like pPXF.33\n4.3 Covariance propagation"
        },
        {
            "heading": "4750 4800 4850 4900 4950 5000",
            "text": "One part of the MUSE pipline is resampling the data from an irregular to a regular grid to create a datacube object.4 This process causes variance values of single pixels to be transferred into covariances. The pipeline authors argue4 that it would be infeasible to carry these covariances through further pipeline steps due to the size of the data involved. Since the MUSE pipeline only resamples the data once, the variances per voxel of the output datacube are still accurate. However, combining multiple voxels from a datacube in further analyses beyond the scope of the reduction pipeline without considering the involved covariances could cause significant underestimation of the uncertainties of flux values.\nWhile it is true that the full covariance matrix would be too large to handle, it turns out that most entries of this matrix are zero. Each resampling method implemented in the MUSE pipeline only considers pixel values that are in some spatial and spectral proximity to the position of the output voxel. Therefore, covariances of a voxel are only offset from zero for other voxels in its proximity. With this in mind, the number of entries that are non-zero is likely small enough to be manageable for a whole datacube.\nTo put this to the test we implemented the drizzle-like resampling from the MUSE pipeline. We then added the handling of covariances according to the approach used for the pipeline of the Mapping Nearby Galaxies at Apache Point Observatory (MaNGA).34 We applied this algorithm to a spatially and spectrally limited part of a MUSE observation and extracted the spectrum of a single star from the reduced datacube. This spectrum is shown in the upper panel of Fig. 4. The flux uncertainties that are shown in that panel and the lower panel were calculated with and without taking the covariances into account. It is apparent that uncertainties derived only from variances are about 30% smaller than the ones derived by including the covariances.\nThe next step is to implement this method in the existing MUSE pipeline and run it on a full MUSE observation. While we expect that the additional computation time cost is not significant, this still needs to be tested. Based on the reduction with covariances described above, we anticipate that the additional storage size needed is in the order of 10GB for a full MUSE observation using the drizzle-like resampling method. This estimate would change for other resampling methods that take into account pixels that are further away from the output voxel. Overall, this seems to be a promising approach to account for covariances during reduction with the MUSE pipeline."
        },
        {
            "heading": "5. BLUEMUSE SIMULATIONS",
            "text": "In the late preparation phase before first light of MUSE, the consortium worked on a \u2019QSIM\u2019 tool to produce synthetic data cubes reflecting targeted science observations. These were intended to allow the different science teams to prepare their individual analysis tools on data that would be as close to the final data products as feasible while being able to generate these mock data in a reasonable amount of time on their local desktop machines. An alternative tool, called the Instrument Numerical Model (INM),35, 36 was able to simulate raw MUSE calibration and science exposures, but required computations of several days on a powerful workstation to generate the data. These in turn then had to be reduced using the data reduction pipeline to create datacubes. Compared to this, the QSIM datacube simulator was a very lightweight tool to generate datacubes quickly.\nIn 2013 QSIM was rewritten by M. Wendt from scratch in Python 2.X on the basis of the MUSE Python Data Analysis Framework (MPDAF) developed at the same time in Lyon.37 In the end only few science simulations were realized before the First Light of MUSE itself. Namely, mockup cubes of parts of the UDF fields as well as a comprehensive simulation of a globular cluster field containing about 38,000 stars that also served as testing ground for resolving stellar populations with crowded field 3D spectroscopy.38 Fortunately, the MUSE instrument was very successful right from the start and even the commissioning data led to science publications. In particular of the globular cluster NGC 6397, featuring the aforementioned crowded field spectroscopy39 and a transverse science case directly motivated by the earlier simulations.40 Once real instrument data was available, there was little use for a simulation tool in its state at the time."
        },
        {
            "heading": "5.1 Development of simulation software for BlueMUSE",
            "text": "During the preparation for the upcoming MUSE data before commissioning, it became obvious that the future end users of the final data products needed to get ready to deal with that kind of data in terms of sheer volume and also the limited ability of common tools to handle 3-dimensional data sets. In contrast, future users of BlueMUSE will be able to draw from a large pool of released tools and experience as well as laptop sized hardware that is easily up to the task of managing the expected data end products. A lesson learned from the development of dedicated simulation tools is that they need to be available way ahead of the planning of science observation since this is where simulations can play out their full potential. Accessing feasiblity and requirements for certain scientific questions in relation to a group of objects. While software like the provided exposure time calculator (ETC) will provide estimates of the expected signal-to-noise for a given observation, its impact on the success of the scientific exploitation of the data can only be tested and confirmed deploying the full analysis chain on the data. A number \u2013 but not all \u2013 of the questions that can and should be tackled ahead of the observation proposals are:\n\u2022 What is the minimum S/N at which we can expect to detect the characteristic features of interest?\n\u2022 Is the given resolution as well as the binsize appropriate for the set goals?\n\u2022 How much is the data being affected by the (reduced) transmission of the instrument (at the lower wavelength end)?\n\u2022 Are sky emission and telluric absorption lines a problem for the specific redshift range?\nTo successfully tackle those questions, the simulations need to create as realistic as possible data that mimics the expected data product from the offical data reduction pipeline closely. This includes the geometrical properties of the data cube and the plain instrumental parameters such as the spatial and spectral sampling, the spectral resolution as well as the overall cube dimensions as mentioned in section 1. Naturally it needs an interface to implement various science objects in the simulations, ranging from individual point sources such as quasars to clusters of stars, groups of galaxies or even diffuse emission.\nBut it also has to implement the simulated observing conditions, most notably the seeing conditions but also the full composition of the telluric background and the resulting complex noise properties of the data. The infamous \u2019redshift desert\u2019 for example \u2013 the inability or lowered sensitivity to appropiately determine galaxy redshifts in a certain redshift range (usually 1.4 < z < 1.9) \u2013 can in part be attributed to the lack of suitable emission lines in the optical for certain redshift ranges but a major aspect is the contamination with telluric features for higher wavelength ranges. Even single features can have influence on detection software, which is only one aspect why an accurate sky modelling is fundamental.\nTo address the mentioned points, a completely new software is currently being developed at Potsdam University to simulate BlueMUSE data: \u2019BlueSi\u2019. Where the former QSIM relied on frequent changes of an early MPDAF development version and on Python 2.x the focus is now on user-friendlyness and long-term maintainability to have a ready-to-use product in Python 3.x already in the science planning phase of the instrument. In the current early state, the BlueMUSE simulation software \u2019BlueSi\u2019 implements a Python interface to The Cerro Paranal Advanced Sky Model|| which allows the user to either manually vary up to 36 parameters related to physical conditions or simply mimic the conditions at a specific day and time and optionally merely provide deviations to those. This will allow the user to make very detailed choices while also being able to rely on realistic default settings.\nThe latter point turned out to be crucial in the usability and overall value of such simulations software and it also affects the inclusion of science objects into the simulated data cubes. While the simulation software for MUSE allowed for very complex and specific objects such as galaxies with separated information on different stellar populations with their own distributions and kinematics along with parametrized rotational curves and dispersion maps of any number of emission lines, it was basically impossible for a non-expert in all of those fields to generate realistic representations of typical galaxies. The mere preparation of the source file in the proper format constituted a significant obstacle.\nTo provide a much smoother learning curve and ease the process of simulating data products for a range of science cases, we work in close contact with the potential future users to help create an intuitive user interface and data format per major science case. We hope that by establishing a range of actual science objects as provided by the related peer-group the threshold to derive new science objects as targets for the BlueSi software will be significantly lowered.\nAs part of the current efforts, we implement a simulation of a globular cluster based on the data and analysis of MUSE observations. The detailed study of NGC 320141 allows us to to make use of a large data base of synthetic stellar spectra (PHOENIX42) based on the derived stellar parameters. These synthetic spectra cover the full wavelength range of BlueMUSE and are computed at very high resolution (R \u223c 500,000). Naturally, the simulation also needs to incorporate the features related to the cluster itself, such as the individual radial velocities of the stars and their intrinsic magnitudes.\nThe different steps involved in defining the data format and interface to the simulation software will be documented and serve as a blueprint for further integration."
        },
        {
            "heading": "6. CONCLUSIONS AND OUTLOOK",
            "text": "Despite some issues, the MUSE integral field spectrograph and its pipeline are a major success. The pipeline was already in a good shape to support commissioning activities in 2014 and first science papers shortly thereafter. Most of the shortcomings of the pipeline are understood and will be rectified in the design of the BlueMUSE pipeline, with MUSE data and pipeline as its testbed.\nSpecific improvements planned for the BlueMUSE data reduction are a simpler structure with better parallelization, improved wavelength calibration through Fabry-Perot or frequency comb techniques, a more detailed knowledge of the line-spread function, and the propagation of covariance to the final datacube.\nTo support science studies, a new simulation suite \u2019BlueSi\u2019 is being developed, with globular clusters as the first case to test generation of a realistic datacube.\nThe BlueMUSE integral field spectrograph is currently in its internal Phase A study phase and will enter the formal process with ESO in 2024. It is planned to be installed at the VLT in 2030 by which time its pipeline should be largely finished and ready for testing on sky.\n||This model is available from https://www.eso.org/sci/software/pipelines/skytools/skymodel."
        },
        {
            "heading": "ACKNOWLEDGMENTS",
            "text": "PMW, SM, MMR, and AK gratefully acknowledge support by the BMBF from the ErUM program (project VLT-BlueMUSE, grants 05A20BAB and 05A20MGA)."
        }
    ],
    "title": "The BlueMUSE data reduction pipeline: lessons learned from MUSE and first design choices",
    "year": 2022
}